<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/common.css">
  <link rel="shortcut icon" type="image/x-icon" href="/examples/public/favicon.ico" >
  <title>load-resource-support</title>
</head>

<style>
  #app {
    width: 100%;
    height: 100%;
  }

  #exportConfig {
    position: fixed;
    color: white;
    top: 0%;
    left: 0%;
    background: black;
    max-width: 100%;
    max-height: 100%;
    overflow: auto;
  }
</style>

<body>
  <div class="exportconfig" id="exportConfig"></div>
  <div id="app"></div>

  <script type="module">
    import { v4 as getUUid} from 'uuid'
    import * as Vis from '../dist/Vis.es.js' 
    import * as THREE from 'three'
    import assets from '/examples/public/assetsConfig/configLoadResource.json'

    const loaderManager = new Vis.LoaderManager()
    const resourceManager = new Vis.ResourceManager()

    loaderManager.addEventListener(Vis.LoaderManagerEventType.LOADED, e => {
      resourceManager.mappingResource(e.resourceMap)
    })

    loaderManager.load(assets)

    const lightConfig = {}
    const ambientLightConfig =  Vis.generateConfig('AmbientLight', {vid: getUUid()})
    const pointLightConfig =  Vis.generateConfig('PointLight', {
      vid: getUUid(),
      position: {
        z: 10,
        y: 5
      }
    })
    lightConfig[ambientLightConfig.vid] = ambientLightConfig
    lightConfig[pointLightConfig.vid] = pointLightConfig

    const textureMap = {}
    const mapTexture = Vis.generateConfig('ImageTexture', {
      vid: getUUid(),
      image: "/examples/public/texture/katana/katana_BaseColor.png"
    })
    const normalTexture = Vis.generateConfig('ImageTexture', {
      vid: getUUid(),
      image: "/examples/public/texture/katana/katana_Normal.png"
    })
    const roughnessTexture = Vis.generateConfig('ImageTexture', {
      vid: getUUid(),
      image: "/examples/public/texture/katana/katana_Roughness.png"
    })
    const metalnessTexture = Vis.generateConfig('ImageTexture', {
      vid: getUUid(),
      image: "/examples/public/texture/katana/katanal_Metallic.png"
    })
    textureMap[mapTexture.vid] = mapTexture
    textureMap[normalTexture.vid] = normalTexture
    textureMap[roughnessTexture.vid] = roughnessTexture
    textureMap[metalnessTexture.vid] = metalnessTexture

    const materialMap = {}
    const meshStandardMaterial = Vis.generateConfig('MeshStandardMaterial', {
      vid: getUUid(),
      color: 'rgb(255, 255, 255)',
      map: mapTexture.vid,
      normalMap: normalTexture.vid,
      roughnessMap: roughnessTexture.vid,
      metalnessMap: metalnessTexture.vid
    })
    materialMap[meshStandardMaterial.vid] = meshStandardMaterial

    const textureDataSupport = new Vis.TextureDataSupport(textureMap)
    const materialDataSupport = new Vis.MaterialDataSupport(materialMap)
    const lightDataSupport = new Vis.LightDataSupport(lightConfig)
    const geometryDataSupport = new Vis.GeometryDataSupport({})
    const modelDataSupport = new Vis.ModelDataSupport({})


    


    const geometryData = geometryDataSupport.getData()
    const modelData = modelDataSupport.getData()
    
    let x = -10
    let config = {}
    resourceManager.addEventListener(Vis.ResourceManagerEventType.MAPPED, e => {
      e.configMappingMap.forEach((config, url) => {
        if (config.children) {
          config.children.forEach(mesh => {
            config = Vis.generateConfig('LoadGeometry', {
              vid: getUUid(),
              url: mesh.geometry
            })
            geometryData[config.vid] = config
            
            config = Vis.generateConfig('Model', {
              vid: getUUid(),
              geometry: config.vid,
              material: meshStandardMaterial.vid,
              position: {
                x
              },
              scale: {
                x: 20,
                y: 20,
                z: 20
              }
            })
            x += 5
            modelData[config.vid] = config
          })
        }
      })

      const engine = new Vis.ModelingEngineSupport({
        dom: document.getElementById('app'),
        textureDataSupport ,
        materialDataSupport,
        lightDataSupport,
        modelDataSupport,
        geometryDataSupport,
        resourceManager
      })
      engine.render()
    })


  </script>
</body>
</html>