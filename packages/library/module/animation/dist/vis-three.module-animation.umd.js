(function(n,i){typeof exports=="object"&&typeof module!="undefined"?i(exports,require("@vis-three/middleware")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware"],i):(n=typeof globalThis!="undefined"?globalThis:n||self,i((n["vis-three"]=n["vis-three"]||{},n["vis-three"]["module-animation"]={}),n.middleware))})(this,function(n,i){"use strict";var S=Object.defineProperty;var A=(n,i,u)=>i in n?S(n,i,{enumerable:!0,configurable:!0,writable:!0,value:u}):n[i]=u;var d=(n,i,u)=>(A(n,typeof i!="symbol"?i+"":i,u),u);class u extends i.Compiler{constructor(){super();d(this,"scriptAniSymbol","vis.scriptAni")}restoreAttribute(e){if(!e.target||!e.attribute)return this;let r=this.engine.getObjectBySymbol(e.target),s=this.engine.getConfigBySymbol(e.target);(!r||!s)&&console.warn("AnimationCompiler: can not found object target or config in engine",e.vid);const a=e.attribute.split(".");a.shift();const c=a.pop();for(const m of a)if(r[m]&&s[m])r=r[m],s=s[m];else return console.warn("AnimationCompiler: object and config attribute are not sync"),this;return r[c]=s[c],this}cover(e){super.cover(e);const r=this.map.get(e.vid);return e[Symbol.for(this.scriptAniSymbol)]=r,this}remove(e){return this.engine.removeEventListener("render",e[Symbol.for(this.scriptAniSymbol)]),this.restoreAttribute(e),delete e[Symbol.for(this.scriptAniSymbol)],super.remove(e),this}compile(e,r){const s=this.target[e];this.restoreAttribute(s),super.compile(e,r);const a=this.map.get(e),c=s[Symbol.for(this.scriptAniSymbol)];return this.map.set(s.vid,c),this.weakMap.delete(a),this.weakMap.set(c,e),this}}const b=function(t,o){t.key==="name"&&t.path.length===1||i.Rule(t,o)},p=function(){return Object.assign(i.getSymbolConfig(),{name:"",target:"",attribute:"",play:!0})},l=function(){return Object.assign(p(),{script:{name:""}})},y=function(){return Object.assign(p(),{script:{name:""}})},f=function(t,o){let e=o.compilerManager.getObjectBySymbol(t.target);if(!e)return console.warn(`can not found object in enigne: ${t.target}`),()=>{};const r=t.attribute.split(".");r.shift();const s=r.pop();for(const a of r){if(e[a]===void 0)return console.warn(`animaton processor: target object can not found key: ${a}`,e),()=>{};e=e[a]}return i.AniScriptGeneratorManager.generateScript(o,e,s,t.script)};var h=i.defineProcessor({type:"ScriptAnimation",config:l,commands:{set:{play({target:t,engine:o,value:e}){e?o.renderManager.addEventListener("render",t):o.renderManager.removeEventListener("render",t)},$reg:[{reg:new RegExp(".*"),handler({config:t,engine:o,compiler:e}){const r=t[Symbol.for(e.scriptAniSymbol)];o.renderManager.removeEventListener("render",r);const s=f(t,o);t[Symbol.for(e.scriptAniSymbol)]=s,t.play&&o.renderManager.addEventListener("render",r)}}]}},create(t,o,e){const r=f(t,o);return t.play&&o.renderManager.addEventListener("render",r),t[Symbol.for(e.scriptAniSymbol)]=r,r},dispose(){}}),g={type:"animation",compiler:u,rule:b,processors:[h],lifeOrder:i.SUPPORT_LIFE_CYCLE.NINE};n.AnimationCompiler=u,n.default=g,n.getKeyframeAnimationConfig=y,n.getScriptAnimationConfig=l,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
