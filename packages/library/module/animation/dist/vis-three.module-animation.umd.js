(function(r,o){typeof exports=="object"&&typeof module!="undefined"?o(exports,require("@vis-three/middleware"),require("three")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","three"],o):(r=typeof globalThis!="undefined"?globalThis:r||self,o((r["vis-three"]=r["vis-three"]||{},r["vis-three"]["module-animation"]={}),r.middleware,r.three))})(this,function(r,o,m){"use strict";var j=Object.defineProperty;var C=(r,o,m)=>o in r?j(r,o,{enumerable:!0,configurable:!0,writable:!0,value:m}):r[o]=m;var h=(r,o,m)=>(C(r,typeof o!="symbol"?o+"":o,m),m);class l extends o.Compiler{constructor(){super();h(this,"scriptAniSymbol","vis.scriptAni")}playAnimation(t){this.engine.renderManager.addEventListener("render",t)}stopAnimation(t){this.engine.renderManager.removeEventListener("render",t)}restoreAttribute(t){if(!t.target||!t.attribute)return this;let n=this.engine.getObjectBySymbol(t.target),i=this.engine.getConfigBySymbol(t.target);(!n||!i)&&console.warn("AnimationCompiler: can not found object target or config in engine",t.vid);const s=t.attribute.split(".");s.shift();const c=s.pop();for(const p of s)if(n[p]&&i[p])n=n[p],i=i[p];else return console.warn("AnimationCompiler: object and config attribute are not sync"),this;return n[c]=i[c],this}cover(t){if(super.cover(t),t.type==="ScriptAnimation"){const n=this.map.get(t.vid);t[Symbol.for(this.scriptAniSymbol)]=n}return this}remove(t){return t.type==="ScriptAnimation"&&(this.engine.removeEventListener("render",t[Symbol.for(this.scriptAniSymbol)]),this.restoreAttribute(t),delete t[Symbol.for(this.scriptAniSymbol)]),super.remove(t),this}compile(t,n){const i=this.target[t];if(i.type==="ScriptAnimation"){this.restoreAttribute(i),super.compile(t,n);const s=this.map.get(t),c=i[Symbol.for(this.scriptAniSymbol)];return this.map.set(i.vid,c),this.weakMap.delete(s),this.weakMap.set(c,t),this}return super.compile(t,n),this}}const d=function(e,a){e.key==="name"&&e.path.length===1||o.Rule(e,a)},y=function(){return Object.assign(o.getSymbolConfig(),{play:!0})},f=function(){return Object.assign(y(),{target:"",time:0,timeScale:1})},b=function(){return Object.assign(y(),{target:"",script:{name:""},attribute:""})},A=function(e,a){let t=a.compilerManager.getObjectBySymbol(e.target);if(!t)return console.warn(`can not found object in enigne: ${e.target}`),()=>{};const n=e.attribute.split(".");n.shift();const i=n.pop();for(const s of n){if(t[s]===void 0)return console.warn(`animaton processor: target object can not found key: ${s}`,t),()=>{};t=t[s]}return o.AniScriptGeneratorManager.generateScript(a,t,i,e.script)};var S=o.defineProcessor({type:"ScriptAnimation",config:b,commands:{set:{play({target:e,compiler:a,value:t}){t?a.playAnimation(e):a.stopAnimation(e)},$reg:[{reg:new RegExp(".*"),handler({config:e,engine:a,compiler:t}){const n=e[Symbol.for(t.scriptAniSymbol)];t.stopAnimation(n);const i=A(e,a);e[Symbol.for(t.scriptAniSymbol)]=i,e.play&&t.playAnimation(n)}}]}},create(e,a,t){const n=A(e,a);return e.play&&t.playAnimation(n),e[Symbol.for(t.scriptAniSymbol)]=n,n},dispose(e,a,t){t.stopAnimation(e)}});const u=new WeakMap;var g=o.defineProcessor({type:"MixerAnimation",config:f,create(e,a,t){let n;Array.isArray(e.target)?(n=new m.AnimationObjectGroup,e.target.forEach(s=>{const c=a.getObjectBySymbol(s);c?n.add(c):console.warn(`mixer animation processor can not found vid in engine: ${s}`)})):(n=a.getObjectBySymbol(e.target),n||(console.warn(`mixer animation processor can not found vid in engine: ${e.target}`),n=new m.Object3D));const i=new m.AnimationMixer(n);if(i.time=e.time,i.timeScale=e.timeScale,e.play){const s=c=>{i.update(c.delta)};t.playAnimation(s),u.set(i,s)}return i},dispose(e,a,t){const n=u.get(e);n&&(t.stopAnimation(n),u.delete(e)),e.uncacheRoot(e.getRoot()),e._actions.forEach(i=>{const s=i.getClip();e.uncacheClip(s),e.uncacheAction(s)})}}),v={type:"animation",compiler:l,rule:d,processors:[S,g],lifeOrder:o.SUPPORT_LIFE_CYCLE.NINE};r.AnimationCompiler=l,r.default=v,r.getMixerAnimationConfig=f,r.getScriptAnimationConfig=b,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
