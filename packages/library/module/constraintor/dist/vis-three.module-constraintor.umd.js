(function(o,i){typeof exports=="object"&&typeof module!="undefined"?module.exports=i(require("@vis-three/middleware"),require("uuid"),require("@vis-three/library-constraintor")):typeof define=="function"&&define.amd?define(["@vis-three/middleware","uuid","@vis-three/library-constraintor"],i):(o=typeof globalThis!="undefined"?globalThis:o||self,o["vis-three"]=o["vis-three"]||{},o["vis-three"]["module-constraintor"]=i(o.middleware,o.uuid,o.libraryConstraintor))})(this,function(o,i,u){"use strict";class B extends o.Compiler{constructor(){super()}}const g=function(t,e,r=i.validate){o.Rule(t,e,r)},y=function(){return Object.assign(o.getSymbolConfig(),{target:""})},m=function(){return Object.assign(y(),{target:"",targetAttr:"",ref:"",refAttr:"",offset:null})},l=function(){return Object.assign(y(),{targetAttr:"",ref:"",space:"world",offset:{position:{direction:"+",axes:"y"},operate:"+",value:0}})},E={reg:new RegExp(".*"),handler(t){t.processor.set(t),t.target.constrain()}},c=new WeakMap,f=function(t,e,r){t.constrain();const n=r.getObjectBySymbol(e.ref);if(n){const s=()=>{t.constrain()};c.set(t,{object:e.ref,attr:e.refAttr,event:s}),o.Bus.compilerEvent.on(n,`${o.COMPILER_EVENT.COMPILE}:${e.refAttr}`,s)}},a=function(t,e){const r=c.get(t);!r||(o.Bus.compilerEvent.off(e.getObjectBySymbol(r.object),`${o.COMPILER_EVENT.COMPILE}:${r.attr}`,r.event),c.delete(t))};var A=o.defineProcessor({type:"NumberConstraintor",config:m,commands:{set:{target({target:t,config:e,engine:r}){e.target&&e.targetAttr&&(t.setTarget(r.getConfigBySymbol(e.target),e.targetAttr),t.constrain())},targetAttr({target:t,config:e,engine:r}){e.target&&e.targetAttr&&(t.setTarget(r.getConfigBySymbol(e.target),e.targetAttr),t.constrain())},ref({target:t,config:e,engine:r}){e.ref&&e.refAttr&&(a(t,r),t.setReference(r.getConfigBySymbol(e.ref),e.refAttr),f(t,e,r))},refAttr({target:t,config:e,engine:r}){e.ref&&e.refAttr&&(a(t,r),t.setReference(r.getConfigBySymbol(e.ref),e.refAttr),f(t,e,r))},$reg:[E]}},create(t,e){const r=new u.NumberConstraintor(e.getConfigBySymbol(t.target),t.targetAttr,e.getConfigBySymbol(t.ref),t.refAttr,t.offset?{...t.offset}:null);return f(r,t,e),r},dispose(t,e){a(t,e)}});const C=new WeakMap,p=["geometry","position.x","position.y","position.z","rotation.x","rotation.y","rotation.z","scale.x","scale.y","scale.z"],b=function(t,e){const r=()=>{t.constrain()};C.set(t,r),p.forEach(n=>{o.Bus.compilerEvent.on(e,`${o.COMPILER_EVENT.COMPILE}${n}`,r)}),e.geometry&&o.Bus.compilerEvent.on(e.geometry,o.COMPILER_EVENT.UPDATE,r)},v=function(t){const e=t.reference,r=C.get(t);r&&(p.forEach(n=>{o.Bus.compilerEvent.off(e,`${o.COMPILER_EVENT.COMPILE}${n}`,r)}),e.geometry&&o.Bus.compilerEvent.off(e.geometry,o.COMPILER_EVENT.UPDATE,r))};var O=o.defineProcessor({type:"BoundingBoxConstraintor",config:l,commands:{set:{target({target:t,config:e,engine:r}){e.target&&e.targetAttr&&(t.setTarget(r.getConfigBySymbol(e.target),e.targetAttr),t.constrain())},targetAttr({target:t,config:e,engine:r}){e.target&&e.targetAttr&&(t.setTarget(r.getConfigBySymbol(e.target),e.targetAttr),t.constrain())},ref({target:t,config:e,engine:r,value:n}){if(v(t),!n)return;const s=r.getObjectBySymbol(e.ref);if(!s){console.warn(`BoundingBox constraintor processor: can not found object: ${e.ref}`);return}t.setReference(s),t.constrain(),b(t,s)},$reg:[E]}},create(t,e){const r=e.getObjectBySymbol(t.ref),n=new u.BoundingBoxConstraintor(e.getConfigBySymbol(t.target),t.targetAttr,t.space,r,o.JSONHandler.clone(t.offset));return r&&(n.constrain(),b(n,r)),n},dispose(t){v(t)}}),P={type:"constraintor",compiler:B,rule:g,processors:[A,O],lifeOrder:o.SUPPORT_LIFE_CYCLE.NINE};return P});
