(function(s,t){typeof exports=="object"&&typeof module!="undefined"?module.exports=t(require("@vis-three/middleware"),require("@vis-three/module-object"),require("three"),require("three/examples/jsm/renderers/CSS2DRenderer")):typeof define=="function"&&define.amd?define(["@vis-three/middleware","@vis-three/module-object","three","three/examples/jsm/renderers/CSS2DRenderer"],t):(s=typeof globalThis!="undefined"?globalThis:s||self,s["vis-three"]=s["vis-three"]||{},s["vis-three"]["module-css2d"]=t(s.middleware,s.moduleObject,s.three,s.CSS2DRenderer))})(this,function(s,t,i,p){"use strict";var C=Object.defineProperty;var P=(s,t,i)=>t in s?C(s,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[t]=i;var n=(s,t,i)=>(P(s,typeof t!="symbol"?t+"":t,i),i);class f extends t.ObjectCompiler{constructor(){super()}}const w=function(){return Object.assign(t.getObjectConfig(),{element:"",width:50,height:50})},S=function(){return Object.assign(w(),{})};class x extends p.CSS2DObject{constructor(e=document.createElement("div")){const o=document.createElement("div"),d=50,c=50;o.style.width=`${d}px`,o.style.height=`${c}px`,o.appendChild(e);super(o);n(this,"geometry");n(this,"_width");n(this,"_height");this.geometry=new i.PlaneBufferGeometry(d,c),this.geometry.computeBoundingBox(),this._width=d,this._height=c}get width(){return this._width}set width(e){this.geometry.dispose(),this.geometry=new i.PlaneBufferGeometry(e,this._height),this.geometry.computeBoundingBox(),this.element.style.width=`${e}px`,this._width=e}get height(){return this._height}set height(e){this.geometry.dispose(),this.geometry=new i.PlaneBufferGeometry(this._width,e),this.geometry.computeBoundingBox(),this.element.style.height=`${e}px`,this._height=e}}class g extends x{constructor(e=document.createElement("div")){super(e);n(this,"cacheBox",new i.Box3);n(this,"viewWorldMatrix",new i.Matrix4);n(this,"mvPosition",new i.Vector3);n(this,"matrixScale",new i.Vector3);n(this,"worldScale",new i.Vector3);n(this,"vA",new i.Vector3);n(this,"vB",new i.Vector3);n(this,"vC",new i.Vector3);n(this,"alignedPosition",new i.Vector2);n(this,"rotatedPosition",new i.Vector2);n(this,"intersectPoint",new i.Vector3);this.type="CSS2DPlane",this.element.classList.add("vis-css2d","vis-css2d-plane"),new MutationObserver(()=>{this.matrixScale.set(Math.abs(this.width/100)*.1,Math.abs(this.height/100)*.1,1)}).observe(this.element,{attributeFilter:["style"]})}transformVertex(e,o,d){const c=this.alignedPosition,a=this.rotatedPosition,m=0,u=1;c.copy(e).multiply(d),a.x=u*c.x-m*c.y,a.y=m*c.x+u*c.y,e.copy(o),e.x+=a.x,e.y+=a.y,e.applyMatrix4(this.viewWorldMatrix)}raycast(e,o){e.camera===null&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),this.viewWorldMatrix.copy(e.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(e.camera.matrixWorldInverse,this.matrixWorld),this.mvPosition.setFromMatrixPosition(this.modelViewMatrix),this.worldScale.copy(this.matrixScale).multiplyScalar(-this.mvPosition.z),this.transformVertex(this.vA.set(-.5,-.5,0),this.mvPosition,this.worldScale),this.transformVertex(this.vB.set(.5,-.5,0),this.mvPosition,this.worldScale),this.transformVertex(this.vC.set(.5,.5,0),this.mvPosition,this.worldScale);let d=e.ray.intersectTriangle(this.vA,this.vB,this.vC,!1,this.intersectPoint);if(d===null&&(this.transformVertex(this.vB.set(-.5,.5,0),this.mvPosition,this.worldScale),d=e.ray.intersectTriangle(this.vA,this.vC,this.vB,!1,this.intersectPoint),d===null))return;const c=e.ray.origin.distanceTo(this.intersectPoint);c<e.near||c>e.far||o.push({distance:c,point:this.intersectPoint.clone(),face:null,object:this})}}const l=function(r,h){const e=h.resourceManager.resourceMap;if(!e.has(r))return console.warn(`css2D compiler: can not found resource element: ${r}`),document.createElement("div");const o=e.get(r);return o instanceof HTMLElement?o:(console.warn("css2D compiler can not suport render this resource type.",o.constructor,r),document.createElement("div"))};var v=s.defineProcessor({type:"CSS2DPlane",config:S,commands:{add:t.objectCommands.add,set:{element({target:r,value:h,engine:e}){r.element.innerHTML="",r.element.appendChild(l(h,e))},...t.objectCommands.set},delete:t.objectCommands.delete},create(r,h){return t.objectCreate(new g(l(r.element,h)),r,{element:!0},h)},dispose:t.objectDispose}),y={type:"css2D",object:!0,compiler:f,rule:function(r,h){t.ObjectRule(r,h)},processors:[v],lifeOrder:s.SUPPORT_LIFE_CYCLE.THREE};return y});
