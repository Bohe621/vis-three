(function(i,a){typeof exports=="object"&&typeof module!="undefined"?a(exports,require("@vis-three/middleware"),require("three"),require("three/examples/jsm/geometries/DecalGeometry")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","three","three/examples/jsm/geometries/DecalGeometry"],a):(i=typeof globalThis!="undefined"?globalThis:i||self,a((i["vis-three"]=i["vis-three"]||{},i["vis-three"]["module-geometry"]={}),i.middleware,i.three,i.DecalGeometry))})(this,function(i,a,n,Y){"use strict";var Xe=Object.defineProperty;var Ze=(i,a,n)=>a in i?Xe(i,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):i[a]=n;var S=(i,a,n)=>(Ze(i,typeof a!="symbol"?a+"":a,n),n);const W=function(e,t){t.center&&e.center(),e.computeBoundingBox();const r=e.boundingBox,s=t.position,o=t.rotation,u=t.scale,m=new n.Quaternion().setFromEuler(new n.Euler(o.x,o.y,o.z,"XYZ"));return e.applyQuaternion(m),e.scale(u.x,u.y,u.z),t.center&&e.center(),e.computeBoundingBox(),e.translate((r.max.x-r.min.x)/2*s.x,(r.max.y-r.min.y)/2*s.y,(r.max.z-r.min.z)/2*s.z),e},E={reg:new RegExp(".*"),handler({config:e,target:t,processor:r,engine:s,compiler:o}){const u=r.create(e,s,o);t.copy(u),t.uuid=u.uuid,r.dispose(u,s,o)}},y={add:{groups({target:e,value:t}){e.addGroup(t.start,t.count,t.materialIndex)},$reg:[E]},set:{groups(e){const{path:t,target:r,config:s}=e;if(t[1]!==void 0){r.groups.splice(Number(e.path[1]),1);const o=s.groups[t[1]];r.addGroup(o.start,o.count,o.materialIndex)}else console.warn("geometry processor can not set group",e)},$reg:[E]},delete:{groups({target:e,key:t}){e.groups.splice(Number(t),1)},$reg:[E]}},p=function(e,t){e.clearGroups();for(const r of t.groups)e.addGroup(r.start,r.count,r.materialIndex);return W(e,t)},g=function(e){e.dispose()},h=function(){return Object.assign(a.getSymbolConfig(),{center:!0,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},groups:[]})},k=function(){return Object.assign(h(),{width:5,height:5,depth:5,widthSegments:1,heightSegments:1,depthSegments:1})},H=function(){return Object.assign(h(),{radius:3,widthSegments:32,heightSegments:32,phiStart:0,phiLength:Math.PI*2,thetaStart:0,thetaLength:Math.PI})},q=function(){return Object.assign(h(),{width:5,height:5,widthSegments:1,heightSegments:1})},X=function(){return Object.assign(h(),{radius:3,segments:8,thetaStart:0,thetaLength:Math.PI*2})},Z=function(){return Object.assign(h(),{radius:3,height:5,radialSegments:8,heightSegments:1,openEnded:!1,thetaStart:0,thetaLength:Math.PI*2})},J=function(){return Object.assign(h(),{radius:3,tube:.4,radialSegments:8,tubularSegments:6,arc:Math.PI*2})},K=function(){return Object.assign(h(),{innerRadius:2,outerRadius:3,thetaSegments:8,phiSegments:8,thetaStart:0,thetaLength:Math.PI*2})},ee=function(){return Object.assign(h(),{url:""})},te=function(){return Object.assign(h(),{attribute:{position:[],color:[],index:[],normal:[],uv:[],uv2:[]}})},re=function(){return Object.assign(h(),{radiusTop:3,radiusBottom:3,height:5,radialSegments:8,heightSegments:1,openEnded:!1,thetaStart:0,thetaLength:Math.PI*2})},ne=function(){return Object.assign(h(),{target:"",thresholdAngle:1})},d=function(){return Object.assign(h(),{center:!1,path:[],divisions:36,space:!0})},oe=function(){return Object.assign(d(),{center:!1})},se=function(){return Object.assign(d(),{center:!1})},ae=function(){return Object.assign(d(),{center:!1})},ue=function(){return Object.assign(d(),{center:!1})},T=function(){return Object.assign(h(),{center:!1,path:[],tubularSegments:64,radius:1,radialSegments:8,closed:!1})},ce=function(){return Object.assign(T(),{center:!1})},ie=function(){return Object.assign(T(),{center:!1})},me=function(){return Object.assign(h(),{center:!1,shape:"",curveSegments:12})},ye=function(){return Object.assign(h(),{center:!1,path:[],curveSegments:12})},pe=function(){return Object.assign(h(),{center:!1,shapes:"",options:{curveSegments:12,steps:1,depth:1,bevelEnabled:!0,bevelThickness:.2,bevelSize:.1,bevelOffset:0,bevelSegments:3,extrudePath:"",UVGenerator:"default"}})},le=function(){return Object.assign(h(),{center:!1,path:"",space:!1,divisions:36})},ge=function(){return Object.assign(h(),{path:"",divisions:32,segments:12,phiStart:0,phiLength:Math.PI*2})},he=function(){return Object.assign(h(),{center:!1,target:{geometry:"",position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:0,y:0,z:0}},point:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0},size:{x:0,y:0,z:0}})};var Ge=a.defineProcessor({type:"BoxGeometry",config:k,commands:y,create:e=>p(new n.BoxBufferGeometry(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments),e),dispose:g}),fe=a.defineProcessor({type:"CircleGeometry",config:X,commands:y,create:e=>p(new n.CircleBufferGeometry(e.radius,e.segments,e.thetaStart,e.thetaLength),e),dispose:g}),Pe=a.defineProcessor({type:"ConeGeometry",config:Z,commands:y,create:e=>p(new n.ConeBufferGeometry(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength),e),dispose:g});const l=function(e){return e>1?1:e<0?0:e};var O={default:void 0,cover:{generateTopUV(e,t,r,s,o){const u=t[r*3],m=t[r*3+1],c=t[s*3],G=t[s*3+1],v=t[o*3],C=t[o*3+1];return[new n.Vector2(l(u),l(m)),new n.Vector2(l(c),l(G)),new n.Vector2(l(v),l(C))]},generateSideWallUV(e,t,r,s,o,u){const m=t[r*3],c=t[r*3+1],G=t[r*3+2],v=t[s*3],C=t[s*3+1],N=t[s*3+2],We=t[o*3],ke=t[o*3+1],Q=t[o*3+2],He=t[u*3],qe=t[u*3+1],$=t[u*3+2];return Math.abs(c-C)<Math.abs(m-v)?[new n.Vector2(l(m),l(1-G)),new n.Vector2(l(v),l(1-N)),new n.Vector2(l(We),l(1-Q)),new n.Vector2(l(He),l(1-$))]:[new n.Vector2(l(c),l(1-G)),new n.Vector2(l(C),l(1-N)),new n.Vector2(l(ke),l(1-Q)),new n.Vector2(l(qe),l(1-$))]}}};class M extends n.BufferGeometry{constructor(r){super();S(this,"type","LoadBufferGeometry");r&&this.copy(r)}}class f extends n.BufferGeometry{constructor(r=[],s=36,o=!0){super();S(this,"parameters");this.type="CurveGeometry",this.parameters={path:r.map(u=>u.clone()),space:o,divisions:s}}}class z extends f{constructor(t=[],r=36,s=!0){super(t,r,s),this.type="CubicBezierCurveGeometry";const o=new n.CurvePath;if(t.length<4){console.warn("CubicBezierCurveGeometry path length at least 4.");return}const u=4+(t.length-4)-(t.length-4)%3;for(let c=2;c<u;c+=3)o.add(new n.CubicBezierCurve3(t[c-2],t[c-1],t[c],t[c+1]));const m=o.curves.reduce((c,G)=>c+=G.arcLengthDivisions,0);if(r>m){const c=Math.ceil((r-m)/o.curves.length);o.curves.forEach(G=>{G.arcLengthDivisions=G.arcLengthDivisions*(c+1),G.updateArcLengths()})}this.setFromPoints(s?o.getSpacedPoints(r):o.getPoints(r))}}class w extends f{constructor(t=[],r=36,s=!0){if(super(t,r,s),this.type="LineCurveGeometry",!t.length){console.warn("LineCurveGeometry path length at least 1.");return}const o=new n.CurvePath;for(let m=1;m<t.length;m+=1)o.add(new n.LineCurve3(t[m-1],t[m]));const u=o.curves.reduce((m,c)=>m+=c.arcLengthDivisions,0);if(r>u){const m=Math.ceil((r-u)/o.curves.length);o.curves.forEach(c=>{c.arcLengthDivisions=c.arcLengthDivisions*(m+1),c.updateArcLengths()})}this.setFromPoints(s?o.getSpacedPoints(r):o.getPoints(r))}}class j extends f{constructor(t=[],r=36,s=!0){super(t,r,s),this.type="QuadraticBezierCurveGeometry";const o=new n.CurvePath;if(t.length<3){console.warn("QuadraticBezierCurveGeometry path length at least 3.");return}const u=3+(t.length-3)-(t.length-3)%2;for(let c=1;c<u;c+=2)o.add(new n.QuadraticBezierCurve3(t[c-1],t[c],t[c+1]));const m=o.curves.reduce((c,G)=>c+=G.arcLengthDivisions,0);if(r>m){const c=Math.ceil((r-m)/o.curves.length);o.curves.forEach(G=>{G.arcLengthDivisions=G.arcLengthDivisions*(c+1),G.updateArcLengths()})}this.setFromPoints(s?o.getSpacedPoints(r):o.getPoints(r))}}class V extends f{constructor(t=[],r=36,s=!0){if(super(t,r,s),this.type="SplineCurveGeometry",!t.length){console.warn("SplineCurveGeometry path length at least 1.");return}const o=new n.CatmullRomCurve3(t);this.setFromPoints(s?o.getSpacedPoints(r):o.getPoints(r))}}class D extends n.ShapeBufferGeometry{constructor(t=[new n.Vector2(0,0)],r=12){const s=new n.Shape,o=t[0];if(o){s.moveTo(o.x,o.y);for(let u=1;u<t.length;u+=1)s.lineTo(t[u].x,t[u].y)}super(s,r),this.type="LineShapeGeometry"}}class _ extends n.TubeGeometry{constructor(t=[],r=64,s=1,o=8,u=!1){if(!t.length){console.warn("LineTubeGeometry path length at least 1.");return}const m=new n.CurvePath;for(let c=1;c<t.length;c+=1)m.add(new n.LineCurve3(t[c-1],t[c]));super(m,r,s,o,u),this.type="LineTubeGeometry"}}class A extends n.TubeGeometry{constructor(t=[],r=64,s=1,o=8,u=!1){if(!t.length){console.warn("SplineTubeGeometry path length at least 1.");return}const m=new n.CatmullRomCurve3(t);super(m,r,s,o,u),this.type="SplineTubeGeometry"}}class F extends n.BufferGeometry{constructor(r=new n.Path,s=36,o=!0){super();S(this,"parameters");this.type="PathGeometry",this.parameters={path:r,space:o,divisions:s},r.curves.length&&this.setFromPoints(o?r.getSpacedPoints(s):r.getPoints(s))}}var de=a.defineProcessor({type:"CubicBezierCurveGeometry",config:ae,commands:y,create:e=>p(new z(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.divisions,e.space),e),dispose:g});const ve=function(e){const t=new n.BufferGeometry;return e.position.length&&t.setAttribute("position",new n.Float32BufferAttribute(e.position,3)),e.color.length&&t.setAttribute("color",new n.Float32BufferAttribute(e.color,3)),e.normal.length&&t.setAttribute("normal",new n.Float32BufferAttribute(e.normal,3)),e.uv.length&&t.setAttribute("uv",new n.Float32BufferAttribute(e.uv,2)),e.uv2.length&&t.setAttribute("uv2",new n.Float32BufferAttribute(e.uv2,2)),e.index.length&&t.setIndex(e.index),t};var Ce=a.defineProcessor({type:"CustomGeometry",config:te,commands:y,create(e){return p(ve(e.attribute),e)},dispose(e){e.dispose()}}),Se=a.defineProcessor({type:"CylinderGeometry",config:re,commands:y,create:e=>p(new n.CylinderBufferGeometry(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength),e),dispose:g});const Ee=new n.EdgesGeometry(new n.BoxBufferGeometry(5,5,5));var be=a.defineProcessor({type:"EdgesGeometry",config:ne,commands:y,create(e,t){const r=t.compilerManager.getObjectfromModule(a.MODULETYPE.GEOMETRY,e.target);return!r||!(r instanceof n.BufferGeometry)?(console.error(`engine rescoure can not found url: ${e.target}`),Ee):p(new n.EdgesGeometry(r,e.thresholdAngle),e)},dispose(e){e.dispose()}});class R extends a.Compiler{constructor(){super()}}const Le=function(e,t){a.Rule(e,t)};var Be=a.defineProcessor({type:"LineCurveGeometry",config:oe,commands:y,create:e=>p(new w(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.divisions,e.space),e),dispose:g}),xe=a.defineProcessor({type:"LineShapeGeometry",config:ye,commands:y,create:e=>p(new D(e.path.map(t=>new n.Vector2(t.x,t.y)),e.curveSegments),e),dispose:g}),Te=a.defineProcessor({type:"LineTubeGeometry",config:ce,commands:y,create:e=>p(new _(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.tubularSegments,e.radius,e.radialSegments,e.closed),e),dispose:g}),Oe=a.defineProcessor({type:"LoadGeometry",config:ee,commands:y,create(e,t){const r=t.resourceManager.resourceMap.get(e.url);return!r&&!(r instanceof n.BufferGeometry)?(console.error(`engine rescoure can not found url: ${e.url}`),new n.BoxBufferGeometry(5,5,5)):p(new M(r),e)},dispose(e){e.dispose()}}),Me=a.defineProcessor({type:"PlaneGeometry",config:q,commands:y,create:e=>p(new n.PlaneBufferGeometry(e.width,e.height,e.widthSegments,e.heightSegments),e),dispose:g}),ze=a.defineProcessor({type:"QuadraticBezierCurveGeometry",config:ue,commands:y,create:e=>p(new j(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.divisions,e.space),e),dispose:g}),we=a.defineProcessor({type:"RingGeometry",config:K,commands:y,create:e=>p(new n.RingBufferGeometry(e.innerRadius,e.outerRadius,e.thetaSegments,e.phiSegments,e.thetaStart,e.thetaLength),e),dispose:g}),je=a.defineProcessor({type:"SphereGeometry",config:H,commands:y,create:e=>p(new n.SphereBufferGeometry(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength),e),dispose:g}),Ve=a.defineProcessor({type:"SplineCurveGeometry",config:se,commands:y,create:e=>p(new V(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.divisions,e.space),e),dispose:g}),De=a.defineProcessor({type:"SplineTubeGeometry",config:ie,commands:y,create:e=>p(new A(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.tubularSegments,e.radius,e.radialSegments,e.closed),e),dispose:g}),_e=a.defineProcessor({type:"TorusGeometry",config:J,commands:y,create:e=>p(new n.TorusGeometry(e.radius,e.tube,e.radialSegments,e.tubularSegments,e.arc),e),dispose:g});const P=new WeakMap,U=function(e,t,r){P.has(e)||P.set(e,new Set),P.get(e).add({target:t,eventFun:r})};var Ae=a.defineProcessor({type:"ExtrudeGeometry",config:pe,commands:y,create(e,t){const r=t.compilerManager.getObjectfromModule(a.MODULETYPE.SHAPE,e.shapes)||void 0,s=t.compilerManager.getObjectfromModule(a.MODULETYPE.PATH,e.options.extrudePath)||void 0,o=new n.ExtrudeBufferGeometry(r,Object.assign({},e.options,{extrudePath:s,UVGenerator:O[e.options.UVGenerator||"default"]}));if(r){const u=()=>{e.shapes=e.shapes};a.Bus.compilerEvent.on(r,a.COMPILER_EVENT.UPDATE,u),U(o,r,u)}if(s){const u=()=>{e.options.extrudePath=e.options.extrudePath};a.Bus.compilerEvent.on(s,a.COMPILER_EVENT.UPDATE,u),U(o,s,u)}return p(o,e)},dispose(e,t,r){const s=P.get(e);s&&s.forEach(o=>{a.Bus.compilerEvent.off(o.target,a.COMPILER_EVENT.UPDATE,o.eventFun)}),P.delete(e),g(e)}});const b=new WeakMap,Fe=function(e,t,r){b.set(e,{target:t,eventFun:r})};var Re=a.defineProcessor({type:"PathGeometry",config:le,commands:y,create(e,t){const r=t.compilerManager.getObjectfromModule(a.MODULETYPE.PATH,e.path)||void 0,s=new F(r,e.divisions,e.space);if(r){const o=()=>{e.path=e.path};a.Bus.compilerEvent.on(r,a.COMPILER_EVENT.UPDATE,o),Fe(s,r,o)}return p(s,e)},dispose(e,t,r){const s=b.get(e);s&&a.Bus.compilerEvent.off(s.target,a.COMPILER_EVENT.UPDATE,s.eventFun),b.delete(e),g(e)}});const L=new WeakMap,Ue=function(e,t,r){L.set(e,{target:t,eventFun:r})};var Ie=a.defineProcessor({type:"ShapeGeometry",config:me,commands:y,create(e,t){const r=t.compilerManager.getObjectfromModule(a.MODULETYPE.SHAPE,e.shape)||void 0,s=new n.ShapeBufferGeometry(r,e.curveSegments);if(r){const o=()=>{e.shape=e.shape};a.Bus.compilerEvent.on(r,a.COMPILER_EVENT.UPDATE,o),Ue(s,r,o)}return p(s,e)},dispose(e,t,r){const s=L.get(e);s&&a.Bus.compilerEvent.off(s.target,a.COMPILER_EVENT.UPDATE,s.eventFun),L.delete(e),g(e)}});const B=new WeakMap,Ne=function(e,t,r){B.set(e,{target:t,eventFun:r})};var Qe=a.defineProcessor({type:"LatheGeometry",config:ge,commands:y,create(e,t){const r=t.compilerManager.getObjectfromModule(a.MODULETYPE.PATH,e.path)||void 0,s=new n.LatheGeometry(r?r.getPoints(e.divisions):void 0,e.segments,e.phiStart,e.phiLength);if(r){const o=()=>{e.path=e.path};a.Bus.compilerEvent.on(r,a.COMPILER_EVENT.UPDATE,o),Ne(s,r,o)}return p(s,e)},dispose(e){const t=B.get(e);t&&a.Bus.compilerEvent.off(t.target,a.COMPILER_EVENT.UPDATE,t.eventFun),B.delete(e),g(e)}});const I=new n.BufferGeometry,x=new n.Mesh;var $e=a.defineProcessor({type:"DecalGeometry",config:he,commands:y,create:(e,t)=>{const r=e.target.geometry&&t.getObjectBySymbol(e.target.geometry)||I;return x.geometry=r,x.matrixWorld.compose(new n.Vector3(e.target.position.x,e.target.position.y,e.target.position.z),new n.Quaternion().setFromEuler(new n.Euler(e.target.rotation.x,e.target.rotation.y,e.target.rotation.z)),new n.Vector3(e.target.scale.x,e.target.scale.y,e.target.scale.z)),p(new Y.DecalGeometry(x,new n.Vector3(e.point.x,e.point.y,e.point.z),new n.Euler(e.orientation.x,e.orientation.y,e.orientation.z),new n.Vector3(e.size.x,e.size.y,e.size.z)),e)},dispose:g}),Ye={type:"geometry",compiler:R,rule:Le,lifeOrder:a.SUPPORT_LIFE_CYCLE.TWO,processors:[Ge,fe,Pe,de,Ce,Se,be,Be,xe,Te,Oe,Me,ze,we,je,Ve,De,_e,Ae,Re,Ie,Qe,$e]};i.CubicBezierCurveGeometry=z,i.CurveGeometry=f,i.ExtrudeUVGenerator=O,i.GeometryCompiler=R,i.LineCurveGeometry=w,i.LineShapeGeometry=D,i.LineTubeGeometry=_,i.LoadGeometry=M,i.PathGeometry=F,i.QuadraticBezierCurveGeometry=j,i.SplineCurveGeometry=V,i.SplineTubeGeometry=A,i.default=Ye,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
