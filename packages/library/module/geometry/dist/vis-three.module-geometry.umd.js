(function(u,n){typeof exports=="object"&&typeof module!="undefined"?module.exports=n(require("@vis-three/middleware"),require("three")):typeof define=="function"&&define.amd?define(["@vis-three/middleware","three"],n):(u=typeof globalThis!="undefined"?globalThis:u||self,u["vis-three"]=u["vis-three"]||{},u["vis-three"]["module-geometry"]=n(u.middleware,u.three))})(this,function(u,n){"use strict";var Te=Object.defineProperty;var Oe=(u,n,l)=>n in u?Te(u,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):u[n]=l;var P=(u,n,l)=>(Oe(u,typeof n!="symbol"?n+"":n,l),l);class l extends n.BufferGeometry{constructor(r){super();P(this,"type","LoadBufferGeometry");r&&this.copy(r)}}class G extends n.BufferGeometry{constructor(r=[],o=36,s=!0){super();P(this,"parameters");this.type="CurveGeometry",this.parameters={path:r.map(a=>a.clone()),space:s,divisions:o}}}class B extends G{constructor(t=[],r=36,o=!0){super(t,r,o),this.type="CubicBezierCurveGeometry";const s=new n.CurvePath;if(t.length<4){console.warn("CubicBezierCurveGeometry path length at least 4.");return}const a=4+(t.length-4)-(t.length-4)%3;for(let i=2;i<a;i+=3)s.add(new n.CubicBezierCurve3(t[i-2],t[i-1],t[i],t[i+1]));const p=s.curves.reduce((i,g)=>i+=g.arcLengthDivisions,0);if(r>p){const i=Math.ceil((r-p)/s.curves.length);s.curves.forEach(g=>{g.arcLengthDivisions=g.arcLengthDivisions*(i+1),g.updateArcLengths()})}this.setFromPoints(o?s.getSpacedPoints(r):s.getPoints(r))}}class L extends G{constructor(t=[],r=36,o=!0){if(super(t,r,o),this.type="LineCurveGeometry",!t.length){console.warn("LineCurveGeometry path length at least 1.");return}const s=new n.CurvePath;for(let p=1;p<t.length;p+=1)s.add(new n.LineCurve3(t[p-1],t[p]));const a=s.curves.reduce((p,i)=>p+=i.arcLengthDivisions,0);if(r>a){const p=Math.ceil((r-a)/s.curves.length);s.curves.forEach(i=>{i.arcLengthDivisions=i.arcLengthDivisions*(p+1),i.updateArcLengths()})}this.setFromPoints(o?s.getSpacedPoints(r):s.getPoints(r))}}class x extends G{constructor(t=[],r=36,o=!0){super(t,r,o),this.type="QuadraticBezierCurveGeometry";const s=new n.CurvePath;if(t.length<3){console.warn("QuadraticBezierCurveGeometry path length at least 3.");return}const a=3+(t.length-3)-(t.length-3)%2;for(let i=1;i<a;i+=2)s.add(new n.QuadraticBezierCurve3(t[i-1],t[i],t[i+1]));const p=s.curves.reduce((i,g)=>i+=g.arcLengthDivisions,0);if(r>p){const i=Math.ceil((r-p)/s.curves.length);s.curves.forEach(g=>{g.arcLengthDivisions=g.arcLengthDivisions*(i+1),g.updateArcLengths()})}this.setFromPoints(o?s.getSpacedPoints(r):s.getPoints(r))}}class T extends G{constructor(t=[],r=36,o=!0){if(super(t,r,o),this.type="SplineCurveGeometry",!t.length){console.warn("SplineCurveGeometry path length at least 1.");return}const s=new n.CatmullRomCurve3(t);this.setFromPoints(o?s.getSpacedPoints(r):s.getPoints(r))}}class O extends n.ShapeBufferGeometry{constructor(t=[new n.Vector2(0,0)],r=12){const o=new n.Shape,s=t[0];if(s){o.moveTo(s.x,s.y);for(let a=1;a<t.length;a+=1)o.lineTo(t[a].x,t[a].y)}super(o,r),this.type="LineShapeGeometry"}}class M extends n.TubeGeometry{constructor(t=[],r=64,o=1,s=8,a=!1){if(!t.length){console.warn("LineTubeGeometry path length at least 1.");return}const p=new n.CurvePath;for(let i=1;i<t.length;i+=1)p.add(new n.LineCurve3(t[i-1],t[i]));super(p,r,o,s,a),this.type="LineTubeGeometry"}}class w extends n.TubeGeometry{constructor(t=[],r=64,o=1,s=8,a=!1){if(!t.length){console.warn("SplineTubeGeometry path length at least 1.");return}const p=new n.CatmullRomCurve3(t);super(p,r,o,s,a),this.type="SplineTubeGeometry"}}const j=function(e,t){!(e instanceof G)&&!(e instanceof n.TubeGeometry)&&!(e instanceof n.ShapeGeometry)&&e.center(),e.computeBoundingBox();const r=e.boundingBox,o=t.position,s=t.rotation,a=t.scale,p=new n.Quaternion().setFromEuler(new n.Euler(s.x,s.y,s.z,"XYZ"));return e.applyQuaternion(p),e.scale(a.x,a.y,a.z),!(e instanceof G)&&!(e instanceof n.TubeGeometry)&&!(e instanceof n.ShapeGeometry)&&e.center(),e.computeBoundingBox(),e.translate((r.max.x-r.min.x)/2*o.x,(r.max.y-r.min.y)/2*o.y,(r.max.z-r.min.z)/2*o.z),e},v={reg:new RegExp(".*"),handler({config:e,target:t,processor:r,engine:o,compiler:s}){const a=r.create(e,o,s);t.copy(a),t.uuid=a.uuid,r.dispose(a,o,s)}},c={add:{groups({target:e,value:t}){e.addGroup(t.start,t.count,t.materialIndex)},$reg:[v]},set:{groups(e){const{path:t,target:r,config:o}=e;if(t[1]!==void 0){r.groups.splice(Number(e.path[1]),1);const s=o.groups[t[1]];r.addGroup(s.start,s.count,s.materialIndex)}else console.warn("geometry processor can not set group",e)},$reg:[v]},delete:{groups({target:e,key:t}){e.groups.splice(Number(t),1)},$reg:[v]}},m=function(e,t){e.clearGroups();for(const r of t.groups)e.addGroup(r.start,r.count,r.materialIndex);return j(e,t)},h=function(e){e.dispose()},y=function(){return{vid:"",type:"Geometry",position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},groups:[]}},z=function(){return Object.assign(y(),{width:5,height:5,depth:5,widthSegments:1,heightSegments:1,depthSegments:1})},A=function(){return Object.assign(y(),{radius:3,widthSegments:32,heightSegments:32,phiStart:0,phiLength:Math.PI*2,thetaStart:0,thetaLength:Math.PI})},D=function(){return Object.assign(y(),{width:5,height:5,widthSegments:1,heightSegments:1})},F=function(){return Object.assign(y(),{radius:3,segments:8,thetaStart:0,thetaLength:Math.PI*2})},R=function(){return Object.assign(y(),{radius:3,height:5,radialSegments:8,heightSegments:1,openEnded:!1,thetaStart:0,thetaLength:Math.PI*2})},I=function(){return Object.assign(y(),{radius:3,tube:.4,radialSegments:8,tubularSegments:6,arc:Math.PI*2})},V=function(){return Object.assign(y(),{innerRadius:2,outerRadius:3,thetaSegments:8,phiSegments:8,thetaStart:0,thetaLength:Math.PI*2})},U=function(){return Object.assign(y(),{url:""})},N=function(){return Object.assign(y(),{attribute:{position:[],color:[],index:[],normal:[],uv:[],uv2:[]}})},Q=function(){return Object.assign(y(),{radiusTop:3,radiusBottom:3,height:5,radialSegments:8,heightSegments:1,openEnded:!1,thetaStart:0,thetaLength:Math.PI*2})},_=function(){return Object.assign(y(),{url:"",thresholdAngle:1})},d=function(){return Object.assign(y(),{path:[],divisions:36,space:!0})},$=function(){return Object.assign(d(),{})},Y=function(){return Object.assign(d(),{})},k=function(){return Object.assign(d(),{})},H=function(){return Object.assign(d(),{})},b=function(){return Object.assign(y(),{path:[],tubularSegments:64,radius:1,radialSegments:8,closed:!1})},W=function(){return Object.assign(b(),{})},q=function(){return Object.assign(b(),{})},X=function(){return Object.assign(y(),{shape:"",curveSegments:12})},Z=function(){return Object.assign(y(),{path:[],curveSegments:12})},J=function(){return Object.assign(y(),{shapes:"",options:{curveSegments:12,steps:1,depth:1,bevelEnabled:!0,bevelThickness:.2,bevelSize:.1,bevelOffset:0,bevelSegments:3,extrudePath:""}})},K=function(){return Object.assign(y(),{path:"",space:!0,divisions:36})};var ee=u.defineProcessor({type:"BoxGeometry",config:z,commands:c,create:e=>m(new n.BoxBufferGeometry(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments),e),dispose:h}),te=u.defineProcessor({type:"CircleGeometry",config:F,commands:c,create:e=>m(new n.CircleBufferGeometry(e.radius,e.segments,e.thetaStart,e.thetaLength),e),dispose:h}),re=u.defineProcessor({type:"ConeGeometry",config:R,commands:c,create:e=>m(new n.ConeBufferGeometry(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength),e),dispose:h}),ne=u.defineProcessor({type:"CubicBezierCurveGeometry",config:k,commands:c,create:e=>m(new B(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.divisions,e.space),e),dispose:h});const se=function(e){const t=new n.BufferGeometry;return e.position.length&&t.setAttribute("position",new n.Float32BufferAttribute(e.position,3)),e.color.length&&t.setAttribute("color",new n.Float32BufferAttribute(e.color,3)),e.normal.length&&t.setAttribute("normal",new n.Float32BufferAttribute(e.normal,3)),e.uv.length&&t.setAttribute("uv",new n.Float32BufferAttribute(e.uv,2)),e.uv2.length&&t.setAttribute("uv2",new n.Float32BufferAttribute(e.uv2,2)),e.index.length&&t.setIndex(e.index),t};var oe=u.defineProcessor({type:"CustomGeometry",config:N,commands:c,create(e){return m(se(e.attribute),e)},dispose(e){e.dispose()}}),ue=u.defineProcessor({type:"CylinderGeometry",config:Q,commands:c,create:e=>m(new n.CylinderBufferGeometry(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength),e),dispose:h}),ae=u.defineProcessor({type:"EdgesGeometry",config:_,commands:c,create(e,t){const r=t.compilerManager.getObjectBySymbol(e.url);return!r||!(r instanceof n.BufferGeometry)?(console.error(`engine rescoure can not found url: ${e.url}`),new n.EdgesGeometry(new n.BoxBufferGeometry(5,5,5))):m(new n.EdgesGeometry(r),e)},dispose(e){e.dispose()}});class ie extends u.Compiler{constructor(){super()}}const ce=function(e,t){u.Rule(e,t)};var me=u.defineProcessor({type:"LineCurveGeometry",config:$,commands:c,create:e=>m(new L(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.divisions,e.space),e),dispose:h}),pe=u.defineProcessor({type:"LineShapeGeometry",config:Z,commands:c,create:e=>m(new O(e.path.map(t=>new n.Vector2(t.x,t.y)),e.curveSegments),e),dispose:h}),he=u.defineProcessor({type:"LineTubeGeometry",config:W,commands:c,create:e=>m(new M(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.tubularSegments,e.radius,e.radialSegments,e.closed),e),dispose:h}),ye=u.defineProcessor({type:"LoadGeometry",config:U,commands:c,create(e,t){const r=t.resourceManager.resourceMap.get(e.url);return!r&&!(r instanceof n.BufferGeometry)?(console.error(`engine rescoure can not found url: ${e.url}`),new n.BoxBufferGeometry(5,5,5)):m(new l(r),e)},dispose(e){e.dispose()}}),ge=u.defineProcessor({type:"PlaneGeometry",config:D,commands:c,create:e=>m(new n.PlaneBufferGeometry(e.width,e.height,e.widthSegments,e.heightSegments),e),dispose:h}),le=u.defineProcessor({type:"QuadraticBezierCurveGeometry",config:H,commands:c,create:e=>m(new x(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.divisions,e.space),e),dispose:h}),Ge=u.defineProcessor({type:"RingGeometry",config:V,commands:c,create:e=>m(new n.RingBufferGeometry(e.innerRadius,e.outerRadius,e.thetaSegments,e.phiSegments,e.thetaStart,e.thetaLength),e),dispose:h}),fe=u.defineProcessor({type:"SphereGeometry",config:A,commands:c,create:e=>m(new n.SphereBufferGeometry(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength),e),dispose:h}),de=u.defineProcessor({type:"SplineCurveGeometry",config:Y,commands:c,create:e=>m(new T(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.divisions,e.space),e),dispose:h}),Pe=u.defineProcessor({type:"SplineTubeGeometry",config:q,commands:c,create:e=>m(new w(e.path.map(t=>new n.Vector3(t.x,t.y,t.z)),e.tubularSegments,e.radius,e.radialSegments,e.closed),e),dispose:h}),ve=u.defineProcessor({type:"TorusGeometry",config:I,commands:c,create:e=>m(new n.TorusGeometry(e.radius,e.tube,e.radialSegments,e.tubularSegments,e.arc),e),dispose:h});const f=new WeakMap,E=function(e,t,r){f.has(e)||f.set(e,new Set),f.get(e).add({target:t,eventFun:r})};var Ce=u.defineProcessor({type:"ExtrudeGeometry",config:J,commands:c,create(e,t){const r=t.compilerManager.getObjectfromModule(u.MODULETYPE.SHAPE,e.shapes)||void 0,o=t.compilerManager.getObjectfromModule(u.MODULETYPE.PATH,e.options.extrudePath)||void 0,s=new n.ExtrudeBufferGeometry(r,Object.assign({},e.options,{extrudePath:o}));if(r){const a=()=>{e.shapes=e.shapes};u.Bus.compilerEvent.on(r,u.COMPILER_EVENT.UPDATE,a),E(s,r,a)}if(o){const a=()=>{e.options.extrudePath=e.options.extrudePath};u.Bus.compilerEvent.on(o,u.COMPILER_EVENT.UPDATE,a),E(s,o,a)}return m(s,e)},dispose(e,t,r){const o=f.get(e);o&&o.forEach(s=>{u.Bus.compilerEvent.off(s.target,u.COMPILER_EVENT.UPDATE,s.eventFun)}),f.delete(e),h(e)}});class Se extends n.BufferGeometry{constructor(r=new n.Path,o=36,s=!0){super();P(this,"parameters");this.type="PathGeometry",this.parameters={path:r,space:s,divisions:o},r.curves.length&&this.setFromPoints(s?r.getSpacedPoints(o):r.getPoints(o))}}const C=new WeakMap,be=function(e,t,r){C.set(e,{target:t,eventFun:r})};var Ee=u.defineProcessor({type:"PathGeometry",config:K,commands:c,create(e,t){const r=t.compilerManager.getObjectfromModule(u.MODULETYPE.PATH,e.path)||void 0,o=new Se(r,e.divisions,e.space);if(r){const s=()=>{e.path=e.path};u.Bus.compilerEvent.on(r,u.COMPILER_EVENT.UPDATE,s),be(o,r,s)}return m(o,e)},dispose(e,t,r){const o=C.get(e);o&&u.Bus.compilerEvent.off(o.target,u.COMPILER_EVENT.UPDATE,o.eventFun),C.delete(e),h(e)}});const S=new WeakMap,Be=function(e,t,r){S.set(e,{target:t,eventFun:r})};var Le=u.defineProcessor({type:"ShapeGeometry",config:X,commands:c,create(e,t){const r=t.compilerManager.getObjectfromModule(u.MODULETYPE.SHAPE,e.shape)||void 0,o=new n.ShapeBufferGeometry(r,e.curveSegments);if(r){const s=()=>{e.shape=e.shape};u.Bus.compilerEvent.on(r,u.COMPILER_EVENT.UPDATE,s),Be(o,r,s)}return m(o,e)},dispose(e,t,r){const o=S.get(e);o&&u.Bus.compilerEvent.off(o.target,u.COMPILER_EVENT.UPDATE,o.eventFun),S.delete(e),h(e)}}),xe={type:"geometry",compiler:ie,rule:ce,lifeOrder:u.SUPPORT_LIFE_CYCLE.TWO,processors:[ee,te,re,ne,oe,ue,ae,me,pe,he,ye,ge,le,Ge,fe,de,Pe,ve,Ce,Ee,Le]};return xe});
