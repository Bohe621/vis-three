(function(l,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("@vis-three/tdcm"),require("@vis-three/utils")):typeof define=="function"&&define.amd?define(["exports","@vis-three/tdcm","@vis-three/utils"],i):(l=typeof globalThis<"u"?globalThis:l||self,i((l["vis-three"]=l["vis-three"]||{},l["vis-three"]["module-object"]={}),l.tdcm,l.utils))})(this,function(l,i,b){"use strict";const h=function(){return Object.assign(i.getBasicConfig(),{type:"Object3D",castShadow:!0,receiveShadow:!0,lookAt:"",visible:!0,raycast:!0,matrixAutoUpdate:!0,renderOrder:0,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},up:{x:0,y:1,z:0},parent:"",children:[],pointerdown:[],pointermove:[],pointerup:[],pointerenter:[],pointerleave:[],click:[],dblclick:[],contextmenu:[]})},M=i.defineRule([function(n){return n.key!=="parent"},i.DEFAULT_RULE.SYMBOL_VALIDATOR,i.DEFAULT_RULE.OPERATE_ADD,i.DEFAULT_RULE.OPERATE_DELETE,i.DEFAULT_RULE.OPERATE_COVER,i.DEFAULT_RULE.OPERATE_COMPILE]),y=function({model:n,target:r,config:o,value:e,engine:a}){if(o.vid===e){console.warn("can not set object lookAt itself.");return}const t=n.cacheLookAt;if(!e){if(!t.updateMatrixWorld)return;r.updateMatrixWorld=t.updateMatrixWorld,t.target=null,t.updateMatrixWorld=null;return}n.toAsync(c=>{const s=a.compilerManager.getObjectFromModules(i.OBJECT_MODULE,e);if(!s)return c&&console.warn(`lookAt handler can not found this vid mapping object: '${e}'`),!1;const p=r.updateMatrixWorld;return t.updateMatrixWorld=p,t.target=s.position,r.updateMatrixWorld=E=>{p.call(r,E),r.lookAt(t.target)},!0})},u=function({model:n,path:r,value:o,engine:e,target:a}){const t=r[0];if(!i.EventGeneratorManager.has(o.name)){console.warn(`EventGeneratorManager: can not support this event: ${o.name}`);return}const c=i.EventGeneratorManager.generateEvent(o,e),s=Symbol.for(n.eventSymbol);o[s]=c,a.addEventListener(t,c)},d=function({model:n,target:r,path:o,value:e}){const a=o[0],t=e[Symbol.for(n.eventSymbol)];if(!t){console.warn("event remove can not fun found event in config",e);return}r.removeEventListener(a,t),delete e[Symbol.for(n.eventSymbol)]},f=function({model:n,target:r,config:o,path:e,engine:a}){if(e.length<2)return;const t=e[0],c=o[e[0]][e[1]],s=c[Symbol.for(n.eventSymbol)];if(!s){console.warn("event remove can not fun found event in config",c);return}r.removeEventListener(t,s);const p=i.EventGeneratorManager.generateEvent(c,a);c[Symbol.for(n.eventSymbol)]=p,r.addEventListener(t,p)},v=function({model:n,target:r,config:o,value:e,engine:a}){n.toTrigger("object",t=>{var p;const c=n.toConfig(e);if(!c)return t||console.warn(` can not foud object config in engine: ${e}`),!1;if(c.parent&&c.parent!==o.vid){const E=n.toConfig(c.parent);if(!E)return t||console.warn(` can not foud object parent config in engine: ${c.parent}`),!1;E.children.splice(E.children.indexOf(e),1)}c.parent=o.vid;const s=a.compilerManager.getObjectFromModules(i.OBJECT_MODULE,e);return s?(r.add(s),s.updateMatrixWorld(!0),(p=n.toModel(e))==null||p.emit(`${i.MODEL_EVENT.COMPILED_ATTR}:parent`),!0):(t||console.warn(`can not found this vid in engine: ${e}.`),!1)})},O=function({model:n,target:r,config:o,value:e,engine:a}){var s;const t=a.compilerManager.getObjectFromModules(i.OBJECT_MODULE,e);if(!t){console.warn(`can not found this vid in engine: ${e}.`);return}r.remove(t);const c=a.getConfigBySymbol(e);if(!c){console.warn(`can not found this vid in engine: ${e}.`);return}c.parent="",(s=n.toModel(e))==null||s.emit(`${i.MODEL_EVENT.COMPILED_ATTR}:parent`)},g=function({model:n,target:r,config:o,value:e,engine:a}){e?delete r.raycast:r.raycast=n.emptyRaycast},A=i.defineModel.extend({shared:{eventSymbol:"vis.event",emptyRaycast:()=>{}},context(){return{cacheLookAt:{target:null,updateMatrixWorld:null}}},commands:{add:{pointerdown:u,pointerup:u,pointermove:u,pointerenter:u,pointerleave:u,click:u,dblclick:u,contextmenu:u,children:v},set:{lookAt:y,pointerdown:f,pointerup:f,pointermove:f,pointerenter:f,pointerleave:f,click:f,dblclick:f,contextmenu:f,parent:i.emptyHandler,raycast:g,children:{$reg:[{reg:new RegExp(".*"),handler:v}]}},delete:{pointerdown:d,pointerup:d,pointermove:d,pointerenter:d,pointerleave:d,click:d,dblclick:d,contextmenu:d,children:O}},create({model:n,target:r,config:o,engine:e,filter:a}){!a.lookAt&&y.call(n,{model:n,target:r,config:o,value:o.lookAt,engine:e}),!o.raycast&&(r.raycast=n.emptyRaycast),o.children.forEach(t=>{v.call(n,{target:r,config:o,value:t,engine:e})});for(const t of Object.values(i.EVENTNAME))n.asyncNextTick(()=>(o[t].forEach((c,s)=>{u.call(n,{model:n,target:r,path:[t,s.toString()],value:c,engine:e})}),!0));b.syncObject(o,r,{vid:!0,type:!0,lookAt:!0,parent:!0,children:!0,raycast:!0,pointerdown:!0,pointermove:!0,pointerup:!0,pointerenter:!0,pointerleave:!0,click:!0,dblclick:!0,contextmenu:!0,...a})},dispose({target:n}){n._listener={}}});l.ObjectRule=M,l.defineObjectModel=A,l.getObjectConfig=h,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
