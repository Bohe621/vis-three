(function(o,r){typeof exports=="object"&&typeof module!="undefined"?r(exports,require("@vis-three/middleware"),require("uuid"),require("@vis-three/utils")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","uuid","@vis-three/utils"],r):(o=typeof globalThis!="undefined"?globalThis:o||self,r((o["vis-three"]=o["vis-three"]||{},o["vis-three"]["module-object"]={}),o.middleware,o.uuid,o.utils))})(this,function(o,r,g,E){"use strict";class M extends r.Compiler{constructor(){super()}}const k=function(){return Object.assign(r.getSymbolConfig(),{type:"Object3D",castShadow:!0,receiveShadow:!0,lookAt:"",visible:!0,matrixAutoUpdate:!0,renderOrder:0,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},up:{x:0,y:1,z:0},parent:"",children:[],pointerdown:[],pointermove:[],pointerup:[],pointerenter:[],pointerleave:[],click:[],dblclick:[],contextmenu:[]})},C=function(t,c,e=g.validate){t.key!=="parent"&&r.Rule(t,c,e)},m=new WeakMap,b=function({target:t,config:c,value:e,engine:u}){if(c.vid===e){console.warn("can not set object lookAt itself.");return}let n=m.get(t);if(n||(n={lookAtTarget:null,updateMatrixWorldFun:null},m.set(t,n)),!e){if(!n.updateMatrixWorldFun)return;t.updateMatrixWorld=n.updateMatrixWorldFun,n.lookAtTarget=null,n.updateMatrixWorldFun=null;return}r.globalAntiShake.exec(i=>{const l=u.compilerManager.getObjectfromModules(r.OBJECTMODULE,e);if(!l)return i&&console.warn(`lookAt handler can not found this vid mapping object: '${e}'`),!1;const f=t.updateMatrixWorld;return n.updateMatrixWorldFun=f,n.lookAtTarget=l.position,t.updateMatrixWorld=A=>{f.call(t,A),t.lookAt(n.lookAtTarget)},!0})},p="vis.event",a=function({target:t,path:c,value:e,engine:u}){const n=c[0];if(!r.EventGeneratorManager.has(e.name)){console.warn(`EventGeneratorManager: can not support this event: ${e.name}`);return}const i=r.EventGeneratorManager.generateEvent(e,u),l=Symbol.for(p);e[l]=i,t.addEventListener(n,i)},s=function({target:t,path:c,value:e}){const u=c[0],n=e[Symbol.for(p)];if(!n){console.warn("event remove can not fun found event in config",e);return}t.removeEventListener(u,n),delete e[Symbol.for(p)]},d=function({target:t,config:c,path:e,engine:u}){if(e.length<2)return;const n=e[0],i=c[e[0]][e[1]],l=i[Symbol.for(p)];if(!l){console.warn("event remove can not fun found event in config",i);return}t.removeEventListener(n,l);const f=r.EventGeneratorManager.generateEvent(i,u);i[Symbol.for(p)]=f,t.addEventListener(n,f)},v=function({target:t,config:c,value:e,engine:u}){r.globalObjectModuleTrigger.registerExec(n=>{const i=u.getConfigBySymbol(e);if(!i)return n||console.warn(` can not foud object config in engine: ${e}`),!1;if(i.parent&&i.parent!==c.vid){const f=u.getConfigBySymbol(i.parent);if(!f)return n||console.warn(` can not foud object parent config in engine: ${i.parent}`),!1;f.children.splice(f.children.indexOf(e),1)}i.parent=c.vid;const l=u.compilerManager.getObjectfromModules(r.OBJECTMODULE,e);return l?(t.add(l),l.updateMatrixWorld(!0),r.Bus.compilerEvent.emit(l,`${r.COMPILER_EVENT.COMPILE}:parent`),!0):(n||console.warn(`can not found this vid in engine: ${e}.`),!1)})},h=function({target:t,config:c,value:e,engine:u}){const n=u.compilerManager.getObjectfromModules(r.OBJECTMODULE,e);if(!n){console.warn(`can not found this vid in engine: ${e}.`);return}t.remove(n);const i=u.getConfigBySymbol(e);if(!i){console.warn(`can not found this vid in engine: ${e}.`);return}i.parent="",r.Bus.compilerEvent.emit(n,`${r.COMPILER_EVENT.COMPILE}:parent`)},O=function(t,c,e,u){!e.lookAt&&b({target:t,config:c,engine:u,value:c.lookAt}),c.children.forEach(n=>{v({target:t,config:c,value:n,engine:u})});for(const n of Object.values(r.EVENTNAME))r.globalAntiShake.nextTick(()=>(c[n].forEach((i,l)=>{a({target:t,path:[n,l.toString()],value:i,engine:u})}),!0));return E.syncObject(c,t,{vid:!0,type:!0,lookAt:!0,parent:!0,children:!0,pointerdown:!0,pointermove:!0,pointerup:!0,pointerenter:!0,pointerleave:!0,click:!0,dblclick:!0,contextmenu:!0,...e}),t},j=function(t){t._listener={}},y={add:{pointerdown:a,pointerup:a,pointermove:a,pointerenter:a,pointerleave:a,click:a,dblclick:a,contextmenu:a,children:v},set:{lookAt:b,pointerdown:d,pointerup:d,pointermove:d,pointerenter:d,pointerleave:d,click:d,dblclick:d,contextmenu:d,parent:r.emptyHandler,children:{$reg:[{reg:new RegExp(".*"),handler:v}]}},delete:{pointerdown:s,pointerup:s,pointermove:s,pointerenter:s,pointerleave:s,click:s,dblclick:s,contextmenu:s,children:h}};o.ObjectCompiler=M,o.ObjectRule=C,o.addChildrenHanlder=v,o.addEventHanlder=a,o.getObjectConfig=k,o.lookAtHandler=b,o.objectCommands=y,o.objectCreate=O,o.objectDispose=j,o.removeChildrenHandler=h,o.removeEventHandler=s,o.updateEventHandler=d,Object.defineProperties(o,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
