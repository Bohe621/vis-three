(function(o,r){typeof exports=="object"&&typeof module!="undefined"?r(exports,require("@vis-three/middleware"),require("uuid"),require("@vis-three/utils")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","uuid","@vis-three/utils"],r):(o=typeof globalThis!="undefined"?globalThis:o||self,r((o["vis-three"]=o["vis-three"]||{},o["vis-three"]["module-object"]={}),o.middleware,o.uuid,o.utils))})(this,function(o,r,E,g){"use strict";class M extends r.Compiler{constructor(){super()}}const k=()=>({vid:"",name:"",type:"Object3D",castShadow:!0,receiveShadow:!0,lookAt:"",visible:!0,matrixAutoUpdate:!0,renderOrder:0,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},up:{x:0,y:1,z:0},parent:"",children:[],pointerdown:[],pointermove:[],pointerup:[],pointerenter:[],pointerleave:[],click:[],dblclick:[],contextmenu:[]}),C=function(t,c,e=E.validate){t.key!=="parent"&&r.Rule(t,c,e)},h=new WeakMap,m=function({target:t,config:c,value:e,engine:u}){if(c.vid===e){console.warn("can not set object lookAt itself.");return}let n=h.get(t);if(n||(n={lookAtTarget:null,updateMatrixWorldFun:null},h.set(t,n)),!e){if(!n.updateMatrixWorldFun)return;t.updateMatrixWorld=n.updateMatrixWorldFun,n.lookAtTarget=null,n.updateMatrixWorldFun=null;return}r.globalAntiShake.exec(i=>{const a=u.compilerManager.getObjectfromModules(r.OBJECTMODULE,e);if(!a)return i&&console.warn(`lookAt handler can not found this vid mapping object: '${e}'`),!1;const f=t.updateMatrixWorld;return n.updateMatrixWorldFun=f,n.lookAtTarget=a.position,t.updateMatrixWorld=A=>{f.call(t,A),t.lookAt(n.lookAtTarget)},!0})},p="vis.event",l=function({target:t,path:c,value:e,engine:u}){const n=c[0];if(!r.EventGeneratorManager.has(e.name)){console.warn(`EventGeneratorManager: can not support this event: ${e.name}`);return}const i=r.EventGeneratorManager.generateEvent(e,u),a=Symbol.for(p);e[a]=i,t.addEventListener(n,i)},d=function({target:t,path:c,value:e}){const u=c[0],n=e[Symbol.for(p)];if(!n){console.warn("event remove can not fun found event in config",e);return}t.removeEventListener(u,n),delete e[Symbol.for(p)]},s=function({target:t,config:c,path:e,engine:u}){if(e.length<2)return;const n=e[0],i=c[e[0]][e[1]],a=i[Symbol.for(p)];if(!a){console.warn("event remove can not fun found event in config",i);return}t.removeEventListener(n,a);const f=r.EventGeneratorManager.generateEvent(i,u);i[Symbol.for(p)]=f,t.addEventListener(n,f)},v=function({target:t,config:c,value:e,engine:u}){r.globalAntiShake.exec(n=>{const i=u.getConfigBySymbol(e);if(!i)return n&&console.warn(` can not foud object config in engine: ${e}`),!1;if(i.parent&&i.parent!==c.vid){const f=u.getConfigBySymbol(i.parent);if(!f)return n&&console.warn(` can not foud object parent config in engine: ${i.parent}`),!1;f.children.splice(f.children.indexOf(e),1)}i.parent=c.vid;const a=u.compilerManager.getObjectfromModules(r.OBJECTMODULE,e);return a?(t.add(a),a.updateMatrixWorld(!0),r.Bus.compilerEvent.emit(a,`${r.COMPILER_EVENT.COMPILE}:parent`),!0):(n&&console.warn(`can not found this vid in engine: ${e}.`),!1)})},b=function({target:t,config:c,value:e,engine:u}){const n=u.compilerManager.getObjectfromModules(r.OBJECTMODULE,e);if(!n){console.warn(`can not found this vid in engine: ${e}.`);return}t.remove(n);const i=u.getConfigBySymbol(e);if(!i){console.warn(`can not found this vid in engine: ${e}.`);return}i.parent="",r.Bus.compilerEvent.emit(n,`${r.COMPILER_EVENT.COMPILE}:parent`)},O=function(t,c,e,u){!e.lookAt&&m({target:t,config:c,engine:u,value:c.lookAt}),c.children.forEach(n=>{v({target:t,config:c,value:n,engine:u})});for(const n of Object.values(r.EVENTNAME))r.globalAntiShake.nextTick(()=>(c[n].forEach((i,a)=>{l({target:t,path:[n,a.toString()],value:i,engine:u})}),!0));return g.syncObject(c,t,{vid:!0,type:!0,lookAt:!0,parent:!0,children:!0,pointerdown:!0,pointermove:!0,pointerup:!0,pointerenter:!0,pointerleave:!0,click:!0,dblclick:!0,contextmenu:!0,...e}),t},y=function(t){t._listener={}},j={add:{pointerdown:l,pointerup:l,pointermove:l,pointerenter:l,pointerleave:l,click:l,dblclick:l,contextmenu:l,children:v},set:{lookAt:m,pointerdown:s,pointerup:s,pointermove:s,pointerenter:s,pointerleave:s,click:s,dblclick:s,contextmenu:s,parent:r.emptyHandler,children:{$reg:[{reg:new RegExp(".*"),handler:v}]}},delete:{pointerdown:d,pointerup:d,pointermove:d,pointerenter:d,pointerleave:d,click:d,dblclick:d,contextmenu:d,children:b}};o.ObjectCompiler=M,o.ObjectRule=C,o.addChildrenHanlder=v,o.addEventHanlder=l,o.getObjectConfig=k,o.lookAtHandler=m,o.objectCommands=j,o.objectCreate=O,o.objectDispose=y,o.removeChildrenHandler=b,o.removeEventHandler=d,o.updateEventHandler=s,Object.defineProperties(o,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
