(function(o,n){typeof exports=="object"&&typeof module!="undefined"?module.exports=n(require("@vis-three/utils"),require("three"),require("@vis-three/middleware"),require("@vis-three/convenient")):typeof define=="function"&&define.amd?define(["@vis-three/utils","three","@vis-three/middleware","@vis-three/convenient"],n):(o=typeof globalThis!="undefined"?globalThis:o||self,o["vis-three"]=o["vis-three"]||{},o["vis-three"]["module-texture"]=n(o.utils,o.three,o.middleware,o.convenient))})(this,function(o,n,i,M){"use strict";var Y=Object.defineProperty;var $=(o,n,i)=>n in o?Y(o,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):o[n]=i;var C=(o,n,i)=>($(o,typeof n!="symbol"?n+"":n,i),i);const m=class extends i.Compiler{constructor(){super()}getResource(r,e){const s=this.engine.resourceManager.resourceMap;if(!s.has(r))return console.warn(`engine resourceManager can not found this url: ${r}`),m.replaceImage;const u=s.get(r);if(Array.isArray(e)){for(const c of e)if(u instanceof c)return u;return console.warn(`this url mapping resource is not a texture image class: ${r}`,u),m.replaceImage}else return u instanceof e?u:(console.warn(`this url mapping resource is not a texture image class: ${r}`,u),m.replaceImage)}};let l=m;C(l,"replaceImage",new M.CanvasGenerator({width:512,height:512}).draw(r=>{r.translate(256,256),r.font="72px",r.fillStyle="white",r.fillText("\u6682\u65E0\u56FE\u7247",0,0)}).getDom());const E={reg:new RegExp("wrapS|wrapT|format|encoding|anisotropy|magFilter|minFilter|mapping"),handler({target:t,key:r,value:e}){t[r]=e,t.needsUpdate=!0}},p=function({target:t,value:r,engine:e}){i.globalAntiShake.exec(s=>(t.image=e.compilerManager.getCompiler(i.MODULETYPE.TEXTURE).getResource(r,[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement]),t.needsUpdate=!0,t.images!==l.replaceImage))},g=function(){return{vid:"",type:"Texture",name:"",mapping:n.UVMapping,wrapS:n.ClampToEdgeWrapping,wrapT:n.ClampToEdgeWrapping,magFilter:n.LinearFilter,minFilter:n.LinearMipmapLinearFilter,anisotropy:1,format:n.RGBAFormat,flipY:!0,offset:{x:0,y:0},repeat:{x:1,y:1},rotation:0,center:{x:0,y:0},matrixAutoUpdate:!0,encoding:n.LinearEncoding,needsUpdate:!1}},R=function(){return Object.assign(g(),{url:""})},L=function(){return Object.assign(g(),{url:"",minFilter:n.LinearFilter})},h=function(){return Object.assign(g(),{cube:{nx:"",ny:"",nz:"",px:"",py:"",pz:""},mapping:n.CubeReflectionMapping,flipY:!1})},b=function(){return Object.assign(g(),{url:"",needsUpdate:!1})},O=function(){return Object.assign(g(),{url:""})};var P=i.defineProcessor({type:"CanvasTexture",config:b,commands:{set:{url:p,$reg:[E]}},create(t,r){const e=new n.CanvasTexture(r.compilerManager.getCompiler(i.MODULETYPE.TEXTURE).getResource(t.url,HTMLCanvasElement));return p({target:e,value:t.url,engine:r}),o.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});const a=[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement],d=function({target:t,index:r,value:e,engine:s}){t.images[r]=s.compilerManager.getCompiler(i.MODULETYPE.TEXTURE).getResource(e,a),t.needsUpdate=!0};var F=i.defineProcessor({type:"CubeTexture",config:h,commands:{set:{cube:{px({target:t,value:r,engine:e}){d({target:t,value:r,engine:e,index:0})},nx({target:t,value:r,engine:e}){d({target:t,value:r,engine:e,index:1})},py({target:t,value:r,engine:e}){d({target:t,value:r,engine:e,index:2})},ny({target:t,value:r,engine:e}){d({target:t,value:r,engine:e,index:3})},pz({target:t,value:r,engine:e}){d({target:t,value:r,engine:e,index:4})},nz({target:t,value:r,engine:e}){d({target:t,value:r,engine:e,index:5})}}}},create(t,r){const e=new n.CubeTexture,s=t.cube,u=r.compilerManager.getCompiler(i.MODULETYPE.TEXTURE),c=[u.getResource(s.px,a),u.getResource(s.nx,a),u.getResource(s.py,a),u.getResource(s.ny,a),u.getResource(s.pz,a),u.getResource(s.nz,a)];return e.image=c,o.syncObject(t,e,{type:!0,cube:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});class j extends n.Texture{constructor(r,e,s,u,c,f,x,T,y,v){super(r,e,s,u,c,f,x,T,y,v)}}var w=i.defineProcessor({type:"ImageTexture",config:R,commands:{set:{url:p,$reg:[E]}},create(t,r){const e=new j;return t.url&&p({target:e,value:t.url,engine:r}),o.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});class U extends n.Texture{constructor(r){super(),Object.keys(r).forEach(e=>{this[e]=r[e]}),this.copy(r)}}var I=i.defineProcessor({type:"LoadTexture",config:O,commands:{set:{url({}){},$reg:[E]}},create(t,r){let e;const s=r.compilerManager.getCompiler(i.MODULETYPE.TEXTURE).getResource(t.url,n.Texture);if(s instanceof n.Texture)e=new U(s);else{const u=new n.Texture(s);e=new U(u)}return o.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});const V=function(t,r){i.Rule(t,r)};class H extends n.Texture{constructor(e,s,u,c,f,x,T,y,v){super(e,s,u,c,f,x,T,y,v);C(this,"isVideoTexture",!0);this.format=T!==void 0?T:n.RGBFormat,this.minFilter=x!==void 0?x:n.LinearFilter,this.magFilter=f!==void 0?f:n.LinearFilter,this.generateMipmaps=!1}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image,s="requestVideoFrameCallback"in e;s?this.needsUpdate=!0:s===!1&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}var A=i.defineProcessor({type:"VideoTexture",config:L,commands:{set:{url:p,$reg:[E]}},create(t,r){const e=new H(document.createElement("video"));return t.url&&p({target:e,value:t.url,engine:r}),o.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}}),D={type:"texture",compiler:l,rule:V,processors:[P,F,w,I,A]};return D});
