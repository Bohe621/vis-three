(function(s,u){typeof exports=="object"&&typeof module!="undefined"?u(exports,require("@vis-three/utils"),require("three"),require("@vis-three/middleware"),require("@vis-three/convenient")):typeof define=="function"&&define.amd?define(["exports","@vis-three/utils","three","@vis-three/middleware","@vis-three/convenient"],u):(s=typeof globalThis!="undefined"?globalThis:s||self,u((s["vis-three"]=s["vis-three"]||{},s["vis-three"]["module-texture"]={}),s.utils,s.three,s.middleware,s.convenient))})(this,function(s,u,n,a,F){"use strict";var X=Object.defineProperty;var $=(s,u,n)=>u in s?X(s,u,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[u]=n;var M=(s,u,n)=>($(s,typeof u!="symbol"?u+"":u,n),n);const m=class extends a.Compiler{constructor(){super()}getResource(r,e){const i=this.engine.resourceManager.resourceMap;if(!i.has(r))return console.warn(`engine resourceManager can not found this url: ${r}`),m.replaceImage;const o=i.get(r);if(Array.isArray(e)){for(const p of e)if(o instanceof p)return o;return console.warn(`this url mapping resource is not a texture image class: ${r}`,o),m.replaceImage}else return o instanceof e?o:(console.warn(`this url mapping resource is not a texture image class: ${r}`,o),m.replaceImage)}};let g=m;M(g,"replaceImage",new F.CanvasGenerator({width:512,height:512}).draw(r=>{r.translate(256,256),r.font="72px",r.fillStyle="white",r.fillText("\u6682\u65E0\u56FE\u7247",0,0)}).getDom());const C={reg:new RegExp("wrapS|wrapT|format|encoding|anisotropy|magFilter|minFilter|mapping|flipY"),handler({target:t,key:r,value:e}){t[r]=e,t.needsUpdate=!0}},l=function({target:t,value:r,engine:e}){a.globalAntiShake.exec(i=>(t.image=e.compilerManager.getCompiler(a.MODULETYPE.TEXTURE).getResource(r,[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement]),t.needsUpdate=!0,t.images!==g.replaceImage))},d=function(){return{vid:"",type:"Texture",name:"",mapping:n.UVMapping,wrapS:n.ClampToEdgeWrapping,wrapT:n.ClampToEdgeWrapping,magFilter:n.LinearFilter,minFilter:n.LinearMipmapLinearFilter,anisotropy:1,format:n.RGBAFormat,flipY:!0,offset:{x:0,y:0},repeat:{x:1,y:1},rotation:0,center:{x:0,y:0},matrixAutoUpdate:!0,encoding:n.LinearEncoding,needsUpdate:!1}},U=function(){return Object.assign(d(),{url:""})},L=function(){return Object.assign(d(),{url:"",minFilter:n.LinearFilter})},R=function(){return Object.assign(d(),{cube:{nx:"",ny:"",nz:"",px:"",py:"",pz:""},mapping:n.CubeReflectionMapping,flipY:!1})},b=function(){return Object.assign(d(),{url:"",needsUpdate:!1})},h=function(){return Object.assign(d(),{url:""})};var P=a.defineProcessor({type:"CanvasTexture",config:b,commands:{set:{url:l,$reg:[C]}},create(t,r){const e=new n.CanvasTexture(r.compilerManager.getCompiler(a.MODULETYPE.TEXTURE).getResource(t.url,HTMLCanvasElement));return l({target:e,value:t.url,engine:r}),u.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});const c=[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement],f=function({target:t,index:r,value:e,engine:i}){t.images[r]=i.compilerManager.getCompiler(a.MODULETYPE.TEXTURE).getResource(e,c),t.needsUpdate=!0};var j=a.defineProcessor({type:"CubeTexture",config:R,commands:{set:{cube:{px({target:t,value:r,engine:e}){f({target:t,value:r,engine:e,index:0})},nx({target:t,value:r,engine:e}){f({target:t,value:r,engine:e,index:1})},py({target:t,value:r,engine:e}){f({target:t,value:r,engine:e,index:2})},ny({target:t,value:r,engine:e}){f({target:t,value:r,engine:e,index:3})},pz({target:t,value:r,engine:e}){f({target:t,value:r,engine:e,index:4})},nz({target:t,value:r,engine:e}){f({target:t,value:r,engine:e,index:5})}}}},create(t,r){const e=new n.CubeTexture,i=t.cube,o=r.compilerManager.getCompiler(a.MODULETYPE.TEXTURE),p=[o.getResource(i.px,c),o.getResource(i.nx,c),o.getResource(i.py,c),o.getResource(i.ny,c),o.getResource(i.pz,c),o.getResource(i.nz,c)];return e.image=p,u.syncObject(t,e,{type:!0,cube:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});class I extends n.Texture{constructor(r,e,i,o,p,T,x,E,v,y){super(r,e,i,o,p,T,x,E,v,y)}}var V=a.defineProcessor({type:"ImageTexture",config:U,commands:{set:{url:l,$reg:[C]}},create(t,r){const e=new I;return t.url&&l({target:e,value:t.url,engine:r}),u.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});class O extends n.Texture{constructor(r){super(),Object.keys(r).forEach(e=>{this[e]=r[e]}),this.copy(r)}}var Y=a.defineProcessor({type:"LoadTexture",config:h,commands:{set:{url({}){},$reg:[C]}},create(t,r){let e;const i=r.compilerManager.getCompiler(a.MODULETYPE.TEXTURE).getResource(t.url,n.Texture);if(i instanceof n.Texture)e=new O(i);else{const o=new n.Texture(i);e=new O(o)}return u.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});const H=function(t,r){a.Rule(t,r)};class A extends n.Texture{constructor(e,i,o,p,T,x,E,v,y){super(e,i,o,p,T,x,E,v,y);M(this,"isVideoTexture",!0);this.format=E!==void 0?E:n.RGBFormat,this.minFilter=x!==void 0?x:n.LinearFilter,this.magFilter=T!==void 0?T:n.LinearFilter,this.generateMipmaps=!1}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image,i="requestVideoFrameCallback"in e;i?this.needsUpdate=!0:i===!1&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}var D=a.defineProcessor({type:"VideoTexture",config:L,commands:{set:{url:l,$reg:[C]}},create(t,r){const e=new A(document.createElement("video"));return t.url&&l({target:e,value:t.url,engine:r}),u.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});function w(t){t.generateLoadTextureConfig=function(r){const e=this.compilerManager.getCompiler(a.MODULETYPE.TEXTURE).getResource(r,n.Texture);return e instanceof HTMLCanvasElement?null:a.generateConfig(a.CONFIGTYPE.LOADTEXTURE,{url:r,flipY:e.flipY,format:e.format,mapping:e.mapping,encoding:e.encoding,minFilter:e.minFilter,magFilter:e.magFilter})}}var S={type:"texture",compiler:g,rule:H,processors:[P,j,V,Y,D],extend:w};s.TextureCompiler=g,s.default=S,s.getCanvasTextureConfig=b,s.getCubeTextureConfig=R,s.getImageTextureConfig=U,s.getLoadTextureConfig=h,s.getTextureConfig=d,s.getVideoTextureConfig=L,Object.defineProperties(s,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
