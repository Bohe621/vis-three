(function(a,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("three"),require("@vis-three/tdcm"),require("@vis-three/convenient"),require("@vis-three/utils")):typeof define=="function"&&define.amd?define(["exports","three","@vis-three/tdcm","@vis-three/convenient","@vis-three/utils"],i):(a=typeof globalThis<"u"?globalThis:a||self,i((a["vis-three"]=a["vis-three"]||{},a["vis-three"]["module-texture"]={}),a.three,a.tdcm,a.convenient,a.utils))})(this,function(a,i,d,h,p){"use strict";const c=function(){return Object.assign(d.getBasicConfig(),{mapping:i.UVMapping,wrapS:i.ClampToEdgeWrapping,wrapT:i.ClampToEdgeWrapping,magFilter:i.LinearFilter,minFilter:i.LinearMipmapLinearFilter,anisotropy:1,format:i.RGBAFormat,flipY:!0,offset:{x:0,y:0},repeat:{x:1,y:1},rotation:0,center:{x:0,y:0},matrixAutoUpdate:!0,needsUpdate:!1})},x=function(){return Object.assign(c(),{url:""})},y=function(){return Object.assign(c(),{url:"",minFilter:i.LinearFilter})},C=function(){return Object.assign(c(),{cube:{nx:"",ny:"",nz:"",px:"",py:"",pz:""},mapping:i.CubeReflectionMapping,flipY:!1})},M=function(){return Object.assign(c(),{url:"",needsUpdate:!1})},L=function(){return Object.assign(c(),{url:""})},l=new h.CanvasGenerator({width:512,height:512}).draw(e=>{e.translate(256,256),e.font="72px",e.fillStyle="white",e.fillText("暂无图片",0,0)}).getDom(),v=function(e,t,r){const n=t.resourceManager.resourceMap;if(!n.has(e))return console.warn(`engine resourceManager can not found this url: ${e}`),l;const s=n.get(e);if(Array.isArray(r)){for(const u of r)if(s instanceof u)return s;return console.warn(`this url mapping resource is not a texture image class: ${e}`,s),l}else return s instanceof r?s:(console.warn(`this url mapping resource is not a texture image class: ${e}`,s),l)},g=d.defineModel.extend({shared:{replaceImage:l,getResource:v},commands:{set:{$reg:[{reg:new RegExp("wrapS|wrapT|format|encoding|anisotropy|magFilter|minFilter|mapping|flipY"),handler({target:e,key:t,value:r}){e[t]=r,e.needsUpdate=!0}}]}}}),H=g(()=>({type:"CanvasTexture",config:M,commands:{set:{url({model:e,target:t,value:r,engine:n}){e.toAsync(s=>(t.image=e.getResource(r,n,[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement]),t.needsUpdate=!0,t.image!==e.replaceImage))}}},create({model:e,config:t,engine:r}){const n=new i.CanvasTexture(e.replaceImage);return e.toAsync(s=>(n.image=e.getResource(t.url,r,[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement]),n.needsUpdate=!0,n.image!==e.replaceImage)),p.syncObject(t,n,{type:!0,url:!0}),n.needsUpdate=!0,n},dispose({target:e}){e.dispose()}})),b=g(()=>({type:"CubeTexture",config:C,shared:{imageHanlder({model:e,target:t,index:r,value:n,engine:s}){t.images[r]=e.getResource(n,s,[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement]),t.needsUpdate=!0}},commands:{set:{cube:{px({model:e,target:t,value:r,engine:n}){e.imageHanlder({model:e,target:t,value:r,index:0,engine:n})},nx({model:e,target:t,value:r,engine:n}){e.imageHanlder({model:e,target:t,value:r,index:1,engine:n})},py({model:e,target:t,value:r,engine:n}){e.imageHanlder({model:e,target:t,value:r,index:2,engine:n})},ny({model:e,target:t,value:r,engine:n}){e.imageHanlder({model:e,target:t,value:r,index:3,engine:n})},pz({model:e,target:t,value:r,engine:n}){e.imageHanlder({model:e,target:t,value:r,index:4,engine:n})},nz({model:e,target:t,value:r,engine:n}){e.imageHanlder({model:e,target:t,value:r,index:5,engine:n})}}}},create({model:e,config:t,engine:r}){const n=new i.CubeTexture,s=t.cube,u=[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement],o=[e.getResource(s.px,r,u),e.getResource(s.nx,r,u),e.getResource(s.py,r,u),e.getResource(s.ny,r,u),e.getResource(s.pz,r,u),e.getResource(s.nz,r,u)];return n.image=o,p.syncObject(t,n,{type:!0,cube:!0}),n.needsUpdate=!0,n},dispose({target:e}){e.dispose()}}));class R extends i.Texture{constructor(t,r,n,s,u,o,f,m,T){super(t,r,n,s,u,o,f,m,T)}}const I=g(()=>({type:"ImageTexture",config:x,commands:{set:{url({model:e,target:t,value:r,engine:n}){e.toAsync(s=>(t.image=e.getResource(r,n,[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement]),t.needsUpdate=!0,t.image!==e.replaceImage))}}},create({model:e,config:t,engine:r}){const n=new R(e.replaceImage);return t.url&&e.toAsync(s=>(n.image=e.getResource(t.url,r,[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement]),n.needsUpdate=!0,n.image!==e.replaceImage)),p.syncObject(t,n,{type:!0,url:!0}),n.needsUpdate=!0,n},dispose({target:e}){e.dispose()}}));class E extends i.Texture{constructor(t){super(),Object.keys(t).forEach(r=>{this[r]=t[r]}),this.copy(t)}}const U=g(()=>({type:"LoadTexture",config:L,commands:{set:{url(){}}},create({model:e,config:t,engine:r}){let n;const s=e.getResource(t.url,r,i.Texture);if(s instanceof i.Texture)n=new E(s);else{const u=new i.Texture(s);n=new E(u)}return p.syncObject(t,n,{type:!0,url:!0}),n.needsUpdate=!0,n},dispose({target:e}){e.dispose()}}));class w extends i.Texture{constructor(t,r,n,s,u,o,f,m,T){super(t,r,n,s,u,o,f,m,T),this.isVideoTexture=!0,this.format=f!==void 0?f:i.RGBFormat,this.minFilter=o!==void 0?o:i.LinearFilter,this.magFilter=u!==void 0?u:i.LinearFilter,this.generateMipmaps=!1}clone(){return new this.constructor(this.image).copy(this)}update(){const t=this.image,r="requestVideoFrameCallback"in t;r?this.needsUpdate=!0:r===!1&&t.readyState>=t.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}const V=g(()=>({type:"VideoTexture",config:y,commands:{set:{url({model:e,target:t,value:r,engine:n}){e.toAsync(s=>(t.image=e.getResource(r,n,[HTMLVideoElement]),t.needsUpdate=!0,t.image!==e.replaceImage))}}},create({model:e,config:t,engine:r}){const n=new w(document.createElement("video"));return t.url&&e.toAsync(s=>(n.image=e.getResource(t.url,r,[HTMLVideoElement]),n.needsUpdate=!0,n.image!==e.replaceImage)),p.syncObject(t,n,{type:!0,url:!0}),n.needsUpdate=!0,n},dispose({target:e}){e.dispose()}}));function F(e){e.generateLoadTextureConfig=function(t){const r=v(t,this,i.Texture);return r instanceof HTMLCanvasElement?null:d.generateConfig(d.CONFIG_TYPE.LOADTEXTURE,{url:t,flipY:r.flipY,format:r.format,mapping:r.mapping,minFilter:r.minFilter,magFilter:r.magFilter})}}const O=d.defineModule({type:"texture",models:[H,b,I,U,V],extend:F});a.default=O,a.getCanvasTextureConfig=M,a.getCubeTextureConfig=C,a.getImageTextureConfig=x,a.getLoadTextureConfig=L,a.getTextureConfig=c,a.getVideoTextureConfig=y,Object.defineProperties(a,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
