(function(s,u){typeof exports=="object"&&typeof module!="undefined"?u(exports,require("@vis-three/utils"),require("three"),require("@vis-three/middleware"),require("@vis-three/convenient")):typeof define=="function"&&define.amd?define(["exports","@vis-three/utils","three","@vis-three/middleware","@vis-three/convenient"],u):(s=typeof globalThis!="undefined"?globalThis:s||self,u((s["vis-three"]=s["vis-three"]||{},s["vis-three"]["module-texture"]={}),s.utils,s.three,s.middleware,s.convenient))})(this,function(s,u,n,a,P){"use strict";var Y=Object.defineProperty;var $=(s,u,n)=>u in s?Y(s,u,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[u]=n;var M=(s,u,n)=>($(s,typeof u!="symbol"?u+"":u,n),n);const f=class extends a.Compiler{constructor(){super()}getResource(r,e){const o=this.engine.resourceManager.resourceMap;if(!o.has(r))return console.warn(`engine resourceManager can not found this url: ${r}`),f.replaceImage;const i=o.get(r);if(Array.isArray(e)){for(const p of e)if(i instanceof p)return i;return console.warn(`this url mapping resource is not a texture image class: ${r}`,i),f.replaceImage}else return i instanceof e?i:(console.warn(`this url mapping resource is not a texture image class: ${r}`,i),f.replaceImage)}};let g=f;M(g,"replaceImage",new P.CanvasGenerator({width:512,height:512}).draw(r=>{r.translate(256,256),r.font="72px",r.fillStyle="white",r.fillText("\u6682\u65E0\u56FE\u7247",0,0)}).getDom());const C={reg:new RegExp("wrapS|wrapT|format|encoding|anisotropy|magFilter|minFilter|mapping"),handler({target:t,key:r,value:e}){t[r]=e,t.needsUpdate=!0}},d=function({target:t,value:r,engine:e}){a.globalAntiShake.exec(o=>(t.image=e.compilerManager.getCompiler(a.MODULETYPE.TEXTURE).getResource(r,[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement]),t.needsUpdate=!0,t.images!==g.replaceImage))},l=function(){return{vid:"",type:"Texture",name:"",mapping:n.UVMapping,wrapS:n.ClampToEdgeWrapping,wrapT:n.ClampToEdgeWrapping,magFilter:n.LinearFilter,minFilter:n.LinearMipmapLinearFilter,anisotropy:1,format:n.RGBAFormat,flipY:!0,offset:{x:0,y:0},repeat:{x:1,y:1},rotation:0,center:{x:0,y:0},matrixAutoUpdate:!0,encoding:n.LinearEncoding,needsUpdate:!1}},U=function(){return Object.assign(l(),{url:""})},R=function(){return Object.assign(l(),{url:"",minFilter:n.LinearFilter})},L=function(){return Object.assign(l(),{cube:{nx:"",ny:"",nz:"",px:"",py:"",pz:""},mapping:n.CubeReflectionMapping,flipY:!1})},b=function(){return Object.assign(l(),{url:"",needsUpdate:!1})},h=function(){return Object.assign(l(),{url:""})};var j=a.defineProcessor({type:"CanvasTexture",config:b,commands:{set:{url:d,$reg:[C]}},create(t,r){const e=new n.CanvasTexture(r.compilerManager.getCompiler(a.MODULETYPE.TEXTURE).getResource(t.url,HTMLCanvasElement));return d({target:e,value:t.url,engine:r}),u.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});const c=[HTMLImageElement,HTMLVideoElement,HTMLCanvasElement],m=function({target:t,index:r,value:e,engine:o}){t.images[r]=o.compilerManager.getCompiler(a.MODULETYPE.TEXTURE).getResource(e,c),t.needsUpdate=!0};var F=a.defineProcessor({type:"CubeTexture",config:L,commands:{set:{cube:{px({target:t,value:r,engine:e}){m({target:t,value:r,engine:e,index:0})},nx({target:t,value:r,engine:e}){m({target:t,value:r,engine:e,index:1})},py({target:t,value:r,engine:e}){m({target:t,value:r,engine:e,index:2})},ny({target:t,value:r,engine:e}){m({target:t,value:r,engine:e,index:3})},pz({target:t,value:r,engine:e}){m({target:t,value:r,engine:e,index:4})},nz({target:t,value:r,engine:e}){m({target:t,value:r,engine:e,index:5})}}}},create(t,r){const e=new n.CubeTexture,o=t.cube,i=r.compilerManager.getCompiler(a.MODULETYPE.TEXTURE),p=[i.getResource(o.px,c),i.getResource(o.nx,c),i.getResource(o.py,c),i.getResource(o.ny,c),i.getResource(o.pz,c),i.getResource(o.nz,c)];return e.image=p,u.syncObject(t,e,{type:!0,cube:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});class I extends n.Texture{constructor(r,e,o,i,p,T,x,v,y,E){super(r,e,o,i,p,T,x,v,y,E)}}var V=a.defineProcessor({type:"ImageTexture",config:U,commands:{set:{url:d,$reg:[C]}},create(t,r){const e=new I;return t.url&&d({target:e,value:t.url,engine:r}),u.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});class O extends n.Texture{constructor(r){super(),Object.keys(r).forEach(e=>{this[e]=r[e]}),this.copy(r)}}var w=a.defineProcessor({type:"LoadTexture",config:h,commands:{set:{url({}){},$reg:[C]}},create(t,r){let e;const o=r.compilerManager.getCompiler(a.MODULETYPE.TEXTURE).getResource(t.url,n.Texture);if(o instanceof n.Texture)e=new O(o);else{const i=new n.Texture(o);e=new O(i)}return u.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}});const H=function(t,r){a.Rule(t,r)};class A extends n.Texture{constructor(e,o,i,p,T,x,v,y,E){super(e,o,i,p,T,x,v,y,E);M(this,"isVideoTexture",!0);this.format=v!==void 0?v:n.RGBFormat,this.minFilter=x!==void 0?x:n.LinearFilter,this.magFilter=T!==void 0?T:n.LinearFilter,this.generateMipmaps=!1}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image,o="requestVideoFrameCallback"in e;o?this.needsUpdate=!0:o===!1&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}var D=a.defineProcessor({type:"VideoTexture",config:R,commands:{set:{url:d,$reg:[C]}},create(t,r){const e=new A(document.createElement("video"));return t.url&&d({target:e,value:t.url,engine:r}),u.syncObject(t,e,{type:!0,url:!0}),e.needsUpdate=!0,e},dispose(t){t.dispose()}}),S={type:"texture",compiler:g,rule:H,processors:[j,F,V,w,D]};s.TextureCompiler=g,s.default=S,s.getCanvasTextureConfig=b,s.getCubeTextureConfig=L,s.getImageTextureConfig=U,s.getLoadTextureConfig=h,s.getTextureConfig=l,s.getVideoTextureConfig=R,Object.defineProperties(s,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
