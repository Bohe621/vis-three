(function(l,c){typeof exports=="object"&&typeof module!="undefined"?c(exports,require("three"),require("uuid"),require("@vis-three/utils"),require("@vis-three/middleware")):typeof define=="function"&&define.amd?define(["exports","three","uuid","@vis-three/utils","@vis-three/middleware"],c):(l=typeof globalThis!="undefined"?globalThis:l||self,c((l["vis-three"]=l["vis-three"]||{},l["vis-three"]["library-parser"]={}),l.three,l.uuid,l.utils,l.middleware))})(this,function(l,c,f,C,o){"use strict";var I=Object.defineProperty;var N=(l,c,f)=>c in l?I(l,c,{enumerable:!0,configurable:!0,writable:!0,value:f}):l[c]=f;var u=(l,c,f)=>(N(l,typeof c!="symbol"?c+"":c,f),f);class T extends o.Parser{constructor(){super(...arguments);u(this,"selector",(e,t,n)=>t.isObject3D&&n.get(T)||null)}parse(e){this.parseObject3D(e)}parseAnimation({url:e,resource:t,configMap:n,resourceMap:r}){r.set(e,t);const s=o.CONFIGFACTORY[o.CONFIGTYPE.LOADANIMATIONCLIP]();s.vid=f.v4(),s.url=e,s.name=t.name,n.set(e,s)}parseColor(e){return`rgb(${Math.round(255*e.r)}, ${Math.round(255*e.g)}, ${Math.round(255*e.b)})`}attributeEnhance(e){const t={};for(const n in e)n.startsWith("_")?t[n.slice(1)]=e[n]:t[n]=e[n];return t}parseTexture({url:e,resource:t,configMap:n,resourceMap:r}){r.set(e,t);const s=o.CONFIGFACTORY[o.CONFIGTYPE.LOADTEXTURE]();n.set(e,s),s.vid=f.v4(),s.url=e,C.syncObject(t,s,{type:!0,vid:!0,url:!0})}parseMaterial({url:e,resource:t,configMap:n,resourceMap:r}){if(r.set(e,t),!o.CONFIGFACTORY[t.type]){console.warn("can not found support config in vis for this resource",t);return}const s=o.CONFIGFACTORY[t.type]();n.set(e,s),s.vid=f.v4(),C.syncObject(this.attributeEnhance(t),s,{type:!0,vid:!0});for(const i in t)if(!!t[i]){if(t[i].isColor)s[i]=this.parseColor(t[i]);else if(i.toLocaleLowerCase().endsWith("map")&&t[i]){const a=`${e}.${i}`;this.parseTexture({url:a,resource:t[i],configMap:n,resourceMap:r}),s[i]=n.get(a).vid}}}parseGeometry({url:e,resource:t,configMap:n,resourceMap:r}){r.set(e,t),t.computeBoundingBox();const s=t.boundingBox,i=s.getCenter(new c.Vector3),a=o.CONFIGFACTORY[o.CONFIGTYPE.LOADGEOMETRY]();a.vid=f.v4(),a.url=e,a.position.x=i.x/(s.max.x-s.min.x)*2,a.position.y=i.y/(s.max.y-s.min.y)*2,a.position.z=i.z/(s.max.z-s.min.z)*2,n.set(e,a)}parseSkeleton({url:e,resource:t,configMap:n,resourceMap:r}){const s=o.CONFIGFACTORY[o.CONFIGTYPE.SKELETON]();s.vid=f.v4();const i=new WeakMap;for(const[a,h]of r.entries())h instanceof c.Bone&&i.set(h,n.get(a));for(const a of t.bones){if(!i.has(a)){console.warn("object3D parser can not fond bone in configMap",a);continue}s.bones.push(i.get(a).vid)}n.set(e,s)}parseObject3D({url:e,resource:t,configMap:n,resourceMap:r}){if(r.set(e,t),!o.CONFIGFACTORY[t.type]){console.warn("can not found support config in middleware module for this resource",t);return}const s=o.CONFIGFACTORY[t.type]();if(s.vid=f.v4(),C.syncObject(t,s,{type:!0,vid:!0,children:!0,geometry:!0,material:!0,parent:!0,lookAt:!0,skeleton:!0}),s.rotation.x=t.rotation.x,s.rotation.y=t.rotation.y,s.rotation.z=t.rotation.z,n.set(e,s),t.material)if(Array.isArray(t.material))s.material=[],t.material.forEach((i,a,h)=>{const A=`${e}.material.${a}`;this.parseMaterial({url:A,resource:i,configMap:n,resourceMap:r}),s.material.push(n.get(A).vid)});else{const i=`${e}.material`;this.parseMaterial({url:i,resource:t.material,configMap:n,resourceMap:r}),s.material=n.get(i).vid}if(t.geometry){const i=`${e}.geometry`;this.parseGeometry({url:i,resource:t.geometry,configMap:n,resourceMap:r}),s.geometry=n.get(i).vid}if(t.skeleton){const i=`${e}.skeleton`;this.parseSkeleton({url:i,resource:t.skeleton,configMap:n,resourceMap:r}),s.skeleton=n.get(i).vid}if(t.children&&t.children.length){const i=[];t.children.forEach((a,h)=>{a.type==="Bone"?i.unshift({index:h,object:a,type:a.type}):i.push({index:h,object:a,type:a.type})}),i.forEach(a=>{const h=`${e}.children.${a.index}`;this.parseObject3D({url:h,resource:a.object,configMap:n,resourceMap:r}),s.children.push(n.get(h).vid)})}t.animations&&t.animations.length&&Array.isArray(t.animations)&&t.animations.forEach((i,a)=>{const h=`${e}.animations.${a}`;this.parseAnimation({url:h,resource:i,configMap:n,resourceMap:r})})}}class m extends T{constructor(){super()}}class E extends o.Parser{constructor(){super();u(this,"object3DParser",new T);u(this,"selector",(e,t,n)=>t.parser&&t.animations&&t.scene&&t.scenes&&n.get(E)||null)}parse({url:e,resource:t,configMap:n,resourceMap:r}){this.object3DParser.parse({url:`${e}.scene`,resource:t.scene,configMap:n,resourceMap:r}),t.animations.forEach((s,i)=>{this.object3DParser.parseAnimation({url:`${e}.animations.${i}`,resource:s,configMap:n,resourceMap:r})})}}class y extends o.Parser{constructor(){super(...arguments);u(this,"selector",(e,t,n)=>t instanceof HTMLCanvasElement&&n.get(y)||null)}parse({url:e,resource:t,configMap:n,resourceMap:r}){const s=o.CONFIGFACTORY[o.CONFIGTYPE.CANVASTEXTURE]();s.url=e,r.set(e,t),n.set(e,s)}}class p extends o.Parser{constructor(){super(...arguments);u(this,"selector",(e,t,n)=>t instanceof HTMLImageElement&&n.get(p)||null)}parse({url:e,resource:t,configMap:n,resourceMap:r}){const s=o.CONFIGFACTORY[o.CONFIGTYPE.IMAGETEXTURE]();s.url=e,r.set(e,t),n.set(e,s)}}class F extends o.Parser{constructor(){super(...arguments);u(this,"selector",(e,t,n)=>t instanceof HTMLVideoElement&&n.get(F)||null)}parse({url:e,resource:t,configMap:n,resourceMap:r}){const s=o.CONFIGFACTORY[o.CONFIGTYPE.VIDEOTEXTURE]();s.url=e,r.set(e,t),n.set(e,s)}}class v extends o.Parser{constructor(){super(...arguments);u(this,"selector",(e,t,n)=>t instanceof c.Texture&&n.get(v)||null)}parse({url:e,resource:t,configMap:n,resourceMap:r}){const s=o.CONFIGFACTORY[o.CONFIGTYPE.LOADTEXTURE]();s.url=e,r.set(e,t),n.set(e,s)}}class P extends o.Parser{constructor(e="css3D"){super();u(this,"type");u(this,"selector",(e,t,n)=>t instanceof HTMLElement&&n.get(P)||null);this.type=e}parse({url:e,resource:t,configMap:n,resourceMap:r}){const s=o.CONFIGFACTORY[this.type==="css3D"?o.CONFIGTYPE.CSS3DPLANE:o.CONFIGTYPE.CSS2DPLANE]();s.element=e,r.set(e,t),n.set(e,s)}}l.FBXResourceParser=m,l.GLTFResourceParser=E,l.HTMLCanvasElementParser=y,l.HTMLElementParser=P,l.HTMLImageElementParser=p,l.HTMLVideoElementParser=F,l.Object3DParser=T,l.TextureParser=v,Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
