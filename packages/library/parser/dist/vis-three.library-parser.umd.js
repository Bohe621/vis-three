(function(l,c){typeof exports=="object"&&typeof module!="undefined"?c(exports,require("three"),require("uuid"),require("@vis-three/utils"),require("@vis-three/middleware")):typeof define=="function"&&define.amd?define(["exports","three","uuid","@vis-three/utils","@vis-three/middleware"],c):(l=typeof globalThis!="undefined"?globalThis:l||self,c((l["vis-three"]=l["vis-three"]||{},l["vis-three"]["library-parser"]={}),l.three,l.uuid,l.utils,l.middleware))})(this,function(l,c,u,C,i){"use strict";var N=Object.defineProperty;var G=(l,c,u)=>c in l?N(l,c,{enumerable:!0,configurable:!0,writable:!0,value:u}):l[c]=u;var f=(l,c,u)=>(G(l,typeof c!="symbol"?c+"":c,u),u);class T extends i.Parser{constructor(){super(...arguments);f(this,"selector",(t,e,n)=>e.isObject3D&&n.get(T)||null)}parse(t){this.parseObject3D(t)}parseAnimation({url:t,resource:e,configMap:n,resourceMap:o}){o.set(t,e);const s=i.CONFIGFACTORY[i.CONFIGTYPE.LOADANIMATIONCLIP]();s.vid=u.v4(),s.url=t,s.name=e.name,n.set(t,s)}parseColor(t){return`rgb(${Math.round(255*t.r)}, ${Math.round(255*t.g)}, ${Math.round(255*t.b)})`}attributeEnhance(t){const e={};for(const n in t)n.startsWith("_")?e[n.slice(1)]=t[n]:e[n]=t[n];return e}parseTexture({url:t,resource:e,configMap:n,resourceMap:o}){o.set(t,e);const s=i.CONFIGFACTORY[i.CONFIGTYPE.LOADTEXTURE]();n.set(t,s),s.vid=u.v4(),s.url=t,C.syncObject(e,s,{type:!0,vid:!0,url:!0})}parseMaterial({url:t,resource:e,configMap:n,resourceMap:o}){if(o.set(t,e),!i.CONFIGFACTORY[e.type]){console.warn("can not found support config in vis for this resource",e);return}const s=i.CONFIGFACTORY[e.type]();n.set(t,s),s.vid=u.v4(),C.syncObject(this.attributeEnhance(e),s,{type:!0,vid:!0});for(const r in e)if(!!e[r]){if(e[r].isColor)s[r]=this.parseColor(e[r]);else if(r.toLocaleLowerCase().endsWith("map")&&e[r]){const a=`${t}.${r}`;this.parseTexture({url:a,resource:e[r],configMap:n,resourceMap:o}),s[r]=n.get(a).vid}}}parseGeometry({url:t,resource:e,configMap:n,resourceMap:o}){o.set(t,e),e.computeBoundingBox();const s=e.boundingBox,r=s.getCenter(new c.Vector3),a=i.CONFIGFACTORY[i.CONFIGTYPE.LOADGEOMETRY]();a.vid=u.v4(),a.url=t,a.position.x=r.x/(s.max.x-s.min.x)*2,a.position.y=r.y/(s.max.y-s.min.y)*2,a.position.z=r.z/(s.max.z-s.min.z)*2,n.set(t,a)}parseSkeleton({url:t,resource:e,configMap:n,resourceMap:o}){const s=i.CONFIGFACTORY[i.CONFIGTYPE.SKELETON]();s.vid=u.v4();const r=new WeakMap;for(const[a,O]of o.entries())O instanceof c.Bone&&r.set(O,n.get(a));for(const a of e.bones){if(!r.has(a)){console.warn("object3D parser can not fond bone in configMap",a);continue}s.bones.push(r.get(a).vid)}n.set(t,s)}parseObject3D({url:t,resource:e,configMap:n,resourceMap:o}){if(o.set(t,e),!i.CONFIGFACTORY[e.type]){console.warn("can not found support config in middleware module for this resource",e);return}const s=i.CONFIGFACTORY[e.type]();if(s.vid=u.v4(),C.syncObject(e,s,{type:!0,vid:!0,children:!0,geometry:!0,material:!0,parent:!0,lookAt:!0,skeleton:!0}),s.rotation.x=e.rotation.x,s.rotation.y=e.rotation.y,s.rotation.z=e.rotation.z,n.set(t,s),e.material)if(Array.isArray(e.material))s.material=[],e.material.forEach((r,a,O)=>{const I=`${t}.material.${a}`;this.parseMaterial({url:I,resource:r,configMap:n,resourceMap:o}),s.material.push(n.get(I).vid)});else{const r=`${t}.material`;this.parseMaterial({url:r,resource:e.material,configMap:n,resourceMap:o}),s.material=n.get(r).vid}if(e.geometry){const r=`${t}.geometry`;this.parseGeometry({url:r,resource:e.geometry,configMap:n,resourceMap:o}),s.geometry=n.get(r).vid}if(e.skeleton){const r=`${t}.skeleton`;this.parseSkeleton({url:r,resource:e.skeleton,configMap:n,resourceMap:o}),s.skeleton=n.get(r).vid}if(e.children&&e.children.length){const r=[];e.children.forEach((a,O)=>{a.type==="Bone"?r.unshift({index:O,object:a,type:a.type}):r.push({index:O,object:a,type:a.type})}),r.forEach(a=>{const O=`${t}.children.${a.index}`;this.parseObject3D({url:O,resource:a.object,configMap:n,resourceMap:o}),s.children.push(n.get(O).vid)})}}}class A extends T{constructor(){super()}}class E extends i.Parser{constructor(){super();f(this,"object3DParser",new T);f(this,"selector",(t,e,n)=>e.parser&&e.animations&&e.scene&&e.scenes&&n.get(E)||null)}parse({url:t,resource:e,configMap:n,resourceMap:o}){this.object3DParser.parse({url:`${t}.scene`,resource:e.scene,configMap:n,resourceMap:o}),e.animations.forEach((s,r)=>{this.object3DParser.parseAnimation({url:`${t}.animations.${r}`,resource:s,configMap:n,resourceMap:o})})}}class p extends i.Parser{constructor(){super(...arguments);f(this,"selector",(t,e,n)=>e instanceof HTMLCanvasElement&&n.get(p)||null)}parse({url:t,resource:e,configMap:n,resourceMap:o}){const s=i.CONFIGFACTORY[i.CONFIGTYPE.CANVASTEXTURE]();s.url=t,o.set(t,e),n.set(t,s)}}class y extends i.Parser{constructor(){super(...arguments);f(this,"selector",(t,e,n)=>e instanceof HTMLImageElement&&n.get(y)||null)}parse({url:t,resource:e,configMap:n,resourceMap:o}){const s=i.CONFIGFACTORY[i.CONFIGTYPE.IMAGETEXTURE]();s.url=t,o.set(t,e),n.set(t,s)}}class F extends i.Parser{constructor(){super(...arguments);f(this,"selector",(t,e,n)=>e instanceof HTMLVideoElement&&n.get(F)||null)}parse({url:t,resource:e,configMap:n,resourceMap:o}){const s=i.CONFIGFACTORY[i.CONFIGTYPE.VIDEOTEXTURE]();s.url=t,o.set(t,e),n.set(t,s)}}class v extends i.Parser{constructor(){super(...arguments);f(this,"selector",(t,e,n)=>e instanceof c.Texture&&n.get(v)||null)}parse({url:t,resource:e,configMap:n,resourceMap:o}){const s=i.CONFIGFACTORY[i.CONFIGTYPE.LOADTEXTURE]();s.url=t,o.set(t,e),n.set(t,s)}}class P extends i.Parser{constructor(t="css3D"){super();f(this,"type");f(this,"selector",(t,e,n)=>e instanceof HTMLElement&&n.get(P)||null);this.type=t}parse({url:t,resource:e,configMap:n,resourceMap:o}){const s=i.CONFIGFACTORY[this.type==="css3D"?i.CONFIGTYPE.CSS3DPLANE:i.CONFIGTYPE.CSS2DPLANE]();s.element=t,o.set(t,e),n.set(t,s)}}l.FBXResourceParser=A,l.GLTFResourceParser=E,l.HTMLCanvasElementParser=p,l.HTMLElementParser=P,l.HTMLImageElementParser=y,l.HTMLVideoElementParser=F,l.Object3DParser=T,l.TextureParser=v,Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
