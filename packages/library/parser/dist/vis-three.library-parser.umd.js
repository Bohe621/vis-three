(function(l,c){typeof exports=="object"&&typeof module!="undefined"?c(exports,require("three"),require("uuid"),require("@vis-three/utils"),require("@vis-three/middleware")):typeof define=="function"&&define.amd?define(["exports","three","uuid","@vis-three/utils","@vis-three/middleware"],c):(l=typeof globalThis!="undefined"?globalThis:l||self,c((l["vis-three"]=l["vis-three"]||{},l["vis-three"]["library-parser"]={}),l.three,l.uuid,l.utils,l.middleware))})(this,function(l,c,f,C,a){"use strict";var P=Object.defineProperty;var A=(l,c,f)=>c in l?P(l,c,{enumerable:!0,configurable:!0,writable:!0,value:f}):l[c]=f;var T=(l,c,f)=>(A(l,typeof c!="symbol"?c+"":c,f),f);class u extends a.Parser{constructor(){super(...arguments);T(this,"selector",(e,t,s)=>t.isObject3D&&s.get(u)||null)}parse(e){this.parseObject3D(e)}parseAnimation({url:e,resource:t,configMap:s,resourceMap:r}){r.set(e,t);const n=a.CONFIGFACTORY[a.CONFIGTYPE.LOADANIMATIONCLIP]();n.vid=f.v4(),n.url=e,n.name=t.name,s.set(e,n)}parseColor(e){return`rgb(${Math.round(255*e.r)}, ${Math.round(255*e.g)}, ${Math.round(255*e.b)})`}attributeEnhance(e){const t={};for(const s in e)s.startsWith("_")?t[s.slice(1)]=e[s]:t[s]=e[s];return t}parseTexture({url:e,resource:t,configMap:s,resourceMap:r}){r.set(e,t);const n=a.CONFIGFACTORY[a.CONFIGTYPE.LOADTEXTURE]();s.set(e,n),n.vid=f.v4(),n.url=e,C.syncObject(t,n,{type:!0,vid:!0,url:!0})}parseMaterial({url:e,resource:t,configMap:s,resourceMap:r}){if(r.set(e,t),!a.CONFIGFACTORY[t.type]){console.warn("can not found support config in vis for this resource",t);return}const n=a.CONFIGFACTORY[t.type]();s.set(e,n),n.vid=f.v4(),C.syncObject(this.attributeEnhance(t),n,{type:!0,vid:!0});for(const i in t)if(!!t[i]){if(t[i].isColor)n[i]=this.parseColor(t[i]);else if(i.toLocaleLowerCase().endsWith("map")&&t[i]){const o=`${e}.${i}`;this.parseTexture({url:o,resource:t[i],configMap:s,resourceMap:r}),n[i]=s.get(o).vid}}}parseGeometry({url:e,resource:t,configMap:s,resourceMap:r}){r.set(e,t),t.computeBoundingBox();const n=t.boundingBox,i=n.getCenter(new c.Vector3),o=a.CONFIGFACTORY[a.CONFIGTYPE.LOADGEOMETRY]();o.vid=f.v4(),o.url=e,o.position.x=i.x/(n.max.x-n.min.x)*2,o.position.y=i.y/(n.max.y-n.min.y)*2,o.position.z=i.z/(n.max.z-n.min.z)*2,s.set(e,o)}parseSkeleton({url:e,resource:t,configMap:s,resourceMap:r}){const n=a.CONFIGFACTORY[a.CONFIGTYPE.SKELETON]();n.vid=f.v4();const i=new WeakMap;for(const[o,h]of r.entries())h instanceof c.Bone&&i.set(h,s.get(o));for(const o of t.bones){if(!i.has(o)){console.warn("object3D parser can not fond bone in configMap",o);continue}n.bones.push(i.get(o).vid)}t.boneInverses.length&&(n.boneInverses=t.boneInverses.map(o=>[].concat(o.elements))),s.set(e,n)}parseObject3D({url:e,resource:t,configMap:s,resourceMap:r}){if(r.set(e,t),!a.CONFIGFACTORY[t.type]){console.warn("can not found support config in middleware module for this resource",t);return}const n=a.CONFIGFACTORY[t.type]();if(n.vid=f.v4(),C.syncObject(t,n,{type:!0,vid:!0,children:!0,geometry:!0,material:!0,parent:!0,lookAt:!0,skeleton:!0}),n.rotation.x=t.rotation.x,n.rotation.y=t.rotation.y,n.rotation.z=t.rotation.z,t.isMesh&&t.morphTargetInfluences&&t.morphTargetInfluences.length&&(n.morphTargetInfluences=[...t.morphTargetInfluences],n.morphTargetDictionary={...t.morphTargetDictionary}),t.isSkinnedMesh&&(n.bindMatrix=[].concat(t.bindMatrix.elements)),s.set(e,n),t.material)if(Array.isArray(t.material))n.material=[],t.material.forEach((i,o,h)=>{const I=`${e}.material.${o}`;this.parseMaterial({url:I,resource:i,configMap:s,resourceMap:r}),n.material.push(s.get(I).vid)});else{const i=`${e}.material`;this.parseMaterial({url:i,resource:t.material,configMap:s,resourceMap:r}),n.material=s.get(i).vid}if(t.geometry){const i=`${e}.geometry`;this.parseGeometry({url:i,resource:t.geometry,configMap:s,resourceMap:r}),n.geometry=s.get(i).vid}if(t.skeleton){const i=`${e}.skeleton`;this.parseSkeleton({url:i,resource:t.skeleton,configMap:s,resourceMap:r}),n.skeleton=s.get(i).vid}if(t.children&&t.children.length){const i=[];t.children.forEach((o,h)=>{o.type==="Bone"?i.unshift({index:h,object:o,type:o.type}):i.push({index:h,object:o,type:o.type})}),i.forEach(o=>{const h=`${e}.children.${o.index}`;this.parseObject3D({url:h,resource:o.object,configMap:s,resourceMap:r}),n.children.push(s.get(h).vid)})}t.animations&&t.animations.length&&Array.isArray(t.animations)&&t.animations.forEach((i,o)=>{const h=`${e}.animations.${o}`;this.parseAnimation({url:h,resource:i,configMap:s,resourceMap:r})})}}class g extends u{constructor(){super()}}class p extends a.Parser{constructor(){super();T(this,"object3DParser",new u);T(this,"selector",(e,t,s)=>t.parser&&t.animations&&t.scene&&t.scenes&&s.get(p)||null)}parse({url:e,resource:t,configMap:s,resourceMap:r}){this.object3DParser.parse({url:`${e}.scene`,resource:t.scene,configMap:s,resourceMap:r}),t.animations.forEach((n,i)=>{this.object3DParser.parseAnimation({url:`${e}.animations.${i}`,resource:n,configMap:s,resourceMap:r})})}}class y extends a.Parser{constructor(){super(...arguments);T(this,"selector",(e,t,s)=>t instanceof HTMLCanvasElement&&s.get(y)||null)}parse({url:e,resource:t,configMap:s,resourceMap:r}){const n=a.CONFIGFACTORY[a.CONFIGTYPE.CANVASTEXTURE]();n.url=e,r.set(e,t),s.set(e,n)}}class E extends a.Parser{constructor(){super(...arguments);T(this,"selector",(e,t,s)=>t instanceof HTMLImageElement&&s.get(E)||null)}parse({url:e,resource:t,configMap:s,resourceMap:r}){const n=a.CONFIGFACTORY[a.CONFIGTYPE.IMAGETEXTURE]();n.url=e,r.set(e,t),s.set(e,n)}}class m extends a.Parser{constructor(){super(...arguments);T(this,"selector",(e,t,s)=>t instanceof HTMLVideoElement&&s.get(m)||null)}parse({url:e,resource:t,configMap:s,resourceMap:r}){const n=a.CONFIGFACTORY[a.CONFIGTYPE.VIDEOTEXTURE]();n.url=e,r.set(e,t),s.set(e,n)}}class F extends a.Parser{constructor(){super(...arguments);T(this,"selector",(e,t,s)=>t instanceof c.Texture&&s.get(F)||null)}parse({url:e,resource:t,configMap:s,resourceMap:r}){const n=a.CONFIGFACTORY[a.CONFIGTYPE.LOADTEXTURE]();n.url=e,r.set(e,t),s.set(e,n)}}class v extends a.Parser{constructor(e="css3D"){super();T(this,"type");T(this,"selector",(e,t,s)=>t instanceof HTMLElement&&s.get(v)||null);this.type=e}parse({url:e,resource:t,configMap:s,resourceMap:r}){const n=a.CONFIGFACTORY[this.type==="css3D"?a.CONFIGTYPE.CSS3DPLANE:a.CONFIGTYPE.CSS2DPLANE]();n.element=e,r.set(e,t),s.set(e,n)}}l.FBXResourceParser=g,l.GLTFResourceParser=p,l.HTMLCanvasElementParser=y,l.HTMLElementParser=v,l.HTMLImageElementParser=E,l.HTMLVideoElementParser=m,l.Object3DParser=u,l.TextureParser=F,Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
