(function(m,u){typeof exports=="object"&&typeof module<"u"?u(exports,require("@vis-three/core"),require("@vis-three/tdcm"),require("@vis-three/utils"),require("three"),require("@vis-three/convenient")):typeof define=="function"&&define.amd?define(["exports","@vis-three/core","@vis-three/tdcm","@vis-three/utils","three","@vis-three/convenient"],u):(m=typeof globalThis<"u"?globalThis:m||self,u((m["vis-three"]=m["vis-three"]||{},m["vis-three"]["plugin-path-support-controls"]={}),m.core,m.tdcm,m.utils,m.three,m.convenient))})(this,function(m,u,g,E,c,v){"use strict";const I="@vis-three/plugin-path-support-controls",M=new c.CanvasTexture(new v.CanvasGenerator({width:32,height:32}).draw(r=>{r.beginPath(),r.fillStyle="rgba(0, 0, 0, 0)",r.fillRect(0,0,32,32),r.closePath(),r.beginPath(),r.fillStyle="rgb(0, 255, 238)",r.strokeStyle="black",r.lineWidth=1,r.arc(16,16,15,0,2*Math.PI),r.stroke(),r.fill(),r.closePath()}).getDom()),b=new c.CanvasTexture(new v.CanvasGenerator({width:32,height:32}).draw(r=>{r.beginPath(),r.fillStyle="rgba(0, 0, 0, 0)",r.fillRect(0,0,32,32),r.closePath(),r.beginPath(),r.fillStyle="rgb(255, 248, 0)",r.strokeStyle="black",r.lineWidth=1,r.arc(16,16,15,0,2*Math.PI),r.stroke(),r.fill(),r.closePath()}).getDom());new c.CanvasTexture(new v.CanvasGenerator({width:32,height:32}).draw(r=>{r.beginPath(),r.fillStyle="rgba(0, 0, 0, 0)",r.fillRect(0,0,32,32),r.closePath(),r.beginPath(),r.fillStyle="rgb(255, 0, 0)",r.strokeStyle="black",r.lineWidth=1,r.moveTo(1,0),r.lineTo(31,16),r.lineTo(0,31),r.lineTo(1,0),r.stroke(),r.fill(),r.closePath()}).getDom());const d=class d extends c.Object3D{constructor(i,a,s,n){super(),this.dragging=!1,this.raycaster=new c.Raycaster,this.anchorGizmo=new c.Points(new c.BufferGeometry,d.anchorMaterial),this.moveGizmo=new c.Points(new c.BufferGeometry,d.moveMaterial),this.moveHelper=new c.LineSegments(new c.BufferGeometry,d.moveHelperMaterial),this.plane=new c.Plane,this.cachePlaneVector3=new c.Vector3,this.cacheQuaternion=new c.Quaternion,this.cacheNormal=new c.Vector3,this.cachePosition=new c.Vector3,this.cacheMouseDownPoistion=new c.Vector3,this.cacheMouseMoveDirection=new c.Vector3,this.cacheConfigIndex=0,this.moveCurveIndexMap={},this.helperRangeMap={},this.currentIndex=0,this.pathType=2,this._pointerHover=this.pointerHover.bind(this),this._pointerMove=this.pointerMove.bind(this),this._pointerDown=this.pointerDown.bind(this),this._pointerUp=this.pointerUp.bind(this),this.anchorGizmo.type="PathSupportControlsAnchorGizmo",this.moveGizmo.type="PathSupportControlsMoveGizmo",this.moveHelper.type="PathSupportControlsMoveHelper",this.moveHelper.raycast=()=>{},this.add(this.anchorGizmo,this.moveGizmo,this.moveHelper),this.renderOrder=1/0,this.matrixAutoUpdate=!1,s&&this.setObject(s),n&&this.setConfig(n),this.setDom(a).setCamera(i).connect()}setDom(i){return this.domElement&&this.disconnect(),this.domElement=i,this.connect(),this}setCamera(i){return this.camera=i,this}setObject(i){return this.object=i,this.matrix=i.matrix,this.matrixWorld=i.matrixWorld,this.cacheObjectInvert=i.matrixWorld.clone().invert(),i.parent.add(this),this}setConfig(i){this.config=i,this.moveCurveIndexMap={},this.helperRangeMap={};const a=this.moveCurveIndexMap,s=this.helperRangeMap,n=[],t=[],o=[];this.config.type==="Path"?(this.pathType=2,this.config.curves.forEach((e,p,h)=>{p===h.length-1?n.push(e.params[0],e.params[1],0,e.params[e.params.length-2],e.params[e.params.length-1],0):n.push(e.params[0],e.params[1],0),e.curve==="arc"?(t.push(e.params[2],e.params[3],0),a[t.length/3-1]={segmentIndex:p,type:"c1"}):e.curve==="bezier"||e.curve==="cubic"?(t.push(e.params[2],e.params[3],0),o.push(e.params[0],e.params[1],0,e.params[2],e.params[3],0),a[t.length/3-1]={segmentIndex:p,type:"c1"},t.push(e.params[4],e.params[5],0),o.push(e.params[e.params.length-2],e.params[e.params.length-1],0,e.params[4],e.params[5],0),a[t.length/3-1]={segmentIndex:p,type:"c2"},s[p]={startIndex:o.length/3-4,previous:!1},s[p+1]={startIndex:o.length/3-4,previous:!0}):e.curve==="quadratic"&&(t.push(e.params[2],e.params[3],0),o.push(e.params[0],e.params[1],0,e.params[2],e.params[3],0,e.params[e.params.length-2],e.params[e.params.length-1],0,e.params[2],e.params[3],0),a[t.length/3-1]={segmentIndex:p,type:"c1"},s[p]={startIndex:o.length/3-4,previous:!1},s[p+1]={startIndex:o.length/3-4,previous:!0})})):this.config.type==="Path3"&&(this.pathType=3,this.config.curves.forEach((e,p,h)=>{p===h.length-1?n.push(e.params[0],e.params[1],e.params[2],e.params[e.params.length-3],e.params[e.params.length-2],e.params[e.params.length-1]):n.push(e.params[0],e.params[1],e.params[2]),e.curve==="cubic"?(t.push(e.params[3],e.params[4],e.params[5]),o.push(e.params[0],e.params[1],e.params[2],e.params[3],e.params[4],e.params[5]),a[t.length/3-1]={segmentIndex:p,type:"c1"},t.push(e.params[6],e.params[7],e.params[8]),o.push(e.params[e.params.length-3],e.params[e.params.length-2],e.params[e.params.length-1],e.params[6],e.params[7],e.params[8]),a[t.length/3-1]={segmentIndex:p,type:"c2"},s[p]={startIndex:o.length/3-4,previous:!1},s[p+1]={startIndex:o.length/3-4,previous:!0}):e.curve==="quadratic"&&(t.push(e.params[3],e.params[4],e.params[5]),o.push(e.params[0],e.params[1],e.params[2],e.params[3],e.params[4],e.params[5],e.params[e.params.length-3],e.params[e.params.length-2],e.params[e.params.length-1],e.params[3],e.params[4],e.params[5]),a[t.length/3-1]={segmentIndex:p,type:"c1"},s[p]={startIndex:o.length/3-4,previous:!1},s[p+1]={startIndex:o.length/3-4,previous:!0})}));const l=function(e,p){const h=e.geometry;h.setAttribute("position",new c.BufferAttribute(new Float32Array(p),3).setUsage(c.DynamicDrawUsage)),h.getAttribute("position").needsUpdate=!0,h.computeBoundingBox(),h.computeBoundingSphere()};return l(this.anchorGizmo,n),l(this.moveGizmo,t),l(this.moveHelper,o),this}update(){this.setConfig(this.config)}updateHelper(i){const a=this.helperRangeMap;if(a[i]!==void 0){const{startIndex:s,previous:n}=a[i],t=n?this.config.curves[i-1]:this.config.curves[i],o=this.moveHelper.geometry.getAttribute("position");t.curve==="bezier"||t.curve==="cubic"?this.pathType===2?(o.setXYZ(s,t.params[0],t.params[1],0),o.setXYZ(s+1,t.params[2],t.params[3],0),o.setXYZ(s+2,t.params[t.params.length-2],t.params[t.params.length-1],0),o.setXYZ(s+3,t.params[4],t.params[5],0)):this.pathType===3&&(o.setXYZ(s,t.params[0],t.params[1],t.params[2]),o.setXYZ(s+1,t.params[3],t.params[4],t.params[5]),o.setXYZ(s+2,t.params[t.params.length-3],t.params[t.params.length-2],t.params[t.params.length-1]),o.setXYZ(s+3,t.params[6],t.params[7],t.params[8])):t.curve==="quadratic"&&(this.pathType===2?(o.setXYZ(s,t.params[0],t.params[1],0),o.setXYZ(s+1,t.params[2],t.params[3],0),o.setXYZ(s+2,t.params[t.params.length-2],t.params[t.params.length-1],0),o.setXYZ(s+3,t.params[2],t.params[3],0)):this.pathType===3&&(o.setXYZ(s,t.params[0],t.params[1],t.params[2]),o.setXYZ(s+1,t.params[3],t.params[4],t.params[5]),o.setXYZ(s+2,t.params[t.params.length-3],t.params[t.params.length-2],t.params[t.params.length-1]),o.setXYZ(s+3,t.params[3],t.params[4],t.params[5]))),o.needsUpdate=!0}return this}use(i){this.pointerManager=i}connect(){return this.object&&this.config&&(this.domElement.addEventListener("pointermove",this._pointerHover),this.domElement.addEventListener("mousedown",this._pointerDown)),this}disconnect(){return this.domElement.removeEventListener("pointermove",this._pointerHover),this.domElement.removeEventListener("mousedown",this._pointerDown),this}dispose(){const i=a=>{a.geometry.dispose(),Array.isArray(a.material)?a.material.forEach(s=>{s.dispose()}):a.material.dispose()};i(this.anchorGizmo),i(this.moveGizmo)}intersectPoint(i){this.raycaster.setFromCamera(this.pointerManager.mouse,this.camera);const a=this.raycaster.intersectObject(this,!0);return a.length?(this.currentGuizmo=a[0].object,this.currentIndex=a[0].index,{guizmo:this.currentGuizmo,index:this.currentIndex,point:a[0].point}):null}intersectPlane(i){return this.raycaster.setFromCamera(this.pointerManager.mouse,this.camera),this.raycaster.ray.intersectPlane(this.plane,this.cachePlaneVector3)}pointerHover(i){if(this.dragging||!this.visible)return;const a=this.intersectPoint(i);Number.isInteger(a==null?void 0:a.index)?this.domElement.style.cursor="move":this.domElement.style.cursor=""}pointerDown(i){if(!this.visible||i.button!==0)return;const a=this.intersectPoint(i);if(a){this.dragging=!0,this.pathType===2?(this.cacheQuaternion.setFromRotationMatrix(this.object.matrixWorld),this.cacheNormal.set(0,0,1).applyQuaternion(this.cacheQuaternion),this.cachePosition.setFromMatrixPosition(this.object.matrixWorld),this.plane.set(this.cacheNormal,this.cachePosition.projectOnVector(this.cacheNormal).length())):this.pathType===3&&(this.camera.getWorldPosition(this.plane.normal).sub(a.point).normalize(),this.plane.constant=(a.point.dot(this.plane.normal)>0?1:-1)*a.point.projectOnVector(this.plane.normal).length()),this.cacheMouseDownPoistion.copy(this.intersectPlane(i)).sub(this.cachePosition);const s=this.currentIndex===this.config.curves.length?this.currentIndex-1:this.currentIndex;this.dispatchEvent({type:"mousedown",index:s,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:this.currentGuizmo===this.moveGizmo?"move":"anchor"}),this.cacheConfigIndex=s,this.domElement.addEventListener("mousemove",this._pointerMove),this.domElement.addEventListener("mouseup",this._pointerUp)}}pointerMove(i){if(!this.visible&&!this.dragging)return;const a=this.intersectPlane(i);if(!a)return;a.sub(this.cachePosition).applyMatrix4(this.cacheObjectInvert),this.cacheMouseMoveDirection.copy(a).sub(this.cacheMouseDownPoistion).normalize();const s=this.currentGuizmo,n=this.currentIndex,t=this.config,o=this.cacheConfigIndex;if(s===this.anchorGizmo){const l=t.curves.length;if(n!==t.curves.length){const h=t.curves[n];h.params[0]=a.x,h.params[1]=a.y,this.pathType===3&&(h.params[2]=a.z),this.updateHelper(n)}else{const h=t.curves[l-1];this.pathType===3?(h.params[h.params.length-3]=a.x,h.params[h.params.length-2]=a.y,h.params[h.params.length-1]=a.z):(h.params[h.params.length-2]=a.x,h.params[h.params.length-1]=a.y),this.updateHelper(l-1)}const e=this.anchorGizmo.geometry.getAttribute("position"),p=e.array;p[n*3]=a.x,p[n*3+1]=a.y,this.pathType===3&&(p[n*3+2]=a.z),e.needsUpdate=!0,this.dispatchEvent({type:"changing",index:o,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:"anchor"})}else if(s===this.moveGizmo){const l=this.moveCurveIndexMap[n].segmentIndex,e=t.curves[l],p=this.moveCurveIndexMap[n].type;p==="c1"?this.pathType===2?(e.params[2]=a.x,e.params[3]=a.y):(e.params[3]=a.x,e.params[4]=a.y,e.params[5]=a.z):p==="c2"&&(this.pathType===2?(e.params[4]=a.x,e.params[5]=a.y):(e.params[6]=a.x,e.params[7]=a.y,e.params[8]=a.z));const h=this.moveGizmo.geometry.getAttribute("position"),y=h.array;y[n*3]=a.x,y[n*3+1]=a.y,this.pathType===3&&(y[n*3+2]=a.z),h.needsUpdate=!0,this.updateHelper(l),this.dispatchEvent({type:"changing",index:o,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:"move"})}}pointerUp(i){this.dragging=!1,this.domElement.removeEventListener("mousemove",this._pointerMove),this.domElement.removeEventListener("mouseup",this._pointerUp),this.currentGuizmo&&(this.currentGuizmo.geometry.computeBoundingSphere(),this.currentGuizmo.geometry.computeBoundingBox()),this.dispatchEvent({type:"mouseup",index:this.cacheConfigIndex,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:this.currentGuizmo===this.anchorGizmo?"anchor":"move"})}};d.anchorMaterial=new c.PointsMaterial({map:M,transparent:!0,depthFunc:c.AlwaysDepth,alphaTest:.01,sizeAttenuation:!1,size:15}),d.moveMaterial=new c.PointsMaterial({map:b,transparent:!0,depthFunc:c.AlwaysDepth,alphaTest:.01,sizeAttenuation:!1,size:15}),d.moveHelperMaterial=new c.LineBasicMaterial({color:"rgb(100, 100, 100)"});let f=d;const P=E.transPkgName(I),w=function(r={raycaster:{params:{Line:{threshold:5},Points:{threshold:5}}}}){let i,a;return{name:P,deps:[...g.PLUGINS,g.POINTER_MANAGER_PLUGIN],install(s){const n=new f(s.camera,s.dom);r.raycaster&&r.raycaster.params&&Object.assign(n.raycaster.params,r.raycaster.params),n.use(s.pointerManager),s.pathSupportControls=n,a=t=>{n.setDom(t.dom)},i=t=>{n.setCamera(t.camera)},s.addEventListener(u.ENGINE_EVENT.SETDOM,a),s.addEventListener(u.ENGINE_EVENT.SETCAMERA,i)},dispose(s){s.removeEventListener(u.ENGINE_EVENT.SETDOM,a),s.removeEventListener(u.ENGINE_EVENT.SETCAMERA,i),s.pathSupportControls.disconnect().dispose(),delete s.pathSupportControls}}};m.PATH_SUPPORT_CONTROLS_PLUGIN=P,m.PathSupportControlsPlugin=w,Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});
