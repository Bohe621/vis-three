(function(c,p){typeof exports=="object"&&typeof module!="undefined"?p(exports,require("@vis-three/utils"),require("uuid"),require("@vis-three/core"),require("rxjs"),require("@vis-three/plugin-loader-manager"),require("@vis-three/plugin-pointer-manager"),require("@vis-three/plugin-event-manager"),require("@vis-three/plugin-render-manager")):typeof define=="function"&&define.amd?define(["exports","@vis-three/utils","uuid","@vis-three/core","rxjs","@vis-three/plugin-loader-manager","@vis-three/plugin-pointer-manager","@vis-three/plugin-event-manager","@vis-three/plugin-render-manager"],p):(c=typeof globalThis!="undefined"?globalThis:c||self,p((c["vis-three"]=c["vis-three"]||{},c["vis-three"].middleware={}),c.utils,c.uuid,c.core,c.rxjs,c.pluginLoaderManager,c.pluginPointerManager,c.pluginEventManager,c.pluginRenderManager))})(this,function(c,p,m,w,te,O,q,W,H){"use strict";var ct=Object.defineProperty;var lt=(c,p,m)=>p in c?ct(c,p,{enumerable:!0,configurable:!0,writable:!0,value:m}):c[p]=m;var u=(c,p,m)=>(lt(c,typeof p!="symbol"?p+"":p,m),m);const S={},V={},C={},U={},F={},re={},I=r=>F[r]||null,ne=r=>U[r],se=r=>{const t=I(r);return t?ne(t):!1},z=function(r,t){re[r.type]=r,C[r.type.toLocaleUpperCase()]=r.type,S[r.type]=r.config,F[r.type]=t},A=(r,t)=>t===1/0?"Infinity":t===-1/0?"-Infinity":t,K=(r,t)=>t==="Infinity"?1/0:t==="-Infinity"?-1/0:t,L=r=>JSON.parse(JSON.stringify(r,A),K);class oe{constructor(t){u(this,"config");this.config=t}pipe(t){return this.config=t(this.config),this}get(){return this.config}}var D={stringify:A,parse:K,clone:L,Pipeline:oe},Je=Object.freeze(Object.defineProperty({__proto__:null,stringify:A,parse:K,clone:L,Pipeline:oe,default:D},Symbol.toStringTag,{value:"Module"}));const M={proxy:{expand:void 0,timing:"before",toRaw:void 0},symbol:{generator:m.v4,validator:m.validate}},Ue=function(r){Object.assign(M,r)},h=function(r,t,e={strict:!0,warn:!0}){if(!S[r])return console.error(`type: ${r} can not be found in configList.`),{vid:"",type:r};const n=(a,i)=>{for(const l in i){if(a[l]===void 0){!e.strict&&(a[l]=i[l]),e.strict&&e.warn&&console.warn(`'${r}' config can not set key: ${l}`);continue}typeof i[l]=="object"&&i[l]!==null&&!Array.isArray(i[l])?(a[l]===null&&(a[l]={...i[l]}),n(a[l],i[l])):a[l]=i[l]}};let s=S[r]();[C.SCRIPTANIMATION,C.KEYFRAMEANIMATION].includes(r)&&(e.strict=!1),s.vid===""&&(s.vid=M.symbol.generator()),t&&n(s,t),!e.handler&&(e.handler=M.proxy.expand),e.handler&&M.proxy.timing==="before"&&(s=e.handler(s));let o=he(s);if(e.handler&&M.proxy.timing==="after"&&(o=e.handler(o)),h.autoInject&&h.injectEngine){const a=h.injectEngine;if(a.applyConfig(o),h.injectScene&&se(s.type)&&s.type!==C.SCENE){let i=null;typeof h.injectScene=="boolean"?i=a.getObjectConfig(a.scene):typeof h.injectScene=="string"&&(i=a.getConfigBySymbol(h.injectScene)),i?i.children.push(s.vid):console.warn("current engine scene can not found it config",a,a.scene)}return o}return o};h.autoInject=!0,h.injectScene=!1,h.injectEngine=null;const ae=(r,t={})=>{let e=JSON.stringify(r,D.stringify);const n={},s=Object.keys(r).filter(a=>a!=="assets");for(const a of s)for(const i of r[a]){const l=i.vid,f=m.v4();e=e.replace(new RegExp(l,"g"),f),t.detail&&(n[l]=f)}const o=JSON.parse(e,D.parse);if(t.fillName)if(typeof t.fillName=="function")for(const a of s)for(const i of o[a])i.name||(i.name=t.fillName(i));else for(const a of s)for(const i of o[a])i.name||(i.name=`${i.type}-${i.vid.slice(-2)}`);return t.detail?{config:o,detail:n}:o},X=(r,t,e={clone:!0,assets:!1})=>{const n=e.clone?D.clone(r):r,s=e.assets?Object.keys(n):Object.keys(n).filter(o=>o!=="assets");for(const o of s)n[o].forEach((i,l,f)=>{f[l]=t(i)});return n},ie=function(r){const t={};for(const e of Object.keys(r))for(const n of r[e])t[n.name]=n;return t},ce=function(r,t){return typeof r=="string"&&(r=JSON.parse(r,D.parse)),X(D.clone(r),e=>(e=h(e.type,e),t?t(e):e))};var Ie={clone:ae,handler:X,planish:ie,observable:ce},xe=Object.freeze(Object.defineProperty({__proto__:null,clone:ae,handler:X,planish:ie,observable:ce,default:Ie},Symbol.toStringTag,{value:"Module"}));class le{constructor(){u(this,"list",[]);u(this,"timer");u(this,"time",0)}exec(t){if(t(!1))return;this.list.includes(t)||this.list.push(t);let e=0;const n=()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const s=[];for(const o of this.list)o(!1)||s.push(o);if(s.length)if(s.length===e){for(const o of s)o(!0);this.list=[]}else e=s.length,this.list=s,n();else this.list=[]},this.time)};n()}append(t){this.list.length&&!this.list.includes(t)?this.list.push(t):this.exec(t)}nextTick(t){setTimeout(()=>{t()},this.time)}}const Ge=new le;class Be{constructor(){u(this,"map",new WeakMap)}create(t){if(this.map.has(t)){console.warn("object is exist.",t);return}this.map.set(t,new w.EventDispatcher)}dispose(t){this.map.delete(t)}check(t){return this.map.has(t)}emit(t,e,n){if(!this.map.has(t)){console.warn("object can not create eventDispatcher please create it",t);return}this.map.get(t).emit(e,n)}on(t,e,n){if(!this.map.has(t)){console.warn("object can not create eventDispatcher please create it",t);return}this.map.get(t).on(e,n)}off(t,e,n){if(!this.map.has(t)){console.warn("object can not create eventDispatcher please create it",t);return}this.map.get(t).off(e,n)}}const v=new Be;var ke=Object.freeze(Object.defineProperty({__proto__:null,compilerEvent:v},Symbol.toStringTag,{value:"Module"}));const qe=function(){return m.v4()};var ue=(r=>(r.ADD="compiler.add",r.REMOVE="compiler.remove",r.COMPILE="compiler.compile",r.UPDATE="compiler.update",r))(ue||{});class We{constructor(){u(this,"MODULE","");u(this,"processors",new Map);u(this,"target",{});u(this,"map",new Map);u(this,"weakMap",new WeakMap);u(this,"engine");u(this,"cacheCompile")}getMap(){return this.map}useEngine(t){return this.engine=t,this}setTarget(t){return this.target=t,this}add(t){if(!this.processors.has(t.type))return console.warn(`${this.MODULE} compiler can not support this type: ${t.type}`),null;const n=this.processors.get(t.type).create(t,this.engine,this);return this.map.set(t.vid,n),this.weakMap.set(n,t.vid),v.create(n),v.emit(n,"compiler.add"),n}remove(t){const e=t.vid;if(!this.map.has(e))return console.warn(`${this.MODULE} compiler can not found this vid object: ${e}.`),this;if(!this.processors.has(t.type))return console.warn(`${this.MODULE} compiler can not support this type: ${t.type}`),this;const n=this.map.get(e);return this.processors.get(t.type).dispose(n,this.engine,this),this.map.delete(e),this.weakMap.delete(n),v.emit(n,"compiler.remove"),v.dispose(n),this.cacheCompile&&this.cacheCompile.vid===e&&(this.cacheCompile=void 0),this}cover(t){const e=t.vid;return this.map.has(e)?(Promise.resolve().then(()=>{p.syncObject(t,t,{vid:!0,type:!0})}),this):(console.warn(`${this.MODULE} compiler can not found this vid object: ${e}.`),this)}compile(t,e){const n=this.cacheCompile;let s,o,a;if(n&&n.vid===t)s=n.target,o=n.config,a=n.processor;else{if(!this.map.has(t))return console.warn(`${this.MODULE} compiler set function: can not found object which vid is: '${t}'`),this;if(!this.target[t])return console.warn(`${this.MODULE} compiler set function: can not found config which vid is: '${t}'`),this;if(s=this.map.get(t),o=this.target[t],!this.processors.has(o.type))return console.warn(`PassCompiler can not support this type: ${o.type}`),this;a=this.processors.get(o.type),this.cacheCompile={target:s,config:o,processor:a,vid:t}}return a.process({config:o,target:s,engine:this.engine,processor:a,compiler:this,...e}),v.emit(s,`compiler.compile:${e.path.join(".")}.${e.key}`),v.emit(s,"compiler.update"),this}compileAll(){const t=this.target;for(const e of Object.values(t))this.add(e);return this}dispose(){this.cacheCompile&&(this.cacheCompile=void 0);for(const t of Object.values(this.target)){if(!this.map.has(t.vid)){console.warn(`${this.MODULE} compiler set function: can not found object which vid is: '${t.vid}'`);continue}const e=this.map.get(t.vid);if(!this.processors.has(t.type)){console.warn(`${this.MODULE}  can not support this type: ${t.type}`);continue}this.processors.get(t.type).dispose(e,this.engine,this)}return this.map.clear(),this.target={},this}reigstProcessor(t,e){return this.processors.has(t.type)?(console.warn(`${this.MODULE} compiler has already exist this processor ${t.type}, that will be cover.`),this):(this.processors.set(t.type,t),z(t,this.MODULE),e(this),this)}getObjectSymbol(t){return this.weakMap.get(t)||null}getObjectBySymbol(t){return this.map.get(t)||null}}const fe=function(r,t,e){return class extends t{constructor(){super();u(this,"MODULE",r);for(const s of e)this.processors.set(s.type,s)}}},pe=new WeakMap,x=function(r){Array.isArray(r)&&pe.set(r,r.concat([]))},He=function(r){return pe.get(r)},Z="vis.father",j="vis.key",Q=function(r){let t="";const e=n=>{n[Symbol.for(j)]!==void 0&&(t=`${n[Symbol.for(j)]}${t?`.${t}`:""}`,n[Symbol.for(Z)]&&e(n[Symbol.for(Z)]))};return e(r),t},Ve=function(r){if(r.length&&p.isObject(r[0])){const t=r.length;for(let e=0;e<t;e+=1)r[e][Symbol.for(j)]=e}},G=new WeakMap,Fe=["push","pop","shift","unshift","splice","sort","reverse"],P=new WeakSet,ze=function(r,t,e){return Array.isArray(r)&&Fe.includes(t)&&P.add(r),Reflect.get(r,t,e)},Ke=function(r,t,e,n,s){const o=Q(r);if(typeof t=="symbol"||s.isIgnore(p.extendPath(o,t)))return Reflect.set(r,t,e,n);if(p.isObject(e)&&!G.has(e)&&(e=B(s,e,r)),r[t]===void 0){p.isObject(e)&&(e[Symbol.for(j)]=t,p.isArray(e)&&x(e)),p.isArray(r)&&P.delete(r);const i=Reflect.set(r,t,e);return p.isArray(r)&&x(r),s.next({operate:"add",path:o,key:t,value:e}),i}const a=Reflect.set(r,t,e);if(p.isArray(r)){if(P.has(r)&&t==="length"){const i=He(r);if(!i)return console.error("array value is not be cached:",r),a;Ve(r);const l=Math.abs(i.length-r.length),f=i.length>=r.length?"delete":"add",g=i.length>=r.length?r:i;let E=0,$e=0;for(const Te of f==="delete"?i:r){if(!g.includes(Te)&&(s.next({operate:f,path:o,key:$e.toString(),value:Te}),E+=1,E===l))break;$e+=1}return x(r),P.delete(r),a}else if(P.has(r)||t==="length")return a}return s.next({operate:"set",path:o,key:t,value:e}),a},Xe=function(r,t,e){const n=Q(r);if(typeof t=="symbol"||e.isIgnore(n))return Reflect.deleteProperty(r,t);const s=r[t],o=Reflect.deleteProperty(r,t);return p.isArray(r)||e.next({operate:"delete",path:n,key:t,value:s}),o},B=function(r,t,e){if(!p.isObject(t)||G.has(t))return t;const n=e?Q(e):"";if(r.isIgnore(n))return t;const s={get:ze,set:(a,i,l,f)=>Ke(a,i,l,f,r),deleteProperty:(a,i)=>Xe(a,i,r)};e&&(t[Symbol.for(Z)]=e);for(const a in t){const i=p.extendPath(n,a);if(!r.isIgnore(i)&&p.isObject(t[a])){if(p.isArray(t[a])){const l=t[a];t[a]=B(r,t[a],t),x(l)}else t[a]=B(r,t[a],t);t[a][Symbol.for(j)]=a}}const o=new Proxy(t,s);return r.saveRaw(o,t),G.set(o,r),o};class Ze extends te.Subject{constructor(e,n){super();u(this,"ignore",{});u(this,"target");u(this,"rawMap",new WeakMap);n&&(this.ignore=n),this.target=B(this,e)}isIgnore(e){let n=this.ignore;for(const s of e.split(".")){if(n[s]===void 0)return!1;if(typeof n[s]=="boolean"&&n[s])return!0;n=n[s]}return!1}setIgnore(e){this.ignore=e}mergeIgnore(e){this.ignore=Object.assign(this.ignore,e)}saveRaw(e,n){this.rawMap.set(e,n)}toRaw(e){return this.rawMap.get(e)}}const he=function(r,t){return new Ze(r,t).target},de=function(r){return G.get(M.proxy.toRaw?M.proxy.toRaw(r):r)},Qe=function(r,t,e){return Reflect.get(r,t,e)},Ye=function(r,t,e,n,s){if(typeof t=="symbol")return Reflect.set(r,t,e,n);if(r[t]===void 0){const o=Reflect.set(r,t,e);return s.add(e),s.next({operate:"add",path:t,key:t,value:e}),o}else{const o=Reflect.set(r,t,e);return s.remove(e.vid),s.add(e),s.next({operate:"set",path:t,key:t,value:e}),o}},_e=function(r,t,e){if(typeof t=="symbol")return Reflect.deleteProperty(r,t);const n=r[t],s=Reflect.deleteProperty(r,t);return e.next({operate:"delete",path:t,key:t,value:n}),e.remove(n.vid),s},ee=class extends te.Subject{constructor(){super();u(this,"container");u(this,"subscriptions",new Map);this.container=new Proxy(ee.generator(),{get:Qe,set:(e,n,s,o)=>Ye(e,n,s,o,this),deleteProperty:(e,n)=>_e(e,n,this)})}add(e){const n=de(e);if(!n){console.error("DataContainer: this config can not observer",e);return}this.subscriptions.set(n.target.vid,n.subscribe(s=>{this.next({operate:s.operate,path:p.extendPath(n.target.vid,s.path),key:s.key,value:s.value})}))}remove(e){this.subscriptions.delete(e)}};let $=ee;u($,"generator",M.proxy.expand?()=>M.proxy.expand({}):()=>({}));class ye{constructor(){u(this,"rule",()=>{});u(this,"members",[])}apply(t){return this.members.includes(t)||this.members.push(t),this}cancel(t){return this.members.includes(t)&&this.members.splice(this.members.indexOf(t),1),this}setRule(t){return this.rule=t,this}translate(t){const e=this.rule;for(const n of this.members)e(t,n);return this}}class me{constructor(t,e=[]){u(this,"MODULE","");u(this,"dataContainer",new $);u(this,"translater");this.translater=new ye().setRule(t),this.dataContainer.subscribe(n=>{this.translater.translate(n)});for(const n of e)this.addConfig(n)}getData(){return this.dataContainer.container}existSymbol(t){return Boolean(this.dataContainer.container[t])}addConfig(t){return this.dataContainer.container[t.vid]=t,this}getConfig(t){return this.dataContainer.container[t]}removeConfig(t){const e=this.dataContainer.container;e[t]!==void 0&&delete e[t]}addCompiler(t){return t.setTarget(this.dataContainer.container),t.compileAll(),this.translater.apply(t),this}toJSON(t=!0){return t?JSON.stringify(this.exportConfig(),A):JSON.stringify(Object.values(this.dataContainer.container),A)}exportConfig(t=!0){if(t){const e=this.dataContainer.container,n=[],s={},o=(a,i,l={})=>{for(const f in a){if(["vid","type"].includes(f)){l[f]=a[f];continue}if(typeof a[f]=="object"&&a[f]!==null){if(Array.isArray(a[f])){if(!a[f].length)continue;l[f]=a[f].map(g=>typeof g=="object"&&g!==null?L(g):g);continue}l[f]={},i[f]?(o(a[f],i[f],l[f]),Object.keys(l[f]).length===0&&delete l[f]):l[f]=L(a[f])}else i[f]!==a[f]&&(l[f]=a[f])}};for(const a of Object.values(e)){if(!s[a.type]){if(!S[a.type]){console.error(`can not font some config with: ${a.type}`);continue}s[a.type]=S[a.type]()}const i={};o(a,s[a.type],i),n.push(i)}return n}else return Object.values(L(this.dataContainer.container))}load(t){const e=this.dataContainer.container,n={},s=(o,a)=>{for(const i in a)typeof o[i]=="object"&&o[i]!==null&&typeof a[i]=="object"&&a[i]!==null?s(o[i],a[i]):o[i]===void 0&&(o[i]=a[i])};for(const o of t){if(!n[o.type]){if(!S[o.type]){console.error(`can not font some config with: ${o.type}`);continue}n[o.type]=S[o.type]()}s(o,n[o.type]),e[o.vid]=o}return this}remove(t){const e=this.dataContainer.container;for(const n of t)e[n.vid]!==void 0&&delete e[n.vid];return this}}const ge=function(r,t){return class extends me{constructor(n=[]){super(t,n);u(this,"MODULE",r)}}};class Me{constructor(t){u(this,"type");u(this,"config");u(this,"commands");u(this,"create");u(this,"dispose");this.type=t.type,this.commands=t.commands,this.create=t.create,this.dispose=t.dispose,this.config=()=>{const e=t.config();return e.type=this.type,e},C[this.type.toLocaleUpperCase()]=this.type,S[this.type]=this.config}process(t){if(!this.commands||!this.commands[t.operate]){this[t.operate](t);return}let e=this.commands[t.operate];for(const n of[].concat(t.path,t.key))if(!e[n]&&!e.$reg){this[t.operate](t);return}else if(e[n])if(typeof e[n]=="function"){e[n](t);return}else e=e[n];else if(e.$reg){for(const s of e.$reg)if(s.reg.test(n)){s.handler(t);return}}this[t.operate](t)}add(t){let e=t.target;const n=t.path;for(const s of n)if(typeof e[s]!==void 0)e=e[s];else{console.warn("processor can not exec default add operate.",t);return}e[t.key]=t.value}set(t){let e=t.target;const n=t.path;for(const s of n)if(typeof e[s]!==void 0)e=e[s];else{console.warn("processor can not exec default set operate.",t);return}e[t.key]=t.value}delete(t){let e=t.target;const n=t.path;for(const s of n)if(typeof e[s]!==void 0)e=e[s];else{console.warn("processor can not exec default delete operate.",t);return}delete e[t.key]}}const et=r=>new Me(r),tt=(r,t,e=m.validate)=>{const{operate:n,key:s,path:o,value:a}=r;let i=s;const l=o.split(".");if(o.length&&(i=l.shift()),!e(i)){console.warn(`${t.MODULE} Rule: vid is illeage: ${i}`);return}if(n==="add"&&!l.length){t.add(a);return}if(r.operate==="delete"&&!l.length){t.remove(a);return}if(r.operate==="set"&&!l.length&&s===i){t.cover(a);return}t.compile(i,{operate:n,key:s,path:l,value:a})},rt=function(){return{vid:"",type:"",name:""}},nt=function(r){return`DEFUALT-${r}`},st=function(){};class Se extends w.EventDispatcher{constructor(){super();u(this,"compilerMap",new Map)}extend(e,n=!1){this.compilerMap.has(e.MODULE)?(console.warn("compiler manager has exist this compiler",e),n&&this.compilerMap.set(e.MODULE,e)):this.compilerMap.set(e.MODULE,e)}getCompiler(e){return this.compilerMap.has(e)?this.compilerMap.get(e):(console.warn(`can not found this type in compiler manager: ${e}`),null)}getObjectSymbol(e){for(const n of this.compilerMap.values()){const s=n.getObjectSymbol(e);if(s)return s}return null}getObjectBySymbol(e){for(const n of this.compilerMap.values()){const s=n.getObjectBySymbol(e);if(s)return s}return null}getObjectfromModule(e,n){return this.compilerMap.has(e)?this.compilerMap.get(e).map.get(n)||null:(console.warn(`compiler manager can not found this module: ${e}`),null)}getObjectfromModules(e,n){Array.isArray(e)||(e=Object.keys(e));for(const s of e){if(!this.compilerMap.has(s)){console.warn(`compiler manager can not found this module: ${s}`);continue}const o=this.compilerMap.get(s);if(o.map.has(n))return o.map.get(n)}return null}dispose(){for(const e of this.compilerMap.values())e.dispose();return this.compilerMap.clear(),this}}const k="CompilerManagerPlugin",be=function(){return{name:k,install(r){const t=new Se;r.compilerManager=t,r.getObjectSymbol=function(e){return t.getObjectSymbol(e)},r.getObjectBySymbol=function(e){return t.getObjectBySymbol(e)},r.getObjectfromModule=function(e,n){return t.getObjectfromModule(e,n)},r.getObjectfromModules=function(e,n){return t.getObjectfromModules(e,n)},r.getObject3D=function(e){return t.getObjectfromModules(U,e)}},dispose(r){r.compilerManager.dispose(),delete r.compilerManager,delete r.getObjectSymbol,delete r.getObjectBySymbol,delete r.getObjectfromModule,delete r.getObjectfromModules,delete r.getObject3D}}};class Oe extends w.EventDispatcher{constructor(){super();u(this,"dataSupportMap",new Map)}extend(e,n=!1){this.dataSupportMap.has(e.MODULE)?(console.warn("dataSupport manager has exist this dataSupport",e),n&&this.dataSupportMap.set(e.MODULE,e)):this.dataSupportMap.set(e.MODULE,e)}getDataSupport(e){return this.dataSupportMap.has(e)?this.dataSupportMap.get(e):(console.warn(`can not found this type in dataSupportManager: ${e}`),null)}getConfigBySymbol(e){const n=this.dataSupportMap.values();for(const s of n){const o=s.getConfig(e);if(o)return o}return null}removeConfigBySymbol(...e){const n=this.dataSupportMap.values();for(const s of e)for(const o of n)if(o.existSymbol(s)){o.removeConfig(s);break}return this}getModuleBySymbol(e){const n=this.dataSupportMap.values();for(const s of n)if(s.existSymbol(e))return s.MODULE;return null}applyConfig(...e){for(const n of e){const s=I(n.type);s?this.dataSupportMap.get(s).addConfig(n):console.warn(`dataSupportManager can not found this config module: ${n.type}`)}return this}load(e){return this.dataSupportMap.forEach((s,o)=>{e[o]&&s.load(e[o])}),this}remove(e){return this.dataSupportMap.forEach((s,o)=>{e[o]&&s.remove(e[o])}),this}toJSON(e={},n=!0){return JSON.stringify(this.exportConfig(e,n),A)}exportConfig(e={},n=!0){return this.dataSupportMap.forEach((o,a)=>{e[a]=o.exportConfig(n)}),e}}const T="DataSupportManagerPlugin",ve=function(){return{name:T,install(r){const t=new Oe;r.dataSupportManager=t,r.applyConfig=function(...e){return t.applyConfig(...e),r},r.getConfigBySymbol=function(e){return t.getConfigBySymbol(e)},r.removeConfigBySymbol=function(...e){return t.removeConfigBySymbol(...e),r},r.toJSON=function(){return t.toJSON()},r.exportConfig=function(){return t.exportConfig()}},dispose(r){delete r.dataSupportManager,delete r.applyConfig,delete r.getConfigBySymbol,delete r.removeConfigBySymbol,delete r.toJSON,delete r.exportConfig}}};var Y=(r=>(r.MAPPED="mapped",r))(Y||{});class Ee extends w.EventDispatcher{constructor(e={}){super();u(this,"configMap",new Map);u(this,"resourceMap",new Map);u(this,"paserMap",new Map);const n=new Map;for(const s in e)n.has(s)&&console.warn(`resourceManager construct params rescource already exist: ${s}, that will be cover.`),n.set(s,e[s]);this.mappingResource(n)}addParser(e){return this.paserMap.has(e.constructor)?this:(this.paserMap.set(e.constructor,e),this)}mappingResource(e,n){const s=this.configMap,o=this.resourceMap,a=[...this.paserMap.values()],i={};for(const[l,f]of e.entries()){if((n==null?void 0:n.parser)&&n.parser[l]){n.parser[l].parse({url:l,resource:f,configMap:s,resourceMap:o});continue}if((n==null?void 0:n.selector)&&n.selector[l]){const E=n.selector[l](l,f,this.paserMap);if(!E){console.warn("resource manager hanlder can not found this resource parser: ",f,n.selector[l]);continue}E.parse({url:l,resource:f,configMap:s,resourceMap:o}),i[l]=this.getResourceConfig(l);continue}let g=null;for(const E of a)if(g=E.selector(l,f,this.paserMap),g)break;if(!g){console.warn("resouce manager can not found some handler to parser this resource:",f);continue}g.parse({url:l,resource:f,configMap:s,resourceMap:o}),i[l]=this.getResourceConfig(l)}return this.dispatchEvent({type:"mapped",configMap:s,resourceMap:o,resourceConfig:i}),this}getResourceConfig(e){const n=this.configMap,s={};return[...n.keys()].filter(o=>o.startsWith(e)).forEach(o=>{const a=n.get(o);if(!a)console.error(`unknow error: can not found config by url: ${o}`);else{const i=I(a.type);i?(!s[i]&&(s[i]=[]),s[i].push(a)):console.error(`unknow error: can not found module by type: ${a.type}`,a)}}),s}hasResource(e){return this.resourceMap.has(e)}remove(e){const n=this.configMap,s=this.resourceMap;return[...n.keys()].filter(o=>o.startsWith(e)).forEach(o=>{n.delete(o);const a=s.get(o);a.dispose&&a.dispose(),s.delete(o)}),this}dispose(){this.resourceMap.forEach((e,n)=>{e.dispose&&e.dispose()}),this.resourceMap.clear(),this.configMap.clear()}}class ot{}const _="ResourceManagerPlugin",we=function(r={}){return{name:_,install(t){const e=new Ee(r.resources);t.resourceManager=e,t.registerResources=n=>{const s=new Map;return Object.keys(n).forEach(o=>{s.set(o,n[o])}),e.mappingResource(s),t}},dispose(t){t.addEventListener(w.ENGINE_EVENT.DISPOSE,()=>{t.resourceManager.dispose()})}}},Ce="LoaderDataSupportStrategy",Ae=function(){let r,t;return{name:Ce,condition:[T,O.LOADER_MANAGER_PLUGIN],exec(e){r=e.toJSON,e.toJSON=function(){const n={assets:JSON.parse(e.loaderManager.toJSON())};return e.dataSupportManager.toJSON(n)},t=e.exportConfig,e.exportConfig=function(){let n={};return n={assets:e.loaderManager.exportConfig()},e.dataSupportManager.exportConfig(n)}},rollback(e){e.toJSON=r,e.exportConfig=t}}},De="LoaderMappingStrategy",Ne=function(){let r,t;return{name:De,condition:[_,O.LOADER_MANAGER_PLUGIN],exec(e){r=e.loadResources,e.loadResources=(n,s)=>{const o=a=>{s(void 0,a),e.resourceManager.removeEventListener(O.LOADER_EVENT.LOADED,o)};try{e.resourceManager.addEventListener(O.LOADER_EVENT.LOADED,o)}catch(a){s(a)}return e.loaderManager.reset().load(n),e},t=e.loadResourcesAsync,e.loadResourcesAsync=n=>new Promise((s,o)=>{try{e.loaderManager.once(O.LOADER_EVENT.LOADED,a=>{e.resourceManager.once(Y.MAPPED,l=>{s(l)});const i=new Map;n.forEach(l=>{typeof l=="string"?i.set(l,a.resourceMap.get(l)):i.set(l.url,a.resourceMap.get(l.url))}),e.resourceManager.mappingResource(i)})}catch(a){o(a)}e.loaderManager.reset().load(n)})},rollback(e){e.loadResources=r,e.loadResourcesAsync=t}}},Re="CompilerSupportStrategy",Le=function(){return{name:Re,condition:[k,T],exec(r){r.compilerManager.compilerMap.forEach((t,e)=>{var n;t.useEngine(r),(n=r.dataSupportManager.dataSupportMap.get(e))==null||n.addCompiler(t)})},rollback(){}}};var je=(r=>(r[r.ZERO=0]="ZERO",r[r.ONE=100]="ONE",r[r.TWO=200]="TWO",r[r.THREE=300]="THREE",r[r.FOUR=400]="FOUR",r[r.FIVE=500]="FIVE",r[r.SIX=600]="SIX",r[r.SEVEN=700]="SEVEN",r[r.EIGHT=800]="EIGHT",r[r.NINE=900]="NINE",r))(je||{});class Pe extends w.Engine{constructor(){super();u(this,"moduleLifeCycle",[]);this.install(O.LoaderManagerPlugin()).install(q.PointerManagerPlugin()).install(W.EventManagerPlugin()).install(H.RenderManagerPlugin()).install(we()).install(ve()).install(be()),this.exec(Ae()).exec(Ne()).exec(Le())}loadLifeCycle(e){const n=this.dataSupportManager,s=this.moduleLifeCycle.sort((o,a)=>o.order-a.order);for(const{module:o}of s)e[o]&&n.load({[o]:e[o]})}removeLifeCycle(e){const n=this.dataSupportManager,s=this.moduleLifeCycle.sort((l,f)=>f.order-l.order);for(const{module:l}of s)e[l]&&n.remove({[l]:e[l]});const o=e.assets||[],a=this.resourceManager,i=this.loaderManager;o.forEach(l=>{a.remove(l),i.remove(l)})}loadConfig(e,n){const s=this.renderManager.hasRendering();if(s&&this.renderManager.stop(),e.assets&&e.assets.length){const o=a=>{delete e.assets,this.loadLifeCycle(e),this.resourceManager.removeEventListener("mapped",o),n&&n(a),s?this.renderManager.play():this.renderManager.render()};this.resourceManager.addEventListener("mapped",o),this.loaderManager.reset().load(e.assets)}else this.loadLifeCycle(e),n&&n(),s?this.renderManager.play():this.renderManager.render();return this}loadConfigAsync(e){return new Promise((n,s)=>{const o=this.renderManager.hasRendering();o&&this.renderManager.stop(),e.assets&&e.assets.length?this.loadResourcesAsync(e.assets).then(a=>{delete e.assets,this.loadLifeCycle(e),o?this.renderManager.play():this.renderManager.render(),n(a)}):(this.loadLifeCycle(e),o?this.renderManager.play():this.renderManager.render(),n(void 0))})}removeConfig(e){this.removeLifeCycle(e)}getObjectConfig(e){const n=this.getObjectSymbol(e);return n?this.getConfigBySymbol(n):null}registModule(e){if(V[e.type.toLocaleUpperCase()])return console.warn(`module ${e.type} is already exist.`),this;V[e.type.toLocaleUpperCase()]=e.type,e.object&&(U[e.type]=!0);const n=ge(e.type,e.rule),s=fe(e.type,e.compiler,e.processors);for(const i of e.processors)z(i,e.type);const o=new s,a=new n([]);return this.dataSupportManager.extend(a),this.compilerManager.extend(o),o.useEngine(this),a.addCompiler(o),e.extend&&e.extend(this),this.moduleLifeCycle.push({module:e.type,order:e.lifeOrder||0}),this}}const at=function(r){const t=new Pe;return r.modules&&r.modules.forEach(e=>{t.registModule(e)}),r.plugins&&r.plugins.forEach(e=>{t.install(e)}),r.strategy&&r.strategy.forEach(e=>{t.exec(e)}),t},d=class{static generateConfig(t,e){if(!d.configLibrary.has(t))return console.warn(`event library can not found config by name: ${t}`),{name:""};const n=(o,a)=>{for(const i in a)o[i]!==void 0&&(typeof a[i]=="object"&&a[i]!==null&&!Array.isArray(a[i])?n(o[i],a[i]):o[i]=a[i])},s=JSON.parse(JSON.stringify(d.configLibrary.get(t)));return n(s,e),s}static generateScript(t,e,n,s){return d.generatorLibrary.has(s.name)?d.generatorLibrary.get(s.name)(t,e,n,s):(console.error(`event library can not found generator by name: ${s.name}`),()=>{})}static has(t){return d.configLibrary.has(t)}};let N=d;u(N,"configLibrary",new Map),u(N,"generatorLibrary",new Map),u(N,"register",function({config:t,generator:e}){return d.configLibrary.has(t.name)?(console.warn(`EventLibrary has already exist this event generator: ${t.name}, that will be cover.`),d):(d.configLibrary.set(t.name,JSON.parse(JSON.stringify(t))),d.generatorLibrary.set(t.name,e),d)});const y=class{static generateConfig(t,e){if(!y.configLibrary.has(t))return console.warn(`event library can not found config by name: ${t}`),{name:""};const n=(o,a)=>{for(const i in a)typeof a[i]=="object"&&a[i]!==null&&!Array.isArray(a[i])?n(o[i],a[i]):o[i]=a[i]},s=JSON.parse(JSON.stringify(y.configLibrary.get(t)));return n(s,e),s}static generateEvent(t,e){return y.generatorLibrary.has(t.name)?y.generatorLibrary.get(t.name)(e,t):(console.error(`event library can not found generator by name: ${t.name}`),()=>{})}static has(t){return y.configLibrary.has(t)}};let R=y;u(R,"configLibrary",new Map),u(R,"generatorLibrary",new Map),u(R,"register",function({config:t,generator:e}){return y.configLibrary.has(t.name)?(console.warn(`EventGeneratorManager has already exist this event generator: ${t.name}, that will be cover.`),y):(y.configLibrary.set(t.name,JSON.parse(JSON.stringify(t))),y.generatorLibrary.set(t.name,e),y)});const b=class{static getShader(t){return b.library.has(t)?b.cloneShader(b.library.get(t)):(console.warn(`con not found shader in shader library: ${t}`),null)}static generateConfig(t){if(!b.library.has(t))return console.warn(`con not found shader in shader library: ${t}`),{};const e=b.library.get(t),n={shader:t,uniforms:{}};return e.uniforms&&(n.uniforms=JSON.parse(JSON.stringify(e.uniforms))),n}static cloneShader(t){const e={name:t.name};return t.vertexShader&&(e.vertexShader=t.vertexShader),t.fragmentShader&&(e.fragmentShader=t.fragmentShader),t.uniforms&&(e.uniforms=JSON.parse(JSON.stringify(t.uniforms))),e}};let J=b;u(J,"library",new Map),u(J,"register",function(t){b.library.has(t.name)&&console.warn(`shader library has exist shader: ${t.name} that will be cover.`),b.library.set(t.name,t)});const it=[k,T];c.AniScriptGeneratorManager=N,c.AntiShake=le,c.Bus=ke,c.COMPILER_EVENT=ue,c.COMPILER_MANAGER_PLUGIN=k,c.COMPILER_SUPPORT_STRATEGY=Re,c.CONFIGFACTORY=S,c.CONFIGMODULE=F,c.CONFIGTYPE=C,c.Compiler=We,c.CompilerFactory=fe,c.CompilerManager=Se,c.CompilerManagerPlugin=be,c.CompilerSupportStrategy=Le,c.DATA_SUPPORT_MANAGER_PLUGIN=T,c.DataContainer=$,c.DataSupport=me,c.DataSupportFactory=ge,c.DataSupportManager=Oe,c.DataSupportManagerPlugin=ve,c.EngineSupport=Pe,c.EventGeneratorManager=R,c.JSONHandler=Je,c.LOADER_DATA_SUPPORT_STRATEGY=Ce,c.LOADER_MAPPING_STRATEGY=De,c.LoaderDataSupportStrategy=Ae,c.LoaderMappingStrategy=Ne,c.MODULETYPE=V,c.OBJECTMODULE=U,c.PLUGINS=it,c.Parser=ot,c.Processor=Me,c.ProcessorMembers=re,c.RESOURCE_EVENT=Y,c.RESOURCE_MANAGER_PLUGIN=_,c.ResourceManager=Ee,c.ResourceManagerPlugin=we,c.Rule=tt,c.SUPPORT_LIFE_CYCLE=je,c.ShaderGeneratorManager=J,c.Template=xe,c.Translater=ye,c.createSymbol=qe,c.defineEngineSupport=at,c.defineOption=Ue,c.defineProcessor=et,c.emptyHandler=st,c.generateConfig=h,c.getModule=I,c.getObserver=de,c.getSymbolConfig=rt,c.globalAntiShake=Ge,c.globalOption=M,c.installProcessor=z,c.isObjectModule=ne,c.isObjectType=se,c.observable=he,c.uniqueSymbol=nt,Object.keys(O).forEach(function(r){r!=="default"&&!c.hasOwnProperty(r)&&Object.defineProperty(c,r,{enumerable:!0,get:function(){return O[r]}})}),Object.keys(q).forEach(function(r){r!=="default"&&!c.hasOwnProperty(r)&&Object.defineProperty(c,r,{enumerable:!0,get:function(){return q[r]}})}),Object.keys(W).forEach(function(r){r!=="default"&&!c.hasOwnProperty(r)&&Object.defineProperty(c,r,{enumerable:!0,get:function(){return W[r]}})}),Object.keys(H).forEach(function(r){r!=="default"&&!c.hasOwnProperty(r)&&Object.defineProperty(c,r,{enumerable:!0,get:function(){return H[r]}})}),Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
