(function(c,p){typeof exports=="object"&&typeof module!="undefined"?p(exports,require("@vis-three/utils"),require("uuid"),require("@vis-three/core"),require("rxjs"),require("@vis-three/plugin-loader-manager"),require("@vis-three/plugin-pointer-manager"),require("@vis-three/plugin-event-manager"),require("@vis-three/plugin-render-manager")):typeof define=="function"&&define.amd?define(["exports","@vis-three/utils","uuid","@vis-three/core","rxjs","@vis-three/plugin-loader-manager","@vis-three/plugin-pointer-manager","@vis-three/plugin-event-manager","@vis-three/plugin-render-manager"],p):(c=typeof globalThis!="undefined"?globalThis:c||self,p((c["vis-three"]=c["vis-three"]||{},c["vis-three"].middleware={}),c.utils,c.uuid,c.core,c.rxjs,c.pluginLoaderManager,c.pluginPointerManager,c.pluginEventManager,c.pluginRenderManager))})(this,function(c,p,m,w,te,O,W,H,V){"use strict";var ct=Object.defineProperty;var lt=(c,p,m)=>p in c?ct(c,p,{enumerable:!0,configurable:!0,writable:!0,value:m}):c[p]=m;var u=(c,p,m)=>(lt(c,typeof p!="symbol"?p+"":p,m),m);const b={},F={},C={},x={},z={},J={},U=r=>z[r]||null,re=r=>x[r],ne=r=>{const t=U(r);return t?re(t):!1},K=function(r,t){J[r.type]=r,C[r.type.toLocaleUpperCase()]=r.type,b[r.type]=r.config,z[r.type]=t},A=(r,t)=>t===1/0?"Infinity":t===-1/0?"-Infinity":t,X=(r,t)=>t==="Infinity"?1/0:t==="-Infinity"?-1/0:t,j=r=>JSON.parse(JSON.stringify(r,A),X);class se{constructor(t){u(this,"config");this.config=t}pipe(t){return this.config=t(this.config),this}get(){return this.config}}var D={stringify:A,parse:X,clone:j,Pipeline:se},Ie=Object.freeze(Object.defineProperty({__proto__:null,stringify:A,parse:X,clone:j,Pipeline:se,default:D},Symbol.toStringTag,{value:"Module"}));const h={proxy:{expand:void 0,timing:"before",toRaw:void 0},symbol:{generator:m.v4,validator:m.validate}},Ge=function(r){r.proxy&&Object.assign(h.proxy,r.proxy),r.symbol&&Object.assign(h.symbol,r.symbol)},d=function(r,t,e={observer:!0,strict:!0,warn:!0}){if(!b[r])return console.error(`type: ${r} can not be found in configList.`),{vid:"",type:r};const n=(a,i)=>{for(const l in i){if(a[l]===void 0){!e.strict&&(a[l]=i[l]),e.strict&&e.warn&&console.warn(`'${r}' config can not set key: ${l}`);continue}typeof i[l]=="object"&&i[l]!==null&&!Array.isArray(i[l])?(a[l]===null&&(a[l]={...i[l]}),n(a[l],i[l])):a[l]=i[l]}};let s=b[r]();if([C.SCRIPTANIMATION,C.KEYFRAMEANIMATION].includes(r)&&(e.strict=!1),s.vid===""&&(s.vid=h.symbol.generator()),t&&n(s,t),e.observer===!1)return s;!e.handler&&(e.handler=h.proxy.expand),e.handler&&h.proxy.timing==="before"&&(s=e.handler(s));let o=pe(s);if(e.handler&&h.proxy.timing==="after"&&(o=e.handler(o)),d.autoInject&&d.injectEngine){const a=d.injectEngine;if(a.applyConfig(o),d.injectScene&&ne(s.type)&&s.type!==C.SCENE){let i=null;typeof d.injectScene=="boolean"?i=a.getObjectConfig(a.scene):typeof d.injectScene=="string"&&(i=a.getConfigBySymbol(d.injectScene)),i?i.children.push(s.vid):console.warn("current engine scene can not found it config",a,a.scene)}return o}return o};d.autoInject=!0,d.injectScene=!1,d.injectEngine=null;const oe=(r,t={})=>{let e=JSON.stringify(r,D.stringify);const n={},s=Object.keys(r).filter(a=>a!=="assets");for(const a of s)for(const i of r[a]){const l=i.vid,f=m.v4();e=e.replace(new RegExp(l,"g"),f),t.detail&&(n[l]=f)}const o=JSON.parse(e,D.parse);if(t.fillName)if(typeof t.fillName=="function")for(const a of s)for(const i of o[a])i.name||(i.name=t.fillName(i));else for(const a of s)for(const i of o[a])i.name||(i.name=`${i.type}-${i.vid.slice(-2)}`);return t.detail?{config:o,detail:n}:o},Z=(r,t,e={clone:!0,assets:!1})=>{const n=e.clone?D.clone(r):r,s=e.assets?Object.keys(n):Object.keys(n).filter(o=>o!=="assets");for(const o of s)n[o].forEach((i,l,f)=>{f[l]=t(i)});return n},ae=function(r){const t={};for(const e of Object.keys(r))for(const n of r[e])t[n.name]=n;return t},ie=function(r,t){return typeof r=="string"&&(r=JSON.parse(r,D.parse)),Z(D.clone(r),e=>(e=d(e.type,e),t?t(e):e))};var Be={clone:oe,handler:Z,planish:ae,observable:ie},ke=Object.freeze(Object.defineProperty({__proto__:null,clone:oe,handler:Z,planish:ae,observable:ie,default:Be},Symbol.toStringTag,{value:"Module"}));class ce{constructor(){u(this,"list",[]);u(this,"timer");u(this,"time",0)}exec(t){if(t(!1))return;this.list.includes(t)||this.list.push(t);let e=0;const n=()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const s=[];for(const o of this.list)o(!1)||s.push(o);if(s.length)if(s.length===e){for(const o of s)o(!0);this.list=[]}else e=s.length,this.list=s,n();else this.list=[]},this.time)};n()}append(t){this.list.length&&!this.list.includes(t)?this.list.push(t):this.exec(t)}nextTick(t){setTimeout(()=>{t()},this.time)}}const qe=new ce;class Q{constructor(){u(this,"map",new WeakMap)}create(t){if(this.map.has(t)){console.warn("object is exist.",t);return}this.map.set(t,new w.EventDispatcher)}dispose(t){this.map.delete(t)}check(t){return this.map.has(t)}emit(t,e,n){if(!this.map.has(t)){console.warn("object can not create eventDispatcher please create it",t);return}this.map.get(t).emit(e,n)}on(t,e,n){if(!this.map.has(t)){console.warn("object can not create eventDispatcher please create it",t);return}this.map.get(t).on(e,n)}off(t,e,n){if(!this.map.has(t)){console.warn("object can not create eventDispatcher please create it",t);return}this.map.get(t).off(e,n)}}const v=new Q,We=new Q;var He=Object.freeze(Object.defineProperty({__proto__:null,Bus:Q,compilerEvent:v,configEvent:We},Symbol.toStringTag,{value:"Module"}));const Ve=function(){return m.v4()};var le=(r=>(r.ADD="compiler.add",r.REMOVE="compiler.remove",r.COMPILE="compiler.compile",r.UPDATE="compiler.update",r))(le||{});class Fe{constructor(){u(this,"MODULE","");u(this,"processors",new Map);u(this,"target",{});u(this,"map",new Map);u(this,"weakMap",new WeakMap);u(this,"engine");u(this,"cacheCompile")}getMap(){return this.map}useEngine(t){return this.engine=t,this}setTarget(t){return this.target=t,this}add(t){if(!this.processors.has(t.type))return console.warn(`${this.MODULE} compiler can not support this type: ${t.type}`),null;const n=this.processors.get(t.type).create(t,this.engine,this);return this.map.set(t.vid,n),this.weakMap.set(n,t.vid),v.create(n),v.emit(n,"compiler.add"),n}remove(t){const e=t.vid;if(!this.map.has(e))return console.warn(`${this.MODULE} compiler can not found this vid object: ${e}.`),this;if(!this.processors.has(t.type))return console.warn(`${this.MODULE} compiler can not support this type: ${t.type}`),this;const n=this.map.get(e);return this.processors.get(t.type).dispose(n,this.engine,this),this.map.delete(e),this.weakMap.delete(n),v.emit(n,"compiler.remove"),v.dispose(n),this.cacheCompile&&this.cacheCompile.vid===e&&(this.cacheCompile=void 0),this}cover(t){const e=t.vid;return this.map.has(e)?(Promise.resolve().then(()=>{p.syncObject(t,t,{vid:!0,type:!0})}),this):(console.warn(`${this.MODULE} compiler can not found this vid object: ${e}.`),this)}compile(t,e){const n=this.cacheCompile;let s,o,a;if(n&&n.vid===t)s=n.target,o=n.config,a=n.processor;else{if(!this.map.has(t))return console.warn(`${this.MODULE} compiler set function: can not found object which vid is: '${t}'`),this;if(!this.target[t])return console.warn(`${this.MODULE} compiler set function: can not found config which vid is: '${t}'`),this;if(s=this.map.get(t),o=this.target[t],!this.processors.has(o.type))return console.warn(`PassCompiler can not support this type: ${o.type}`),this;a=this.processors.get(o.type),this.cacheCompile={target:s,config:o,processor:a,vid:t}}return a.process({config:o,target:s,engine:this.engine,processor:a,compiler:this,...e}),v.emit(s,`compiler.compile:${e.path.join(".")}.${e.key}`),v.emit(s,"compiler.update"),this}compileAll(){const t=this.target;for(const e of Object.values(t))this.add(e);return this}dispose(){this.cacheCompile&&(this.cacheCompile=void 0);for(const t of Object.values(this.target)){if(!this.map.has(t.vid)){console.warn(`${this.MODULE} compiler set function: can not found object which vid is: '${t.vid}'`);continue}const e=this.map.get(t.vid);if(!this.processors.has(t.type)){console.warn(`${this.MODULE}  can not support this type: ${t.type}`);continue}this.processors.get(t.type).dispose(e,this.engine,this)}return this.map.clear(),this.target={},this}reigstProcessor(t,e){return this.processors.has(t.type)?(console.warn(`${this.MODULE} compiler has already exist this processor ${t.type}, that will be cover.`),this):(this.processors.set(t.type,t),K(t,this.MODULE),e(this),this)}getObjectSymbol(t){return this.weakMap.get(t)||null}getObjectBySymbol(t){return this.map.get(t)||null}}const ue=function(r,t,e){return class extends t{constructor(){super();u(this,"MODULE",r);for(const s of e)this.processors.set(s.type,s)}}},fe=new WeakMap,I=function(r){Array.isArray(r)&&fe.set(r,r.concat([]))},ze=function(r){return fe.get(r)},Y="vis.father",L="vis.key",_=function(r){let t="";const e=n=>{n[Symbol.for(L)]!==void 0&&(t=`${n[Symbol.for(L)]}${t?`.${t}`:""}`,n[Symbol.for(Y)]&&e(n[Symbol.for(Y)]))};return e(r),t},Ke=function(r){if(r.length&&p.isObject(r[0])){const t=r.length;for(let e=0;e<t;e+=1)r[e][Symbol.for(L)]=e}},G=new WeakMap,Xe=["push","pop","shift","unshift","splice","sort","reverse"],P=new WeakSet,Ze=function(r,t,e){return Array.isArray(r)&&Xe.includes(t)&&P.add(r),Reflect.get(r,t,e)},Qe=function(r,t,e,n,s){const o=_(r);if(typeof t=="symbol"||s.isIgnore(p.extendPath(o,t)))return Reflect.set(r,t,e,n);if(p.isObject(e)&&!G.has(e)&&(e=B(s,e,r)),r[t]===void 0){p.isObject(e)&&(e[Symbol.for(L)]=t,p.isArray(e)&&I(e)),p.isArray(r)&&P.delete(r);const i=Reflect.set(r,t,e);return p.isArray(r)&&I(r),s.next({operate:"add",path:o,key:t,value:e}),i}const a=Reflect.set(r,t,e);if(p.isArray(r)){if(P.has(r)&&t==="length"){const i=ze(r);if(!i)return console.error("array value is not be cached:",r),a;Ke(r);const l=Math.abs(i.length-r.length),f=i.length>=r.length?"delete":"add",M=i.length>=r.length?r:i;let E=0,Je=0;for(const Ue of f==="delete"?i:r){if(!M.includes(Ue)&&(s.next({operate:f,path:o,key:Je.toString(),value:Ue}),E+=1,E===l))break;Je+=1}return I(r),P.delete(r),a}else if(P.has(r)||t==="length")return a}return s.next({operate:"set",path:o,key:t,value:e}),a},Ye=function(r,t,e){const n=_(r);if(typeof t=="symbol"||e.isIgnore(n))return Reflect.deleteProperty(r,t);const s=r[t],o=Reflect.deleteProperty(r,t);return p.isArray(r)||e.next({operate:"delete",path:n,key:t,value:s}),o},B=function(r,t,e){if(!p.isObject(t)||G.has(t))return t;const n=e?_(e):"";if(r.isIgnore(n))return t;const s={get:Ze,set:(a,i,l,f)=>Qe(a,i,l,f,r),deleteProperty:(a,i)=>Ye(a,i,r)};e&&(t[Symbol.for(Y)]=e);for(const a in t){const i=p.extendPath(n,a);if(!r.isIgnore(i)&&p.isObject(t[a])){if(p.isArray(t[a])){const l=t[a];t[a]=B(r,t[a],t),I(l)}else t[a]=B(r,t[a],t);t[a][Symbol.for(L)]=a}}const o=new Proxy(t,s);return r.saveRaw(o,t),G.set(o,r),o};class _e extends te.Subject{constructor(e,n){super();u(this,"ignore",{});u(this,"target");u(this,"rawMap",new WeakMap);n&&(this.ignore=n),this.target=B(this,e)}isIgnore(e){let n=this.ignore;for(const s of e.split(".")){if(n[s]===void 0)return!1;if(typeof n[s]=="boolean"&&n[s])return!0;n=n[s]}return!1}setIgnore(e){this.ignore=e}mergeIgnore(e){this.ignore=Object.assign(this.ignore,e)}saveRaw(e,n){this.rawMap.set(e,n)}toRaw(e){return this.rawMap.get(e)}}const pe=function(r,t){return new _e(r,t).target},he=function(r){return G.get(h.proxy.toRaw?h.proxy.toRaw(r):r)},de=function(r,t,e){return Reflect.get(r,t,e)},ye=function(r,t,e,n,s){if(typeof t=="symbol")return Reflect.set(r,t,e,n);if(r[t]===void 0){const o=Reflect.set(r,t,e);return s.add(e),s.next({operate:"add",path:t,key:t,value:e}),o}else{const o=Reflect.set(r,t,e);return s.remove(e.vid),s.add(e),s.next({operate:"set",path:t,key:t,value:e}),o}},ge=function(r,t,e){if(typeof t=="symbol")return Reflect.deleteProperty(r,t);const n=r[t],s=Reflect.deleteProperty(r,t);return e.next({operate:"delete",path:t,key:t,value:n}),e.remove(n.vid),s};class me extends te.Subject{constructor(){super();u(this,"container");u(this,"subscriptions",new Map);const e=h.proxy.expand?(n={})=>h.proxy.expand(n):(n={})=>n;h.proxy.timing==="before"?this.container=new Proxy(e(),{get:de,set:(n,s,o,a)=>ye(n,s,o,a,this),deleteProperty:(n,s)=>ge(n,s,this)}):this.container=e(new Proxy({},{get:de,set:(n,s,o,a)=>ye(n,s,o,a,this),deleteProperty:(n,s)=>ge(n,s,this)}))}add(e){const n=he(e);if(!n){console.error("DataContainer: this config can not observer",e);return}this.subscriptions.set(n.target.vid,n.subscribe(s=>{this.next({operate:s.operate,path:p.extendPath(n.target.vid,s.path),key:s.key,value:s.value})}))}remove(e){this.subscriptions.delete(e)}}class Me{constructor(){u(this,"rule",()=>{});u(this,"members",[])}apply(t){return this.members.includes(t)||this.members.push(t),this}cancel(t){return this.members.includes(t)&&this.members.splice(this.members.indexOf(t),1),this}setRule(t){return this.rule=t,this}translate(t){const e=this.rule;for(const n of this.members)e(t,n);return this}}class be{constructor(t,e=[]){u(this,"MODULE","");u(this,"dataContainer",new me);u(this,"translater");this.translater=new Me().setRule(t),this.dataContainer.subscribe(n=>{this.translater.translate(n)});for(const n of e)this.addConfig(n)}getData(){return this.dataContainer.container}existSymbol(t){return Boolean(this.dataContainer.container[t])}addConfig(t){return this.dataContainer.container[t.vid]=t,this}getConfig(t){return this.dataContainer.container[t]}removeConfig(t){const e=this.dataContainer.container;e[t]!==void 0&&delete e[t]}addCompiler(t){return t.setTarget(this.dataContainer.container),t.compileAll(),this.translater.apply(t),this}toJSON(t=!0){return t?JSON.stringify(this.exportConfig(),A):JSON.stringify(Object.values(this.dataContainer.container),A)}exportConfig(t=!0){if(t){const e=this.dataContainer.container,n=[],s={},o=(a,i,l={})=>{for(const f in a){if(["vid","type"].includes(f)){l[f]=a[f];continue}if(typeof a[f]=="object"&&a[f]!==null){if(Array.isArray(a[f])){if(!a[f].length)continue;l[f]=a[f].map(M=>typeof M=="object"&&M!==null?j(M):M);continue}l[f]={},i[f]?(o(a[f],i[f],l[f]),Object.keys(l[f]).length===0&&delete l[f]):l[f]=j(a[f])}else i[f]!==a[f]&&(l[f]=a[f])}};for(const a of Object.values(e)){if(!s[a.type]){if(!b[a.type]){console.error(`can not font some config with: ${a.type}`);continue}s[a.type]=b[a.type]()}const i={};o(a,s[a.type],i),n.push(i)}return n}else return Object.values(j(this.dataContainer.container))}load(t){const e=this.dataContainer.container,n={},s=(o,a)=>{for(const i in a)typeof o[i]=="object"&&o[i]!==null&&typeof a[i]=="object"&&a[i]!==null?s(o[i],a[i]):o[i]===void 0&&(o[i]=a[i])};for(const o of t){if(!n[o.type]){if(!b[o.type]){console.error(`can not font some config with: ${o.type}`);continue}n[o.type]=b[o.type]()}s(o,n[o.type]),e[o.vid]=o}return this}remove(t){const e=this.dataContainer.container;for(const n of t)e[n.vid]!==void 0&&delete e[n.vid];return this}}const Se=function(r,t){return class extends be{constructor(n=[]){super(t,n);u(this,"MODULE",r)}}};class Oe{constructor(t){u(this,"type");u(this,"config");u(this,"commands");u(this,"create");u(this,"dispose");this.type=t.type,this.commands=t.commands,this.create=t.create,this.dispose=t.dispose,this.config=()=>{const e=t.config();return e.type=this.type,e},C[this.type.toLocaleUpperCase()]=this.type,b[this.type]=this.config}process(t){if(!this.commands||!this.commands[t.operate]){this[t.operate](t);return}let e=this.commands[t.operate];for(const n of[].concat(t.path,t.key))if(!e[n]&&!e.$reg){this[t.operate](t);return}else if(e[n])if(typeof e[n]=="function"){e[n](t);return}else e=e[n];else if(e.$reg){for(const s of e.$reg)if(s.reg.test(n)){s.handler(t);return}}this[t.operate](t)}add(t){let e=t.target;const n=t.path;for(const s of n)if(typeof e[s]!==void 0)e=e[s];else{console.warn("processor can not exec default add operate.",t);return}e[t.key]=t.value}set(t){let e=t.target;const n=t.path;for(const s of n)if(typeof e[s]!==void 0)e=e[s];else{console.warn("processor can not exec default set operate.",t);return}e[t.key]=t.value}delete(t){let e=t.target;const n=t.path;for(const s of n)if(typeof e[s]!==void 0)e=e[s];else{console.warn("processor can not exec default delete operate.",t);return}delete e[t.key]}expand(t){const e=function(n,s){for(const o in s)p.isObject(s[o])&&p.isObject(n[o])?e(n[o],s[o]):(p.isObject(s[o])&&!n[o]||!p.isObject(s[o])&&!n[o])&&(n[o]=s[o])};return this.commands||(this.commands={}),e(this.commands,t),this}}const et=r=>new Oe(r),tt=(r,t,e=m.validate)=>{const{operate:n,key:s,path:o,value:a}=r;let i=s;const l=o.split(".");if(l.length&&(i=l.shift()),!e(i)){console.warn(`${t.MODULE} Rule: vid is illeage: ${i}`);return}if(n==="add"&&!l.length&&i===s){t.add(a);return}if(r.operate==="delete"&&!l.length){t.remove(a);return}if(r.operate==="set"&&!l.length&&s===i){t.cover(a);return}t.compile(i,{operate:n,key:s,path:l,value:a})},rt=function(){return{vid:"",type:"",name:""}},nt=function(r){return`DEFUALT-${r}`},st=function(){};class ve extends w.EventDispatcher{constructor(){super();u(this,"compilerMap",new Map)}extend(e,n=!1){this.compilerMap.has(e.MODULE)?(console.warn("compiler manager has exist this compiler",e),n&&this.compilerMap.set(e.MODULE,e)):this.compilerMap.set(e.MODULE,e)}getCompiler(e){return this.compilerMap.has(e)?this.compilerMap.get(e):(console.warn(`can not found this type in compiler manager: ${e}`),null)}getObjectSymbol(e){for(const n of this.compilerMap.values()){const s=n.getObjectSymbol(e);if(s)return s}return null}getObjectBySymbol(e){for(const n of this.compilerMap.values()){const s=n.getObjectBySymbol(e);if(s)return s}return null}getObjectfromModule(e,n){return this.compilerMap.has(e)?this.compilerMap.get(e).map.get(n)||null:(console.warn(`compiler manager can not found this module: ${e}`),null)}getObjectfromModules(e,n){Array.isArray(e)||(e=Object.keys(e));for(const s of e){if(!this.compilerMap.has(s)){console.warn(`compiler manager can not found this module: ${s}`);continue}const o=this.compilerMap.get(s);if(o.map.has(n))return o.map.get(n)}return null}dispose(){for(const e of this.compilerMap.values())e.dispose();return this.compilerMap.clear(),this}}const k="CompilerManagerPlugin",Ee=function(){return{name:k,install(r){const t=new ve;r.compilerManager=t,r.getObjectSymbol=function(e){return t.getObjectSymbol(e)},r.getObjectBySymbol=function(e){return t.getObjectBySymbol(e)},r.getObjectfromModule=function(e,n){return t.getObjectfromModule(e,n)},r.getObjectfromModules=function(e,n){return t.getObjectfromModules(e,n)},r.getObject3D=function(e){return t.getObjectfromModules(x,e)}},dispose(r){r.compilerManager.dispose(),delete r.compilerManager,delete r.getObjectSymbol,delete r.getObjectBySymbol,delete r.getObjectfromModule,delete r.getObjectfromModules,delete r.getObject3D}}};class we extends w.EventDispatcher{constructor(){super();u(this,"dataSupportMap",new Map)}extend(e,n=!1){this.dataSupportMap.has(e.MODULE)?(console.warn("dataSupport manager has exist this dataSupport",e),n&&this.dataSupportMap.set(e.MODULE,e)):this.dataSupportMap.set(e.MODULE,e)}getDataSupport(e){return this.dataSupportMap.has(e)?this.dataSupportMap.get(e):(console.warn(`can not found this type in dataSupportManager: ${e}`),null)}getConfigBySymbol(e){const n=this.dataSupportMap.values();for(const s of n){const o=s.getConfig(e);if(o)return o}return null}removeConfigBySymbol(...e){for(const n of e)for(const s of this.dataSupportMap.values())if(s.existSymbol(n)){s.removeConfig(n);break}return this}getModuleBySymbol(e){const n=this.dataSupportMap.values();for(const s of n)if(s.existSymbol(e))return s.MODULE;return null}applyConfig(...e){for(const n of e){const s=U(n.type);s?this.dataSupportMap.get(s).addConfig(n):console.warn(`dataSupportManager can not found this config module: ${n.type}`)}return this}load(e){return this.dataSupportMap.forEach((s,o)=>{e[o]&&s.load(e[o])}),this}loadByModule(e,n){const s=this.dataSupportMap.get(n);return s?(s.load(e),this):(console.warn(`DataSupportManager can not support this module: ${n}`),this)}remove(e){return this.dataSupportMap.forEach((s,o)=>{e[o]&&s.remove(e[o])}),this}toJSON(e={},n=!0){return JSON.stringify(this.exportConfig(e,n),A)}exportConfig(e={},n=!0){return this.dataSupportMap.forEach((o,a)=>{e[a]=o.exportConfig(n)}),e}}const $="DataSupportManagerPlugin",Ce=function(){return{name:$,install(r){const t=new we;r.dataSupportManager=t,r.applyConfig=function(...e){return t.applyConfig(...e),r},r.getConfigBySymbol=function(e){return t.getConfigBySymbol(e)},r.removeConfigBySymbol=function(...e){return t.removeConfigBySymbol(...e),r},r.toJSON=function(){return t.toJSON()},r.exportConfig=function(){return t.exportConfig()}},dispose(r){delete r.dataSupportManager,delete r.applyConfig,delete r.getConfigBySymbol,delete r.removeConfigBySymbol,delete r.toJSON,delete r.exportConfig}}};var q=(r=>(r.MAPPED="mapped",r))(q||{});class Ae extends w.EventDispatcher{constructor(e={}){super();u(this,"configMap",new Map);u(this,"resourceMap",new Map);u(this,"paserMap",new Map);const n=new Map;for(const s in e)n.has(s)&&console.warn(`resourceManager construct params rescource already exist: ${s}, that will be cover.`),n.set(s,e[s]);this.mappingResource(n)}addParser(e){return this.paserMap.has(e.constructor)?this:(this.paserMap.set(e.constructor,e),this)}mappingResource(e,n){const s=this.configMap,o=this.resourceMap,a=[...this.paserMap.values()],i={};for(const[l,f]of e.entries()){if((n==null?void 0:n.parser)&&n.parser[l]){n.parser[l].parse({url:l,resource:f,configMap:s,resourceMap:o});continue}if((n==null?void 0:n.selector)&&n.selector[l]){const E=n.selector[l](l,f,this.paserMap);if(!E){console.warn("resource manager hanlder can not found this resource parser: ",f,n.selector[l]);continue}E.parse({url:l,resource:f,configMap:s,resourceMap:o}),i[l]=this.getResourceConfig(l);continue}let M=null;for(const E of a)if(M=E.selector(l,f,this.paserMap),M)break;if(!M){console.warn("resouce manager can not found some handler to parser this resource:",f);continue}M.parse({url:l,resource:f,configMap:s,resourceMap:o}),i[l]=this.getResourceConfig(l)}return this.dispatchEvent({type:"mapped",configMap:s,resourceMap:o,resourceConfig:i}),this}getResourceConfig(e){const n=this.configMap,s={};return[...n.keys()].filter(o=>o.startsWith(e)).forEach(o=>{const a=n.get(o);if(!a)console.error(`unknow error: can not found config by url: ${o}`);else{const i=U(a.type);i?(!s[i]&&(s[i]=[]),s[i].push(a)):console.error(`unknow error: can not found module by type: ${a.type}`,a)}}),s}hasResource(e){return this.resourceMap.has(e)}remove(e){const n=this.configMap,s=this.resourceMap;return[...n.keys()].filter(o=>o.startsWith(e)).forEach(o=>{n.delete(o);const a=s.get(o);a.dispose&&a.dispose(),s.delete(o)}),this}dispose(){this.resourceMap.forEach((e,n)=>{e.dispose&&e.dispose()}),this.resourceMap.clear(),this.configMap.clear()}}class ot{}const ee="ResourceManagerPlugin",De=function(r={}){return{name:ee,install(t){const e=new Ae(r.resources);t.resourceManager=e,t.registerResources=n=>{const s=new Map;return Object.keys(n).forEach(o=>{s.set(o,n[o])}),e.mappingResource(s),t}},dispose(t){t.addEventListener(w.ENGINE_EVENT.DISPOSE,()=>{t.resourceManager.dispose()})}}},Ne="LoaderDataSupportStrategy",Re=function(){let r,t;return{name:Ne,condition:[$,O.LOADER_MANAGER_PLUGIN],exec(e){r=e.toJSON,e.toJSON=function(){const n={assets:JSON.parse(e.loaderManager.toJSON())};return e.dataSupportManager.toJSON(n)},t=e.exportConfig,e.exportConfig=function(){let n={};return n={assets:e.loaderManager.exportConfig()},e.dataSupportManager.exportConfig(n)}},rollback(e){e.toJSON=r,e.exportConfig=t}}},je="LoaderMappingStrategy",Le=function(){let r,t;return{name:je,condition:[ee,O.LOADER_MANAGER_PLUGIN],exec(e){r=e.loadResources,e.loadResources=(n,s)=>{const o=a=>{s(void 0,a),e.resourceManager.removeEventListener(O.LOADER_EVENT.LOADED,o)};try{e.resourceManager.addEventListener(O.LOADER_EVENT.LOADED,o)}catch(a){s(a)}return e.loaderManager.reset().load(n),e},t=e.loadResourcesAsync,e.loadResourcesAsync=n=>new Promise((s,o)=>{try{e.loaderManager.once(O.LOADER_EVENT.LOADED,a=>{e.resourceManager.once(q.MAPPED,l=>{s(l)});const i=new Map;n.forEach(l=>{typeof l=="string"?i.set(l,a.resourceMap.get(l)):i.set(l.url,a.resourceMap.get(l.url))}),e.resourceManager.mappingResource(i)})}catch(a){o(a)}e.loaderManager.reset().load(n)})},rollback(e){e.loadResources=r,e.loadResourcesAsync=t}}},Pe="CompilerSupportStrategy",$e=function(){return{name:Pe,condition:[k,$],exec(r){r.compilerManager.compilerMap.forEach((t,e)=>{var n;t.useEngine(r),(n=r.dataSupportManager.dataSupportMap.get(e))==null||n.addCompiler(t)})},rollback(){}}};var Te=(r=>(r[r.ZERO=0]="ZERO",r[r.ONE=100]="ONE",r[r.TWO=200]="TWO",r[r.THREE=300]="THREE",r[r.FOUR=400]="FOUR",r[r.FIVE=500]="FIVE",r[r.SIX=600]="SIX",r[r.SEVEN=700]="SEVEN",r[r.EIGHT=800]="EIGHT",r[r.NINE=900]="NINE",r))(Te||{});class xe extends w.Engine{constructor(){super();u(this,"moduleLifeCycle",[]);u(this,"processorExpands",[]);this.install(O.LoaderManagerPlugin()).install(W.PointerManagerPlugin()).install(H.EventManagerPlugin()).install(V.RenderManagerPlugin()).install(De()).install(Ce()).install(Ee()),this.exec(Re()).exec(Le()).exec($e())}loadLifeCycle(e){const n=this.dataSupportManager,s=this.moduleLifeCycle.sort((o,a)=>o.order-a.order);for(const{module:o}of s)e[o]&&n.loadByModule(e[o],o)}removeLifeCycle(e){const n=this.dataSupportManager,s=this.moduleLifeCycle.sort((l,f)=>f.order-l.order);for(const{module:l}of s)e[l]&&n.remove({[l]:e[l]});const o=e.assets||[],a=this.resourceManager,i=this.loaderManager;o.forEach(l=>{a.remove(l),i.remove(l)})}loadConfig(e,n){const s=this.renderManager.hasRendering();if(s&&this.renderManager.stop(),e.assets&&e.assets.length){const o=a=>{delete e.assets,this.loadLifeCycle(e),this.resourceManager.removeEventListener("mapped",o),n&&n(a),s?this.renderManager.play():this.renderManager.render()};this.resourceManager.addEventListener("mapped",o),this.loaderManager.reset().load(e.assets)}else this.loadLifeCycle(e),n&&n(),s?this.renderManager.play():this.renderManager.render();return this}loadConfigAsync(e){return new Promise((n,s)=>{const o=this.renderManager.hasRendering();o&&this.renderManager.stop(),e.assets&&e.assets.length?this.loadResourcesAsync(e.assets).then(a=>{delete e.assets,this.loadLifeCycle(e),o?this.renderManager.play():this.renderManager.render(),n(a)}):(this.loadLifeCycle(e),o?this.renderManager.play():this.renderManager.render(),n({type:q.MAPPED,configMap:this.resourceManager.configMap,resourceMap:this.resourceManager.resourceMap,resourceConfig:{}}))})}removeConfig(e){this.removeLifeCycle(e)}getObjectConfig(e){const n=this.getObjectSymbol(e);return n?this.getConfigBySymbol(n):null}registModule(e){if(F[e.type.toLocaleUpperCase()])return console.warn(`module ${e.type} is already exist.`),this;F[e.type.toLocaleUpperCase()]=e.type,e.object&&(x[e.type]=!0);const n=Se(e.type,e.rule),s=ue(e.type,e.compiler,e.processors);for(const i of e.processors)K(i,e.type);const o=new s,a=new n([]);this.dataSupportManager.extend(a),this.compilerManager.extend(o),o.useEngine(this),a.addCompiler(o),e.extend&&e.extend(this),e.processors.forEach(i=>{}),e.expand&&this.processorExpands.push(...e.expand);for(const i of this.processorExpands)Array.isArray(i.processors)?Object.values(J).forEach(l=>{i.processors.includes(l.type)&&l.expand(i.command)}):Object.values(J).forEach(l=>{i.processors.test(l.type)&&l.expand(i.command)});return this.moduleLifeCycle.push({module:e.type,order:e.lifeOrder||0}),this}}const at=function(r){const t=new xe;return r.modules&&r.modules.forEach(e=>{t.registModule(e)}),r.plugins&&r.plugins.forEach(e=>{t.install(e)}),r.strategy&&r.strategy.forEach(e=>{t.exec(e)}),t},y=class{static generateConfig(t,e){if(!y.configLibrary.has(t))return console.warn(`event library can not found config by name: ${t}`),{name:""};const n=(o,a)=>{for(const i in a)o[i]!==void 0&&(typeof a[i]=="object"&&a[i]!==null&&!Array.isArray(a[i])?n(o[i],a[i]):o[i]=a[i])},s=JSON.parse(JSON.stringify(y.configLibrary.get(t)));return n(s,e),s}static generateScript(t,e,n,s){return y.generatorLibrary.has(s.name)?y.generatorLibrary.get(s.name)(t,e,n,s):(console.error(`event library can not found generator by name: ${s.name}`),()=>{})}static has(t){return y.configLibrary.has(t)}};let N=y;u(N,"configLibrary",new Map),u(N,"generatorLibrary",new Map),u(N,"register",function({config:t,generator:e}){return y.configLibrary.has(t.name)?(console.warn(`EventLibrary has already exist this event generator: ${t.name}, that will be cover.`),y):(y.configLibrary.set(t.name,JSON.parse(JSON.stringify(t))),y.generatorLibrary.set(t.name,e),y)});const g=class{static generateConfig(t,e){if(!g.configLibrary.has(t))return console.warn(`event library can not found config by name: ${t}`),{name:""};const n=(o,a)=>{for(const i in a)typeof a[i]=="object"&&a[i]!==null&&!Array.isArray(a[i])?n(o[i],a[i]):o[i]=a[i]},s=JSON.parse(JSON.stringify(g.configLibrary.get(t)));return n(s,e),s}static generateEvent(t,e){return g.generatorLibrary.has(t.name)?g.generatorLibrary.get(t.name)(e,t):(console.error(`event library can not found generator by name: ${t.name}`),()=>{})}static has(t){return g.configLibrary.has(t)}};let R=g;u(R,"configLibrary",new Map),u(R,"generatorLibrary",new Map),u(R,"register",function({config:t,generator:e}){return g.configLibrary.has(t.name)?(console.warn(`EventGeneratorManager has already exist this event generator: ${t.name}, that will be cover.`),g):(g.configLibrary.set(t.name,JSON.parse(JSON.stringify(t))),g.generatorLibrary.set(t.name,e),g)});const S=class{static getShader(t){return S.library.has(t)?S.cloneShader(S.library.get(t)):(console.warn(`con not found shader in shader library: ${t}`),null)}static generateConfig(t){if(!S.library.has(t))return console.warn(`con not found shader in shader library: ${t}`),{};const e=S.library.get(t),n={shader:t,uniforms:{}};return e.uniforms&&(n.uniforms=JSON.parse(JSON.stringify(e.uniforms))),n}static cloneShader(t){const e={name:t.name};return t.vertexShader&&(e.vertexShader=t.vertexShader),t.fragmentShader&&(e.fragmentShader=t.fragmentShader),t.uniforms&&(e.uniforms=JSON.parse(JSON.stringify(t.uniforms))),e}};let T=S;u(T,"library",new Map),u(T,"register",function(t){S.library.has(t.name)&&console.warn(`shader library has exist shader: ${t.name} that will be cover.`),S.library.set(t.name,t)});const it=[k,$];c.AniScriptGeneratorManager=N,c.AntiShake=ce,c.Bus=He,c.COMPILER_EVENT=le,c.COMPILER_MANAGER_PLUGIN=k,c.COMPILER_SUPPORT_STRATEGY=Pe,c.CONFIGFACTORY=b,c.CONFIGMODULE=z,c.CONFIGTYPE=C,c.Compiler=Fe,c.CompilerFactory=ue,c.CompilerManager=ve,c.CompilerManagerPlugin=Ee,c.CompilerSupportStrategy=$e,c.DATA_SUPPORT_MANAGER_PLUGIN=$,c.DataContainer=me,c.DataSupport=be,c.DataSupportFactory=Se,c.DataSupportManager=we,c.DataSupportManagerPlugin=Ce,c.EngineSupport=xe,c.EventGeneratorManager=R,c.JSONHandler=Ie,c.LOADER_DATA_SUPPORT_STRATEGY=Ne,c.LOADER_MAPPING_STRATEGY=je,c.LoaderDataSupportStrategy=Re,c.LoaderMappingStrategy=Le,c.MODULETYPE=F,c.OBJECTMODULE=x,c.PLUGINS=it,c.Parser=ot,c.Processor=Oe,c.ProcessorMembers=J,c.RESOURCE_EVENT=q,c.RESOURCE_MANAGER_PLUGIN=ee,c.ResourceManager=Ae,c.ResourceManagerPlugin=De,c.Rule=tt,c.SUPPORT_LIFE_CYCLE=Te,c.ShaderGeneratorManager=T,c.Template=ke,c.Translater=Me,c.createSymbol=Ve,c.defineEngineSupport=at,c.defineOption=Ge,c.defineProcessor=et,c.emptyHandler=st,c.generateConfig=d,c.getModule=U,c.getObserver=he,c.getSymbolConfig=rt,c.globalAntiShake=qe,c.globalOption=h,c.installProcessor=K,c.isObjectModule=re,c.isObjectType=ne,c.observable=pe,c.uniqueSymbol=nt,Object.keys(O).forEach(function(r){r!=="default"&&!c.hasOwnProperty(r)&&Object.defineProperty(c,r,{enumerable:!0,get:function(){return O[r]}})}),Object.keys(W).forEach(function(r){r!=="default"&&!c.hasOwnProperty(r)&&Object.defineProperty(c,r,{enumerable:!0,get:function(){return W[r]}})}),Object.keys(H).forEach(function(r){r!=="default"&&!c.hasOwnProperty(r)&&Object.defineProperty(c,r,{enumerable:!0,get:function(){return H[r]}})}),Object.keys(V).forEach(function(r){r!=="default"&&!c.hasOwnProperty(r)&&Object.defineProperty(c,r,{enumerable:!0,get:function(){return V[r]}})}),Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
