(function(p,l){typeof exports=="object"&&typeof module!="undefined"?l(exports,require("@vis-three/core"),require("@vis-three/middleware"),require("@vis-three/utils"),require("three"),require("@vis-three/convenient")):typeof define=="function"&&define.amd?define(["exports","@vis-three/core","@vis-three/middleware","@vis-three/utils","three","@vis-three/convenient"],l):(p=typeof globalThis!="undefined"?globalThis:p||self,l((p["vis-three"]=p["vis-three"]||{},p["vis-three"]["plugin-path-support-controls"]={}),p.core,p.middleware,p.utils,p.three,p.convenient))})(this,function(p,l,v,w,o,E){"use strict";var C=Object.defineProperty;var x=(p,l,v)=>l in p?C(p,l,{enumerable:!0,configurable:!0,writable:!0,value:v}):p[l]=v;var a=(p,l,v)=>(x(p,typeof l!="symbol"?l+"":l,v),v);const I="@vis-three/plugin-path-support-controls",b=new o.CanvasTexture(new E.CanvasGenerator({width:32,height:32}).draw(i=>{i.beginPath(),i.fillStyle="rgba(0, 0, 0, 0)",i.fillRect(0,0,32,32),i.closePath(),i.beginPath(),i.fillStyle="rgb(0, 255, 238)",i.strokeStyle="black",i.lineWidth=1,i.arc(16,16,15,0,2*Math.PI),i.stroke(),i.fill(),i.closePath()}).getDom()),G=new o.CanvasTexture(new E.CanvasGenerator({width:32,height:32}).draw(i=>{i.beginPath(),i.fillStyle="rgba(0, 0, 0, 0)",i.fillRect(0,0,32,32),i.closePath(),i.beginPath(),i.fillStyle="rgb(255, 248, 0)",i.strokeStyle="black",i.lineWidth=1,i.arc(16,16,15,0,2*Math.PI),i.stroke(),i.fill(),i.closePath()}).getDom());new o.CanvasTexture(new E.CanvasGenerator({width:32,height:32}).draw(i=>{i.beginPath(),i.fillStyle="rgba(0, 0, 0, 0)",i.fillRect(0,0,32,32),i.closePath(),i.beginPath(),i.fillStyle="rgb(255, 0, 0)",i.strokeStyle="black",i.lineWidth=1,i.moveTo(1,0),i.lineTo(31,16),i.lineTo(0,31),i.lineTo(1,0),i.stroke(),i.fill(),i.closePath()}).getDom());const g=class extends o.Object3D{constructor(r,e,n,h){super();a(this,"dragging",!1);a(this,"raycaster",new o.Raycaster);a(this,"anchorGizmo",new o.Points(new o.BufferGeometry,g.anchorMaterial));a(this,"moveGizmo",new o.Points(new o.BufferGeometry,g.moveMaterial));a(this,"moveHelper",new o.LineSegments(new o.BufferGeometry,g.moveHelperMaterial));a(this,"plane",new o.Plane);a(this,"pointerManager");a(this,"cachePlaneVector3",new o.Vector3);a(this,"cacheQuaternion",new o.Quaternion);a(this,"cacheNormal",new o.Vector3);a(this,"cachePosition",new o.Vector3);a(this,"cacheMouseDownPoistion",new o.Vector3);a(this,"cacheMouseMoveDirection",new o.Vector3);a(this,"cacheConfigIndex",0);a(this,"moveCurveIndexMap",{});a(this,"helperRangeMap",{});a(this,"currentGuizmo");a(this,"currentIndex",0);a(this,"domElement");a(this,"camera");a(this,"config");a(this,"object");a(this,"cacheObjectInvert");a(this,"_pointerHover",this.pointerHover.bind(this));a(this,"_pointerMove",this.pointerMove.bind(this));a(this,"_pointerDown",this.pointerDown.bind(this));a(this,"_pointerUp",this.pointerUp.bind(this));this.anchorGizmo.type="PathSupportControlsAnchorGizmo",this.moveGizmo.type="PathSupportControlsMoveGizmo",this.moveHelper.type="PathSupportControlsMoveHelper",this.moveHelper.raycast=()=>{},this.add(this.anchorGizmo,this.moveGizmo,this.moveHelper),this.renderOrder=1/0,this.matrixAutoUpdate=!1,n&&this.setObject(n),h&&this.setConfig(h),this.setDom(e).setCamera(r).connect()}setDom(r){return this.domElement&&this.disconnect(),this.domElement=r,this.connect(),this}setCamera(r){return this.camera=r,this}setObject(r){return this.object=r,this.matrix=r.matrix,this.matrixWorld=r.matrixWorld,this.cacheObjectInvert=r.matrixWorld.clone().invert(),r.parent.add(this),this}setConfig(r){this.config=r,this.moveCurveIndexMap={},this.helperRangeMap={};const e=this.moveCurveIndexMap,n=this.helperRangeMap,h=[],s=[],c=[];this.config.curves.forEach((t,m,u)=>{m===u.length-1?h.push(t.params[0],t.params[1],0,t.params[t.params.length-2],t.params[t.params.length-1],0):h.push(t.params[0],t.params[1],0),t.curve==="arc"?(s.push(t.params[2],t.params[3],0),e[s.length/3-1]={segmentIndex:m,type:"c1"}):t.curve==="bezier"?(s.push(t.params[2],t.params[3],0),c.push(t.params[0],t.params[1],0,t.params[2],t.params[3],0),e[s.length/3-1]={segmentIndex:m,type:"c1"},s.push(t.params[4],t.params[5],0),c.push(t.params[t.params.length-2],t.params[t.params.length-1],0,t.params[4],t.params[5],0),e[s.length/3-1]={segmentIndex:m,type:"c2"},n[m]={startIndex:c.length/3-4,previous:!1},n[m+1]={startIndex:c.length/3-4,previous:!0}):t.curve==="quadratic"&&(s.push(t.params[2],t.params[3],0),c.push(t.params[0],t.params[1],0,t.params[2],t.params[3],0,t.params[t.params.length-2],t.params[t.params.length-1],0,t.params[2],t.params[3],0),e[s.length/3-1]={segmentIndex:m,type:"c1"},n[m]={startIndex:c.length/3-4,previous:!1},n[m+1]={startIndex:c.length/3-4,previous:!0})});const d=function(t,m){const u=t.geometry;u.setAttribute("position",new o.BufferAttribute(new Float32Array(m),3).setUsage(o.DynamicDrawUsage)),u.getAttribute("position").needsUpdate=!0,u.computeBoundingBox(),u.computeBoundingSphere()};return d(this.anchorGizmo,h),d(this.moveGizmo,s),d(this.moveHelper,c),this}update(){this.setConfig(this.config)}updateHelper(r){const e=this.helperRangeMap;if(e[r]!==void 0){const{startIndex:n,previous:h}=e[r],s=h?this.config.curves[r-1]:this.config.curves[r],c=this.moveHelper.geometry.getAttribute("position");s.curve==="bezier"?(c.setXYZ(n,s.params[0],s.params[1],0),c.setXYZ(n+1,s.params[2],s.params[3],0),c.setXYZ(n+2,s.params[s.params.length-2],s.params[s.params.length-1],0),c.setXYZ(n+3,s.params[4],s.params[5],0)):s.curve==="quadratic"&&(c.setXYZ(n,s.params[0],s.params[1],0),c.setXYZ(n+1,s.params[2],s.params[3],0),c.setXYZ(n+2,s.params[s.params.length-2],s.params[s.params.length-1],0),c.setXYZ(n+3,s.params[2],s.params[3],0)),c.needsUpdate=!0}return this}use(r){this.pointerManager=r}connect(){return this.object&&this.config&&(this.domElement.addEventListener("pointermove",this._pointerHover),this.domElement.addEventListener("mousedown",this._pointerDown)),this}disconnect(){return this.domElement.removeEventListener("pointermove",this._pointerHover),this.domElement.removeEventListener("mousedown",this._pointerDown),this}dispose(){const r=e=>{e.geometry.dispose(),Array.isArray(e.material)?e.material.forEach(n=>{n.dispose()}):e.material.dispose()};r(this.anchorGizmo),r(this.moveGizmo)}intersectPoint(r){this.raycaster.setFromCamera(this.pointerManager.mouse,this.camera);const e=this.raycaster.intersectObject(this,!0);return e.length?(this.currentGuizmo=e[0].object,this.currentIndex=e[0].index,{guizmo:this.currentGuizmo,index:this.currentIndex}):null}intersectPlane(r){return this.raycaster.setFromCamera(this.pointerManager.mouse,this.camera),this.raycaster.ray.intersectPlane(this.plane,this.cachePlaneVector3)}pointerHover(r){if(this.dragging||!this.visible)return;const e=this.intersectPoint(r);Number.isInteger(e==null?void 0:e.index)?this.domElement.style.cursor="move":this.domElement.style.cursor=""}pointerDown(r){if(!this.visible)return;if(this.cacheQuaternion.setFromRotationMatrix(this.object.matrixWorld),this.cacheNormal.set(0,0,1).applyQuaternion(this.cacheQuaternion),this.cachePosition.setFromMatrixPosition(this.object.matrixWorld),this.plane.set(this.cacheNormal,this.cachePosition.projectOnVector(this.cacheNormal).length()),this.intersectPoint(r)){this.dragging=!0,this.cacheMouseDownPoistion.copy(this.intersectPlane(r)).sub(this.cachePosition);const n=this.currentIndex===this.config.curves.length?this.currentIndex-1:this.currentIndex;this.dispatchEvent({type:"mousedown",index:n,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:this.currentGuizmo===this.moveGizmo?"move":"anchor"}),this.cacheConfigIndex=n,this.domElement.addEventListener("mousemove",this._pointerMove),this.domElement.addEventListener("mouseup",this._pointerUp)}}pointerMove(r){if(!this.visible&&!this.dragging)return;const e=this.intersectPlane(r);if(!e)return;e.sub(this.cachePosition).applyMatrix4(this.cacheObjectInvert),this.cacheMouseMoveDirection.copy(e).sub(this.cacheMouseDownPoistion).normalize();const n=this.currentGuizmo,h=this.currentIndex,s=this.config,c=this.cacheConfigIndex;if(n===this.anchorGizmo){const d=s.curves.length;if(h!==s.curves.length){const u=s.curves[h];u.params[0]=e.x,u.params[1]=e.y,this.updateHelper(h)}else{const u=s.curves[d-1];u.params[u.params.length-2]=e.x,u.params[u.params.length-1]=e.y,this.updateHelper(d-1)}const t=this.anchorGizmo.geometry.getAttribute("position"),m=t.array;m[h*3]=e.x,m[h*3+1]=e.y,t.needsUpdate=!0,this.dispatchEvent({type:"changing",index:c,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:"anchor"})}else if(n===this.moveGizmo){const d=this.moveCurveIndexMap[h].segmentIndex,t=s.curves[d],m=this.moveCurveIndexMap[h].type;m==="c1"?(t.params[2]=e.x,t.params[3]=e.y):m==="c2"&&(t.params[4]=e.x,t.params[5]=e.y);const u=this.moveGizmo.geometry.getAttribute("position"),M=u.array;M[h*3]=e.x,M[h*3+1]=e.y,u.needsUpdate=!0,this.updateHelper(d),this.dispatchEvent({type:"changing",index:c,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:"move"})}}pointerUp(r){this.dragging=!1,this.domElement.removeEventListener("mousemove",this._pointerMove),this.domElement.removeEventListener("mouseup",this._pointerUp),this.currentGuizmo&&(this.currentGuizmo.geometry.computeBoundingSphere(),this.currentGuizmo.geometry.computeBoundingBox()),this.dispatchEvent({type:"mouseup",index:this.cacheConfigIndex,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:this.currentGuizmo===this.anchorGizmo?"anchor":"move"})}};let f=g;a(f,"anchorMaterial",new o.PointsMaterial({map:b,transparent:!0,depthFunc:o.AlwaysDepth,alphaTest:.01,sizeAttenuation:!1,size:15})),a(f,"moveMaterial",new o.PointsMaterial({map:G,transparent:!0,depthFunc:o.AlwaysDepth,alphaTest:.01,sizeAttenuation:!1,size:15})),a(f,"moveHelperMaterial",new o.LineBasicMaterial({color:"rgb(100, 100, 100)"}));const P=w.transPkgName(I),z=function(i={}){let y,r;return{name:P,deps:[...v.PLUGINS,v.POINTER_MANAGER_PLUGIN],install(e){const n=new f(e.camera,e.dom);i.raycaster&&i.raycaster.params&&Object.assign(n.raycaster.params,i.raycaster.params),n.use(e.pointerManager),e.pathSupportControls=n,r=h=>{n.setDom(h.dom)},y=h=>{n.setCamera(h.camera)},e.addEventListener(l.ENGINE_EVENT.SETDOM,r),e.addEventListener(l.ENGINE_EVENT.SETCAMERA,y)},dispose(e){e.removeEventListener(l.ENGINE_EVENT.SETDOM,r),e.removeEventListener(l.ENGINE_EVENT.SETCAMERA,y),e.pathSupportControls.disconnect().dispose(),delete e.pathSupportControls}}};p.PATH_SUPPORT_CONTROLS_PLUGIN=P,p.PathSupportControlsPlugin=z,Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
