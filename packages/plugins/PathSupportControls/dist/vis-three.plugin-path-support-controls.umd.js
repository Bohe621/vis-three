(function(l,u){typeof exports=="object"&&typeof module!="undefined"?u(exports,require("@vis-three/core"),require("@vis-three/middleware"),require("@vis-three/utils"),require("three"),require("@vis-three/convenient")):typeof define=="function"&&define.amd?define(["exports","@vis-three/core","@vis-three/middleware","@vis-three/utils","three","@vis-three/convenient"],u):(l=typeof globalThis!="undefined"?globalThis:l||self,u((l["vis-three"]=l["vis-three"]||{},l["vis-three"]["plugin-path-support-controls"]={}),l.core,l.middleware,l.utils,l.three,l.convenient))})(this,function(l,u,v,M,m,P){"use strict";var T=Object.defineProperty;var x=(l,u,v)=>u in l?T(l,u,{enumerable:!0,configurable:!0,writable:!0,value:v}):l[u]=v;var n=(l,u,v)=>(x(l,typeof u!="symbol"?u+"":u,v),v);const b="@vis-three/plugin-path-support-controls",w=new m.CanvasTexture(new P.CanvasGenerator({width:32,height:32}).draw(r=>{r.beginPath(),r.fillStyle="rgba(0, 0, 0, 0)",r.fillRect(0,0,32,32),r.closePath(),r.beginPath(),r.fillStyle="rgb(0, 255, 238)",r.strokeStyle="black",r.lineWidth=1,r.arc(16,16,15,0,2*Math.PI),r.stroke(),r.fill(),r.closePath()}).getDom()),G=new m.CanvasTexture(new P.CanvasGenerator({width:32,height:32}).draw(r=>{r.beginPath(),r.fillStyle="rgba(0, 0, 0, 0)",r.fillRect(0,0,32,32),r.closePath(),r.beginPath(),r.fillStyle="rgb(255, 248, 0)",r.strokeStyle="black",r.lineWidth=1,r.arc(16,16,15,0,2*Math.PI),r.stroke(),r.fill(),r.closePath()}).getDom());new m.CanvasTexture(new P.CanvasGenerator({width:32,height:32}).draw(r=>{r.beginPath(),r.fillStyle="rgba(0, 0, 0, 0)",r.fillRect(0,0,32,32),r.closePath(),r.beginPath(),r.fillStyle="rgb(255, 0, 0)",r.strokeStyle="black",r.lineWidth=1,r.moveTo(1,0),r.lineTo(31,16),r.lineTo(0,31),r.lineTo(1,0),r.stroke(),r.fill(),r.closePath()}).getDom());const y=class extends m.Object3D{constructor(i,a,s,h){super();n(this,"dragging",!1);n(this,"raycaster",new m.Raycaster);n(this,"anchorGizmo",new m.Points(new m.BufferGeometry,y.anchorMaterial));n(this,"moveGizmo",new m.Points(new m.BufferGeometry,y.moveMaterial));n(this,"moveHelper",new m.LineSegments(new m.BufferGeometry,y.moveHelperMaterial));n(this,"plane",new m.Plane);n(this,"pointerManager");n(this,"cachePlaneVector3",new m.Vector3);n(this,"cacheQuaternion",new m.Quaternion);n(this,"cacheNormal",new m.Vector3);n(this,"cachePosition",new m.Vector3);n(this,"cacheMouseDownPoistion",new m.Vector3);n(this,"cacheMouseMoveDirection",new m.Vector3);n(this,"cacheConfigIndex",0);n(this,"moveCurveIndexMap",{});n(this,"helperRangeMap",{});n(this,"currentGuizmo");n(this,"currentIndex",0);n(this,"domElement");n(this,"camera");n(this,"config");n(this,"object");n(this,"cacheObjectInvert");n(this,"pathType",2);n(this,"_pointerHover",this.pointerHover.bind(this));n(this,"_pointerMove",this.pointerMove.bind(this));n(this,"_pointerDown",this.pointerDown.bind(this));n(this,"_pointerUp",this.pointerUp.bind(this));this.anchorGizmo.type="PathSupportControlsAnchorGizmo",this.moveGizmo.type="PathSupportControlsMoveGizmo",this.moveHelper.type="PathSupportControlsMoveHelper",this.moveHelper.raycast=()=>{},this.add(this.anchorGizmo,this.moveGizmo,this.moveHelper),this.renderOrder=1/0,this.matrixAutoUpdate=!1,s&&this.setObject(s),h&&this.setConfig(h),this.setDom(a).setCamera(i).connect()}setDom(i){return this.domElement&&this.disconnect(),this.domElement=i,this.connect(),this}setCamera(i){return this.camera=i,this}setObject(i){return this.object=i,this.matrix=i.matrix,this.matrixWorld=i.matrixWorld,this.cacheObjectInvert=i.matrixWorld.clone().invert(),i.parent.add(this),this}setConfig(i){this.config=i,this.moveCurveIndexMap={},this.helperRangeMap={};const a=this.moveCurveIndexMap,s=this.helperRangeMap,h=[],t=[],o=[];this.config.type==="Path"?(this.pathType=2,this.config.curves.forEach((e,p,c)=>{p===c.length-1?h.push(e.params[0],e.params[1],0,e.params[e.params.length-2],e.params[e.params.length-1],0):h.push(e.params[0],e.params[1],0),e.curve==="arc"?(t.push(e.params[2],e.params[3],0),a[t.length/3-1]={segmentIndex:p,type:"c1"}):e.curve==="bezier"||e.curve==="cubic"?(t.push(e.params[2],e.params[3],0),o.push(e.params[0],e.params[1],0,e.params[2],e.params[3],0),a[t.length/3-1]={segmentIndex:p,type:"c1"},t.push(e.params[4],e.params[5],0),o.push(e.params[e.params.length-2],e.params[e.params.length-1],0,e.params[4],e.params[5],0),a[t.length/3-1]={segmentIndex:p,type:"c2"},s[p]={startIndex:o.length/3-4,previous:!1},s[p+1]={startIndex:o.length/3-4,previous:!0}):e.curve==="quadratic"&&(t.push(e.params[2],e.params[3],0),o.push(e.params[0],e.params[1],0,e.params[2],e.params[3],0,e.params[e.params.length-2],e.params[e.params.length-1],0,e.params[2],e.params[3],0),a[t.length/3-1]={segmentIndex:p,type:"c1"},s[p]={startIndex:o.length/3-4,previous:!1},s[p+1]={startIndex:o.length/3-4,previous:!0})})):this.config.type==="Path3"&&(this.pathType=3,this.config.curves.forEach((e,p,c)=>{p===c.length-1?h.push(e.params[0],e.params[1],e.params[2],e.params[e.params.length-3],e.params[e.params.length-2],e.params[e.params.length-1]):h.push(e.params[0],e.params[1],e.params[2]),e.curve==="cubic"?(t.push(e.params[3],e.params[4],e.params[5]),o.push(e.params[0],e.params[1],e.params[2],e.params[3],e.params[4],e.params[5]),a[t.length/3-1]={segmentIndex:p,type:"c1"},t.push(e.params[6],e.params[7],e.params[8]),o.push(e.params[e.params.length-3],e.params[e.params.length-2],e.params[e.params.length-1],e.params[6],e.params[7],e.params[8]),a[t.length/3-1]={segmentIndex:p,type:"c2"},s[p]={startIndex:o.length/3-4,previous:!1},s[p+1]={startIndex:o.length/3-4,previous:!0}):e.curve==="quadratic"&&(t.push(e.params[3],e.params[4],e.params[5]),o.push(e.params[0],e.params[1],e.params[2],e.params[3],e.params[4],e.params[5],e.params[e.params.length-3],e.params[e.params.length-2],e.params[e.params.length-1],e.params[3],e.params[4],e.params[5]),a[t.length/3-1]={segmentIndex:p,type:"c1"},s[p]={startIndex:o.length/3-4,previous:!1},s[p+1]={startIndex:o.length/3-4,previous:!0})}));const d=function(e,p){const c=e.geometry;c.setAttribute("position",new m.BufferAttribute(new Float32Array(p),3).setUsage(m.DynamicDrawUsage)),c.getAttribute("position").needsUpdate=!0,c.computeBoundingBox(),c.computeBoundingSphere()};return d(this.anchorGizmo,h),d(this.moveGizmo,t),d(this.moveHelper,o),this}update(){this.setConfig(this.config)}updateHelper(i){const a=this.helperRangeMap;if(a[i]!==void 0){const{startIndex:s,previous:h}=a[i],t=h?this.config.curves[i-1]:this.config.curves[i],o=this.moveHelper.geometry.getAttribute("position");t.curve==="bezier"||t.curve==="cubic"?this.pathType===2?(o.setXYZ(s,t.params[0],t.params[1],0),o.setXYZ(s+1,t.params[2],t.params[3],0),o.setXYZ(s+2,t.params[t.params.length-2],t.params[t.params.length-1],0),o.setXYZ(s+3,t.params[4],t.params[5],0)):this.pathType===3&&(o.setXYZ(s,t.params[0],t.params[1],t.params[2]),o.setXYZ(s+1,t.params[3],t.params[4],t.params[5]),o.setXYZ(s+2,t.params[t.params.length-3],t.params[t.params.length-2],t.params[t.params.length-1]),o.setXYZ(s+3,t.params[6],t.params[7],t.params[8])):t.curve==="quadratic"&&(this.pathType===2?(o.setXYZ(s,t.params[0],t.params[1],0),o.setXYZ(s+1,t.params[2],t.params[3],0),o.setXYZ(s+2,t.params[t.params.length-2],t.params[t.params.length-1],0),o.setXYZ(s+3,t.params[2],t.params[3],0)):this.pathType===3&&(o.setXYZ(s,t.params[0],t.params[1],t.params[2]),o.setXYZ(s+1,t.params[3],t.params[4],t.params[5]),o.setXYZ(s+2,t.params[t.params.length-3],t.params[t.params.length-2],t.params[t.params.length-1]),o.setXYZ(s+3,t.params[3],t.params[4],t.params[5]))),o.needsUpdate=!0}return this}use(i){this.pointerManager=i}connect(){return this.object&&this.config&&(this.domElement.addEventListener("pointermove",this._pointerHover),this.domElement.addEventListener("mousedown",this._pointerDown)),this}disconnect(){return this.domElement.removeEventListener("pointermove",this._pointerHover),this.domElement.removeEventListener("mousedown",this._pointerDown),this}dispose(){const i=a=>{a.geometry.dispose(),Array.isArray(a.material)?a.material.forEach(s=>{s.dispose()}):a.material.dispose()};i(this.anchorGizmo),i(this.moveGizmo)}intersectPoint(i){this.raycaster.setFromCamera(this.pointerManager.mouse,this.camera);const a=this.raycaster.intersectObject(this,!0);return a.length?(this.currentGuizmo=a[0].object,this.currentIndex=a[0].index,{guizmo:this.currentGuizmo,index:this.currentIndex,point:a[0].point}):null}intersectPlane(i){return this.raycaster.setFromCamera(this.pointerManager.mouse,this.camera),this.raycaster.ray.intersectPlane(this.plane,this.cachePlaneVector3)}pointerHover(i){if(this.dragging||!this.visible)return;const a=this.intersectPoint(i);Number.isInteger(a==null?void 0:a.index)?this.domElement.style.cursor="move":this.domElement.style.cursor=""}pointerDown(i){if(!this.visible)return;const a=this.intersectPoint(i);if(a){this.dragging=!0,this.pathType===2?(this.cacheQuaternion.setFromRotationMatrix(this.object.matrixWorld),this.cacheNormal.set(0,0,1).applyQuaternion(this.cacheQuaternion),this.cachePosition.setFromMatrixPosition(this.object.matrixWorld),this.plane.set(this.cacheNormal,this.cachePosition.projectOnVector(this.cacheNormal).length())):this.pathType===3&&(this.camera.getWorldPosition(this.plane.normal).sub(a.point).normalize(),this.plane.constant=(a.point.dot(this.plane.normal)>0?1:-1)*a.point.projectOnVector(this.plane.normal).length()),this.cacheMouseDownPoistion.copy(this.intersectPlane(i)).sub(this.cachePosition);const s=this.currentIndex===this.config.curves.length?this.currentIndex-1:this.currentIndex;this.dispatchEvent({type:"mousedown",index:s,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:this.currentGuizmo===this.moveGizmo?"move":"anchor"}),this.cacheConfigIndex=s,this.domElement.addEventListener("mousemove",this._pointerMove),this.domElement.addEventListener("mouseup",this._pointerUp)}}pointerMove(i){if(!this.visible&&!this.dragging)return;const a=this.intersectPlane(i);if(!a)return;a.sub(this.cachePosition).applyMatrix4(this.cacheObjectInvert),this.cacheMouseMoveDirection.copy(a).sub(this.cacheMouseDownPoistion).normalize();const s=this.currentGuizmo,h=this.currentIndex,t=this.config,o=this.cacheConfigIndex;if(s===this.anchorGizmo){const d=t.curves.length;if(h!==t.curves.length){const c=t.curves[h];c.params[0]=a.x,c.params[1]=a.y,this.pathType===3&&(c.params[2]=a.z),this.updateHelper(h)}else{const c=t.curves[d-1];this.pathType===3?(c.params[c.params.length-3]=a.x,c.params[c.params.length-2]=a.y,c.params[c.params.length-1]=a.z):(c.params[c.params.length-2]=a.x,c.params[c.params.length-1]=a.y),this.updateHelper(d-1)}const e=this.anchorGizmo.geometry.getAttribute("position"),p=e.array;p[h*3]=a.x,p[h*3+1]=a.y,this.pathType===3&&(p[h*3+2]=a.z),e.needsUpdate=!0,this.dispatchEvent({type:"changing",index:o,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:"anchor"})}else if(s===this.moveGizmo){const d=this.moveCurveIndexMap[h].segmentIndex,e=t.curves[d],p=this.moveCurveIndexMap[h].type;p==="c1"?this.pathType===2?(e.params[2]=a.x,e.params[3]=a.y):(e.params[3]=a.x,e.params[4]=a.y,e.params[5]=a.z):p==="c2"&&(this.pathType===2?(e.params[4]=a.x,e.params[5]=a.y):(e.params[6]=a.x,e.params[7]=a.y,e.params[8]=a.z));const c=this.moveGizmo.geometry.getAttribute("position"),E=c.array;E[h*3]=a.x,E[h*3+1]=a.y,this.pathType===3&&(E[h*3+2]=a.z),c.needsUpdate=!0,this.updateHelper(d),this.dispatchEvent({type:"changing",index:o,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:"move"})}}pointerUp(i){this.dragging=!1,this.domElement.removeEventListener("mousemove",this._pointerMove),this.domElement.removeEventListener("mouseup",this._pointerUp),this.currentGuizmo&&(this.currentGuizmo.geometry.computeBoundingSphere(),this.currentGuizmo.geometry.computeBoundingBox()),this.dispatchEvent({type:"mouseup",index:this.cacheConfigIndex,config:this.config,last:this.currentIndex===this.config.curves.length,object:this.object,operate:this.currentGuizmo===this.anchorGizmo?"anchor":"move"})}};let f=y;n(f,"anchorMaterial",new m.PointsMaterial({map:w,transparent:!0,depthFunc:m.AlwaysDepth,alphaTest:.01,sizeAttenuation:!1,size:15})),n(f,"moveMaterial",new m.PointsMaterial({map:G,transparent:!0,depthFunc:m.AlwaysDepth,alphaTest:.01,sizeAttenuation:!1,size:15})),n(f,"moveHelperMaterial",new m.LineBasicMaterial({color:"rgb(100, 100, 100)"}));const I=M.transPkgName(b),z=function(r={raycaster:{params:{Line:{threshold:5},Points:{threshold:5}}}}){let g,i;return{name:I,deps:[...v.PLUGINS,v.POINTER_MANAGER_PLUGIN],install(a){const s=new f(a.camera,a.dom);r.raycaster&&r.raycaster.params&&Object.assign(s.raycaster.params,r.raycaster.params),s.use(a.pointerManager),a.pathSupportControls=s,i=h=>{s.setDom(h.dom)},g=h=>{s.setCamera(h.camera)},a.addEventListener(u.ENGINE_EVENT.SETDOM,i),a.addEventListener(u.ENGINE_EVENT.SETCAMERA,g)},dispose(a){a.removeEventListener(u.ENGINE_EVENT.SETDOM,i),a.removeEventListener(u.ENGINE_EVENT.SETCAMERA,g),a.pathSupportControls.disconnect().dispose(),delete a.pathSupportControls}}};l.PATH_SUPPORT_CONTROLS_PLUGIN=I,l.PathSupportControlsPlugin=z,Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
