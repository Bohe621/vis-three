(function(s,d){typeof exports=="object"&&typeof module!="undefined"?d(exports,require("three"),require("three/examples/jsm/loaders/OBJLoader"),require("three/examples/jsm/loaders/MTLLoader"),require("three/examples/jsm/loaders/RGBELoader"),require("three/examples/jsm/loaders/GLTFLoader"),require("three/examples/jsm/loaders/FBXLoader"),require("three/examples/jsm/loaders/DRACOLoader"),require("three/examples/jsm/loaders/KTX2Loader.js"),require("three/examples/jsm/loaders/DDSLoader.js"),require("three/examples/jsm/libs/meshopt_decoder.module.js"),require("@vis-three/core"),require("@vis-three/utils")):typeof define=="function"&&define.amd?define(["exports","three","three/examples/jsm/loaders/OBJLoader","three/examples/jsm/loaders/MTLLoader","three/examples/jsm/loaders/RGBELoader","three/examples/jsm/loaders/GLTFLoader","three/examples/jsm/loaders/FBXLoader","three/examples/jsm/loaders/DRACOLoader","three/examples/jsm/loaders/KTX2Loader.js","three/examples/jsm/loaders/DDSLoader.js","three/examples/jsm/libs/meshopt_decoder.module.js","@vis-three/core","@vis-three/utils"],d):(s=typeof globalThis!="undefined"?globalThis:s||self,d((s["vis-three"]=s["vis-three"]||{},s["vis-three"]["plugin-loader-manager"]={}),s.three,s.OBJLoader,s.MTLLoader,s.RGBELoader,s.GLTFLoader,s.FBXLoader,s.DRACOLoader,s.KTX2Loader_js,s.DDSLoader_js,s.meshopt_decoder_module_js,s.core,s.utils))})(this,function(s,d,p,j,T,S,O,x,A,F,R,w,B){"use strict";var N=Object.defineProperty;var J=(s,d,p)=>d in s?N(s,d,{enumerable:!0,configurable:!0,writable:!0,value:p}):s[d]=p;var l=(s,d,p)=>(J(s,typeof d!="symbol"?d+"":d,p),p);const f=class extends d.Loader{constructor(r){super(r)}load(r,e,o,n){this.path!==void 0&&(r=this.path+r),this.manager.itemStart(r),r=this.manager.resolveURL(r);const i=d.Cache.get(r);if(i!==void 0)return setTimeout(()=>{e&&e(i),this.manager.itemEnd(r)},0),i;const t=document.createElement("video");return t.preload=f.preload,t.autoplay=f.autoplay,t.loop=f.loop,t.muted=f.muted,t.src=r,t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.zIndex="-1",document.body.appendChild(t),t.oncanplay=()=>{d.Cache.add(r,t),this.manager.itemEnd(r),e&&e(t)},t.onerror=u=>{this.manager.itemEnd(r),n&&n(u)},t}};let L=f;l(L,"autoplay",!0),l(L,"preload","auto"),l(L,"muted",!0),l(L,"loop",!0);var E=(h=>(h.BEFORELOAD="beforeLoad",h.LOADING="loading",h.DETAILLOADING="detailLoading",h.DETAILLOADED="detailLoaded",h.LOADED="loaded",h))(E||{});class M extends w.EventDispatcher{constructor(e){super();l(this,"resourceMap");l(this,"loaderMap");l(this,"urlList",[]);l(this,"loadTotal");l(this,"loadSuccess");l(this,"loadError");l(this,"isError");l(this,"isLoading");l(this,"isLoaded");l(this,"loadDetailMap");l(this,"path","");this.resourceMap=new Map,this.loadTotal=0,this.loadSuccess=0,this.loadError=0,this.isError=!1,this.isLoading=!1,this.isLoaded=!1,this.loadDetailMap={};const o=new d.ImageLoader,n=new L,i=new S.GLTFLoader;i.setDRACOLoader(new x.DRACOLoader),i.setKTX2Loader(new A.KTX2Loader),i.setMeshoptDecoder(R.MeshoptDecoder),this.loaderMap={jpg:o,png:o,jpeg:o,obj:new p.OBJLoader,mtl:new j.MTLLoader,mp4:n,webm:n,ogg:n,hdr:new T.RGBELoader,gltf:i,glb:i,fbx:new O.FBXLoader,dds:new F.DDSLoader},e&&(this.loaderMap=Object.assign(this.loaderMap,e.loaderExtends))}loaded(){return this.dispatchEvent({type:"loaded",loadTotal:this.loadTotal,loadSuccess:this.loadSuccess,loadError:this.loadError,resourceMap:this.resourceMap}),this}checkLoaded(){return this.loadTotal===this.loadSuccess+this.loadError&&(this.isError=!0,this.isLoaded=!0,this.isLoading=!1,this.loaded()),this}setPath(e){return this.path=e,this}setRequestHeader(e){return Object.values(this.loaderMap).forEach(o=>{o.setRequestHeader(e)}),this}setResponseType(e){return Object.values(this.loaderMap).forEach(o=>{o.setResponseType&&o.setResponseType(e)}),this}getLoader(e){return this.loaderMap[e]?this.loaderMap[e]:null}load(e){var t;if(this.reset(),this.isLoading=!0,this.dispatchEvent({type:"beforeLoad",urlList:[...e]}),e.length<=0)return this.checkLoaded(),console.warn("url list is empty."),this;this.loadTotal+=e.length;const o=this.resourceMap,n=this.loaderMap,i=this.loadDetailMap;for(const u of e){let c,m;typeof u=="string"?(c=u,m=((t=c.split(".").pop())==null?void 0:t.toLocaleLowerCase())||""):(c=u.url,m=u.ext.toLocaleLowerCase(),m.startsWith(".")&&(m=m.slice(1)));const a={url:c,progress:0,error:!1,message:c};if(i[c]=a,o.has(c)){a.progress=1,this.loadSuccess+=1,this.dispatchEvent({type:"detailLoaded",detail:a}),this.dispatchEvent({type:"loading",loadTotal:this.loadTotal,loadSuccess:this.loadSuccess,loadError:this.loadError}),this.checkLoaded();continue}if(!m){a.message=`url: ${c} \u5730\u5740\u6709\u8BEF\uFF0C\u65E0\u6CD5\u83B7\u53D6\u6587\u4EF6\u683C\u5F0F\u3002`,console.warn(a.message),a.error=!0,this.isError=!0,this.loadError+=1,this.dispatchEvent({type:"detailLoaded",detail:a}),this.dispatchEvent({type:"loading",loadTotal:this.loadTotal,loadSuccess:this.loadSuccess,loadError:this.loadError});continue}const v=n[m];if(!v){a.message=`url: ${c} \u4E0D\u652F\u6301\u6B64\u6587\u4EF6\u683C\u5F0F\u52A0\u8F7D\u3002`,console.warn(a.message),a.error=!0,this.isError=!0,this.loadError+=1,this.dispatchEvent({type:"detailLoaded",detail:a}),this.dispatchEvent({type:"loading",loadTotal:this.loadTotal,loadSuccess:this.loadSuccess,loadError:this.loadError});continue}const y=c.replace(/\\/g,"/").split("/"),G=y.pop(),P=this.path+y.join("/")+"/";v.setPath(P).loadAsync(G,g=>{a.progress=Number((g.loaded/g.total).toFixed(2)),this.dispatchEvent({type:"detailLoading",detail:a})}).then(g=>{a.progress=1,this.loadSuccess+=1,this.resourceMap.set(c,g),this.urlList.push(u),this.dispatchEvent({type:"detailLoaded",detail:a}),this.dispatchEvent({type:"loading",loadTotal:this.loadTotal,loadSuccess:this.loadSuccess,loadError:this.loadError}),this.checkLoaded()}).catch(g=>{a.error=!0,a.message=JSON.stringify(g),this.loadError+=1,this.dispatchEvent({type:"detailLoaded",detail:a}),this.dispatchEvent({type:"loading",loadTotal:this.loadTotal,loadSuccess:this.loadSuccess,loadError:this.loadError}),this.checkLoaded()})}return this}reset(){return this.loadTotal=0,this.loadSuccess=0,this.loadError=0,this.isError=!1,this.isLoading=!1,this.isLoaded=!1,this.loadDetailMap={},this}register(e,o){return this.loaderMap[e]=o,this}hasLoaded(e){return this.resourceMap.has(e)}getResource(e){return this.resourceMap.get(e)}getLoadDetailMap(){return this.loadDetailMap}setLoadDetailMap(e){return this.loadDetailMap=e,this}remove(e){}toJSON(){return JSON.stringify(this.urlList)}exportConfig(){return JSON.parse(JSON.stringify(this.urlList))}dispose(){return this.resourceMap.clear(),this}}const C="@vis-three/plugin-loader-manager",D=B.transPkgName(C),q=function(h){return{name:D,install(r){const e=new M(h);h!=null&&h.path&&e.setPath(h.path),r.loaderManager=e,r.loadResources=(o,n)=>{const i=t=>{n(void 0,t),e.removeEventListener(E.LOADED,i)};try{e.addEventListener(E.LOADED,i)}catch(t){n(t)}return e.load(o),r},r.loadResourcesAsync=o=>new Promise((n,i)=>{const t=u=>{n(u),e.removeEventListener(E.LOADED,t)};try{e.addEventListener(E.LOADED,t)}catch(u){i(u)}e.load(o)})},dispose(r){r.loaderManager.dispose(),delete r.loaderManager,delete r.loadResources,delete r.loadResourcesAsync}}};s.LOADER_EVENT=E,s.LOADER_MANAGER_PLUGIN=D,s.LoaderManager=M,s.LoaderManagerPlugin=q,Object.defineProperties(s,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
