(function(i,h){typeof exports=="object"&&typeof module<"u"?h(exports,require("@vis-three/utils"),require("@vis-three/core"),require("rxjs"),require("nanoid"),require("@vis-three/plugin-loader-manager"),require("@vis-three/plugin-pointer-manager"),require("@vis-three/plugin-event-manager"),require("@vis-three/plugin-render-manager")):typeof define=="function"&&define.amd?define(["exports","@vis-three/utils","@vis-three/core","rxjs","nanoid","@vis-three/plugin-loader-manager","@vis-three/plugin-pointer-manager","@vis-three/plugin-event-manager","@vis-three/plugin-render-manager"],h):(i=typeof globalThis<"u"?globalThis:i||self,h((i["vis-three"]=i["vis-three"]||{},i["vis-three"].tdcm={}),i.utils,i.core,i.rxjs,i.nanoid,i.pluginLoaderManager,i.pluginPointerManager,i.pluginEventManager,i.pluginRenderManager))})(this,function(i,h,O,te,Fe,y,J,_,F){"use strict";const ke=function(r){return r=r.replace(/[\-_\s]+(.)?/g,function(e,t){return t?t.toUpperCase():""}),r.slice(0,1).toLowerCase()+r.slice(1)},Ve=function(r){return ke(r).toUpperCase()},re=function(r){const e=/(?=[A-Z])/;return r.split(e).map(t=>t.toUpperCase()).join("_")},M={},ne={},N={},k={},C={},L={},V=M,qe=N,q=k,se=C,He=L,x=r=>L[r]||null,oe=r=>C[r],ie=r=>{const e=x(r);return e?oe(e):!1},H="vis.father",b="vis.key",W="vis.observer",Y="vis.model",ae=new WeakMap,I=function(r){Array.isArray(r)&&ae.set(r,r.concat([]))},We=function(r){return ae.get(r)},z=function(r){let e="";const t=n=>{n[Symbol.for(b)]!==void 0&&(e=`${n[Symbol.for(b)]}${e?`.${e}`:""}`,n[Symbol.for(H)]&&t(n[Symbol.for(H)]))};return t(r),e},Ye=function(r){if(r.length&&h.isObject(r[0])){const e=r.length;for(let t=0;t<e;t+=1)r[t][Symbol.for(b)]=t}},A=function(r){return r[Symbol.for(W)]},ce=function(r){return!!r[Symbol.for(W)]},ze=function(r){return r[Symbol.for(Y)]},f=class f{static exec(e){if(e(!1))return;f.list.includes(e)||f.list.push(e);let t=0;const n=()=>{f.timer&&clearTimeout(f.timer),f.timer=window.setTimeout(()=>{const s=[];for(const o of f.list)o(!1)||s.push(o);if(s.length)if(s.length===t){for(const o of s)o(!0);f.list=[]}else t=s.length,f.list=s,n();else f.list=[]},f.time)};n()}static append(e){f.list.length&&!f.list.includes(e)?f.list.push(e):f.exec(e)}static nextTick(e){window.setTimeout(()=>{e()},f.time)}};f.list=[],f.time=0;let D=f;class Z extends O.EventDispatcher{constructor(e){super(),this.config=e.config,this.engine=e.engine,this.compiler=e.compiler}toConfig(e){return this.engine.getConfigBySymbol(e)}toModel(e){if(typeof e=="string")return this.engine.compilerManager.getModelBySymbol(e);{const t=this.engine.getObjectSymbol(e);return t?this.engine.compilerManager.getModelBySymbol(t):(console.warn("Model: can not found object symbol:",e),null)}}toObject(e){return this.engine.getObjectBySymbol(e)}toPuppet(e){return this.toObject(e)}toAsync(e){D.exec(e)}asyncNextTick(e){D.nextTick(e)}toTrigger(e,t){const n=this.engine.getTrigger(e);n&&n.register(t)}process(e){if(!this.commands||!this.commands[e.operate]){this[e.operate](e);return}let t=this.commands[e.operate];const n=e.path?e.path.split(".").concat(e.key):[e.key];for(const s of n)if(!t[s]&&!t.$reg){this[e.operate](e);return}else if(t[s])if(typeof t[s]=="function"){t[s].call(this,{model:this,ctx:this,config:this.config,target:this.puppet,puppet:this.puppet,engine:this.engine,compiler:this.compiler,...e});return}else t=t[s];else if(t.$reg){for(const o of t.$reg)if(o.reg.test(s)){o.handler.call(this,{model:this,ctx:this,config:this.config,target:this.puppet,puppet:this.puppet,engine:this.engine,compiler:this.compiler,...e});return}}this[e.operate](e)}add(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default add operate.",e);return}t[e.key]=e.value}set(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default set operate.",e);return}t[e.key]=e.value}delete(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default delete operate.",e);return}delete t[e.key]}create(){this.config[Symbol.for(Y)]=this,this.puppet=this.createPuppet.call(this,{model:this,config:this.config,engine:this.engine,compiler:this.compiler})}dispose(){this.disposePuppet.call(this,{model:this,target:this.puppet,puppet:this.puppet,config:this.config,engine:this.engine,compiler:this.compiler}),this.config[Symbol.for(Y)]=void 0,this.clear()}}const R=function(r){return r};R.extend=function(r){const e=function(t){const n=t(r);return n.shared=Object.assign({},r.shared,n.shared),n.commands=Object.assign({},r.commands,n.commands),n.context=function(s){return Object.assign(r.context?r.context(s):{},n.context?n.context.call(this,s):{})},n};return e.extend=function(t){const n=t(r);return n.shared=Object.assign({},r.shared,n.shared),n.commands=Object.assign({},r.commands,n.commands),n.context=function(s){return Object.assign(r.context?r.context(s):{},n.context?n.context.call(this,s):{})},R.extend(n)},e},R.expand=function(r){return r};const Ze=R;var m=(r=>(r.COMPILED_ADD="compiledAdd",r.COMPILED_REMOVE="compiledRemove",r.COMPILED_ATTR="compiledAttr",r.COMPILED_UPDATE="compiledUpdate",r.COMPILED="compiled",r.NOTICED="noticed",r))(m||{});class le{constructor(e){this.MODULE="",this.builders=new Map,this.target={},this.map=new Map,this.symbolMap=new WeakMap,this.MODULE=e.module;for(const t of e.models)this.useModel(t)}getMap(){return null}useEngine(e){return this.engine=e,this}setTarget(e){return this.target=e,this}add(e){if(!this.builders.has(e.type))return console.warn(`${this.MODULE} Compiler: can not support this type: ${e.type}`),null;const{option:t,Builder:n}=this.builders.get(e.type),s=n?new n({config:e,engine:this.engine,compiler:this}):new Z({config:e,engine:this.engine,compiler:this});return t.context&&Object.assign(s,t.context({model:s})),s.createPuppet=t.create,s.disposePuppet=t.dispose,s.commands=t.commands,s.create(),this.map.set(e.vid,s),this.symbolMap.set(s.puppet,e.vid),s.emit(m.COMPILED_ADD),s.emit(m.COMPILED),s.puppet}remove(e){const t=e.vid;if(!this.map.has(t))return console.warn(`${this.MODULE} Compiler: can not found this vid object: ${t}.`),this;if(!this.builders.has(e.type))return console.warn(`${this.MODULE} Compiler: can not support this type: ${e.type}`),this;const n=this.map.get(t);return this.map.delete(t),this.symbolMap.delete(n.puppet),n.dispose(),n.emit(m.COMPILED_REMOVE),n.emit(m.COMPILED),this}cover(e){const t=e.vid;return this.map.has(t)?(Promise.resolve().then(()=>{h.syncObject(e,e,{vid:!0,type:!0})}),this):(console.warn(`${this.MODULE} Compiler: can not found this vid object: ${t}.`),this)}compile(e,t){if(!this.map.has(e))return console.warn(`${this.MODULE} Compiler: can not found model which vid is: '${e}'`),this;const n=this.map.get(e);n.process(t);const s=t.path;return n.emit(`${m.COMPILED_ATTR}:${s&&s+"."}${t.key}`),n.emit(m.COMPILED_UPDATE),n.emit(m.COMPILED),this}compileAll(){const e=this.target;for(const t of Object.values(e))this.add(t);return this}dispose(){for(const e of this.map.values())e.dispose();return this.map.clear(),this.target={},this}getObjectSymbol(e){return this.symbolMap.get(e)||null}getObjectBySymbol(e){var t;return((t=this.map.get(e))==null?void 0:t.puppet)||null}getModelBySymbol(e){return this.map.get(e)||null}useModel(e,t){if(this.builders.has(e.type))return console.warn(`${this.MODULE} Compiler: has already exist this model ${e.type}.`),this;let n;if(e.shared){n=class extends Z{constructor(s){super(s)}};for(const s in e.shared)n.prototype[s]=e.shared[s]}return this.builders.set(e.type,{option:e,Builder:n}),Object.defineProperty(M,e.type,{get(){return e.config}}),k[re(e.type)]=e.type,q[Ve(e.type)]=e.type,L[e.type]=this.MODULE,ne[e.type]=e,t&&t(this),this}useProcessor(e,t){return this.useModel(e,t)}}const p={proxy:{expand:void 0,timing:"before",toRaw:void 0},symbol:{generator:Fe.nanoid,validator:r=>r.length===21},engine:void 0},Xe=function(r){r.proxy&&Object.assign(p.proxy,r.proxy),r.symbol&&Object.assign(p.symbol,r.symbol)},ue=function(r,e,t){return Reflect.get(r,e,t)},fe=function(r,e,t,n,s){if(typeof e=="symbol")return Reflect.set(r,e,t,n);if(r[e]===void 0){const o=Reflect.set(r,e,t);return s.add(t),s.next({operate:"add",path:"",key:e,value:t,symbol:e}),o}else{const o=Reflect.set(r,e,t);return s.remove(t.vid),s.add(t),s.next({operate:"set",path:"",key:e,value:t,symbol:e}),o}},he=function(r,e,t){if(typeof e=="symbol")return Reflect.deleteProperty(r,e);const n=r[e],s=Reflect.deleteProperty(r,e);return t.next({operate:"delete",path:"",key:e,value:n,symbol:e}),t.remove(n.vid),s};class pe extends te.Subject{constructor(){super(),this.subscriptions=new Map;const e=p.proxy.expand?(t={})=>p.proxy.expand(t):(t={})=>t;p.proxy.timing==="before"?this.space=new Proxy(e(),{get:ue,set:(t,n,s,o)=>fe(t,n,s,o,this),deleteProperty:(t,n)=>he(t,n,this)}):this.space=e(new Proxy({},{get:ue,set:(t,n,s,o)=>fe(t,n,s,o,this),deleteProperty:(t,n)=>he(t,n,this)}))}add(e){const t=A(e);if(!t){console.error("Container: this config can not observer",e);return}this.subscriptions.set(t.target.vid,t.subscribe(n=>{this.next({operate:n.operate,path:n.path,key:n.key,value:n.value,symbol:t.target.vid})}))}remove(e){this.subscriptions.delete(e)}}const S=(r,e)=>e===1/0?"Infinity":e===-1/0?"-Infinity":e,X=(r,e)=>e==="Infinity"?1/0:e==="-Infinity"?-1/0:e,P=r=>JSON.parse(JSON.stringify(r,S),X),E={stringify:S,parse:X,clone:P},Ke=Object.freeze(Object.defineProperty({__proto__:null,clone:P,default:E,parse:X,stringify:S},Symbol.toStringTag,{value:"Module"})),d=function(r,e,t={observer:!0,strict:!0,warn:!0}){if(t.observer===void 0&&(t.observer=!0),t.strict===void 0&&(t.strict=!0),t.warn===void 0&&(t.warn=!0),t.handler===void 0&&(t.handler=p.proxy.expand),!V[r])return console.error(`type: ${r} can not be found in configList.`),{vid:"",type:r};const n=(a,c)=>{for(const l in c){if(a[l]===void 0){!t.strict&&(a[l]=c[l]),t.strict&&t.warn&&console.warn(`'${r}' config can not set key: ${l}`);continue}typeof c[l]=="object"&&c[l]!==null&&!Array.isArray(c[l])?(a[l]===null&&(a[l]={...c[l]}),n(a[l],c[l])):a[l]=c[l]}};let s=V[r]();if(s.vid===""&&(s.vid=p.symbol.generator()),e&&n(s,e),t.observer===!1)return s;t.handler&&p.proxy.timing==="before"&&(s=t.handler(s));let o=Oe(s);if(t.handler&&p.proxy.timing==="after"&&(o=t.handler(o)),d.autoInject&&d.injectEngine){const a=d.injectEngine;if(a.applyConfig(o),d.injectScene&&ie(s.type)&&s.type!==q.SCENE){let c=null;typeof d.injectScene=="boolean"?c=a.getObjectConfig(a.scene):typeof d.injectScene=="string"&&(c=a.getConfigBySymbol(d.injectScene)),c?c.children.push(s.vid):console.warn("current engine scene can not found it config",a,a.scene)}return o}return o};d.autoInject=!0,d.injectScene=!1,d.injectEngine=null;const de=(r,e={})=>{let t=JSON.stringify(r,E.stringify);const n={};!e.filter&&(e.filter=["assets"]);const s=Object.keys(r).filter(a=>!e.filter.includes(a));for(const a of s)for(const c of r[a]){const l=c.vid,u=Ee();t=t.replace(new RegExp(l,"g"),u),e.detail&&(n[l]=u)}const o=JSON.parse(t,E.parse);if(e.fillName)if(typeof e.fillName=="function")for(const a of s)for(const c of o[a])c.name||(c.name=e.fillName(c));else for(const a of s)for(const c of o[a])c.name||(c.name=`${c.type}-${c.vid.slice(-2)}`);return e.detail?{config:o,detail:n}:o},K=(r,e,t={filter:["assets"],clone:!0})=>{const n=t.clone?E.clone(r):r;!t.filter&&(t.filter=["assets"]);const s=Object.keys(n).filter(o=>!t.filter.includes(o));for(const o of s)n[o].forEach((c,l,u)=>{u[l]=e(c)});return n},ge=function(r){const e={};for(const t of Object.keys(r))for(const n of r[t])e[n.name]=n;return e},me=function(r,e){return typeof r=="string"&&(r=JSON.parse(r,E.parse)),K(E.clone(r),t=>(t=d(t.type,t,{strict:!1}),e?e(t):t))},Qe=Object.freeze(Object.defineProperty({__proto__:null,clone:de,default:{clone:de,handler:K,planish:ge,observable:me},handler:K,observable:me,planish:ge},Symbol.toStringTag,{value:"Module"}));class ye{constructor(){this.list=[],this.time=0}exec(e){if(e(!1))return;this.list.includes(e)||this.list.push(e);let t=0;const n=()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const s=[];for(const o of this.list)o(!1)||s.push(o);if(s.length)if(s.length===t){for(const o of s)o(!0);this.list=[]}else t=s.length,this.list=s,n();else this.list=[]},this.time)};n()}append(e){this.list.length&&!this.list.includes(e)?this.list.push(e):this.exec(e)}nextTick(e){setTimeout(()=>{e()},this.time)}}const et=new ye;class Me{constructor(e){this.MODULE="",this.container=new pe,this.ruler=e.ruler,this.MODULE=e.module,this.container.subscribe(t=>{this.ruler.execute(t)})}getData(){return this.container.space}existSymbol(e){return!!this.container.space[e]}addConfig(e){return this.container.space[e.vid]=e,this}getConfig(e){return this.container.space[e]}removeConfig(e){const t=this.container.space;t[e]!==void 0&&delete t[e]}addCompiler(e){return e.setTarget(this.container.space),e.compileAll(),this.ruler.link(e),this}toJSON(e=!0){return JSON.stringify(e?this.exportConfig():Object.values(this.container.space),S)}exportConfig(e=!0){if(e){const t=this.container.space,n=[],s={},o=(a,c,l={})=>{for(const u in a){if(["vid","type"].includes(u)){l[u]=a[u];continue}if(typeof a[u]=="object"&&a[u]!==null){if(Array.isArray(a[u])){if(!a[u].length)continue;l[u]=a[u].map(g=>typeof g=="object"&&g!==null?P(g):g);continue}l[u]={},c[u]?(o(a[u],c[u],l[u]),Object.keys(l[u]).length===0&&delete l[u]):l[u]=P(a[u])}else c[u]!==a[u]&&(l[u]=a[u])}};for(const a of Object.values(t)){if(!s[a.type]){if(!M[a.type]){console.error(`can not font some config with: ${a.type}`);continue}s[a.type]=M[a.type]()}const c={};o(a,s[a.type],c),n.push(c)}return n}else return Object.values(P(this.container.space))}load(e){const t=this.container.space,n={},s=(o,a)=>{for(const c in a)typeof o[c]=="object"&&o[c]!==null&&typeof a[c]=="object"&&a[c]!==null?s(o[c],a[c]):o[c]===void 0&&(o[c]=a[c])};for(const o of e){if(!n[o.type]){if(!M[o.type]){console.error(`can not font some config with: ${o.type}`);continue}n[o.type]=M[o.type]()}s(o,n[o.type]),t[o.vid]=o}return this}remove(e){const t=this.container.space;for(const n of e)t[n.vid]!==void 0&&delete t[n.vid];return this}}const tt=["push","pop","shift","unshift","splice","sort","reverse"],w=new WeakSet,rt={get:function(r,e,t){return Array.isArray(r)&&tt.includes(e)&&w.add(r),Reflect.get(r,e,t)},set:function(r,e,t,n){const s=z(r),o=A(r);if(typeof e=="symbol"||o.ignore(h.extendPath(s,e)))return Reflect.set(r,e,t,n);if(h.isObject(t)&&!ce(t)&&(t=G(o,t,r,e)),r[e]===void 0){h.isObject(t)&&(t[Symbol.for(b)]=e,h.isArray(t)&&I(t)),h.isArray(r)&&w.delete(r);const l=Reflect.set(r,e,t);return h.isArray(r)&&I(r),o.next({operate:"add",path:s,key:e,value:t}),l}const a=r[e],c=Reflect.set(r,e,t);if(h.isArray(r)){if(w.has(r)&&e==="length"){const l=We(r);if(!l)return Array.isArray(a)&&console.error("array value is not be cached:",r),c;Ye(r);const u=Math.abs(l.length-r.length),g=l.length>=r.length?"delete":"add",gt=l.length>=r.length?r:l;let Ue=0,Je=0;for(const _e of g==="delete"?l:r){if(!gt.includes(_e)&&(o.next({operate:g,path:s,key:Je.toString(),value:_e}),Ue+=1,Ue===u))break;Je+=1}return I(r),w.delete(r),c}else if(w.has(r)||e==="length")return c}return o.next({operate:"set",path:s,key:e,value:t}),c},deleteProperty:function(r,e){const t=z(r),n=A(r);if(typeof e=="symbol"||n.ignore(t))return Reflect.deleteProperty(r,e);const s=r[e],o=Reflect.deleteProperty(r,e);return h.isArray(r)||n.next({operate:"delete",path:t,key:e,value:s}),o}},G=function(r,e,t,n){if(!h.isObject(e)||ce(e))return e;const s=t?z(t):"";if(r.ignore(s))return e;t&&(e[Symbol.for(H)]=t),e[Symbol.for(W)]=r;for(const a in e){const c=h.extendPath(s,a);if(!r.ignore(c)&&h.isObject(e[a])){if(h.isArray(e[a])){const l=e[a];e[a]=G(r,e[a],e),I(l)}else e[a]=G(r,e[a],e);e[a][Symbol.for(b)]=a}}return n&&(e[Symbol.for(b)]=n),new Proxy(e,rt)},T=class T extends te.Subject{constructor(e){super(),this.disable=!1,this.target=G(this,e)}ignore(e){const t=e.indexOf(".");return t===-1?T.IGNORE[e]:T.IGNORE[e.slice(0,t)]}next(e){if(this.disable)return;super.next(e);const t=ze(this.target);t&&t.emit(m.NOTICED)}};T.IGNORE={vid:!0,type:!0,alias:!0,meta:!0};let Q=T;const Oe=function(r){return new Q(r).target},nt=function(r,e){const t=A(r);if(!t){console.warn("this object can not found it observer:",r);return}t.disable=!0,e(),t.disable=!1},v={SYMBOL_VALIDATOR(r){return!p.symbol.validator(r.symbol)},OPERATE_ADD({operate:r,path:e,symbol:t,key:n,value:s},o){return r==="add"&&!e.length&&t===n?(o.add(s),!1):!0},OPERATE_DELETE({operate:r,path:e,value:t},n){return r==="delete"&&!e.length?(n.remove(t),!1):!0},OPERATE_COVER({operate:r,path:e,value:t,key:n,symbol:s},o){return r==="set"&&!e.length&&n===s?(o.cover(t),!1):!0},OPERATE_COMPILE(r,e){return e.compile(r.symbol,r),!1}};class be{constructor(e){this.rules=[],this.pointer=null,e?this.rules=e:this.rules.push(v.SYMBOL_VALIDATOR,v.OPERATE_ADD,v.OPERATE_DELETE,v.OPERATE_COVER,v.OPERATE_COMPILE)}link(e){this.compiler=e}execute(e){for(const t of this.rules)if(!t(e,this.compiler))break}remove(e){if(this.rules.includes(e)){const t=this.rules.indexOf(e);this.rules.splice(t,1)}else console.warn("Ruler: can not found rule",e,this.rules)}add(e,t){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):t!==void 0?(this.rules.splice(t,0,e),this):this.pointer===null?(console.error("Ruler:index is undefined, need a index or use before and after api to set a index"),this):(this.rules.splice(this.pointer,0,e),this)}before(e){return this.rules.includes(e)?(this.pointer=this.rules.indexOf(e),this):(console.warn("Ruler: rules not found this rule",this.rules),this)}after(e){return this.rules.includes(e)?(this.pointer=this.rules.indexOf(e)+1,this):(console.warn("Ruler: rules not found this rule",this.rules),this)}push(e){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):(this.rules.push(e),this)}unshift(e){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):(this.rules.unshift(e),this)}pop(){return this.rules.pop(),this}shift(){return this.rules.shift(),this}}const st=function(r){return r},Se=function(){return{vid:"",type:"",name:"",alias:"",meta:{}}},ot=Se,it=function(r){return`DEFUALT-${r}`},Ee=function(){return p.symbol.generator()},at=function(){};class ve{constructor(e){this.type="",this.module=e,this.type=e.type,this.ruler=new be(e.rule),this.compiler=e.compiler?new e.compiler({module:e.type,models:e.models}):new le({module:e.type,models:e.models}),this.converter=new Me({module:e.type,ruler:this.ruler}).addCompiler(this.compiler)}}const ct=function(r){return r};class Ce extends O.EventDispatcher{constructor(){super(),this.compilerMap=new Map}extend(e,t=!1){this.compilerMap.has(e.MODULE)?(console.warn("compiler manager has exist this compiler",e),t&&this.compilerMap.set(e.MODULE,e)):this.compilerMap.set(e.MODULE,e)}getCompiler(e){return this.compilerMap.has(e)?this.compilerMap.get(e):(console.warn(`can not found this type in compiler manager: ${e}`),null)}getObjectSymbol(e){for(const t of this.compilerMap.values()){const n=t.getObjectSymbol(e);if(n)return n}return null}getObjectBySymbol(e){for(const t of this.compilerMap.values()){const n=t.getObjectBySymbol(e);if(n)return n}return null}getModelBySymbol(e){for(const t of this.compilerMap.values()){const n=t.getModelBySymbol(e);if(n)return n}return null}getObjectfromModule(e,t){return this.getObjectFromModule(e,t)}getObjectFromModule(e,t){var s;return this.compilerMap.has(e)?((s=this.compilerMap.get(e).map.get(t))==null?void 0:s.puppet)||null:(console.warn(`compiler manager can not found this module: ${e}`),null)}getObjectfromModules(e,t){return this.getObjectFromModules(e,t)}getObjectFromModules(e,t){var n;Array.isArray(e)||(e=Object.keys(e));for(const s of e){if(!this.compilerMap.has(s)){console.warn(`compiler manager can not found this module: ${s}`);continue}const o=this.compilerMap.get(s);if(o.map.has(t))return(n=o.map.get(t))==null?void 0:n.puppet}return null}dispose(){for(const e of this.compilerMap.values())e.dispose();return this.compilerMap.clear(),this}}const $="CompilerManagerPlugin",Ae=function(){return{name:$,install(r){const e=new Ce;r.compilerManager=e,r.getObjectSymbol=function(t){return e.getObjectSymbol(t)},r.getObjectBySymbol=function(t){return e.getObjectBySymbol(t)},r.getObjectfromModule=function(t,n){return e.getObjectfromModule(t,n)},r.getObjectfromModules=function(t,n){return e.getObjectfromModules(t,n)},r.getObject3D=function(t){return e.getObjectfromModules(se,t)}},dispose(r){r.compilerManager.dispose(),delete r.compilerManager,delete r.getObjectSymbol,delete r.getObjectBySymbol,delete r.getObjectfromModule,delete r.getObjectfromModules,delete r.getObject3D}}};class De extends O.EventDispatcher{constructor(){super(),this.dataSupportMap=new Map}extend(e,t=!1){this.dataSupportMap.has(e.MODULE)?(console.warn("dataSupport manager has exist this dataSupport",e),t&&this.dataSupportMap.set(e.MODULE,e)):this.dataSupportMap.set(e.MODULE,e)}getDataSupport(e){return this.dataSupportMap.has(e)?this.dataSupportMap.get(e):(console.warn(`can not found this type in dataSupportManager: ${e}`),null)}getConfigBySymbol(e){const t=this.dataSupportMap.values();for(const n of t){const s=n.getConfig(e);if(s)return s}return null}getConfigfromModule(e,t){return this.getConfigFromModule(e,t)}getConfigFromModule(e,t){return this.dataSupportMap.has(e)?this.dataSupportMap.get(e).getConfig(t)||null:(console.warn(`data support manager can not found this module: ${e}`),null)}getConfigfromModules(e,t){return this.getConfigFromModules(e,t)}getConfigFromModules(e,t){Array.isArray(e)||(e=Object.keys(e));for(const n of e){if(!this.dataSupportMap.has(n)){console.warn(`data support manager can not found this module: ${n}`);continue}const o=this.dataSupportMap.get(n).getConfig(t);if(o)return o}return null}removeConfigBySymbol(...e){for(const t of e)for(const n of this.dataSupportMap.values())if(n.existSymbol(t)){n.removeConfig(t);break}return this}getModuleBySymbol(e){const t=this.dataSupportMap.values();for(const n of t)if(n.existSymbol(e))return n.MODULE;return null}applyConfig(...e){for(const t of e){const n=x(t.type);n?this.dataSupportMap.get(n).addConfig(t):console.warn(`dataSupportManager can not found this config module: ${t.type}`)}return this}load(e){return this.dataSupportMap.forEach((n,s)=>{e[s]&&n.load(e[s])}),this}loadByModule(e,t){const n=this.dataSupportMap.get(t);return n?(n.load(e),this):(console.warn(`DataSupportManager can not support this module: ${t}`),this)}remove(e){return this.dataSupportMap.forEach((n,s)=>{e[s]&&n.remove(e[s])}),this}toJSON(e={},t=!0){return JSON.stringify(this.exportConfig(e,t),S)}exportConfig(e={},t=!0){return this.dataSupportMap.forEach((s,o)=>{e[o]=s.exportConfig(t)}),e}}const j="DataSupportManagerPlugin",Re=function(){return{name:j,install(r){const e=new De;r.dataSupportManager=e,r.applyConfig=function(...t){return e.applyConfig(...t),r},r.getConfigBySymbol=function(t){return e.getConfigBySymbol(t)},r.getConfigfromModule=function(t,n){return e.getConfigfromModule(t,n)},r.getConfigfromModules=function(t,n){return e.getConfigfromModules(t,n)},r.removeConfigBySymbol=function(...t){return e.removeConfigBySymbol(...t),r},r.toJSON=function(){return e.toJSON()},r.exportConfig=function(){return e.exportConfig()}},dispose(r){delete r.dataSupportManager,delete r.applyConfig,delete r.getConfigBySymbol,delete r.removeConfigBySymbol,delete r.toJSON,delete r.exportConfig}}};class Pe{}class B extends Pe{constructor(){super(...arguments),this.selector=(e,t,n)=>n.get(B)||null}parse({url:e,resource:t,configMap:n,resourceMap:s}){s.set(e,t)}}var U=(r=>(r.MAPPED="mapped",r))(U||{});class we extends O.EventDispatcher{constructor(e={}){super(),this.configMap=new Map,this.resourceMap=new Map,this.paserMap=new Map,this.defalutParser=new B;const t=new Map;for(const n in e)t.has(n)&&console.warn(`resourceManager construct params rescource already exist: ${n}, that will be cover.`),t.set(n,e[n]);this.mappingResource(t)}addParser(e){return this.paserMap.has(e.constructor)?this:(this.paserMap.set(e.constructor,e),this)}mappingResource(e,t){const n=this.configMap,s=this.resourceMap,o=[...this.paserMap.values()],a={};for(const[c,l]of e.entries()){if(t!=null&&t.parser&&t.parser[c]){t.parser[c].parse({url:c,resource:l,configMap:n,resourceMap:s});continue}if(t!=null&&t.selector&&t.selector[c]){const g=t.selector[c](c,l,this.paserMap);if(!g){console.warn("resource manager hanlder can not found this resource parser: ",l,t.selector[c]);continue}g.parse({url:c,resource:l,configMap:n,resourceMap:s}),a[c]=this.getResourceConfig(c);continue}let u=null;for(const g of o)if(u=g.selector(c,l,this.paserMap),u)break;if(!u){console.warn("resouce manager can not found some handler to parser this resource, that will use default parser do it:",l),this.defalutParser.parse({url:c,resource:l,configMap:n,resourceMap:s});continue}u.parse({url:c,resource:l,configMap:n,resourceMap:s}),a[c]=this.getResourceConfig(c)}return this.dispatchEvent({type:"mapped",configMap:n,resourceMap:s,resourceConfig:a}),this}getResourceConfig(e){const t=this.configMap,n={};return[...t.keys()].filter(s=>s.startsWith(e)).forEach(s=>{const o=t.get(s);if(!o)console.error(`unknow error: can not found config by url: ${s}`);else{const a=x(o.type);a?(!n[a]&&(n[a]=[]),n[a].push(o)):console.error(`unknow error: can not found module by type: ${o.type}`,o)}}),n}hasResource(e){return this.resourceMap.has(e)}remove(e){const t=this.configMap,n=this.resourceMap;return[...t.keys()].filter(s=>s.startsWith(e)).forEach(s=>{t.delete(s);const o=n.get(s);o.dispose&&o.dispose(),n.delete(s)}),this}dispose(){this.resourceMap.forEach((e,t)=>{e.dispose&&e.dispose()}),this.resourceMap.clear(),this.configMap.clear()}}const ee="ResourceManagerPlugin",je=function(r={}){return{name:ee,install(e){const t=new we(r.resources);e.resourceManager=t,e.registerResources=n=>{const s=new Map;return Object.keys(n).forEach(o=>{s.set(o,n[o])}),t.mappingResource(s),e}},dispose(e){e.addEventListener(O.ENGINE_EVENT.DISPOSE,()=>{e.resourceManager.dispose()})}}},Te="LoaderDataSupportStrategy",Ne=function(){let r,e;return{name:Te,condition:[j,y.LOADER_MANAGER_PLUGIN],exec(t){r=t.toJSON,t.toJSON=function(){const n={assets:JSON.parse(t.loaderManager.toJSON())};return t.dataSupportManager.toJSON(n)},e=t.exportConfig,t.exportConfig=function(){let n={};return n={assets:t.loaderManager.exportConfig()},t.dataSupportManager.exportConfig(n)}},rollback(t){t.toJSON=r,t.exportConfig=e}}},Le="LoaderMappingStrategy",xe=function(){let r,e;return{name:Le,condition:[ee,y.LOADER_MANAGER_PLUGIN],exec(t){r=t.loadResources,t.loadResources=(n,s)=>{const o=a=>{s(void 0,a),t.resourceManager.removeEventListener(y.LOADER_EVENT.LOADED,o)};try{t.resourceManager.addEventListener(y.LOADER_EVENT.LOADED,o)}catch(a){s(a)}return t.loaderManager.reset().load(n),t},e=t.loadResourcesAsync,t.loadResourcesAsync=n=>new Promise((s,o)=>{try{t.loaderManager.once(y.LOADER_EVENT.LOADED,a=>{t.resourceManager.once(U.MAPPED,l=>{s(l)});const c=new Map;n.forEach(l=>{typeof l=="string"?c.set(l,a.resourceMap.get(l)):c.set(l.url,a.resourceMap.get(l.url))}),t.resourceManager.mappingResource(c)})}catch(a){o(a)}t.loaderManager.reset().load(n)})},rollback(t){t.loadResources=r,t.loadResourcesAsync=e}}},Ie="CompilerSupportStrategy",Ge=function(){return{name:Ie,condition:[$,j],exec(r){r.compilerManager.compilerMap.forEach((e,t)=>{var n;e.useEngine(r),(n=r.dataSupportManager.dataSupportMap.get(t))==null||n.addCompiler(e)})},rollback(){}}};class lt{constructor(e){this.condition={},this.list=[],this.validator=()=>!0,e&&(this.validator=e)}add(e){return this.validator(e)&&(this.condition[e]=!1),this}reach(e){return this.condition[e]===void 0?(console.warn(`ModuleTrigger: can not set module condition: ${e}.`),this):(this.condition[e]=!0,this.check()&&this.trig(),this)}register(e){e(!0)||this.list.push(e)}trig(){const e=this.list;for(const t of e)t(!1);this.reset()}reset(){this.list=[],Object.keys(this.condition).forEach(e=>{this.condition[e]=!1})}check(){return!Object.values(this.condition).includes(!1)}}const ut=new lt(r=>!!C[r]);var $e=(r=>(r[r.ZERO=0]="ZERO",r[r.ONE=100]="ONE",r[r.TWO=200]="TWO",r[r.THREE=300]="THREE",r[r.FOUR=400]="FOUR",r[r.FIVE=500]="FIVE",r[r.SIX=600]="SIX",r[r.SEVEN=700]="SEVEN",r[r.EIGHT=800]="EIGHT",r[r.NINE=900]="NINE",r))($e||{});class Be extends O.Engine{constructor(e={}){super(),this.moduleLifeCycle=[],this.triggers={object:ut},this.install(y.LoaderManagerPlugin(e.LoaderManagerPlugin)).install(J.PointerManagerPlugin(e.PointerManagerPlugin)).install(_.EventManagerPlugin(e.EventManagerPlugin)).install(F.RenderManagerPlugin(e.RenderManagerPlugin)).install(je(e.ResourceManagerPlugin)).install(Re(e.DataSupportManagerPlugin)).install(Ae(e.CompilerManagerPlugin)),this.exec(Ne()).exec(xe()).exec(Ge())}loadLifeCycle(e){const t=this.dataSupportManager,n=this.triggers,s=this.moduleLifeCycle.sort((o,a)=>o.order-a.order);for(const{module:o}of s){e[o]&&t.loadByModule(e[o],o);for(const a in n)n[a].reach(o)}}removeLifeCycle(e){const t=this.dataSupportManager,n=this.moduleLifeCycle.sort((c,l)=>l.order-c.order);for(const{module:c}of n)e[c]&&t.remove({[c]:e[c]});const s=e.assets||[],o=this.resourceManager,a=this.loaderManager;s.forEach(c=>{o.remove(c),a.remove(c)})}loadConfig(e,t){const n=this.renderManager.hasRendering();if(n&&this.renderManager.stop(),e.assets&&e.assets.length){const s=o=>{delete e.assets,this.loadLifeCycle(e),this.resourceManager.removeEventListener("mapped",s),t&&t(o),n?this.renderManager.play():this.renderManager.render()};this.resourceManager.addEventListener("mapped",s),this.loaderManager.reset().load(e.assets)}else this.loadLifeCycle(e),t&&t(),n?this.renderManager.play():this.renderManager.render();return this}loadConfigAsync(e,t){return new Promise((n,s)=>{const o=this.renderManager.hasRendering();o&&this.renderManager.stop(),e.assets&&e.assets.length?this.loadResourcesAsync(e.assets).then(a=>{delete e.assets,this.loadLifeCycle(e),o?this.renderManager.play():this.renderManager.render(),n(a)}):(this.loadLifeCycle(e),o?this.renderManager.play():this.renderManager.render(),n({type:U.MAPPED,configMap:this.resourceManager.configMap,resourceMap:this.resourceManager.resourceMap,resourceConfig:{}}))})}removeConfig(e){this.removeLifeCycle(e)}getObjectConfig(e){const t=this.getObjectSymbol(e);return t?this.getConfigBySymbol(t):null}useModule(e){const t=re(e.type);if(N[t])return console.warn(`Engine:module ${e.type} is already exist.`),this;N[t]=e.type,e.object&&(C[e.type]=!0);const n=new ve(e);return n.compiler.useEngine(this),this.dataSupportManager.extend(n.converter),this.compilerManager.extend(n.compiler),e.extend&&e.extend(this),this.moduleLifeCycle.push({module:e.type,order:e.lifeOrder||0}),Object.values(this.triggers).forEach(s=>{s.add(e.type)}),this}addTrigger(e,t){return this.triggers[e]?console.warn(`EngineSupport: this trigger has already exist: ${e}.`,this.triggers):this.triggers[e]=t,this}getTrigger(e){return this.triggers[e]?this.triggers[e]:(console.warn(`EngineSupport: not found this trigger: ${e}.`,this.triggers),null)}init(){}registModule(e){return this.useModule(e)}}const ft=function(r,e={}){const t=new Be(e);return r.modules&&r.modules.forEach(n=>{t.useModule(n)}),r.plugins&&r.plugins.forEach(n=>{t.install(n)}),r.strategy&&r.strategy.forEach(n=>{t.exec(n)}),t},ht=r=>{D.exec(r)},pt=()=>{},dt=[$,j];i.AntiShake=ye,i.COMPILER_MANAGER_PLUGIN=$,i.COMPILER_SUPPORT_STRATEGY=Ie,i.CONFIGFACTORY=V,i.CONFIGMODULE=He,i.CONFIGTYPE=q,i.CONFIG_FACTORY=M,i.CONFIG_MODEL=ne,i.CONFIG_MODULE=L,i.CONFIG_TYPE=k,i.Compiler=le,i.CompilerManager=Ce,i.CompilerManagerPlugin=Ae,i.CompilerSupportStrategy=Ge,i.Container=pe,i.Converter=Me,i.DATA_SUPPORT_MANAGER_PLUGIN=j,i.DEFAULT_RULE=v,i.DataSupportManager=De,i.DataSupportManagerPlugin=Re,i.DefaultParser=B,i.EngineSupport=Be,i.JSONHandler=Ke,i.LOADER_DATA_SUPPORT_STRATEGY=Te,i.LOADER_MAPPING_STRATEGY=Le,i.LoaderDataSupportStrategy=Ne,i.LoaderMappingStrategy=xe,i.MODEL_EVENT=m,i.MODULETYPE=qe,i.MODULE_TYPE=N,i.Model=Z,i.Moduler=ve,i.OBJECTMODULE=se,i.OBJECT_MODULE=C,i.PLUGINS=dt,i.Parser=Pe,i.RESOURCE_EVENT=U,i.RESOURCE_MANAGER_PLUGIN=ee,i.ResourceManager=we,i.ResourceManagerPlugin=je,i.Ruler=be,i.SUPPORT_LIFE_CYCLE=$e,i.Template=Qe,i.createSymbol=Ee,i.defineEngineSupport=ft,i.defineModel=R,i.defineModule=ct,i.defineOption=Xe,i.defineProcessor=Ze,i.defineRule=st,i.emptyHandler=at,i.generateConfig=d,i.getBasicConfig=Se,i.getModule=x,i.getObserver=A,i.getSymbolConfig=ot,i.globalAntiShake=et,i.globalOption=p,i.isObjectModule=oe,i.isObjectType=ie,i.observable=Oe,i.slientSync=nt,i.toAsync=ht,i.toTrigger=pt,i.uniqueSymbol=it,Object.keys(y).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(i,r)&&Object.defineProperty(i,r,{enumerable:!0,get:()=>y[r]})}),Object.keys(J).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(i,r)&&Object.defineProperty(i,r,{enumerable:!0,get:()=>J[r]})}),Object.keys(_).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(i,r)&&Object.defineProperty(i,r,{enumerable:!0,get:()=>_[r]})}),Object.keys(F).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(i,r)&&Object.defineProperty(i,r,{enumerable:!0,get:()=>F[r]})}),Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})});
