(function(a,f){typeof exports=="object"&&typeof module<"u"?f(exports,require("@vis-three/utils"),require("@vis-three/core"),require("rxjs"),require("nanoid"),require("@vis-three/plugin-loader-manager"),require("@vis-three/plugin-pointer-manager"),require("@vis-three/plugin-event-manager"),require("@vis-three/plugin-render-manager")):typeof define=="function"&&define.amd?define(["exports","@vis-three/utils","@vis-three/core","rxjs","nanoid","@vis-three/plugin-loader-manager","@vis-three/plugin-pointer-manager","@vis-three/plugin-event-manager","@vis-three/plugin-render-manager"],f):(a=typeof globalThis<"u"?globalThis:a||self,f((a["vis-three"]=a["vis-three"]||{},a["vis-three"].tdcm={}),a.utils,a.core,a.rxjs,a.nanoid,a.pluginLoaderManager,a.pluginPointerManager,a.pluginEventManager,a.pluginRenderManager))})(this,function(a,f,b,re,ke,y,_,k,F){"use strict";const Fe=function(r){return r=r.replace(/[\-_\s]+(.)?/g,function(e,t){return t?t.toUpperCase():""}),r.slice(0,1).toLowerCase()+r.slice(1)},Ve=function(r){return Fe(r).toUpperCase()},ne=function(r){const e=/(?=[A-Z])/;return r.split(e).map(t=>t.toUpperCase()).join("_")},M={},O={},L={},V={},A={},x={},q=M,qe=L,H=V,se=A,He=x,I=r=>x[r]||null,oe=r=>A[r],ie=r=>{const e=I(r);return e?oe(e):!1},W="vis.father",S="vis.key",Y="vis.observer",z="vis.model",ae=new WeakMap,G=function(r){Array.isArray(r)&&ae.set(r,r.concat([]))},We=function(r){return ae.get(r)},Z=function(r){let e="";const t=n=>{n[Symbol.for(S)]!==void 0&&(e=`${n[Symbol.for(S)]}${e?`.${e}`:""}`,n[Symbol.for(W)]&&t(n[Symbol.for(W)]))};return t(r),e},Ye=function(r){if(r.length&&f.isObject(r[0])){const e=r.length;for(let t=0;t<e;t+=1)r[t][Symbol.for(S)]=t}},D=function(r){return r[Symbol.for(Y)]},ce=function(r){return!!r[Symbol.for(Y)]},ze=function(r){return r[Symbol.for(z)]},d=class d{static exec(e){if(e(!1))return;d.list.includes(e)||d.list.push(e);let t=0;const n=()=>{d.timer&&clearTimeout(d.timer),d.timer=window.setTimeout(()=>{const s=[];for(const o of d.list)o(!1)||s.push(o);if(s.length)if(s.length===t){for(const o of s)o(!0);d.list=[]}else t=s.length,d.list=s,n();else d.list=[]},d.time)};n()}static append(e){d.list.length&&!d.list.includes(e)?d.list.push(e):d.exec(e)}static nextTick(e){window.setTimeout(()=>{e()},d.time)}};d.list=[],d.time=0;let R=d;class X extends b.EventDispatcher{constructor(e){super(),this.config=e.config,this.engine=e.engine,this.compiler=e.compiler}toConfig(e){return this.engine.getConfigBySymbol(e)}toModel(e){if(typeof e=="string")return this.engine.compilerManager.getModelBySymbol(e);{const t=this.engine.getObjectSymbol(e);return t?this.engine.compilerManager.getModelBySymbol(t):(console.warn("Model: can not found object symbol:",e),null)}}toObject(e){return this.engine.getObjectBySymbol(e)}toPuppet(e){return this.toObject(e)}toAsync(e){R.exec(e)}asyncNextTick(e){R.nextTick(e)}toTrigger(e,t){const n=this.engine.getTrigger(e);n&&n.register(t)}process(e){if(!this.commands||!this.commands[e.operate]){this[e.operate](e);return}let t=this.commands[e.operate];const n=e.path?e.path.split(".").concat(e.key):[e.key];for(const s of n)if(!t[s]&&!t.$reg){this[e.operate](e);return}else if(t[s])if(typeof t[s]=="function"){t[s].call(this,{model:this,ctx:this,config:this.config,target:this.puppet,puppet:this.puppet,engine:this.engine,compiler:this.compiler,...e});return}else t=t[s];else if(t.$reg){for(const o of t.$reg)if(o.reg.test(s)){o.handler.call(this,{model:this,ctx:this,config:this.config,target:this.puppet,puppet:this.puppet,engine:this.engine,compiler:this.compiler,...e});return}}this[e.operate](e)}add(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default add operate.",e);return}t[e.key]=e.value}set(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default set operate.",e);return}t[e.key]=e.value}delete(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default delete operate.",e);return}delete t[e.key]}create(){this.config[Symbol.for(z)]=this,this.puppet=this.createPuppet.call(this,{model:this,config:this.config,engine:this.engine,compiler:this.compiler})}dispose(){this.disposePuppet.call(this,{model:this,target:this.puppet,puppet:this.puppet,config:this.config,engine:this.engine,compiler:this.compiler}),this.config[Symbol.for(z)]=void 0,this.clear()}}const P=function(r){return r};P.extend=function(r){const e=function(t){const n=t(r);return n.shared=Object.assign({},r.shared,n.shared),n.commands=f.objectDeepMerge(n.commands,r.commands),n.context=function(s){return Object.assign(r.context?r.context(s):{},n.context?n.context.call(this,s):{})},n};return e.extend=function(t){const n=t(r);return n.shared=Object.assign({},r.shared,n.shared),n.commands=f.objectDeepMerge(n.commands,r.commands),n.context=function(s){return Object.assign(r.context?r.context(s):{},n.context?n.context.call(this,s):{})},P.extend(n)},e},P.expand=function(r){return r};const Ze=P;var m=(r=>(r.COMPILED_ADD="compiledAdd",r.COMPILED_REMOVE="compiledRemove",r.COMPILED_ATTR="compiledAttr",r.COMPILED_UPDATE="compiledUpdate",r.COMPILED="compiled",r.NOTICED="noticed",r))(m||{});class le{constructor(e){this.MODULE="",this.builders=new Map,this.target={},this.map=new Map,this.symbolMap=new WeakMap,this.MODULE=e.module;for(const t of e.models)this.useModel(t)}getMap(){return null}useEngine(e){return this.engine=e,this}setTarget(e){return this.target=e,this}add(e){if(!this.builders.has(e.type))return console.warn(`${this.MODULE} Compiler: can not support this type: ${e.type}`),null;const{option:t,Builder:n}=this.builders.get(e.type),s=n?new n({config:e,engine:this.engine,compiler:this}):new X({config:e,engine:this.engine,compiler:this});return t.context&&Object.assign(s,t.context({model:s})),s.createPuppet=t.create,s.disposePuppet=t.dispose,s.commands=t.commands,s.create(),this.map.set(e.vid,s),this.symbolMap.set(s.puppet,e.vid),s.emit(m.COMPILED_ADD),s.emit(m.COMPILED),s.puppet}remove(e){const t=e.vid;if(!this.map.has(t))return console.warn(`${this.MODULE} Compiler: can not found this vid object: ${t}.`),this;if(!this.builders.has(e.type))return console.warn(`${this.MODULE} Compiler: can not support this type: ${e.type}`),this;const n=this.map.get(t);return this.map.delete(t),this.symbolMap.delete(n.puppet),n.dispose(),n.emit(m.COMPILED_REMOVE),n.emit(m.COMPILED),this}cover(e){const t=e.vid;return this.map.has(t)?(Promise.resolve().then(()=>{f.syncObject(e,e,{vid:!0,type:!0})}),this):(console.warn(`${this.MODULE} Compiler: can not found this vid object: ${t}.`),this)}compile(e,t){if(!this.map.has(e))return console.warn(`${this.MODULE} Compiler: can not found model which vid is: '${e}'`),this;const n=this.map.get(e);n.process(t);const s=t.path;return n.emit(`${m.COMPILED_ATTR}:${s&&s+"."}${t.key}`),n.emit(m.COMPILED_UPDATE),n.emit(m.COMPILED),this}compileAll(){const e=this.target;for(const t of Object.values(e))this.add(t);return this}dispose(){for(const e of this.map.values())e.dispose();return this.map.clear(),this.target={},this}getObjectSymbol(e){return this.symbolMap.get(e)||null}getObjectBySymbol(e){var t;return((t=this.map.get(e))==null?void 0:t.puppet)||null}getModelBySymbol(e){return this.map.get(e)||null}useModel(e,t){if(this.builders.has(e.type))return console.warn(`${this.MODULE} Compiler: has already exist this model ${e.type}.`),this;let n;if(e.shared){n=class extends X{constructor(s){super(s)}};for(const s in e.shared)n.prototype[s]=e.shared[s]}if(e.expand){const s=function(o,i){o?(o.config=function(){return Object.assign(o.config(),i.config())},!o.commands&&(o.commands={}),o.commands=f.objectDeepMerge(o.commands,i.commands,{fresh:!1})):console.error("Compiler: model expend error, can not found model witch has not been registered.",i.models,O)};for(const o of e.expand)if(typeof o.models=="string")s(O[o.models],o);else if(Array.isArray(o.models))for(const i in o.models)s(O[i],o);else if(o.models instanceof RegExp)for(const i in O)o.models.test(i)&&s(O[i],o)}return this.builders.set(e.type,{option:e,Builder:n}),Object.defineProperty(M,e.type,{get(){return e.config}}),V[ne(e.type)]=e.type,H[Ve(e.type)]=e.type,x[e.type]=this.MODULE,O[e.type]=e,t&&t(this),this}useProcessor(e,t){return this.useModel(e,t)}}const h={proxy:{expand:void 0,timing:"before",toRaw:void 0},symbol:{generator:ke.nanoid,validator:r=>r.length===21},engine:void 0},Xe=function(r){r.proxy&&Object.assign(h.proxy,r.proxy),r.symbol&&Object.assign(h.symbol,r.symbol)},ue=function(r,e,t){return Reflect.get(r,e,t)},fe=function(r,e,t,n,s){if(typeof e=="symbol")return Reflect.set(r,e,t,n);if(r[e]===void 0){const o=Reflect.set(r,e,t);return s.add(t),s.next({operate:"add",path:"",key:e,value:t,symbol:e}),o}else{const o=Reflect.set(r,e,t);return s.remove(t.vid),s.add(t),s.next({operate:"set",path:"",key:e,value:t,symbol:e}),o}},de=function(r,e,t){if(typeof e=="symbol")return Reflect.deleteProperty(r,e);const n=r[e],s=Reflect.deleteProperty(r,e);return t.next({operate:"delete",path:"",key:e,value:n,symbol:e}),t.remove(n.vid),s};class he extends re.Subject{constructor(){super(),this.subscriptions=new Map;const e=h.proxy.expand?(t={})=>h.proxy.expand(t):(t={})=>t;h.proxy.timing==="before"?this.space=new Proxy(e(),{get:ue,set:(t,n,s,o)=>fe(t,n,s,o,this),deleteProperty:(t,n)=>de(t,n,this)}):this.space=e(new Proxy({},{get:ue,set:(t,n,s,o)=>fe(t,n,s,o,this),deleteProperty:(t,n)=>de(t,n,this)}))}add(e){const t=D(e);if(!t){console.error("Container: this config can not observer",e);return}this.subscriptions.set(t.target.vid,t.subscribe(n=>{this.next({operate:n.operate,path:n.path,key:n.key,value:n.value,symbol:t.target.vid})}))}remove(e){this.subscriptions.delete(e)}}const E=(r,e)=>e===1/0?"Infinity":e===-1/0?"-Infinity":e,K=(r,e)=>e==="Infinity"?1/0:e==="-Infinity"?-1/0:e,w=r=>JSON.parse(JSON.stringify(r,E),K),v={stringify:E,parse:K,clone:w},Ke=Object.freeze(Object.defineProperty({__proto__:null,clone:w,default:v,parse:K,stringify:E},Symbol.toStringTag,{value:"Module"})),p=function(r,e,t={observer:!0,strict:!0,warn:!0}){if(t.observer===void 0&&(t.observer=!0),t.strict===void 0&&(t.strict=!0),t.warn===void 0&&(t.warn=!0),t.handler===void 0&&(t.handler=h.proxy.expand),!q[r])return console.error(`type: ${r} can not be found in configList.`),{vid:"",type:r};const n=(i,c)=>{for(const l in c){if(i[l]===void 0){!t.strict&&(i[l]=c[l]),t.strict&&t.warn&&console.warn(`'${r}' config can not set key: ${l}`);continue}typeof c[l]=="object"&&c[l]!==null&&!Array.isArray(c[l])?(i[l]===null&&(i[l]={...c[l]}),n(i[l],c[l])):i[l]=c[l]}};let s=q[r]();if(s.vid===""&&(s.vid=h.symbol.generator()),e&&n(s,e),t.observer===!1)return s;t.handler&&h.proxy.timing==="before"&&(s=t.handler(s));let o=Oe(s);if(t.handler&&h.proxy.timing==="after"&&(o=t.handler(o)),p.autoInject&&p.injectEngine){const i=p.injectEngine;if(i.applyConfig(o),p.injectScene&&ie(s.type)&&s.type!==H.SCENE){let c=null;typeof p.injectScene=="boolean"?c=i.getObjectConfig(i.scene):typeof p.injectScene=="string"&&(c=i.getConfigBySymbol(p.injectScene)),c?c.children.push(s.vid):console.warn("current engine scene can not found it config",i,i.scene)}return o}return o};p.autoInject=!0,p.injectScene=!1,p.injectEngine=null;const pe=(r,e={})=>{let t=JSON.stringify(r,v.stringify);const n={};!e.filter&&(e.filter=["assets"]);const s=Object.keys(r).filter(i=>!e.filter.includes(i));for(const i of s)for(const c of r[i]){const l=c.vid,u=Ee();t=t.replace(new RegExp(l,"g"),u),e.detail&&(n[l]=u)}const o=JSON.parse(t,v.parse);if(e.fillName)if(typeof e.fillName=="function")for(const i of s)for(const c of o[i])c.name||(c.name=e.fillName(c));else for(const i of s)for(const c of o[i])c.name||(c.name=`${c.type}-${c.vid.slice(-2)}`);return e.detail?{config:o,detail:n}:o},Q=(r,e,t={filter:["assets"],clone:!0})=>{const n=t.clone?v.clone(r):r;!t.filter&&(t.filter=["assets"]);const s=Object.keys(n).filter(o=>!t.filter.includes(o));for(const o of s)n[o].forEach((c,l,u)=>{u[l]=e(c)});return n},ge=function(r){const e={};for(const t of Object.keys(r))for(const n of r[t])e[n.name]=n;return e},me=function(r,e){return typeof r=="string"&&(r=JSON.parse(r,v.parse)),Q(v.clone(r),t=>(t=p(t.type,t,{strict:!1}),e?e(t):t))},Qe=Object.freeze(Object.defineProperty({__proto__:null,clone:pe,default:{clone:pe,handler:Q,planish:ge,observable:me},handler:Q,observable:me,planish:ge},Symbol.toStringTag,{value:"Module"}));class ye{constructor(){this.list=[],this.time=0}exec(e){if(e(!1))return;this.list.includes(e)||this.list.push(e);let t=0;const n=()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const s=[];for(const o of this.list)o(!1)||s.push(o);if(s.length)if(s.length===t){for(const o of s)o(!0);this.list=[]}else t=s.length,this.list=s,n();else this.list=[]},this.time)};n()}append(e){this.list.length&&!this.list.includes(e)?this.list.push(e):this.exec(e)}nextTick(e){setTimeout(()=>{e()},this.time)}}const et=new ye;class Me{constructor(e){this.MODULE="",this.container=new he,this.ruler=e.ruler,this.MODULE=e.module,this.container.subscribe(t=>{this.ruler.execute(t)})}getData(){return this.container.space}existSymbol(e){return!!this.container.space[e]}addConfig(e){return this.container.space[e.vid]=e,this}getConfig(e){return this.container.space[e]}removeConfig(e){const t=this.container.space;t[e]!==void 0&&delete t[e]}addCompiler(e){return e.setTarget(this.container.space),e.compileAll(),this.ruler.link(e),this}toJSON(e=!0){return JSON.stringify(e?this.exportConfig():Object.values(this.container.space),E)}exportConfig(e=!0){if(e){const t=this.container.space,n=[],s={},o=(i,c,l={})=>{for(const u in i){if(["vid","type"].includes(u)){l[u]=i[u];continue}if(typeof i[u]=="object"&&i[u]!==null){if(Array.isArray(i[u])){if(!i[u].length)continue;l[u]=i[u].map(g=>typeof g=="object"&&g!==null?w(g):g);continue}l[u]={},c[u]?(o(i[u],c[u],l[u]),Object.keys(l[u]).length===0&&delete l[u]):l[u]=w(i[u])}else c[u]!==i[u]&&(l[u]=i[u])}};for(const i of Object.values(t)){if(!s[i.type]){if(!M[i.type]){console.error(`can not font some config with: ${i.type}`);continue}s[i.type]=M[i.type]()}const c={};o(i,s[i.type],c),n.push(c)}return n}else return Object.values(w(this.container.space))}load(e){const t=this.container.space,n={},s=(o,i)=>{for(const c in i)typeof o[c]=="object"&&o[c]!==null&&typeof i[c]=="object"&&i[c]!==null?s(o[c],i[c]):o[c]===void 0&&(o[c]=i[c])};for(const o of e){if(!n[o.type]){if(!M[o.type]){console.error(`can not font some config with: ${o.type}`);continue}n[o.type]=M[o.type]()}s(o,n[o.type]),t[o.vid]=o}return this}remove(e){const t=this.container.space;for(const n of e)t[n.vid]!==void 0&&delete t[n.vid];return this}}const tt=["push","pop","shift","unshift","splice","sort","reverse"],j=new WeakSet,rt={get:function(r,e,t){return Array.isArray(r)&&tt.includes(e)&&j.add(r),Reflect.get(r,e,t)},set:function(r,e,t,n){const s=Z(r),o=D(r);if(typeof e=="symbol"||o.ignore(f.extendPath(s,e)))return Reflect.set(r,e,t,n);if(f.isObject(t)&&!ce(t)&&(t=$(o,t,r,e)),r[e]===void 0){f.isObject(t)&&(t[Symbol.for(S)]=e,f.isArray(t)&&G(t)),f.isArray(r)&&j.delete(r);const l=Reflect.set(r,e,t);return f.isArray(r)&&G(r),o.next({operate:"add",path:s,key:e,value:t}),l}const i=r[e],c=Reflect.set(r,e,t);if(f.isArray(r)){if(j.has(r)&&e==="length"){const l=We(r);if(!l)return Array.isArray(i)&&console.error("array value is not be cached:",r),c;Ye(r);const u=Math.abs(l.length-r.length),g=l.length>=r.length?"delete":"add",gt=l.length>=r.length?r:l;let Ue=0,Je=0;for(const _e of g==="delete"?l:r){if(!gt.includes(_e)&&(o.next({operate:g,path:s,key:Je.toString(),value:_e}),Ue+=1,Ue===u))break;Je+=1}return G(r),j.delete(r),c}else if(j.has(r)||e==="length")return c}return o.next({operate:"set",path:s,key:e,value:t}),c},deleteProperty:function(r,e){const t=Z(r),n=D(r);if(typeof e=="symbol"||n.ignore(t))return Reflect.deleteProperty(r,e);const s=r[e],o=Reflect.deleteProperty(r,e);return f.isArray(r)||n.next({operate:"delete",path:t,key:e,value:s}),o}},$=function(r,e,t,n){if(!f.isObject(e)||ce(e))return e;const s=t?Z(t):"";if(r.ignore(s))return e;t&&(e[Symbol.for(W)]=t),e[Symbol.for(Y)]=r;for(const i in e){const c=f.extendPath(s,i);if(!r.ignore(c)&&f.isObject(e[i])){if(f.isArray(e[i])){const l=e[i];e[i]=$(r,e[i],e),G(l)}else e[i]=$(r,e[i],e);e[i][Symbol.for(S)]=i}}return n&&(e[Symbol.for(S)]=n),new Proxy(e,rt)},N=class N extends re.Subject{constructor(e){super(),this.disable=!1,this.target=$(this,e)}ignore(e){const t=e.indexOf(".");return t===-1?N.IGNORE[e]:N.IGNORE[e.slice(0,t)]}next(e){if(this.disable)return;super.next(e);const t=ze(this.target);t&&t.emit(m.NOTICED)}};N.IGNORE={vid:!0,type:!0,alias:!0,meta:!0};let ee=N;const Oe=function(r){return new ee(r).target},nt=function(r,e){const t=D(r);if(!t){console.warn("this object can not found it observer:",r);return}t.disable=!0,e(),t.disable=!1},C={SYMBOL_VALIDATOR(r){return!h.symbol.validator(r.symbol)},OPERATE_ADD({operate:r,path:e,symbol:t,key:n,value:s},o){return r==="add"&&!e.length&&t===n?(o.add(s),!1):!0},OPERATE_DELETE({operate:r,path:e,value:t},n){return r==="delete"&&!e.length?(n.remove(t),!1):!0},OPERATE_COVER({operate:r,path:e,value:t,key:n,symbol:s},o){return r==="set"&&!e.length&&n===s?(o.cover(t),!1):!0},OPERATE_COMPILE(r,e){return e.compile(r.symbol,r),!1}};class be{constructor(e){this.rules=[],this.pointer=null,e?this.rules=e:this.rules.push(C.SYMBOL_VALIDATOR,C.OPERATE_ADD,C.OPERATE_DELETE,C.OPERATE_COVER,C.OPERATE_COMPILE)}link(e){this.compiler=e}execute(e){for(const t of this.rules)if(!t(e,this.compiler))break}remove(e){if(this.rules.includes(e)){const t=this.rules.indexOf(e);this.rules.splice(t,1)}else console.warn("Ruler: can not found rule",e,this.rules)}add(e,t){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):t!==void 0?(this.rules.splice(t,0,e),this):this.pointer===null?(console.error("Ruler:index is undefined, need a index or use before and after api to set a index"),this):(this.rules.splice(this.pointer,0,e),this)}before(e){return this.rules.includes(e)?(this.pointer=this.rules.indexOf(e),this):(console.warn("Ruler: rules not found this rule",this.rules),this)}after(e){return this.rules.includes(e)?(this.pointer=this.rules.indexOf(e)+1,this):(console.warn("Ruler: rules not found this rule",this.rules),this)}push(e){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):(this.rules.push(e),this)}unshift(e){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):(this.rules.unshift(e),this)}pop(){return this.rules.pop(),this}shift(){return this.rules.shift(),this}}const st=function(r){return r},Se=function(){return{vid:"",type:"",name:"",alias:"",meta:{}}},ot=Se,it=function(r){return`DEFUALT-${r}`},Ee=function(){return h.symbol.generator()},at=function(){};class ve{constructor(e){this.type="",this.module=e,this.type=e.type,this.ruler=new be(e.rule),this.compiler=e.compiler?new e.compiler({module:e.type,models:e.models}):new le({module:e.type,models:e.models}),this.converter=new Me({module:e.type,ruler:this.ruler}).addCompiler(this.compiler)}}const ct=function(r){return r};class Ce extends b.EventDispatcher{constructor(){super(),this.compilerMap=new Map}extend(e,t=!1){this.compilerMap.has(e.MODULE)?(console.warn("compiler manager has exist this compiler",e),t&&this.compilerMap.set(e.MODULE,e)):this.compilerMap.set(e.MODULE,e)}getCompiler(e){return this.compilerMap.has(e)?this.compilerMap.get(e):(console.warn(`can not found this type in compiler manager: ${e}`),null)}getObjectSymbol(e){for(const t of this.compilerMap.values()){const n=t.getObjectSymbol(e);if(n)return n}return null}getObjectBySymbol(e){for(const t of this.compilerMap.values()){const n=t.getObjectBySymbol(e);if(n)return n}return null}getModelBySymbol(e){for(const t of this.compilerMap.values()){const n=t.getModelBySymbol(e);if(n)return n}return null}getObjectfromModule(e,t){return this.getObjectFromModule(e,t)}getObjectFromModule(e,t){var s;return this.compilerMap.has(e)?((s=this.compilerMap.get(e).map.get(t))==null?void 0:s.puppet)||null:(console.warn(`compiler manager can not found this module: ${e}`),null)}getObjectfromModules(e,t){return this.getObjectFromModules(e,t)}getObjectFromModules(e,t){var n;Array.isArray(e)||(e=Object.keys(e));for(const s of e){if(!this.compilerMap.has(s)){console.warn(`compiler manager can not found this module: ${s}`);continue}const o=this.compilerMap.get(s);if(o.map.has(t))return(n=o.map.get(t))==null?void 0:n.puppet}return null}dispose(){for(const e of this.compilerMap.values())e.dispose();return this.compilerMap.clear(),this}}const B="CompilerManagerPlugin",Ae=function(){return{name:B,install(r){const e=new Ce;r.compilerManager=e,r.getObjectSymbol=function(t){return e.getObjectSymbol(t)},r.getObjectBySymbol=function(t){return e.getObjectBySymbol(t)},r.getObjectfromModule=function(t,n){return e.getObjectfromModule(t,n)},r.getObjectfromModules=function(t,n){return e.getObjectfromModules(t,n)},r.getObject3D=function(t){return e.getObjectfromModules(se,t)}},dispose(r){r.compilerManager.dispose(),delete r.compilerManager,delete r.getObjectSymbol,delete r.getObjectBySymbol,delete r.getObjectfromModule,delete r.getObjectfromModules,delete r.getObject3D}}};class De extends b.EventDispatcher{constructor(){super(),this.dataSupportMap=new Map}extend(e,t=!1){this.dataSupportMap.has(e.MODULE)?(console.warn("dataSupport manager has exist this dataSupport",e),t&&this.dataSupportMap.set(e.MODULE,e)):this.dataSupportMap.set(e.MODULE,e)}getDataSupport(e){return this.dataSupportMap.has(e)?this.dataSupportMap.get(e):(console.warn(`can not found this type in dataSupportManager: ${e}`),null)}getConfigBySymbol(e){const t=this.dataSupportMap.values();for(const n of t){const s=n.getConfig(e);if(s)return s}return null}getConfigfromModule(e,t){return this.getConfigFromModule(e,t)}getConfigFromModule(e,t){return this.dataSupportMap.has(e)?this.dataSupportMap.get(e).getConfig(t)||null:(console.warn(`data support manager can not found this module: ${e}`),null)}getConfigfromModules(e,t){return this.getConfigFromModules(e,t)}getConfigFromModules(e,t){Array.isArray(e)||(e=Object.keys(e));for(const n of e){if(!this.dataSupportMap.has(n)){console.warn(`data support manager can not found this module: ${n}`);continue}const o=this.dataSupportMap.get(n).getConfig(t);if(o)return o}return null}removeConfigBySymbol(...e){for(const t of e)for(const n of this.dataSupportMap.values())if(n.existSymbol(t)){n.removeConfig(t);break}return this}getModuleBySymbol(e){const t=this.dataSupportMap.values();for(const n of t)if(n.existSymbol(e))return n.MODULE;return null}applyConfig(...e){for(const t of e){const n=I(t.type);n?this.dataSupportMap.get(n).addConfig(t):console.warn(`dataSupportManager can not found this config module: ${t.type}`)}return this}load(e){return this.dataSupportMap.forEach((n,s)=>{e[s]&&n.load(e[s])}),this}loadByModule(e,t){const n=this.dataSupportMap.get(t);return n?(n.load(e),this):(console.warn(`DataSupportManager can not support this module: ${t}`),this)}remove(e){return this.dataSupportMap.forEach((n,s)=>{e[s]&&n.remove(e[s])}),this}toJSON(e={},t=!0){return JSON.stringify(this.exportConfig(e,t),E)}exportConfig(e={},t=!0){return this.dataSupportMap.forEach((s,o)=>{e[o]=s.exportConfig(t)}),e}}const T="DataSupportManagerPlugin",Re=function(){return{name:T,install(r){const e=new De;r.dataSupportManager=e,r.applyConfig=function(...t){return e.applyConfig(...t),r},r.getConfigBySymbol=function(t){return e.getConfigBySymbol(t)},r.getConfigfromModule=function(t,n){return e.getConfigfromModule(t,n)},r.getConfigfromModules=function(t,n){return e.getConfigfromModules(t,n)},r.removeConfigBySymbol=function(...t){return e.removeConfigBySymbol(...t),r},r.toJSON=function(){return e.toJSON()},r.exportConfig=function(){return e.exportConfig()}},dispose(r){delete r.dataSupportManager,delete r.applyConfig,delete r.getConfigBySymbol,delete r.removeConfigBySymbol,delete r.toJSON,delete r.exportConfig}}};class Pe{}class U extends Pe{constructor(){super(...arguments),this.selector=(e,t,n)=>n.get(U)||null}parse({url:e,resource:t,configMap:n,resourceMap:s}){s.set(e,t)}}var J=(r=>(r.MAPPED="mapped",r))(J||{});class we extends b.EventDispatcher{constructor(e={}){super(),this.configMap=new Map,this.resourceMap=new Map,this.paserMap=new Map,this.defalutParser=new U;const t=new Map;for(const n in e)t.has(n)&&console.warn(`resourceManager construct params rescource already exist: ${n}, that will be cover.`),t.set(n,e[n]);this.mappingResource(t)}addParser(e){return this.paserMap.has(e.constructor)?this:(this.paserMap.set(e.constructor,e),this)}mappingResource(e,t){const n=this.configMap,s=this.resourceMap,o=[...this.paserMap.values()],i={};for(const[c,l]of e.entries()){if(t!=null&&t.parser&&t.parser[c]){t.parser[c].parse({url:c,resource:l,configMap:n,resourceMap:s});continue}if(t!=null&&t.selector&&t.selector[c]){const g=t.selector[c](c,l,this.paserMap);if(!g){console.warn("resource manager hanlder can not found this resource parser: ",l,t.selector[c]);continue}g.parse({url:c,resource:l,configMap:n,resourceMap:s}),i[c]=this.getResourceConfig(c);continue}let u=null;for(const g of o)if(u=g.selector(c,l,this.paserMap),u)break;if(!u){console.warn("resouce manager can not found some handler to parser this resource, that will use default parser do it:",l),this.defalutParser.parse({url:c,resource:l,configMap:n,resourceMap:s});continue}u.parse({url:c,resource:l,configMap:n,resourceMap:s}),i[c]=this.getResourceConfig(c)}return this.dispatchEvent({type:"mapped",configMap:n,resourceMap:s,resourceConfig:i}),this}getResourceConfig(e){const t=this.configMap,n={};return[...t.keys()].filter(s=>s.startsWith(e)).forEach(s=>{const o=t.get(s);if(!o)console.error(`unknow error: can not found config by url: ${s}`);else{const i=I(o.type);i?(!n[i]&&(n[i]=[]),n[i].push(o)):console.error(`unknow error: can not found module by type: ${o.type}`,o)}}),n}hasResource(e){return this.resourceMap.has(e)}remove(e){const t=this.configMap,n=this.resourceMap;return[...t.keys()].filter(s=>s.startsWith(e)).forEach(s=>{t.delete(s);const o=n.get(s);o.dispose&&o.dispose(),n.delete(s)}),this}dispose(){this.resourceMap.forEach((e,t)=>{e.dispose&&e.dispose()}),this.resourceMap.clear(),this.configMap.clear()}}const te="ResourceManagerPlugin",je=function(r={}){return{name:te,install(e){const t=new we(r.resources);e.resourceManager=t,e.registerResources=n=>{const s=new Map;return Object.keys(n).forEach(o=>{s.set(o,n[o])}),t.mappingResource(s),e}},dispose(e){e.addEventListener(b.ENGINE_EVENT.DISPOSE,()=>{e.resourceManager.dispose()})}}},Te="LoaderDataSupportStrategy",Ne=function(){let r,e;return{name:Te,condition:[T,y.LOADER_MANAGER_PLUGIN],exec(t){r=t.toJSON,t.toJSON=function(){const n={assets:JSON.parse(t.loaderManager.toJSON())};return t.dataSupportManager.toJSON(n)},e=t.exportConfig,t.exportConfig=function(){let n={};return n={assets:t.loaderManager.exportConfig()},t.dataSupportManager.exportConfig(n)}},rollback(t){t.toJSON=r,t.exportConfig=e}}},Le="LoaderMappingStrategy",xe=function(){let r,e;return{name:Le,condition:[te,y.LOADER_MANAGER_PLUGIN],exec(t){r=t.loadResources,t.loadResources=(n,s)=>{const o=i=>{s(void 0,i),t.resourceManager.removeEventListener(y.LOADER_EVENT.LOADED,o)};try{t.resourceManager.addEventListener(y.LOADER_EVENT.LOADED,o)}catch(i){s(i)}return t.loaderManager.reset().load(n),t},e=t.loadResourcesAsync,t.loadResourcesAsync=n=>new Promise((s,o)=>{try{t.loaderManager.once(y.LOADER_EVENT.LOADED,i=>{t.resourceManager.once(J.MAPPED,l=>{s(l)});const c=new Map;n.forEach(l=>{typeof l=="string"?c.set(l,i.resourceMap.get(l)):c.set(l.url,i.resourceMap.get(l.url))}),t.resourceManager.mappingResource(c)})}catch(i){o(i)}t.loaderManager.reset().load(n)})},rollback(t){t.loadResources=r,t.loadResourcesAsync=e}}},Ie="CompilerSupportStrategy",Ge=function(){return{name:Ie,condition:[B,T],exec(r){r.compilerManager.compilerMap.forEach((e,t)=>{var n;e.useEngine(r),(n=r.dataSupportManager.dataSupportMap.get(t))==null||n.addCompiler(e)})},rollback(){}}};class lt{constructor(e){this.condition={},this.list=[],this.validator=()=>!0,e&&(this.validator=e)}add(e){return this.validator(e)&&(this.condition[e]=!1),this}reach(e){return this.condition[e]===void 0?(console.warn(`ModuleTrigger: can not set module condition: ${e}.`),this):(this.condition[e]=!0,this.check()&&this.trig(),this)}register(e){e(!0)||this.list.push(e)}trig(){const e=this.list;for(const t of e)t(!1);this.reset()}reset(){this.list=[],Object.keys(this.condition).forEach(e=>{this.condition[e]=!1})}check(){return!Object.values(this.condition).includes(!1)}}const ut=new lt(r=>!!A[r]);var $e=(r=>(r[r.ZERO=0]="ZERO",r[r.ONE=100]="ONE",r[r.TWO=200]="TWO",r[r.THREE=300]="THREE",r[r.FOUR=400]="FOUR",r[r.FIVE=500]="FIVE",r[r.SIX=600]="SIX",r[r.SEVEN=700]="SEVEN",r[r.EIGHT=800]="EIGHT",r[r.NINE=900]="NINE",r))($e||{});class Be extends b.Engine{constructor(e={}){super(),this.moduleLifeCycle=[],this.triggers={object:ut},this.install(y.LoaderManagerPlugin(e.LoaderManagerPlugin)).install(_.PointerManagerPlugin(e.PointerManagerPlugin)).install(k.EventManagerPlugin(e.EventManagerPlugin)).install(F.RenderManagerPlugin(e.RenderManagerPlugin)).install(je(e.ResourceManagerPlugin)).install(Re(e.DataSupportManagerPlugin)).install(Ae(e.CompilerManagerPlugin)),this.exec(Ne()).exec(xe()).exec(Ge())}loadLifeCycle(e){const t=this.dataSupportManager,n=this.triggers,s=this.moduleLifeCycle.sort((o,i)=>o.order-i.order);for(const{module:o}of s){e[o]&&t.loadByModule(e[o],o);for(const i in n)n[i].reach(o)}}removeLifeCycle(e){const t=this.dataSupportManager,n=this.moduleLifeCycle.sort((c,l)=>l.order-c.order);for(const{module:c}of n)e[c]&&t.remove({[c]:e[c]});const s=e.assets||[],o=this.resourceManager,i=this.loaderManager;s.forEach(c=>{o.remove(c),i.remove(c)})}loadConfig(e,t){const n=this.renderManager.hasRendering();if(n&&this.renderManager.stop(),e.assets&&e.assets.length){const s=o=>{delete e.assets,this.loadLifeCycle(e),this.resourceManager.removeEventListener("mapped",s),t&&t(o),n?this.renderManager.play():this.renderManager.render()};this.resourceManager.addEventListener("mapped",s),this.loaderManager.reset().load(e.assets)}else this.loadLifeCycle(e),t&&t(),n?this.renderManager.play():this.renderManager.render();return this}loadConfigAsync(e,t){return new Promise((n,s)=>{const o=this.renderManager.hasRendering();o&&this.renderManager.stop(),e.assets&&e.assets.length?this.loadResourcesAsync(e.assets).then(i=>{delete e.assets,this.loadLifeCycle(e),o?this.renderManager.play():this.renderManager.render(),n(i)}):(this.loadLifeCycle(e),o?this.renderManager.play():this.renderManager.render(),n({type:J.MAPPED,configMap:this.resourceManager.configMap,resourceMap:this.resourceManager.resourceMap,resourceConfig:{}}))})}removeConfig(e){this.removeLifeCycle(e)}getObjectConfig(e){const t=this.getObjectSymbol(e);return t?this.getConfigBySymbol(t):null}useModule(e){const t=ne(e.type);if(L[t])return console.warn(`Engine:module ${e.type} is already exist.`),this;L[t]=e.type,e.object&&(A[e.type]=!0);const n=new ve(e);return n.compiler.useEngine(this),this.dataSupportManager.extend(n.converter),this.compilerManager.extend(n.compiler),e.extend&&e.extend(this),this.moduleLifeCycle.push({module:e.type,order:e.lifeOrder||0}),Object.values(this.triggers).forEach(s=>{s.add(e.type)}),this}addTrigger(e,t){return this.triggers[e]?console.warn(`EngineSupport: this trigger has already exist: ${e}.`,this.triggers):this.triggers[e]=t,this}getTrigger(e){return this.triggers[e]?this.triggers[e]:(console.warn(`EngineSupport: not found this trigger: ${e}.`,this.triggers),null)}init(){}registModule(e){return this.useModule(e)}}const ft=function(r,e={}){const t=new Be(e);return r.modules&&r.modules.forEach(n=>{t.useModule(n)}),r.plugins&&r.plugins.forEach(n=>{t.install(n)}),r.strategy&&r.strategy.forEach(n=>{t.exec(n)}),t},dt=r=>{R.exec(r)},ht=()=>{},pt=[B,T];a.AntiShake=ye,a.COMPILER_MANAGER_PLUGIN=B,a.COMPILER_SUPPORT_STRATEGY=Ie,a.CONFIGFACTORY=q,a.CONFIGMODULE=He,a.CONFIGTYPE=H,a.CONFIG_FACTORY=M,a.CONFIG_MODEL=O,a.CONFIG_MODULE=x,a.CONFIG_TYPE=V,a.Compiler=le,a.CompilerManager=Ce,a.CompilerManagerPlugin=Ae,a.CompilerSupportStrategy=Ge,a.Container=he,a.Converter=Me,a.DATA_SUPPORT_MANAGER_PLUGIN=T,a.DEFAULT_RULE=C,a.DataSupportManager=De,a.DataSupportManagerPlugin=Re,a.DefaultParser=U,a.EngineSupport=Be,a.JSONHandler=Ke,a.LOADER_DATA_SUPPORT_STRATEGY=Te,a.LOADER_MAPPING_STRATEGY=Le,a.LoaderDataSupportStrategy=Ne,a.LoaderMappingStrategy=xe,a.MODEL_EVENT=m,a.MODULETYPE=qe,a.MODULE_TYPE=L,a.Model=X,a.Moduler=ve,a.OBJECTMODULE=se,a.OBJECT_MODULE=A,a.PLUGINS=pt,a.Parser=Pe,a.RESOURCE_EVENT=J,a.RESOURCE_MANAGER_PLUGIN=te,a.ResourceManager=we,a.ResourceManagerPlugin=je,a.Ruler=be,a.SUPPORT_LIFE_CYCLE=$e,a.Template=Qe,a.createSymbol=Ee,a.defineEngineSupport=ft,a.defineModel=P,a.defineModule=ct,a.defineOption=Xe,a.defineProcessor=Ze,a.defineRule=st,a.emptyHandler=at,a.generateConfig=p,a.getBasicConfig=Se,a.getModule=I,a.getObserver=D,a.getSymbolConfig=ot,a.globalAntiShake=et,a.globalOption=h,a.isObjectModule=oe,a.isObjectType=ie,a.observable=Oe,a.slientSync=nt,a.toAsync=dt,a.toTrigger=ht,a.uniqueSymbol=it,Object.keys(y).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(a,r)&&Object.defineProperty(a,r,{enumerable:!0,get:()=>y[r]})}),Object.keys(_).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(a,r)&&Object.defineProperty(a,r,{enumerable:!0,get:()=>_[r]})}),Object.keys(k).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(a,r)&&Object.defineProperty(a,r,{enumerable:!0,get:()=>k[r]})}),Object.keys(F).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(a,r)&&Object.defineProperty(a,r,{enumerable:!0,get:()=>F[r]})}),Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
