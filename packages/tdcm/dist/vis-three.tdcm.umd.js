(function(c,p){typeof exports=="object"&&typeof module<"u"?p(exports,require("@vis-three/utils"),require("@vis-three/core"),require("rxjs"),require("nanoid"),require("@vis-three/plugin-loader-manager"),require("@vis-three/plugin-pointer-manager"),require("@vis-three/plugin-event-manager"),require("@vis-three/plugin-render-manager")):typeof define=="function"&&define.amd?define(["exports","@vis-three/utils","@vis-three/core","rxjs","nanoid","@vis-three/plugin-loader-manager","@vis-three/plugin-pointer-manager","@vis-three/plugin-event-manager","@vis-three/plugin-render-manager"],p):(c=typeof globalThis<"u"?globalThis:c||self,p((c["vis-three"]=c["vis-three"]||{},c["vis-three"].tdcm={}),c.utils,c.core,c.rxjs,c.nanoid,c.pluginLoaderManager,c.pluginPointerManager,c.pluginEventManager,c.pluginRenderManager))})(this,function(c,p,E,oe,Ye,b,F,V,q){"use strict";const ze=function(r){return r=r.replace(/[\-_\s]+(.)?/g,function(e,t){return t?t.toUpperCase():""}),r.slice(0,1).toLowerCase()+r.slice(1)},Ze=function(r){return ze(r).toUpperCase()},ae=function(r){const e=/(?=[A-Z])/;return r.split(e).map(t=>t.toUpperCase()).join("_")},S={},Xe={},$={},H={},D={},x={},W=S,Ke=$,Y=H,ce=D,Qe=x,I=r=>x[r]||null,le=r=>D[r],ue=r=>{const e=I(r);return e?le(e):!1},z="vis.father",v="vis.key",Z="vis.observer",X="vis.model",fe=new WeakMap,U=function(r){Array.isArray(r)&&fe.set(r,r.concat([]))},_e=function(r){return fe.get(r)},K=function(r){let e="";const t=n=>{n[Symbol.for(v)]!==void 0&&(e=`${n[Symbol.for(v)]}${e?`.${e}`:""}`,n[Symbol.for(z)]&&t(n[Symbol.for(z)]))};return t(r),e},et=function(r){if(r.length&&p.isObject(r[0])){const e=r.length;for(let t=0;t<e;t+=1)r[t][Symbol.for(v)]=t}},R=function(r){return r[Symbol.for(Z)]},he=function(r){return!!r[Symbol.for(Z)]},tt=function(r){return r[Symbol.for(X)]},h=class h{static exec(e){if(e(!1))return;h.list.includes(e)||h.list.push(e);let t=0;const n=()=>{h.timer&&clearTimeout(h.timer),h.timer=window.setTimeout(()=>{const s=[];for(const i of h.list)i(!1)||s.push(i);if(s.length)if(s.length===t){for(const i of s)i(!0);h.list=[]}else t=s.length,h.list=s,n();else h.list=[]},h.time)};n()}static append(e){h.list.length&&!h.list.includes(e)?h.list.push(e):h.exec(e)}static nextTick(e){window.setTimeout(()=>{e()},h.time)}};h.list=[],h.time=0;let P=h;class pe extends E.EventDispatcher{constructor(e){super(),this.config=e.config,this.engine=e.engine,this.compiler=e.compiler}toConfig(e){return this.engine.getConfigBySymbol(e)}toModel(e){return this.engine.compilerManager.getModelBySymbol(e)}toObject(e){return this.engine.getObjectBySymbol(e)}toPuppet(e){return this.toObject(e)}toAsync(e){P.exec(e)}asyncNextTick(e){P.nextTick(e)}toTrigger(e,t){const n=this.engine.getTrigger(e);n&&n.register(t)}process(e){if(!this.commands||!this.commands[e.operate]){this[e.operate](e);return}let t=this.commands[e.operate];const n=e.path?e.path.split(".").concat(e.key):[e.key];for(const s of n)if(!t[s]&&!t.$reg){this[e.operate](e);return}else if(t[s])if(typeof t[s]=="function"){t[s].call(this,{model:this,ctx:this,config:this.config,target:this.puppet,puppet:this.puppet,engine:this.engine,compiler:this.compiler,...e});return}else t=t[s];else if(t.$reg){for(const i of t.$reg)if(i.reg.test(s)){i.handler.call(this,{model:this,ctx:this,config:this.config,target:this.puppet,puppet:this.puppet,engine:this.engine,compiler:this.compiler,...e});return}}this[e.operate](e)}add(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default add operate.",e);return}t[e.key]=e.value}set(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default set operate.",e);return}t[e.key]=e.value}delete(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default delete operate.",e);return}delete t[e.key]}create(){this.config[Symbol.for(X)]=this,this.puppet=this.createPuppet.call(this,{model:this,config:this.config,engine:this.engine,compiler:this.compiler})}dispose(){this.disposePuppet.call(this,{model:this,target:this.puppet,puppet:this.puppet,config:this.config,engine:this.engine,compiler:this.compiler}),this.config[Symbol.for(X)]=void 0,this.clear()}}const Q=function(r){return r};Q.extend=function(r){return function(e){const t=e(r);return t.commands=Object.assign({},r.commands,t.commands),t.context=function(n){return Object.assign(r.context?r.context(n):{},t.context?t.context.call(this,n):{})},t}};const rt=Q;var O=(r=>(r.COMPILED_ADD="compiledAdd",r.COMPILED_REMOVE="compiledRemove",r.COMPILED_ATTR="compiledAttr",r.COMPILED_UPDATE="compiledUpdate",r.COMPILED="compiled",r.NOTICED="noticed",r))(O||{});class de{constructor(e){this.MODULE="",this.builders=new Map,this.target={},this.map=new Map,this.symbolMap=new WeakMap,this.MODULE=e.module;for(const t of e.models)this.useModel(t)}getMap(){return null}useEngine(e){return this.engine=e,this}setTarget(e){return this.target=e,this}add(e){if(!this.builders.has(e.type))return console.warn(`${this.MODULE} Compiler: can not support this type: ${e.type}`),null;const t=this.builders.get(e.type),n=new pe({config:e,engine:this.engine,compiler:this});return t.context&&Object.assign(n,t.context({model:n})),n.createPuppet=t.create,n.disposePuppet=t.dispose,n.commands=t.commands,n.create(),this.map.set(e.vid,n),this.symbolMap.set(n.puppet,e.vid),n.emit(O.COMPILED_ADD),n.emit(O.COMPILED),n.puppet}remove(e){const t=e.vid;if(!this.map.has(t))return console.warn(`${this.MODULE} Compiler: can not found this vid object: ${t}.`),this;if(!this.builders.has(e.type))return console.warn(`${this.MODULE} Compiler: can not support this type: ${e.type}`),this;const n=this.map.get(t);return this.map.delete(t),this.symbolMap.delete(n.puppet),n.dispose(),n.emit(O.COMPILED_REMOVE),n.emit(O.COMPILED),this}cover(e){const t=e.vid;return this.map.has(t)?(Promise.resolve().then(()=>{p.syncObject(e,e,{vid:!0,type:!0})}),this):(console.warn(`${this.MODULE} Compiler: can not found this vid object: ${t}.`),this)}compile(e,t){if(!this.map.has(e))return console.warn(`${this.MODULE} Compiler: can not found model which vid is: '${e}'`),this;const n=this.map.get(e);n.process(t);const s=t.path;return n.emit(`${O.COMPILED_ATTR}:${s&&s+"."}${t.key}`),n.emit(O.COMPILED_UPDATE),n.emit(O.COMPILED),this}compileAll(){const e=this.target;for(const t of Object.values(e))this.add(t);return this}dispose(){for(const e of this.map.values())e.dispose();return this.map.clear(),this.target={},this}getObjectSymbol(e){return this.symbolMap.get(e)||null}getObjectBySymbol(e){var t;return((t=this.map.get(e))==null?void 0:t.puppet)||null}getModelBySymbol(e){return this.map.get(e)||null}useModel(e,t){return this.builders.has(e.type)?(console.warn(`${this.MODULE} Compiler: has already exist this model ${e.type}.`),this):(this.builders.set(e.type,e),S[e.type]=e.config,H[ae(e.type)]=e.type,Y[Ze(e.type)]=e.type,x[e.type]=this.MODULE,t&&t(this),this)}useProcessor(e,t){return this.useModel(e,t)}}const g={proxy:{expand:void 0,timing:"before",toRaw:void 0},symbol:{generator:Ye.nanoid,validator:r=>r.length===21},engine:void 0},nt=function(r){r.proxy&&Object.assign(g.proxy,r.proxy),r.symbol&&Object.assign(g.symbol,r.symbol)},ge=function(r,e,t){return Reflect.get(r,e,t)},ye=function(r,e,t,n,s){if(typeof e=="symbol")return Reflect.set(r,e,t,n);if(r[e]===void 0){const i=Reflect.set(r,e,t);return s.add(t),s.next({operate:"add",path:"",key:e,value:t,symbol:e}),i}else{const i=Reflect.set(r,e,t);return s.remove(t.vid),s.add(t),s.next({operate:"set",path:"",key:e,value:t,symbol:e}),i}},me=function(r,e,t){if(typeof e=="symbol")return Reflect.deleteProperty(r,e);const n=r[e],s=Reflect.deleteProperty(r,e);return t.next({operate:"delete",path:"",key:e,value:n,symbol:e}),t.remove(n.vid),s};class Me extends oe.Subject{constructor(){super(),this.subscriptions=new Map;const e=g.proxy.expand?(t={})=>g.proxy.expand(t):(t={})=>t;g.proxy.timing==="before"?this.space=new Proxy(e(),{get:ge,set:(t,n,s,i)=>ye(t,n,s,i,this),deleteProperty:(t,n)=>me(t,n,this)}):this.space=e(new Proxy({},{get:ge,set:(t,n,s,i)=>ye(t,n,s,i,this),deleteProperty:(t,n)=>me(t,n,this)}))}add(e){const t=R(e);if(!t){console.error("Container: this config can not observer",e);return}this.subscriptions.set(t.target.vid,t.subscribe(n=>{this.next({operate:n.operate,path:n.path,key:n.key,value:n.value,symbol:t.target.vid})}))}remove(e){this.subscriptions.delete(e)}}const C=(r,e)=>e===1/0?"Infinity":e===-1/0?"-Infinity":e,_=(r,e)=>e==="Infinity"?1/0:e==="-Infinity"?-1/0:e,L=r=>JSON.parse(JSON.stringify(r,C),_),A={stringify:C,parse:_,clone:L},st=Object.freeze(Object.defineProperty({__proto__:null,clone:L,default:A,parse:_,stringify:C},Symbol.toStringTag,{value:"Module"})),y=function(r,e,t={observer:!0,strict:!0,warn:!0}){if(t.observer===void 0&&(t.observer=!0),t.strict===void 0&&(t.strict=!0),t.warn===void 0&&(t.warn=!0),t.handler===void 0&&(t.handler=g.proxy.expand),!W[r])return console.error(`type: ${r} can not be found in configList.`),{vid:"",type:r};const n=(o,a)=>{for(const l in a){if(o[l]===void 0){!t.strict&&(o[l]=a[l]),t.strict&&t.warn&&console.warn(`'${r}' config can not set key: ${l}`);continue}typeof a[l]=="object"&&a[l]!==null&&!Array.isArray(a[l])?(o[l]===null&&(o[l]={...a[l]}),n(o[l],a[l])):o[l]=a[l]}};let s=W[r]();if(s.vid===""&&(s.vid=g.symbol.generator()),e&&n(s,e),t.observer===!1)return s;t.handler&&g.proxy.timing==="before"&&(s=t.handler(s));let i=Ce(s);if(t.handler&&g.proxy.timing==="after"&&(i=t.handler(i)),y.autoInject&&y.injectEngine){const o=y.injectEngine;if(o.applyConfig(i),y.injectScene&&ue(s.type)&&s.type!==Y.SCENE){let a=null;typeof y.injectScene=="boolean"?a=o.getObjectConfig(o.scene):typeof y.injectScene=="string"&&(a=o.getConfigBySymbol(y.injectScene)),a?a.children.push(s.vid):console.warn("current engine scene can not found it config",o,o.scene)}return i}return i};y.autoInject=!0,y.injectScene=!1,y.injectEngine=null;const Oe=(r,e={})=>{let t=JSON.stringify(r,A.stringify);const n={};!e.filter&&(e.filter=["assets"]);const s=Object.keys(r).filter(o=>!e.filter.includes(o));for(const o of s)for(const a of r[o]){const l=a.vid,u=De();t=t.replace(new RegExp(l,"g"),u),e.detail&&(n[l]=u)}const i=JSON.parse(t,A.parse);if(e.fillName)if(typeof e.fillName=="function")for(const o of s)for(const a of i[o])a.name||(a.name=e.fillName(a));else for(const o of s)for(const a of i[o])a.name||(a.name=`${a.type}-${a.vid.slice(-2)}`);return e.detail?{config:i,detail:n}:i},ee=(r,e,t={filter:["assets"],clone:!0})=>{const n=t.clone?A.clone(r):r;!t.filter&&(t.filter=["assets"]);const s=Object.keys(n).filter(i=>!t.filter.includes(i));for(const i of s)n[i].forEach((a,l,u)=>{u[l]=e(a)});return n},be=function(r){const e={};for(const t of Object.keys(r))for(const n of r[t])e[n.name]=n;return e},Se=function(r,e){return typeof r=="string"&&(r=JSON.parse(r,A.parse)),ee(A.clone(r),t=>(t=y(t.type,t,{strict:!1}),e?e(t):t))},it=Object.freeze(Object.defineProperty({__proto__:null,clone:Oe,default:{clone:Oe,handler:ee,planish:be,observable:Se},handler:ee,observable:Se,planish:be},Symbol.toStringTag,{value:"Module"}));class Ee{constructor(){this.list=[],this.time=0}exec(e){if(e(!1))return;this.list.includes(e)||this.list.push(e);let t=0;const n=()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const s=[];for(const i of this.list)i(!1)||s.push(i);if(s.length)if(s.length===t){for(const i of s)i(!0);this.list=[]}else t=s.length,this.list=s,n();else this.list=[]},this.time)};n()}append(e){this.list.length&&!this.list.includes(e)?this.list.push(e):this.exec(e)}nextTick(e){setTimeout(()=>{e()},this.time)}}const ot=new Ee;class ve{constructor(e){this.MODULE="",this.container=new Me,this.ruler=e.ruler,this.MODULE=e.module,this.container.subscribe(t=>{this.ruler.execute(t)})}getData(){return this.container.space}existSymbol(e){return!!this.container.space[e]}addConfig(e){return this.container.space[e.vid]=e,this}getConfig(e){return this.container.space[e]}removeConfig(e){const t=this.container.space;t[e]!==void 0&&delete t[e]}addCompiler(e){return e.setTarget(this.container.space),e.compileAll(),this.ruler.link(e),this}toJSON(e=!0){return JSON.stringify(e?this.exportConfig():Object.values(this.container.space),C)}exportConfig(e=!0){if(e){const t=this.container.space,n=[],s={},i=(o,a,l={})=>{for(const u in o){if(["vid","type"].includes(u)){l[u]=o[u];continue}if(typeof o[u]=="object"&&o[u]!==null){if(Array.isArray(o[u])){if(!o[u].length)continue;l[u]=o[u].map(m=>typeof m=="object"&&m!==null?L(m):m);continue}l[u]={},a[u]?(i(o[u],a[u],l[u]),Object.keys(l[u]).length===0&&delete l[u]):l[u]=L(o[u])}else a[u]!==o[u]&&(l[u]=o[u])}};for(const o of Object.values(t)){if(!s[o.type]){if(!S[o.type]){console.error(`can not font some config with: ${o.type}`);continue}s[o.type]=S[o.type]()}const a={};i(o,s[o.type],a),n.push(a)}return n}else return Object.values(L(this.container.space))}load(e){const t=this.container.space,n={},s=(i,o)=>{for(const a in o)typeof i[a]=="object"&&i[a]!==null&&typeof o[a]=="object"&&o[a]!==null?s(i[a],o[a]):i[a]===void 0&&(i[a]=o[a])};for(const i of e){if(!n[i.type]){if(!S[i.type]){console.error(`can not font some config with: ${i.type}`);continue}n[i.type]=S[i.type]()}s(i,n[i.type]),t[i.vid]=i}return this}remove(e){const t=this.container.space;for(const n of e)t[n.vid]!==void 0&&delete t[n.vid];return this}}const at=["push","pop","shift","unshift","splice","sort","reverse"],N=new WeakSet,ct={get:function(r,e,t){return Array.isArray(r)&&at.includes(e)&&N.add(r),Reflect.get(r,e,t)},set:function(r,e,t,n){const s=K(r),i=R(r);if(typeof e=="symbol"||i.ignore(p.extendPath(s,e)))return Reflect.set(r,e,t,n);if(p.isObject(t)&&!he(t)&&(t=G(i,t,r,e)),r[e]===void 0){p.isObject(t)&&(t[Symbol.for(v)]=e,p.isArray(t)&&U(t)),p.isArray(r)&&N.delete(r);const l=Reflect.set(r,e,t);return p.isArray(r)&&U(r),i.next({operate:"add",path:s,key:e,value:t}),l}const o=r[e],a=Reflect.set(r,e,t);if(p.isArray(r)){if(N.has(r)&&e==="length"){const l=_e(r);if(!l)return Array.isArray(o)&&console.error("array value is not be cached:",r),a;et(r);const u=Math.abs(l.length-r.length),m=l.length>=r.length?"delete":"add",St=l.length>=r.length?r:l;let qe=0,He=0;for(const We of m==="delete"?l:r){if(!St.includes(We)&&(i.next({operate:m,path:s,key:He.toString(),value:We}),qe+=1,qe===u))break;He+=1}return U(r),N.delete(r),a}else if(N.has(r)||e==="length")return a}return i.next({operate:"set",path:s,key:e,value:t}),a},deleteProperty:function(r,e){const t=K(r),n=R(r);if(typeof e=="symbol"||n.ignore(t))return Reflect.deleteProperty(r,e);const s=r[e],i=Reflect.deleteProperty(r,e);return p.isArray(r)||n.next({operate:"delete",path:t,key:e,value:s}),i}},G=function(r,e,t,n){if(!p.isObject(e)||he(e))return e;const s=t?K(t):"";if(r.ignore(s))return e;t&&(e[Symbol.for(z)]=t),e[Symbol.for(Z)]=r;for(const o in e){const a=p.extendPath(s,o);if(!r.ignore(a)&&p.isObject(e[o])){if(p.isArray(e[o])){const l=e[o];e[o]=G(r,e[o],e),U(l)}else e[o]=G(r,e[o],e);e[o][Symbol.for(v)]=o}}return n&&(e[Symbol.for(v)]=n),new Proxy(e,ct)},j=class j extends oe.Subject{constructor(e){super(),this.disable=!1,this.target=G(this,e)}ignore(e){const t=e.indexOf(".");return t===-1?j.IGNORE[e]:j.IGNORE[e.slice(0,t)]}next(e){if(this.disable)return;super.next(e);const t=tt(this.target);t&&t.emit(O.NOTICED)}};j.IGNORE={vid:!0,type:!0,alias:!0,meta:!0};let te=j;const Ce=function(r){return new te(r).target},lt=function(r,e){const t=R(r);if(!t){console.warn("this object can not found it observer:",r);return}t.disable=!0,e(),t.disable=!1},w={SYMBOL_VALIDATOR(r){return!g.symbol.validator(r.symbol)},OPERATE_ADD({operate:r,path:e,symbol:t,key:n,value:s},i){return r==="add"&&!e.length&&t===n?(i.add(s),!1):!0},OPERATE_DELETE({operate:r,path:e,value:t},n){return r==="delete"&&!e.length?(n.remove(t),!1):!0},OPERATE_COVER({operate:r,path:e,value:t,key:n,symbol:s},i){return r==="set"&&!e.length&&n===s?(i.cover(t),!1):!0},OPERATE_COMPILE(r,e){return e.compile(r.symbol,r),!1}};class Ae{constructor(e){this.rules=[],this.pointer=null,e?this.rules=e:this.rules.push(w.SYMBOL_VALIDATOR,w.OPERATE_ADD,w.OPERATE_DELETE,w.OPERATE_COVER,w.OPERATE_COMPILE)}link(e){this.compiler=e}execute(e){for(const t of this.rules)if(!t(e,this.compiler))break}remove(e){if(this.rules.includes(e)){const t=this.rules.indexOf(e);this.rules.splice(t,1)}else console.warn("Ruler: can not found rule",e,this.rules)}add(e,t){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):t!==void 0?(this.rules.splice(t,0,e),this):this.pointer===null?(console.error("Ruler:index is undefined, need a index or use before and after api to set a index"),this):(this.rules.splice(this.pointer,0,e),this)}before(e){return this.rules.includes(e)?(this.pointer=this.rules.indexOf(e),this):(console.warn("Ruler: rules not found this rule",this.rules),this)}after(e){return this.rules.includes(e)?(this.pointer=this.rules.indexOf(e)+1,this):(console.warn("Ruler: rules not found this rule",this.rules),this)}push(e){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):(this.rules.push(e),this)}unshift(e){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):(this.rules.unshift(e),this)}pop(){return this.rules.pop(),this}shift(){return this.rules.shift(),this}}const ut=function(r){return r},we=function(){return{vid:"",type:"",name:"",alias:"",meta:{}}},ft=we,ht=function(r){return`DEFUALT-${r}`},De=function(){return g.symbol.generator()},pt=function(){};class Re{constructor(e){this.type="",this.module=e,this.type=e.type,this.ruler=new Ae(e.rule),this.compiler=e.compiler?new e.compiler({module:e.type,models:e.models}):new de({module:e.type,models:e.models}),this.converter=new ve({module:e.type,ruler:this.ruler}).addCompiler(this.compiler)}}const dt=function(r){return r};class Pe extends E.EventDispatcher{constructor(){super(),this.compilerMap=new Map}extend(e,t=!1){this.compilerMap.has(e.MODULE)?(console.warn("compiler manager has exist this compiler",e),t&&this.compilerMap.set(e.MODULE,e)):this.compilerMap.set(e.MODULE,e)}getCompiler(e){return this.compilerMap.has(e)?this.compilerMap.get(e):(console.warn(`can not found this type in compiler manager: ${e}`),null)}getObjectSymbol(e){for(const t of this.compilerMap.values()){const n=t.getObjectSymbol(e);if(n)return n}return null}getObjectBySymbol(e){for(const t of this.compilerMap.values()){const n=t.getObjectBySymbol(e);if(n)return n}return null}getModelBySymbol(e){for(const t of this.compilerMap.values()){const n=t.getModelBySymbol(e);if(n)return n}return null}getObjectfromModule(e,t){return this.getObjectFromModule(e,t)}getObjectFromModule(e,t){return this.compilerMap.has(e)?this.compilerMap.get(e).map.get(t)||null:(console.warn(`compiler manager can not found this module: ${e}`),null)}getObjectfromModules(e,t){return this.getObjectFromModules(e,t)}getObjectFromModules(e,t){Array.isArray(e)||(e=Object.keys(e));for(const n of e){if(!this.compilerMap.has(n)){console.warn(`compiler manager can not found this module: ${n}`);continue}const s=this.compilerMap.get(n);if(s.map.has(t))return s.map.get(t)}return null}dispose(){for(const e of this.compilerMap.values())e.dispose();return this.compilerMap.clear(),this}}const B="CompilerManagerPlugin",Le=function(){return{name:B,install(r){const e=new Pe;r.compilerManager=e,r.getObjectSymbol=function(t){return e.getObjectSymbol(t)},r.getObjectBySymbol=function(t){return e.getObjectBySymbol(t)},r.getObjectfromModule=function(t,n){return e.getObjectfromModule(t,n)},r.getObjectfromModules=function(t,n){return e.getObjectfromModules(t,n)},r.getObject3D=function(t){return e.getObjectfromModules(ce,t)}},dispose(r){r.compilerManager.dispose(),delete r.compilerManager,delete r.getObjectSymbol,delete r.getObjectBySymbol,delete r.getObjectfromModule,delete r.getObjectfromModules,delete r.getObject3D}}};class Ne extends E.EventDispatcher{constructor(){super(),this.dataSupportMap=new Map}extend(e,t=!1){this.dataSupportMap.has(e.MODULE)?(console.warn("dataSupport manager has exist this dataSupport",e),t&&this.dataSupportMap.set(e.MODULE,e)):this.dataSupportMap.set(e.MODULE,e)}getDataSupport(e){return this.dataSupportMap.has(e)?this.dataSupportMap.get(e):(console.warn(`can not found this type in dataSupportManager: ${e}`),null)}getConfigBySymbol(e){const t=this.dataSupportMap.values();for(const n of t){const s=n.getConfig(e);if(s)return s}return null}getConfigfromModule(e,t){return this.dataSupportMap.has(e)?this.dataSupportMap.get(e).getConfig(t)||null:(console.warn(`data support manager can not found this module: ${e}`),null)}getConfigfromModules(e,t){Array.isArray(e)||(e=Object.keys(e));for(const n of e){if(!this.dataSupportMap.has(n)){console.warn(`data support manager can not found this module: ${n}`);continue}const i=this.dataSupportMap.get(n).getConfig(t);if(i)return i}return null}removeConfigBySymbol(...e){for(const t of e)for(const n of this.dataSupportMap.values())if(n.existSymbol(t)){n.removeConfig(t);break}return this}getModuleBySymbol(e){const t=this.dataSupportMap.values();for(const n of t)if(n.existSymbol(e))return n.MODULE;return null}applyConfig(...e){for(const t of e){const n=I(t.type);n?this.dataSupportMap.get(n).addConfig(t):console.warn(`dataSupportManager can not found this config module: ${t.type}`)}return this}load(e){return this.dataSupportMap.forEach((n,s)=>{e[s]&&n.load(e[s])}),this}loadByModule(e,t){const n=this.dataSupportMap.get(t);return n?(n.load(e),this):(console.warn(`DataSupportManager can not support this module: ${t}`),this)}remove(e){return this.dataSupportMap.forEach((n,s)=>{e[s]&&n.remove(e[s])}),this}toJSON(e={},t=!0){return JSON.stringify(this.exportConfig(e,t),C)}exportConfig(e={},t=!0){return this.dataSupportMap.forEach((s,i)=>{e[i]=s.exportConfig(t)}),e}}const T="DataSupportManagerPlugin",Te=function(){return{name:T,install(r){const e=new Ne;r.dataSupportManager=e,r.applyConfig=function(...t){return e.applyConfig(...t),r},r.getConfigBySymbol=function(t){return e.getConfigBySymbol(t)},r.getConfigfromModule=function(t,n){return e.getConfigfromModule(t,n)},r.getConfigfromModules=function(t,n){return e.getConfigfromModules(t,n)},r.removeConfigBySymbol=function(...t){return e.removeConfigBySymbol(...t),r},r.toJSON=function(){return e.toJSON()},r.exportConfig=function(){return e.exportConfig()}},dispose(r){delete r.dataSupportManager,delete r.applyConfig,delete r.getConfigBySymbol,delete r.removeConfigBySymbol,delete r.toJSON,delete r.exportConfig}}};class je{}class J extends je{constructor(){super(...arguments),this.selector=(e,t,n)=>n.get(J)||null}parse({url:e,resource:t,configMap:n,resourceMap:s}){s.set(e,t)}}var k=(r=>(r.MAPPED="mapped",r))(k||{});class $e extends E.EventDispatcher{constructor(e={}){super(),this.configMap=new Map,this.resourceMap=new Map,this.paserMap=new Map,this.defalutParser=new J;const t=new Map;for(const n in e)t.has(n)&&console.warn(`resourceManager construct params rescource already exist: ${n}, that will be cover.`),t.set(n,e[n]);this.mappingResource(t)}addParser(e){return this.paserMap.has(e.constructor)?this:(this.paserMap.set(e.constructor,e),this)}mappingResource(e,t){const n=this.configMap,s=this.resourceMap,i=[...this.paserMap.values()],o={};for(const[a,l]of e.entries()){if(t!=null&&t.parser&&t.parser[a]){t.parser[a].parse({url:a,resource:l,configMap:n,resourceMap:s});continue}if(t!=null&&t.selector&&t.selector[a]){const m=t.selector[a](a,l,this.paserMap);if(!m){console.warn("resource manager hanlder can not found this resource parser: ",l,t.selector[a]);continue}m.parse({url:a,resource:l,configMap:n,resourceMap:s}),o[a]=this.getResourceConfig(a);continue}let u=null;for(const m of i)if(u=m.selector(a,l,this.paserMap),u)break;if(!u){console.warn("resouce manager can not found some handler to parser this resource, that will use default parser do it:",l),this.defalutParser.parse({url:a,resource:l,configMap:n,resourceMap:s});continue}u.parse({url:a,resource:l,configMap:n,resourceMap:s}),o[a]=this.getResourceConfig(a)}return this.dispatchEvent({type:"mapped",configMap:n,resourceMap:s,resourceConfig:o}),this}getResourceConfig(e){const t=this.configMap,n={};return[...t.keys()].filter(s=>s.startsWith(e)).forEach(s=>{const i=t.get(s);if(!i)console.error(`unknow error: can not found config by url: ${s}`);else{const o=I(i.type);o?(!n[o]&&(n[o]=[]),n[o].push(i)):console.error(`unknow error: can not found module by type: ${i.type}`,i)}}),n}hasResource(e){return this.resourceMap.has(e)}remove(e){const t=this.configMap,n=this.resourceMap;return[...t.keys()].filter(s=>s.startsWith(e)).forEach(s=>{t.delete(s);const i=n.get(s);i.dispose&&i.dispose(),n.delete(s)}),this}dispose(){this.resourceMap.forEach((e,t)=>{e.dispose&&e.dispose()}),this.resourceMap.clear(),this.configMap.clear()}}const re="ResourceManagerPlugin",xe=function(r={}){return{name:re,install(e){const t=new $e(r.resources);e.resourceManager=t,e.registerResources=n=>{const s=new Map;return Object.keys(n).forEach(i=>{s.set(i,n[i])}),t.mappingResource(s),e}},dispose(e){e.addEventListener(E.ENGINE_EVENT.DISPOSE,()=>{e.resourceManager.dispose()})}}},Ie="LoaderDataSupportStrategy",Ue=function(){let r,e;return{name:Ie,condition:[T,b.LOADER_MANAGER_PLUGIN],exec(t){r=t.toJSON,t.toJSON=function(){const n={assets:JSON.parse(t.loaderManager.toJSON())};return t.dataSupportManager.toJSON(n)},e=t.exportConfig,t.exportConfig=function(){let n={};return n={assets:t.loaderManager.exportConfig()},t.dataSupportManager.exportConfig(n)}},rollback(t){t.toJSON=r,t.exportConfig=e}}},Ge="LoaderMappingStrategy",Be=function(){let r,e;return{name:Ge,condition:[re,b.LOADER_MANAGER_PLUGIN],exec(t){r=t.loadResources,t.loadResources=(n,s)=>{const i=o=>{s(void 0,o),t.resourceManager.removeEventListener(b.LOADER_EVENT.LOADED,i)};try{t.resourceManager.addEventListener(b.LOADER_EVENT.LOADED,i)}catch(o){s(o)}return t.loaderManager.reset().load(n),t},e=t.loadResourcesAsync,t.loadResourcesAsync=n=>new Promise((s,i)=>{try{t.loaderManager.once(b.LOADER_EVENT.LOADED,o=>{t.resourceManager.once(k.MAPPED,l=>{s(l)});const a=new Map;n.forEach(l=>{typeof l=="string"?a.set(l,o.resourceMap.get(l)):a.set(l.url,o.resourceMap.get(l.url))}),t.resourceManager.mappingResource(a)})}catch(o){i(o)}t.loaderManager.reset().load(n)})},rollback(t){t.loadResources=r,t.loadResourcesAsync=e}}},Je="CompilerSupportStrategy",ke=function(){return{name:Je,condition:[B,T],exec(r){r.compilerManager.compilerMap.forEach((e,t)=>{var n;e.useEngine(r),(n=r.dataSupportManager.dataSupportMap.get(t))==null||n.addCompiler(e)})},rollback(){}}};class gt{constructor(e){this.condition={},this.list=[],this.validator=()=>!0,e&&(this.validator=e)}add(e){return this.validator(e)&&(this.condition[e]=!1),this}reach(e){return this.condition[e]===void 0?(console.warn(`ModuleTrigger: can not set module condition: ${e}.`),this):(this.condition[e]=!0,this.check()&&this.trig(),this)}register(e){e(!0)||this.list.push(e)}trig(){const e=this.list;for(const t of e)t(!1);this.reset()}reset(){this.list=[],Object.keys(this.condition).forEach(e=>{this.condition[e]=!1})}check(){return!Object.values(this.condition).includes(!1)}}const yt=new gt(r=>!!D[r]);var Fe=(r=>(r[r.ZERO=0]="ZERO",r[r.ONE=100]="ONE",r[r.TWO=200]="TWO",r[r.THREE=300]="THREE",r[r.FOUR=400]="FOUR",r[r.FIVE=500]="FIVE",r[r.SIX=600]="SIX",r[r.SEVEN=700]="SEVEN",r[r.EIGHT=800]="EIGHT",r[r.NINE=900]="NINE",r))(Fe||{});class Ve extends E.Engine{constructor(e={}){super(),this.moduleLifeCycle=[],this.triggers={object:yt},this.install(b.LoaderManagerPlugin(e.LoaderManagerPlugin)).install(F.PointerManagerPlugin(e.PointerManagerPlugin)).install(V.EventManagerPlugin(e.EventManagerPlugin)).install(q.RenderManagerPlugin(e.RenderManagerPlugin)).install(xe(e.ResourceManagerPlugin)).install(Te(e.DataSupportManagerPlugin)).install(Le(e.CompilerManagerPlugin)),this.exec(Ue()).exec(Be()).exec(ke())}loadLifeCycle(e){const t=this.dataSupportManager,n=this.triggers,s=this.moduleLifeCycle.sort((i,o)=>i.order-o.order);for(const{module:i}of s){e[i]&&t.loadByModule(e[i],i);for(const o in n)n[o].reach(i)}}removeLifeCycle(e){const t=this.dataSupportManager,n=this.moduleLifeCycle.sort((a,l)=>l.order-a.order);for(const{module:a}of n)e[a]&&t.remove({[a]:e[a]});const s=e.assets||[],i=this.resourceManager,o=this.loaderManager;s.forEach(a=>{i.remove(a),o.remove(a)})}loadConfig(e,t){const n=this.renderManager.hasRendering();if(n&&this.renderManager.stop(),e.assets&&e.assets.length){const s=i=>{delete e.assets,this.loadLifeCycle(e),this.resourceManager.removeEventListener("mapped",s),t&&t(i),n?this.renderManager.play():this.renderManager.render()};this.resourceManager.addEventListener("mapped",s),this.loaderManager.reset().load(e.assets)}else this.loadLifeCycle(e),t&&t(),n?this.renderManager.play():this.renderManager.render();return this}loadConfigAsync(e,t){return new Promise((n,s)=>{const i=this.renderManager.hasRendering();i&&this.renderManager.stop(),e.assets&&e.assets.length?this.loadResourcesAsync(e.assets).then(o=>{delete e.assets,this.loadLifeCycle(e),i?this.renderManager.play():this.renderManager.render(),n(o)}):(this.loadLifeCycle(e),i?this.renderManager.play():this.renderManager.render(),n({type:k.MAPPED,configMap:this.resourceManager.configMap,resourceMap:this.resourceManager.resourceMap,resourceConfig:{}}))})}removeConfig(e){this.removeLifeCycle(e)}getObjectConfig(e){const t=this.getObjectSymbol(e);return t?this.getConfigBySymbol(t):null}useModule(e){const t=ae(e.type);if($[t])return console.warn(`Engine:module ${e.type} is already exist.`),this;$[t]=e.type,e.object&&(D[e.type]=!0);const n=new Re(e);return n.compiler.useEngine(this),this.dataSupportManager.extend(n.converter),this.compilerManager.extend(n.compiler),e.extend&&e.extend(this),this.moduleLifeCycle.push({module:e.type,order:e.lifeOrder||0}),Object.values(this.triggers).forEach(s=>{s.add(e.type)}),this}addTrigger(e,t){return this.triggers[e]?console.warn(`EngineSupport: this trigger has already exist: ${e}.`,this.triggers):this.triggers[e]=t,this}getTrigger(e){return this.triggers[e]?this.triggers[e]:(console.warn(`EngineSupport: not found this trigger: ${e}.`,this.triggers),null)}init(){}registModule(e){return this.useModule(e)}}const mt=function(r,e={}){const t=new Ve(e);return r.modules&&r.modules.forEach(n=>{t.useModule(n)}),r.plugins&&r.plugins.forEach(n=>{t.install(n)}),r.strategy&&r.strategy.forEach(n=>{t.exec(n)}),t},d=class d{static generateConfig(e,t){if(!d.configLibrary.has(e))return console.warn(`event library can not found config by name: ${e}`),{name:""};const n=(i,o)=>{for(const a in o)i[a]!==void 0&&(typeof o[a]=="object"&&o[a]!==null&&!Array.isArray(o[a])?n(i[a],o[a]):i[a]=o[a])},s=JSON.parse(JSON.stringify(d.configLibrary.get(e)));return n(s,t),s}static generateScript(e,t,n,s){return d.generatorLibrary.has(s.name)?d.generatorLibrary.get(s.name)(e,t,n,s):(console.error(`event library can not found generator by name: ${s.name}`),()=>{})}static has(e){return d.configLibrary.has(e)}};d.configLibrary=new Map,d.generatorLibrary=new Map,d.register=function({config:e,generator:t}){return d.configLibrary.has(e.name)?(console.warn(`EventLibrary has already exist this event generator: ${e.name}, that will be cover.`),d):(d.configLibrary.set(e.name,JSON.parse(JSON.stringify(e))),d.generatorLibrary.set(e.name,t),d)};let ne=d;const f=class f{static generateConfig(e,t){if(!f.configLibrary.has(e))return console.warn(`event library can not found config by name: ${e}`),null;const n=(i,o)=>{for(const a in o)typeof o[a]=="object"&&o[a]!==null&&!Array.isArray(o[a])?n(i[a],o[a]):i[a]=o[a]},s=JSON.parse(JSON.stringify(f.configLibrary.get(e)));return n(s,t),s}static generateEvent(e,t){return f.generatorLibrary.has(e.name)?f.generatorLibrary.get(e.name)(t,e):(console.error(`event library can not found generator by name: ${e.name}`),()=>{})}static has(e){return f.configLibrary.has(e)}static useEngine(e){f.engine=e}static createEvent(e,t,n){if(!f.engine&&!n)return console.error("EventGenerator Manager createEvent must provide an engine, you can use 'useEngine' to set it."),null;const s=f.generateConfig(e,t);return s?f.generateEvent(s,n||f.engine):null}};f.configLibrary=new Map,f.generatorLibrary=new Map,f.register=function({config:e,generator:t}){return f.configLibrary.has(e.name)?(console.warn(`EventGeneratorManager has already exist this event generator: ${e.name}, that will be cover.`),f):(f.configLibrary.set(e.name,JSON.parse(JSON.stringify(e))),f.generatorLibrary.set(e.name,t),f)};let se=f;const M=class M{static getShader(e){return M.library.has(e)?M.cloneShader(M.library.get(e)):(console.warn(`con not found shader in shader library: ${e}`),null)}static generateConfig(e,t){if(!M.library.has(e))return console.warn(`con not found shader in shader library: ${e}`),{shader:e,uniforms:{}};const n=M.library.get(e),s={shader:e,uniforms:{}};if(n.uniforms&&(s.uniforms=JSON.parse(JSON.stringify(n.uniforms))),t){const i=(o,a)=>{for(const l in a)o[l]!==void 0&&(typeof a[l]=="object"&&a[l]!==null&&!Array.isArray(a[l])?(o[l]===null&&(o[l]={...a[l]}),i(o[l],a[l])):o[l]=a[l])};i(s.uniforms,t)}return s}static cloneShader(e){const t={name:e.name};return e.vertexShader&&(t.vertexShader=e.vertexShader),e.fragmentShader&&(t.fragmentShader=e.fragmentShader),e.uniforms&&(t.uniforms=JSON.parse(JSON.stringify(e.uniforms))),t}};M.library=new Map,M.register=function(e){M.library.has(e.name)&&console.warn(`shader library has exist shader: ${e.name} that will be cover.`),M.library.set(e.name,e)};let ie=M;const Mt=r=>{P.exec(r)},Ot=()=>{},bt=[B,T];c.AniScriptGeneratorManager=ne,c.AntiShake=Ee,c.COMPILER_MANAGER_PLUGIN=B,c.COMPILER_SUPPORT_STRATEGY=Je,c.CONFIGFACTORY=W,c.CONFIGMODULE=Qe,c.CONFIGTYPE=Y,c.CONFIG_FACTORY=S,c.CONFIG_MODEL=Xe,c.CONFIG_MODULE=x,c.CONFIG_TYPE=H,c.Compiler=de,c.CompilerManager=Pe,c.CompilerManagerPlugin=Le,c.CompilerSupportStrategy=ke,c.Container=Me,c.Converter=ve,c.DATA_SUPPORT_MANAGER_PLUGIN=T,c.DEFAULT_RULE=w,c.DataSupportManager=Ne,c.DataSupportManagerPlugin=Te,c.DefaultParser=J,c.EngineSupport=Ve,c.EventGeneratorManager=se,c.JSONHandler=st,c.LOADER_DATA_SUPPORT_STRATEGY=Ie,c.LOADER_MAPPING_STRATEGY=Ge,c.LoaderDataSupportStrategy=Ue,c.LoaderMappingStrategy=Be,c.MODEL_EVENT=O,c.MODULETYPE=Ke,c.MODULE_TYPE=$,c.Model=pe,c.Moduler=Re,c.OBJECTMODULE=ce,c.OBJECT_MODULE=D,c.PLUGINS=bt,c.Parser=je,c.RESOURCE_EVENT=k,c.RESOURCE_MANAGER_PLUGIN=re,c.ResourceManager=$e,c.ResourceManagerPlugin=xe,c.Ruler=Ae,c.SUPPORT_LIFE_CYCLE=Fe,c.ShaderGeneratorManager=ie,c.Template=it,c.createSymbol=De,c.defineEngineSupport=mt,c.defineModel=Q,c.defineModule=dt,c.defineOption=nt,c.defineProcessor=rt,c.defineRule=ut,c.emptyHandler=pt,c.generateConfig=y,c.getBasicConfig=we,c.getModule=I,c.getObserver=R,c.getSymbolConfig=ft,c.globalAntiShake=ot,c.globalOption=g,c.isObjectModule=le,c.isObjectType=ue,c.observable=Ce,c.slientSync=lt,c.toAsync=Mt,c.toTrigger=Ot,c.uniqueSymbol=ht,Object.keys(b).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(c,r)&&Object.defineProperty(c,r,{enumerable:!0,get:()=>b[r]})}),Object.keys(F).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(c,r)&&Object.defineProperty(c,r,{enumerable:!0,get:()=>F[r]})}),Object.keys(V).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(c,r)&&Object.defineProperty(c,r,{enumerable:!0,get:()=>V[r]})}),Object.keys(q).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(c,r)&&Object.defineProperty(c,r,{enumerable:!0,get:()=>q[r]})}),Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
