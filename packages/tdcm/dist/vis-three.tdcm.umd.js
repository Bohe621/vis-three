(function(c,d){typeof exports=="object"&&typeof module<"u"?d(exports,require("@vis-three/utils"),require("@vis-three/core"),require("rxjs"),require("nanoid"),require("@vis-three/plugin-loader-manager"),require("@vis-three/plugin-pointer-manager"),require("@vis-three/plugin-event-manager"),require("@vis-three/plugin-render-manager")):typeof define=="function"&&define.amd?define(["exports","@vis-three/utils","@vis-three/core","rxjs","nanoid","@vis-three/plugin-loader-manager","@vis-three/plugin-pointer-manager","@vis-three/plugin-event-manager","@vis-three/plugin-render-manager"],d):(c=typeof globalThis<"u"?globalThis:c||self,d((c["vis-three"]=c["vis-three"]||{},c["vis-three"].tdcm={}),c.utils,c.core,c.rxjs,c.nanoid,c.pluginLoaderManager,c.pluginPointerManager,c.pluginEventManager,c.pluginRenderManager))})(this,function(c,d,S,oe,He,O,k,F,V){"use strict";const We=function(r){return r=r.replace(/[\-_\s]+(.)?/g,function(e,t){return t?t.toUpperCase():""}),r.slice(0,1).toLowerCase()+r.slice(1)},Ye=function(r){return We(r).toUpperCase()},ie=function(r){const e=/(?=[A-Z])/;return r.split(e).map(t=>t.toUpperCase()).join("_")},b={},ze={},j={},q={},w={},x={},H=b,Ze=j,W=q,ae=w,Xe=x,$=r=>x[r]||null,ce=r=>w[r],le=r=>{const e=$(r);return e?ce(e):!1},Y="vis.father",E="vis.key",z="vis.observer",Z="vis.model",ue=new WeakMap,I=function(r){Array.isArray(r)&&ue.set(r,r.concat([]))},Ke=function(r){return ue.get(r)},X=function(r){let e="";const t=n=>{n[Symbol.for(E)]!==void 0&&(e=`${n[Symbol.for(E)]}${e?`.${e}`:""}`,n[Symbol.for(Y)]&&t(n[Symbol.for(Y)]))};return t(r),e},Qe=function(r){if(r.length&&d.isObject(r[0])){const e=r.length;for(let t=0;t<e;t+=1)r[t][Symbol.for(E)]=t}},D=function(r){return r[Symbol.for(z)]},fe=function(r){return!!r[Symbol.for(z)]},_e=function(r){return r[Symbol.for(Z)]},h=class h{static exec(e){if(e(!1))return;h.list.includes(e)||h.list.push(e);let t=0;const n=()=>{h.timer&&clearTimeout(h.timer),h.timer=window.setTimeout(()=>{const s=[];for(const o of h.list)o(!1)||s.push(o);if(s.length)if(s.length===t){for(const o of s)o(!0);h.list=[]}else t=s.length,h.list=s,n();else h.list=[]},h.time)};n()}static append(e){h.list.length&&!h.list.includes(e)?h.list.push(e):h.exec(e)}static nextTick(e){window.setTimeout(()=>{e()},h.time)}};h.list=[],h.time=0;let R=h;class K extends S.EventDispatcher{constructor(e){super(),this.config=e.config,this.engine=e.engine,this.compiler=e.compiler}toConfig(e){return this.engine.getConfigBySymbol(e)}toModel(e){return this.engine.compilerManager.getModelBySymbol(e)}toObject(e){return this.engine.getObjectBySymbol(e)}toPuppet(e){return this.toObject(e)}toAsync(e){R.exec(e)}asyncNextTick(e){R.nextTick(e)}toTrigger(e,t){const n=this.engine.getTrigger(e);n&&n.register(t)}process(e){if(!this.commands||!this.commands[e.operate]){this[e.operate](e);return}let t=this.commands[e.operate];const n=e.path?e.path.split(".").concat(e.key):[e.key];for(const s of n)if(!t[s]&&!t.$reg){this[e.operate](e);return}else if(t[s])if(typeof t[s]=="function"){t[s].call(this,{model:this,ctx:this,config:this.config,target:this.puppet,puppet:this.puppet,engine:this.engine,compiler:this.compiler,...e});return}else t=t[s];else if(t.$reg){for(const o of t.$reg)if(o.reg.test(s)){o.handler.call(this,{model:this,ctx:this,config:this.config,target:this.puppet,puppet:this.puppet,engine:this.engine,compiler:this.compiler,...e});return}}this[e.operate](e)}add(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default add operate.",e);return}t[e.key]=e.value}set(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default set operate.",e);return}t[e.key]=e.value}delete(e){let t=this.puppet;const n=e.path;for(const s of n)if(typeof t[s]!==void 0)t=t[s];else{console.warn("processor can not exec default delete operate.",e);return}delete t[e.key]}create(){this.config[Symbol.for(Z)]=this,this.puppet=this.createPuppet.call(this,{model:this,config:this.config,engine:this.engine,compiler:this.compiler})}dispose(){this.disposePuppet.call(this,{model:this,target:this.puppet,puppet:this.puppet,config:this.config,engine:this.engine,compiler:this.compiler}),this.config[Symbol.for(Z)]=void 0,this.clear()}}const Q=function(r){return r};Q.extend=function(r){return function(e){const t=e(r);return t.commands=Object.assign({},r.commands,t.commands),t.context=function(n){return Object.assign(r.context?r.context(n):{},t.context?t.context.call(this,n):{})},t}};const et=Q;var M=(r=>(r.COMPILED_ADD="compiledAdd",r.COMPILED_REMOVE="compiledRemove",r.COMPILED_ATTR="compiledAttr",r.COMPILED_UPDATE="compiledUpdate",r.COMPILED="compiled",r.NOTICED="noticed",r))(M||{});class he{constructor(e){this.MODULE="",this.builders=new Map,this.target={},this.map=new Map,this.symbolMap=new WeakMap,this.MODULE=e.module;for(const t of e.models)this.useModel(t)}getMap(){return null}useEngine(e){return this.engine=e,this}setTarget(e){return this.target=e,this}add(e){if(!this.builders.has(e.type))return console.warn(`${this.MODULE} Compiler: can not support this type: ${e.type}`),null;const{option:t,Builder:n}=this.builders.get(e.type),s=n?new n({config:e,engine:this.engine,compiler:this}):new K({config:e,engine:this.engine,compiler:this});return t.context&&Object.assign(s,t.context({model:s})),s.createPuppet=t.create,s.disposePuppet=t.dispose,s.commands=t.commands,s.create(),this.map.set(e.vid,s),this.symbolMap.set(s.puppet,e.vid),s.emit(M.COMPILED_ADD),s.emit(M.COMPILED),s.puppet}remove(e){const t=e.vid;if(!this.map.has(t))return console.warn(`${this.MODULE} Compiler: can not found this vid object: ${t}.`),this;if(!this.builders.has(e.type))return console.warn(`${this.MODULE} Compiler: can not support this type: ${e.type}`),this;const n=this.map.get(t);return this.map.delete(t),this.symbolMap.delete(n.puppet),n.dispose(),n.emit(M.COMPILED_REMOVE),n.emit(M.COMPILED),this}cover(e){const t=e.vid;return this.map.has(t)?(Promise.resolve().then(()=>{d.syncObject(e,e,{vid:!0,type:!0})}),this):(console.warn(`${this.MODULE} Compiler: can not found this vid object: ${t}.`),this)}compile(e,t){if(!this.map.has(e))return console.warn(`${this.MODULE} Compiler: can not found model which vid is: '${e}'`),this;const n=this.map.get(e);n.process(t);const s=t.path;return n.emit(`${M.COMPILED_ATTR}:${s&&s+"."}${t.key}`),n.emit(M.COMPILED_UPDATE),n.emit(M.COMPILED),this}compileAll(){const e=this.target;for(const t of Object.values(e))this.add(t);return this}dispose(){for(const e of this.map.values())e.dispose();return this.map.clear(),this.target={},this}getObjectSymbol(e){return this.symbolMap.get(e)||null}getObjectBySymbol(e){var t;return((t=this.map.get(e))==null?void 0:t.puppet)||null}getModelBySymbol(e){return this.map.get(e)||null}useModel(e,t){if(this.builders.has(e.type))return console.warn(`${this.MODULE} Compiler: has already exist this model ${e.type}.`),this;let n;if(e.shared){n=class extends K{constructor(s){super(s)}};for(const s in e.shared)n.prototype[s]=e.shared[s]}return this.builders.set(e.type,{option:e,Builder:n}),b[e.type]=e.config,q[ie(e.type)]=e.type,W[Ye(e.type)]=e.type,x[e.type]=this.MODULE,t&&t(this),this}useProcessor(e,t){return this.useModel(e,t)}}const p={proxy:{expand:void 0,timing:"before",toRaw:void 0},symbol:{generator:He.nanoid,validator:r=>r.length===21},engine:void 0},tt=function(r){r.proxy&&Object.assign(p.proxy,r.proxy),r.symbol&&Object.assign(p.symbol,r.symbol)},de=function(r,e,t){return Reflect.get(r,e,t)},pe=function(r,e,t,n,s){if(typeof e=="symbol")return Reflect.set(r,e,t,n);if(r[e]===void 0){const o=Reflect.set(r,e,t);return s.add(t),s.next({operate:"add",path:"",key:e,value:t,symbol:e}),o}else{const o=Reflect.set(r,e,t);return s.remove(t.vid),s.add(t),s.next({operate:"set",path:"",key:e,value:t,symbol:e}),o}},ge=function(r,e,t){if(typeof e=="symbol")return Reflect.deleteProperty(r,e);const n=r[e],s=Reflect.deleteProperty(r,e);return t.next({operate:"delete",path:"",key:e,value:n,symbol:e}),t.remove(n.vid),s};class ye extends oe.Subject{constructor(){super(),this.subscriptions=new Map;const e=p.proxy.expand?(t={})=>p.proxy.expand(t):(t={})=>t;p.proxy.timing==="before"?this.space=new Proxy(e(),{get:de,set:(t,n,s,o)=>pe(t,n,s,o,this),deleteProperty:(t,n)=>ge(t,n,this)}):this.space=e(new Proxy({},{get:de,set:(t,n,s,o)=>pe(t,n,s,o,this),deleteProperty:(t,n)=>ge(t,n,this)}))}add(e){const t=D(e);if(!t){console.error("Container: this config can not observer",e);return}this.subscriptions.set(t.target.vid,t.subscribe(n=>{this.next({operate:n.operate,path:n.path,key:n.key,value:n.value,symbol:t.target.vid})}))}remove(e){this.subscriptions.delete(e)}}const v=(r,e)=>e===1/0?"Infinity":e===-1/0?"-Infinity":e,_=(r,e)=>e==="Infinity"?1/0:e==="-Infinity"?-1/0:e,P=r=>JSON.parse(JSON.stringify(r,v),_),C={stringify:v,parse:_,clone:P},rt=Object.freeze(Object.defineProperty({__proto__:null,clone:P,default:C,parse:_,stringify:v},Symbol.toStringTag,{value:"Module"})),g=function(r,e,t={observer:!0,strict:!0,warn:!0}){if(t.observer===void 0&&(t.observer=!0),t.strict===void 0&&(t.strict=!0),t.warn===void 0&&(t.warn=!0),t.handler===void 0&&(t.handler=p.proxy.expand),!H[r])return console.error(`type: ${r} can not be found in configList.`),{vid:"",type:r};const n=(i,a)=>{for(const l in a){if(i[l]===void 0){!t.strict&&(i[l]=a[l]),t.strict&&t.warn&&console.warn(`'${r}' config can not set key: ${l}`);continue}typeof a[l]=="object"&&a[l]!==null&&!Array.isArray(a[l])?(i[l]===null&&(i[l]={...a[l]}),n(i[l],a[l])):i[l]=a[l]}};let s=H[r]();if(s.vid===""&&(s.vid=p.symbol.generator()),e&&n(s,e),t.observer===!1)return s;t.handler&&p.proxy.timing==="before"&&(s=t.handler(s));let o=Ee(s);if(t.handler&&p.proxy.timing==="after"&&(o=t.handler(o)),g.autoInject&&g.injectEngine){const i=g.injectEngine;if(i.applyConfig(o),g.injectScene&&le(s.type)&&s.type!==W.SCENE){let a=null;typeof g.injectScene=="boolean"?a=i.getObjectConfig(i.scene):typeof g.injectScene=="string"&&(a=i.getConfigBySymbol(g.injectScene)),a?a.children.push(s.vid):console.warn("current engine scene can not found it config",i,i.scene)}return o}return o};g.autoInject=!0,g.injectScene=!1,g.injectEngine=null;const me=(r,e={})=>{let t=JSON.stringify(r,C.stringify);const n={};!e.filter&&(e.filter=["assets"]);const s=Object.keys(r).filter(i=>!e.filter.includes(i));for(const i of s)for(const a of r[i]){const l=a.vid,u=Ae();t=t.replace(new RegExp(l,"g"),u),e.detail&&(n[l]=u)}const o=JSON.parse(t,C.parse);if(e.fillName)if(typeof e.fillName=="function")for(const i of s)for(const a of o[i])a.name||(a.name=e.fillName(a));else for(const i of s)for(const a of o[i])a.name||(a.name=`${a.type}-${a.vid.slice(-2)}`);return e.detail?{config:o,detail:n}:o},ee=(r,e,t={filter:["assets"],clone:!0})=>{const n=t.clone?C.clone(r):r;!t.filter&&(t.filter=["assets"]);const s=Object.keys(n).filter(o=>!t.filter.includes(o));for(const o of s)n[o].forEach((a,l,u)=>{u[l]=e(a)});return n},Me=function(r){const e={};for(const t of Object.keys(r))for(const n of r[t])e[n.name]=n;return e},Oe=function(r,e){return typeof r=="string"&&(r=JSON.parse(r,C.parse)),ee(C.clone(r),t=>(t=g(t.type,t,{strict:!1}),e?e(t):t))},nt=Object.freeze(Object.defineProperty({__proto__:null,clone:me,default:{clone:me,handler:ee,planish:Me,observable:Oe},handler:ee,observable:Oe,planish:Me},Symbol.toStringTag,{value:"Module"}));class be{constructor(){this.list=[],this.time=0}exec(e){if(e(!1))return;this.list.includes(e)||this.list.push(e);let t=0;const n=()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const s=[];for(const o of this.list)o(!1)||s.push(o);if(s.length)if(s.length===t){for(const o of s)o(!0);this.list=[]}else t=s.length,this.list=s,n();else this.list=[]},this.time)};n()}append(e){this.list.length&&!this.list.includes(e)?this.list.push(e):this.exec(e)}nextTick(e){setTimeout(()=>{e()},this.time)}}const st=new be;class Se{constructor(e){this.MODULE="",this.container=new ye,this.ruler=e.ruler,this.MODULE=e.module,this.container.subscribe(t=>{this.ruler.execute(t)})}getData(){return this.container.space}existSymbol(e){return!!this.container.space[e]}addConfig(e){return this.container.space[e.vid]=e,this}getConfig(e){return this.container.space[e]}removeConfig(e){const t=this.container.space;t[e]!==void 0&&delete t[e]}addCompiler(e){return e.setTarget(this.container.space),e.compileAll(),this.ruler.link(e),this}toJSON(e=!0){return JSON.stringify(e?this.exportConfig():Object.values(this.container.space),v)}exportConfig(e=!0){if(e){const t=this.container.space,n=[],s={},o=(i,a,l={})=>{for(const u in i){if(["vid","type"].includes(u)){l[u]=i[u];continue}if(typeof i[u]=="object"&&i[u]!==null){if(Array.isArray(i[u])){if(!i[u].length)continue;l[u]=i[u].map(y=>typeof y=="object"&&y!==null?P(y):y);continue}l[u]={},a[u]?(o(i[u],a[u],l[u]),Object.keys(l[u]).length===0&&delete l[u]):l[u]=P(i[u])}else a[u]!==i[u]&&(l[u]=i[u])}};for(const i of Object.values(t)){if(!s[i.type]){if(!b[i.type]){console.error(`can not font some config with: ${i.type}`);continue}s[i.type]=b[i.type]()}const a={};o(i,s[i.type],a),n.push(a)}return n}else return Object.values(P(this.container.space))}load(e){const t=this.container.space,n={},s=(o,i)=>{for(const a in i)typeof o[a]=="object"&&o[a]!==null&&typeof i[a]=="object"&&i[a]!==null?s(o[a],i[a]):o[a]===void 0&&(o[a]=i[a])};for(const o of e){if(!n[o.type]){if(!b[o.type]){console.error(`can not font some config with: ${o.type}`);continue}n[o.type]=b[o.type]()}s(o,n[o.type]),t[o.vid]=o}return this}remove(e){const t=this.container.space;for(const n of e)t[n.vid]!==void 0&&delete t[n.vid];return this}}const ot=["push","pop","shift","unshift","splice","sort","reverse"],N=new WeakSet,it={get:function(r,e,t){return Array.isArray(r)&&ot.includes(e)&&N.add(r),Reflect.get(r,e,t)},set:function(r,e,t,n){const s=X(r),o=D(r);if(typeof e=="symbol"||o.ignore(d.extendPath(s,e)))return Reflect.set(r,e,t,n);if(d.isObject(t)&&!fe(t)&&(t=G(o,t,r,e)),r[e]===void 0){d.isObject(t)&&(t[Symbol.for(E)]=e,d.isArray(t)&&I(t)),d.isArray(r)&&N.delete(r);const l=Reflect.set(r,e,t);return d.isArray(r)&&I(r),o.next({operate:"add",path:s,key:e,value:t}),l}const i=r[e],a=Reflect.set(r,e,t);if(d.isArray(r)){if(N.has(r)&&e==="length"){const l=Ke(r);if(!l)return Array.isArray(i)&&console.error("array value is not be cached:",r),a;Qe(r);const u=Math.abs(l.length-r.length),y=l.length>=r.length?"delete":"add",Ot=l.length>=r.length?r:l;let Fe=0,Ve=0;for(const qe of y==="delete"?l:r){if(!Ot.includes(qe)&&(o.next({operate:y,path:s,key:Ve.toString(),value:qe}),Fe+=1,Fe===u))break;Ve+=1}return I(r),N.delete(r),a}else if(N.has(r)||e==="length")return a}return o.next({operate:"set",path:s,key:e,value:t}),a},deleteProperty:function(r,e){const t=X(r),n=D(r);if(typeof e=="symbol"||n.ignore(t))return Reflect.deleteProperty(r,e);const s=r[e],o=Reflect.deleteProperty(r,e);return d.isArray(r)||n.next({operate:"delete",path:t,key:e,value:s}),o}},G=function(r,e,t,n){if(!d.isObject(e)||fe(e))return e;const s=t?X(t):"";if(r.ignore(s))return e;t&&(e[Symbol.for(Y)]=t),e[Symbol.for(z)]=r;for(const i in e){const a=d.extendPath(s,i);if(!r.ignore(a)&&d.isObject(e[i])){if(d.isArray(e[i])){const l=e[i];e[i]=G(r,e[i],e),I(l)}else e[i]=G(r,e[i],e);e[i][Symbol.for(E)]=i}}return n&&(e[Symbol.for(E)]=n),new Proxy(e,it)},L=class L extends oe.Subject{constructor(e){super(),this.disable=!1,this.target=G(this,e)}ignore(e){const t=e.indexOf(".");return t===-1?L.IGNORE[e]:L.IGNORE[e.slice(0,t)]}next(e){if(this.disable)return;super.next(e);const t=_e(this.target);t&&t.emit(M.NOTICED)}};L.IGNORE={vid:!0,type:!0,alias:!0,meta:!0};let te=L;const Ee=function(r){return new te(r).target},at=function(r,e){const t=D(r);if(!t){console.warn("this object can not found it observer:",r);return}t.disable=!0,e(),t.disable=!1},A={SYMBOL_VALIDATOR(r){return!p.symbol.validator(r.symbol)},OPERATE_ADD({operate:r,path:e,symbol:t,key:n,value:s},o){return r==="add"&&!e.length&&t===n?(o.add(s),!1):!0},OPERATE_DELETE({operate:r,path:e,value:t},n){return r==="delete"&&!e.length?(n.remove(t),!1):!0},OPERATE_COVER({operate:r,path:e,value:t,key:n,symbol:s},o){return r==="set"&&!e.length&&n===s?(o.cover(t),!1):!0},OPERATE_COMPILE(r,e){return e.compile(r.symbol,r),!1}};class ve{constructor(e){this.rules=[],this.pointer=null,e?this.rules=e:this.rules.push(A.SYMBOL_VALIDATOR,A.OPERATE_ADD,A.OPERATE_DELETE,A.OPERATE_COVER,A.OPERATE_COMPILE)}link(e){this.compiler=e}execute(e){for(const t of this.rules)if(!t(e,this.compiler))break}remove(e){if(this.rules.includes(e)){const t=this.rules.indexOf(e);this.rules.splice(t,1)}else console.warn("Ruler: can not found rule",e,this.rules)}add(e,t){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):t!==void 0?(this.rules.splice(t,0,e),this):this.pointer===null?(console.error("Ruler:index is undefined, need a index or use before and after api to set a index"),this):(this.rules.splice(this.pointer,0,e),this)}before(e){return this.rules.includes(e)?(this.pointer=this.rules.indexOf(e),this):(console.warn("Ruler: rules not found this rule",this.rules),this)}after(e){return this.rules.includes(e)?(this.pointer=this.rules.indexOf(e)+1,this):(console.warn("Ruler: rules not found this rule",this.rules),this)}push(e){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):(this.rules.push(e),this)}unshift(e){return this.rules.includes(e)?(console.warn("Ruler: rules has already exist this rule",this.rules),this):(this.rules.unshift(e),this)}pop(){return this.rules.pop(),this}shift(){return this.rules.shift(),this}}const ct=function(r){return r},Ce=function(){return{vid:"",type:"",name:"",alias:"",meta:{}}},lt=Ce,ut=function(r){return`DEFUALT-${r}`},Ae=function(){return p.symbol.generator()},ft=function(){};class we{constructor(e){this.type="",this.module=e,this.type=e.type,this.ruler=new ve(e.rule),this.compiler=e.compiler?new e.compiler({module:e.type,models:e.models}):new he({module:e.type,models:e.models}),this.converter=new Se({module:e.type,ruler:this.ruler}).addCompiler(this.compiler)}}const ht=function(r){return r};class De extends S.EventDispatcher{constructor(){super(),this.compilerMap=new Map}extend(e,t=!1){this.compilerMap.has(e.MODULE)?(console.warn("compiler manager has exist this compiler",e),t&&this.compilerMap.set(e.MODULE,e)):this.compilerMap.set(e.MODULE,e)}getCompiler(e){return this.compilerMap.has(e)?this.compilerMap.get(e):(console.warn(`can not found this type in compiler manager: ${e}`),null)}getObjectSymbol(e){for(const t of this.compilerMap.values()){const n=t.getObjectSymbol(e);if(n)return n}return null}getObjectBySymbol(e){for(const t of this.compilerMap.values()){const n=t.getObjectBySymbol(e);if(n)return n}return null}getModelBySymbol(e){for(const t of this.compilerMap.values()){const n=t.getModelBySymbol(e);if(n)return n}return null}getObjectfromModule(e,t){return this.getObjectFromModule(e,t)}getObjectFromModule(e,t){return this.compilerMap.has(e)?this.compilerMap.get(e).map.get(t)||null:(console.warn(`compiler manager can not found this module: ${e}`),null)}getObjectfromModules(e,t){return this.getObjectFromModules(e,t)}getObjectFromModules(e,t){Array.isArray(e)||(e=Object.keys(e));for(const n of e){if(!this.compilerMap.has(n)){console.warn(`compiler manager can not found this module: ${n}`);continue}const s=this.compilerMap.get(n);if(s.map.has(t))return s.map.get(t)}return null}dispose(){for(const e of this.compilerMap.values())e.dispose();return this.compilerMap.clear(),this}}const U="CompilerManagerPlugin",Re=function(){return{name:U,install(r){const e=new De;r.compilerManager=e,r.getObjectSymbol=function(t){return e.getObjectSymbol(t)},r.getObjectBySymbol=function(t){return e.getObjectBySymbol(t)},r.getObjectfromModule=function(t,n){return e.getObjectfromModule(t,n)},r.getObjectfromModules=function(t,n){return e.getObjectfromModules(t,n)},r.getObject3D=function(t){return e.getObjectfromModules(ae,t)}},dispose(r){r.compilerManager.dispose(),delete r.compilerManager,delete r.getObjectSymbol,delete r.getObjectBySymbol,delete r.getObjectfromModule,delete r.getObjectfromModules,delete r.getObject3D}}};class Pe extends S.EventDispatcher{constructor(){super(),this.dataSupportMap=new Map}extend(e,t=!1){this.dataSupportMap.has(e.MODULE)?(console.warn("dataSupport manager has exist this dataSupport",e),t&&this.dataSupportMap.set(e.MODULE,e)):this.dataSupportMap.set(e.MODULE,e)}getDataSupport(e){return this.dataSupportMap.has(e)?this.dataSupportMap.get(e):(console.warn(`can not found this type in dataSupportManager: ${e}`),null)}getConfigBySymbol(e){const t=this.dataSupportMap.values();for(const n of t){const s=n.getConfig(e);if(s)return s}return null}getConfigfromModule(e,t){return this.getConfigFromModule(e,t)}getConfigFromModule(e,t){return this.dataSupportMap.has(e)?this.dataSupportMap.get(e).getConfig(t)||null:(console.warn(`data support manager can not found this module: ${e}`),null)}getConfigfromModules(e,t){return this.getConfigFromModules(e,t)}getConfigFromModules(e,t){Array.isArray(e)||(e=Object.keys(e));for(const n of e){if(!this.dataSupportMap.has(n)){console.warn(`data support manager can not found this module: ${n}`);continue}const o=this.dataSupportMap.get(n).getConfig(t);if(o)return o}return null}removeConfigBySymbol(...e){for(const t of e)for(const n of this.dataSupportMap.values())if(n.existSymbol(t)){n.removeConfig(t);break}return this}getModuleBySymbol(e){const t=this.dataSupportMap.values();for(const n of t)if(n.existSymbol(e))return n.MODULE;return null}applyConfig(...e){for(const t of e){const n=$(t.type);n?this.dataSupportMap.get(n).addConfig(t):console.warn(`dataSupportManager can not found this config module: ${t.type}`)}return this}load(e){return this.dataSupportMap.forEach((n,s)=>{e[s]&&n.load(e[s])}),this}loadByModule(e,t){const n=this.dataSupportMap.get(t);return n?(n.load(e),this):(console.warn(`DataSupportManager can not support this module: ${t}`),this)}remove(e){return this.dataSupportMap.forEach((n,s)=>{e[s]&&n.remove(e[s])}),this}toJSON(e={},t=!0){return JSON.stringify(this.exportConfig(e,t),v)}exportConfig(e={},t=!0){return this.dataSupportMap.forEach((s,o)=>{e[o]=s.exportConfig(t)}),e}}const T="DataSupportManagerPlugin",Ne=function(){return{name:T,install(r){const e=new Pe;r.dataSupportManager=e,r.applyConfig=function(...t){return e.applyConfig(...t),r},r.getConfigBySymbol=function(t){return e.getConfigBySymbol(t)},r.getConfigfromModule=function(t,n){return e.getConfigfromModule(t,n)},r.getConfigfromModules=function(t,n){return e.getConfigfromModules(t,n)},r.removeConfigBySymbol=function(...t){return e.removeConfigBySymbol(...t),r},r.toJSON=function(){return e.toJSON()},r.exportConfig=function(){return e.exportConfig()}},dispose(r){delete r.dataSupportManager,delete r.applyConfig,delete r.getConfigBySymbol,delete r.removeConfigBySymbol,delete r.toJSON,delete r.exportConfig}}};class Te{}class B extends Te{constructor(){super(...arguments),this.selector=(e,t,n)=>n.get(B)||null}parse({url:e,resource:t,configMap:n,resourceMap:s}){s.set(e,t)}}var J=(r=>(r.MAPPED="mapped",r))(J||{});class Le extends S.EventDispatcher{constructor(e={}){super(),this.configMap=new Map,this.resourceMap=new Map,this.paserMap=new Map,this.defalutParser=new B;const t=new Map;for(const n in e)t.has(n)&&console.warn(`resourceManager construct params rescource already exist: ${n}, that will be cover.`),t.set(n,e[n]);this.mappingResource(t)}addParser(e){return this.paserMap.has(e.constructor)?this:(this.paserMap.set(e.constructor,e),this)}mappingResource(e,t){const n=this.configMap,s=this.resourceMap,o=[...this.paserMap.values()],i={};for(const[a,l]of e.entries()){if(t!=null&&t.parser&&t.parser[a]){t.parser[a].parse({url:a,resource:l,configMap:n,resourceMap:s});continue}if(t!=null&&t.selector&&t.selector[a]){const y=t.selector[a](a,l,this.paserMap);if(!y){console.warn("resource manager hanlder can not found this resource parser: ",l,t.selector[a]);continue}y.parse({url:a,resource:l,configMap:n,resourceMap:s}),i[a]=this.getResourceConfig(a);continue}let u=null;for(const y of o)if(u=y.selector(a,l,this.paserMap),u)break;if(!u){console.warn("resouce manager can not found some handler to parser this resource, that will use default parser do it:",l),this.defalutParser.parse({url:a,resource:l,configMap:n,resourceMap:s});continue}u.parse({url:a,resource:l,configMap:n,resourceMap:s}),i[a]=this.getResourceConfig(a)}return this.dispatchEvent({type:"mapped",configMap:n,resourceMap:s,resourceConfig:i}),this}getResourceConfig(e){const t=this.configMap,n={};return[...t.keys()].filter(s=>s.startsWith(e)).forEach(s=>{const o=t.get(s);if(!o)console.error(`unknow error: can not found config by url: ${s}`);else{const i=$(o.type);i?(!n[i]&&(n[i]=[]),n[i].push(o)):console.error(`unknow error: can not found module by type: ${o.type}`,o)}}),n}hasResource(e){return this.resourceMap.has(e)}remove(e){const t=this.configMap,n=this.resourceMap;return[...t.keys()].filter(s=>s.startsWith(e)).forEach(s=>{t.delete(s);const o=n.get(s);o.dispose&&o.dispose(),n.delete(s)}),this}dispose(){this.resourceMap.forEach((e,t)=>{e.dispose&&e.dispose()}),this.resourceMap.clear(),this.configMap.clear()}}const re="ResourceManagerPlugin",je=function(r={}){return{name:re,install(e){const t=new Le(r.resources);e.resourceManager=t,e.registerResources=n=>{const s=new Map;return Object.keys(n).forEach(o=>{s.set(o,n[o])}),t.mappingResource(s),e}},dispose(e){e.addEventListener(S.ENGINE_EVENT.DISPOSE,()=>{e.resourceManager.dispose()})}}},xe="LoaderDataSupportStrategy",$e=function(){let r,e;return{name:xe,condition:[T,O.LOADER_MANAGER_PLUGIN],exec(t){r=t.toJSON,t.toJSON=function(){const n={assets:JSON.parse(t.loaderManager.toJSON())};return t.dataSupportManager.toJSON(n)},e=t.exportConfig,t.exportConfig=function(){let n={};return n={assets:t.loaderManager.exportConfig()},t.dataSupportManager.exportConfig(n)}},rollback(t){t.toJSON=r,t.exportConfig=e}}},Ie="LoaderMappingStrategy",Ge=function(){let r,e;return{name:Ie,condition:[re,O.LOADER_MANAGER_PLUGIN],exec(t){r=t.loadResources,t.loadResources=(n,s)=>{const o=i=>{s(void 0,i),t.resourceManager.removeEventListener(O.LOADER_EVENT.LOADED,o)};try{t.resourceManager.addEventListener(O.LOADER_EVENT.LOADED,o)}catch(i){s(i)}return t.loaderManager.reset().load(n),t},e=t.loadResourcesAsync,t.loadResourcesAsync=n=>new Promise((s,o)=>{try{t.loaderManager.once(O.LOADER_EVENT.LOADED,i=>{t.resourceManager.once(J.MAPPED,l=>{s(l)});const a=new Map;n.forEach(l=>{typeof l=="string"?a.set(l,i.resourceMap.get(l)):a.set(l.url,i.resourceMap.get(l.url))}),t.resourceManager.mappingResource(a)})}catch(i){o(i)}t.loaderManager.reset().load(n)})},rollback(t){t.loadResources=r,t.loadResourcesAsync=e}}},Ue="CompilerSupportStrategy",Be=function(){return{name:Ue,condition:[U,T],exec(r){r.compilerManager.compilerMap.forEach((e,t)=>{var n;e.useEngine(r),(n=r.dataSupportManager.dataSupportMap.get(t))==null||n.addCompiler(e)})},rollback(){}}};class dt{constructor(e){this.condition={},this.list=[],this.validator=()=>!0,e&&(this.validator=e)}add(e){return this.validator(e)&&(this.condition[e]=!1),this}reach(e){return this.condition[e]===void 0?(console.warn(`ModuleTrigger: can not set module condition: ${e}.`),this):(this.condition[e]=!0,this.check()&&this.trig(),this)}register(e){e(!0)||this.list.push(e)}trig(){const e=this.list;for(const t of e)t(!1);this.reset()}reset(){this.list=[],Object.keys(this.condition).forEach(e=>{this.condition[e]=!1})}check(){return!Object.values(this.condition).includes(!1)}}const pt=new dt(r=>!!w[r]);var Je=(r=>(r[r.ZERO=0]="ZERO",r[r.ONE=100]="ONE",r[r.TWO=200]="TWO",r[r.THREE=300]="THREE",r[r.FOUR=400]="FOUR",r[r.FIVE=500]="FIVE",r[r.SIX=600]="SIX",r[r.SEVEN=700]="SEVEN",r[r.EIGHT=800]="EIGHT",r[r.NINE=900]="NINE",r))(Je||{});class ke extends S.Engine{constructor(e={}){super(),this.moduleLifeCycle=[],this.triggers={object:pt},this.install(O.LoaderManagerPlugin(e.LoaderManagerPlugin)).install(k.PointerManagerPlugin(e.PointerManagerPlugin)).install(F.EventManagerPlugin(e.EventManagerPlugin)).install(V.RenderManagerPlugin(e.RenderManagerPlugin)).install(je(e.ResourceManagerPlugin)).install(Ne(e.DataSupportManagerPlugin)).install(Re(e.CompilerManagerPlugin)),this.exec($e()).exec(Ge()).exec(Be())}loadLifeCycle(e){const t=this.dataSupportManager,n=this.triggers,s=this.moduleLifeCycle.sort((o,i)=>o.order-i.order);for(const{module:o}of s){e[o]&&t.loadByModule(e[o],o);for(const i in n)n[i].reach(o)}}removeLifeCycle(e){const t=this.dataSupportManager,n=this.moduleLifeCycle.sort((a,l)=>l.order-a.order);for(const{module:a}of n)e[a]&&t.remove({[a]:e[a]});const s=e.assets||[],o=this.resourceManager,i=this.loaderManager;s.forEach(a=>{o.remove(a),i.remove(a)})}loadConfig(e,t){const n=this.renderManager.hasRendering();if(n&&this.renderManager.stop(),e.assets&&e.assets.length){const s=o=>{delete e.assets,this.loadLifeCycle(e),this.resourceManager.removeEventListener("mapped",s),t&&t(o),n?this.renderManager.play():this.renderManager.render()};this.resourceManager.addEventListener("mapped",s),this.loaderManager.reset().load(e.assets)}else this.loadLifeCycle(e),t&&t(),n?this.renderManager.play():this.renderManager.render();return this}loadConfigAsync(e,t){return new Promise((n,s)=>{const o=this.renderManager.hasRendering();o&&this.renderManager.stop(),e.assets&&e.assets.length?this.loadResourcesAsync(e.assets).then(i=>{delete e.assets,this.loadLifeCycle(e),o?this.renderManager.play():this.renderManager.render(),n(i)}):(this.loadLifeCycle(e),o?this.renderManager.play():this.renderManager.render(),n({type:J.MAPPED,configMap:this.resourceManager.configMap,resourceMap:this.resourceManager.resourceMap,resourceConfig:{}}))})}removeConfig(e){this.removeLifeCycle(e)}getObjectConfig(e){const t=this.getObjectSymbol(e);return t?this.getConfigBySymbol(t):null}useModule(e){const t=ie(e.type);if(j[t])return console.warn(`Engine:module ${e.type} is already exist.`),this;j[t]=e.type,e.object&&(w[e.type]=!0);const n=new we(e);return n.compiler.useEngine(this),this.dataSupportManager.extend(n.converter),this.compilerManager.extend(n.compiler),e.extend&&e.extend(this),this.moduleLifeCycle.push({module:e.type,order:e.lifeOrder||0}),Object.values(this.triggers).forEach(s=>{s.add(e.type)}),this}addTrigger(e,t){return this.triggers[e]?console.warn(`EngineSupport: this trigger has already exist: ${e}.`,this.triggers):this.triggers[e]=t,this}getTrigger(e){return this.triggers[e]?this.triggers[e]:(console.warn(`EngineSupport: not found this trigger: ${e}.`,this.triggers),null)}init(){}registModule(e){return this.useModule(e)}}const gt=function(r,e={}){const t=new ke(e);return r.modules&&r.modules.forEach(n=>{t.useModule(n)}),r.plugins&&r.plugins.forEach(n=>{t.install(n)}),r.strategy&&r.strategy.forEach(n=>{t.exec(n)}),t},f=class f{static generateConfig(e,t){if(!f.configLibrary.has(e))return console.warn(`event library can not found config by name: ${e}`),null;const n=(o,i)=>{for(const a in i)typeof i[a]=="object"&&i[a]!==null&&!Array.isArray(i[a])?n(o[a],i[a]):o[a]=i[a]},s=JSON.parse(JSON.stringify(f.configLibrary.get(e)));return n(s,t),s}static generateEvent(e,t){return f.generatorLibrary.has(e.name)?f.generatorLibrary.get(e.name)(t,e):(console.error(`event library can not found generator by name: ${e.name}`),()=>{})}static has(e){return f.configLibrary.has(e)}static useEngine(e){f.engine=e}static createEvent(e,t,n){if(!f.engine&&!n)return console.error("EventGenerator Manager createEvent must provide an engine, you can use 'useEngine' to set it."),null;const s=f.generateConfig(e,t);return s?f.generateEvent(s,n||f.engine):null}};f.configLibrary=new Map,f.generatorLibrary=new Map,f.register=function({config:e,generator:t}){return f.configLibrary.has(e.name)?(console.warn(`EventGeneratorManager has already exist this event generator: ${e.name}, that will be cover.`),f):(f.configLibrary.set(e.name,JSON.parse(JSON.stringify(e))),f.generatorLibrary.set(e.name,t),f)};let ne=f;const m=class m{static getShader(e){return m.library.has(e)?m.cloneShader(m.library.get(e)):(console.warn(`con not found shader in shader library: ${e}`),null)}static generateConfig(e,t){if(!m.library.has(e))return console.warn(`con not found shader in shader library: ${e}`),{shader:e,uniforms:{}};const n=m.library.get(e),s={shader:e,uniforms:{}};if(n.uniforms&&(s.uniforms=JSON.parse(JSON.stringify(n.uniforms))),t){const o=(i,a)=>{for(const l in a)i[l]!==void 0&&(typeof a[l]=="object"&&a[l]!==null&&!Array.isArray(a[l])?(i[l]===null&&(i[l]={...a[l]}),o(i[l],a[l])):i[l]=a[l])};o(s.uniforms,t)}return s}static cloneShader(e){const t={name:e.name};return e.vertexShader&&(t.vertexShader=e.vertexShader),e.fragmentShader&&(t.fragmentShader=e.fragmentShader),e.uniforms&&(t.uniforms=JSON.parse(JSON.stringify(e.uniforms))),t}};m.library=new Map,m.register=function(e){m.library.has(e.name)&&console.warn(`shader library has exist shader: ${e.name} that will be cover.`),m.library.set(e.name,e)};let se=m;const yt=r=>{R.exec(r)},mt=()=>{},Mt=[U,T];c.AntiShake=be,c.COMPILER_MANAGER_PLUGIN=U,c.COMPILER_SUPPORT_STRATEGY=Ue,c.CONFIGFACTORY=H,c.CONFIGMODULE=Xe,c.CONFIGTYPE=W,c.CONFIG_FACTORY=b,c.CONFIG_MODEL=ze,c.CONFIG_MODULE=x,c.CONFIG_TYPE=q,c.Compiler=he,c.CompilerManager=De,c.CompilerManagerPlugin=Re,c.CompilerSupportStrategy=Be,c.Container=ye,c.Converter=Se,c.DATA_SUPPORT_MANAGER_PLUGIN=T,c.DEFAULT_RULE=A,c.DataSupportManager=Pe,c.DataSupportManagerPlugin=Ne,c.DefaultParser=B,c.EngineSupport=ke,c.EventGeneratorManager=ne,c.JSONHandler=rt,c.LOADER_DATA_SUPPORT_STRATEGY=xe,c.LOADER_MAPPING_STRATEGY=Ie,c.LoaderDataSupportStrategy=$e,c.LoaderMappingStrategy=Ge,c.MODEL_EVENT=M,c.MODULETYPE=Ze,c.MODULE_TYPE=j,c.Model=K,c.Moduler=we,c.OBJECTMODULE=ae,c.OBJECT_MODULE=w,c.PLUGINS=Mt,c.Parser=Te,c.RESOURCE_EVENT=J,c.RESOURCE_MANAGER_PLUGIN=re,c.ResourceManager=Le,c.ResourceManagerPlugin=je,c.Ruler=ve,c.SUPPORT_LIFE_CYCLE=Je,c.ShaderGeneratorManager=se,c.Template=nt,c.createSymbol=Ae,c.defineEngineSupport=gt,c.defineModel=Q,c.defineModule=ht,c.defineOption=tt,c.defineProcessor=et,c.defineRule=ct,c.emptyHandler=ft,c.generateConfig=g,c.getBasicConfig=Ce,c.getModule=$,c.getObserver=D,c.getSymbolConfig=lt,c.globalAntiShake=st,c.globalOption=p,c.isObjectModule=ce,c.isObjectType=le,c.observable=Ee,c.slientSync=at,c.toAsync=yt,c.toTrigger=mt,c.uniqueSymbol=ut,Object.keys(O).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(c,r)&&Object.defineProperty(c,r,{enumerable:!0,get:()=>O[r]})}),Object.keys(k).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(c,r)&&Object.defineProperty(c,r,{enumerable:!0,get:()=>k[r]})}),Object.keys(F).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(c,r)&&Object.defineProperty(c,r,{enumerable:!0,get:()=>F[r]})}),Object.keys(V).forEach(r=>{r!=="default"&&!Object.prototype.hasOwnProperty.call(c,r)&&Object.defineProperty(c,r,{enumerable:!0,get:()=>V[r]})}),Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
