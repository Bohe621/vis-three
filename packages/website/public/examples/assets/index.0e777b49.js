import{a as m,E}from"./index.8b9e7665.js";import{L as u,a as g}from"./index.9e868923.js";import{P as h}from"./index.f27dc7ff.js";import{E as S}from"./index.9a3e1c8e.js";import{R}from"./index.510eaae3.js";import{R as P,D as p,a as i,C as L,b as y,c as A,M as l}from"./index.0a1fac43.js";const M="ResourceManagerPlugin",C=function(t){return{name:M,install(e){const r=new P(t.resources);e.resourceManager=r,e.registerResources=a=>{const s=new Map;return Object.keys(a).forEach(o=>{s.set(o,a[o])}),r.mappingResource(s),e}},dispose(e){e.addEventListener(m.DISPOSE,()=>{e.resourceManager.dispose()})}}},f="LoaderDataSupportStrategy",x=function(){let t,e;return{name:f,condition:[p,u],exec(r){t=r.toJSON,r.toJSON=function(){const a={assets:JSON.parse(r.loaderManager.toJSON())};return r.dataSupportManager.toJSON(a)},e=r.exportConfig,r.exportConfig=function(){let a={};return a={assets:r.loaderManager.exportConfig()},r.dataSupportManager.exportConfig(a)}},rollback(r){r.toJSON=t,r.exportConfig=e}}},O="LoaderMappingStrategy",v=function(){let t,e;return{name:O,condition:[M,u],exec(r){t=r.loadResources,r.loadResources=(a,s)=>{const o=n=>{s(void 0,n),r.resourceManager.removeEventListener(i.MAPPED,o)};try{r.resourceManager.addEventListener(i.MAPPED,o)}catch(n){s(n)}return r.loaderManager.load(a),r},e=r.loadResourcesAsync,r.loadResourcesAsync=a=>new Promise((s,o)=>{const n=d=>{s(d),r.resourceManager.removeEventListener(i.MAPPED,n)};try{r.resourceManager.addEventListener(i.MAPPED,n)}catch(d){o(d)}r.loaderManager.load(a)})},rollback(r){r.loadResources=t,r.loadResourcesAsync=e}}},N="CompilerSupportStrategy",T=function(){return{name:N,condition:[L,p],exec(t){t.compilerManager.compilerMap.forEach((e,r)=>{var a;e.useEngine(t),(a=t.dataSupportManager.dataSupportMap.get(r))==null||a.addCompiler(e)})},rollback(){}}};class _ extends E{constructor(e={},r={}){super(),this.install(g()).install(h()).install(S()).install(R()).install(C({resources:r})).install(y(e)).install(A()),this.exec(x()).exec(v()).exec(T())}loadLifeCycle(e){const r=this.dataSupportManager;e.texture&&r.load({texture:e.texture}),e.material&&r.load({material:e.material}),delete e.texture,delete e.material,r.load(e)}removeLifeCycle(e){const r=this.dataSupportManager,a=e[l.TEXTURE]||[],s=e[l.MATERIAL]||[],o=e.assets||[];delete e.texture,delete e.material,delete e.assets,r.remove(e),r.remove({[l.MATERIAL]:s}),r.remove({[l.TEXTURE]:a});const n=this.resourceManager,d=this.loaderManager;o.forEach(c=>{n.remove(c),d.remove(c)})}loadConfig(e,r){const a=this.renderManager.hasRendering();if(a&&this.renderManager.stop(),e.assets&&e.assets.length){const s=o=>{delete e.assets,this.loadLifeCycle(e),this.resourceManager.removeEventListener("mapped",s),r&&r(o),a?this.renderManager.play():this.renderManager.render()};this.resourceManager.addEventListener("mapped",s),this.loaderManager.reset().load(e.assets)}else this.loadLifeCycle(e),r&&r(),a?this.renderManager.play():this.renderManager.render();return this}loadConfigAsync(e){return new Promise((r,a)=>{const s=this.renderManager.hasRendering();if(s&&this.renderManager.stop(),e.assets&&e.assets.length){const o=n=>{delete e.assets,this.loadLifeCycle(e),this.resourceManager.removeEventListener("mapped",o),s?this.renderManager.play():this.renderManager.render(),r(n)};this.resourceManager.addEventListener("mapped",o),this.loaderManager.reset().load(e.assets)}else this.loadLifeCycle(e),s?this.renderManager.play():this.renderManager.render(),r(void 0)})}removeConfig(e){this.removeLifeCycle(e)}getObjectConfig(e){const r=this.getObjectSymbol(e);return r?this.getConfigBySymbol(r):null}setCameraBySymbol(e){const r=this.compilerManager.getCompiler(l.CAMERA);return r.map.has(e)?this.setCamera(r.map.get(e)):console.warn("can not found camera",e),this}setSceneBySymbol(e){const r=this.compilerManager.getCompiler(l.SCENE);return r.map.has(e)?this.setScene(r.map.get(e)):console.warn("can not found scene",e),this}}const J=function(t){const e=new _;return t.plugins&&t.plugins.forEach(r=>{e.install(r)}),t.strategy&&t.strategy.forEach(r=>{e.exec(r)}),e};export{_ as E,J as d};
