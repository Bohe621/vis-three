(function(u,g){typeof exports=="object"&&typeof module!="undefined"?g(exports,require("@vis-three/middleware"),require("@vis-three/utils"),require("@vue/reactivity"),require("@vis-three/core"),require("@vue/shared")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","@vis-three/utils","@vue/reactivity","@vis-three/core","@vue/shared"],g):(u=typeof globalThis!="undefined"?globalThis:u||self,g((u["vis-three"]=u["vis-three"]||{},u["vis-three"].widget={}),u.middleware,u.utils,u.reactivity,u.core,u.shared))})(this,function(u,g,z,h,Q,d){"use strict";const X="0.6.0",U=function(t,e=null,n={}){return{_isVNode:!0,type:t,props:e,config:null,component:null,el:null,key:n.key||null,ref:n.ref||null,children:null}},C=function(t){return typeof t=="object"?Boolean(t._isVNode):!1},q=function(t){return/^on[A-Z]/.test(t)},V=function(t){const e=t.props,n={};for(const o in e)q(o)&&(n[o]=e[o]);return n};var B=(t=>(t.STATIC="static",t.VIF="vif",t.VFOR="vfor",t))(B||{});const l=function(t,e=null){const n=U(t,e,{key:e&&e.key||null,ref:e&&e.ref||null});return l.add(n),n};l.reset=function(){l.el=null,l.scope="static",l.vnodes=[]},l.add=function(t){if(t.el=l.el,l.scope!=="static"){const e=l.vnodes[l.vnodes.length-1];l.scope==="vfor"&&(t.key||(t.key=e.vnodes.length),e.keyMap.set(t.key,t)),e.vnodes.push(t)}else l.vnodes.push(t);return l.vnodes};const ee=function(t,e=null){return l(t,e)},te=function(t){l.scope="vif",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),t(),l.scope="static"},ne=function(t){l.scope="vfor",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),t(),l.scope="static"};var $=(t=>(t.MOUNTED="mounted",t))($||{});const oe=function(t=()=>{}){m.currentComponent&&m.currentComponent.on("mounted",e=>t())};let F=!1,L=!1;const v=[];let b=0;const R=[];let w=null,k=0;const re=Promise.resolve();function se(t){let e=b+1,n=v.length;for(;e<n;){const o=e+n>>>1,r=v[o],i=j(r);i<t||i===t&&r.pre?e=o+1:n=o}return e}function D(t){(!v.length||!v.includes(t,F&&t.allowRecurse?b+1:b))&&(t.id==null?v.push(t):v.splice(se(t.id),0,t),_())}function _(){!F&&!L&&(L=!0,re.then(H))}function J(t){Array.isArray(t)?R.push(...t):(!w||!w.includes(t,t.allowRecurse?k+1:k))&&R.push(t),_()}function ie(){if(R.length){const t=[...new Set(R)];if(R.length=0,w){w.push(...t);return}for(w=t,w.sort((e,n)=>j(e)-j(n)),k=0;k<w.length;k++)w[k]();w=null,k=0}}const j=t=>t.id==null?1/0:t.id,ce=(t,e)=>{const n=j(t)-j(e);if(n===0){if(t.pre&&!e.pre)return-1;if(e.pre&&!t.pre)return 1}return n};function H(){L=!1,F=!0,v.sort(ce);try{for(b=0;b<v.length;b++){const t=v[b];if(t&&t.active!==!1)try{t()}catch(e){console.error(e)}}}finally{b=0,v.length=0,ie(),F=!1,(v.length||R.length)&&H()}}class m extends Q.EventDispatcher{constructor(e,n){super(),this.cid=g.createSymbol(),this.name="",this.el="",this.isMounted=!1,this.props=h.shallowReactive(Object.create(Object.prototype)),this.scope=new h.EffectScope(!0),this.subTree=null,this.cacheResources=Object.create(Object.prototype),this.resourcesKeyEnum=Object.create(Object.prototype),this.vnode=e;const o=e.type;o.name&&(this.name=o.name),this.el=o.el,this.options=o,this.renderer=n,this.engine=n.engine,this.ctx=n.context,this.createProps(),this.createSetup(),this.createResources(),this.createRender(),this.createEffect()}static setCurrentComponent(e){m.currentComponent=e,e.scope.on()}static unsetCurrentComponent(){m.currentComponent&&m.currentComponent.scope.off(),m.currentComponent=null}renderTree(){return l.reset(),l.el=this.el,this.render.call({...this.setupState,...this.props},{components:this.options.components||{},resources:this.resourcesKeyEnum}),l.vnodes}createResources(){if(!this.options.resources)return;const e=this.options.resources.call(this.setupState);this.engine.registerResources(e),this.cacheResources=e;for(const n in e)this.resourcesKeyEnum[n]=n}createProps(){const e=this.options.props||{},n=this.props,o=this.vnode.props||{};for(const r in e){const i=e[r];if(i.required&&typeof o[r]=="undefined"){console.error("widget component: component prop is required.",{component:this,props:o,key:r});return}let s;if(typeof o[r]!="undefined"?s=o[r]:i.default&&(s=typeof i.default=="function"?i.default():i.default),s.constructor!==i.type){console.error("widget component: component prop is not instance of type.",{component:this,props:o,key:r,value:s,type:i.type});return}n[r]=s}}createSetup(){m.setCurrentComponent(this);const e=this.options.setup({engine:this.engine,props:this.props});this.setupState=h.proxyRefs(e),this.rawSetupState=e,m.unsetCurrentComponent()}createRender(){this.render=this.options.render}createEffect(){const e=new h.ReactiveEffect(()=>{if(this.isMounted){const o=this.renderTree(),r=this.subTree;if(r.length!==o.length){console.error("widget component render: tree render error",{nextTree:o,prevTree:r});return}for(let i=0;i<o.length;i+=1)if(C(r[i])&&C(o[i]))this.renderer.patch(r[i],o[i]);else{const s=o[i],f=r[i];if(s.scope!==f.scope){console.error("widget component render: tree render error",{nextTree:o,prevTree:r});return}if(s.scope===B.VIF){for(const c of f.vnodes)this.renderer.unmountElement(c);for(const c of s.vnodes)this.renderer.mountElement(c)}else if(s.scope===B.VFOR){for(const c of s.keyMap.keys())f.keyMap.has(c)?(this.renderer.patch(f.keyMap.get(c),s.keyMap.get(c)),f.keyMap.delete(c)):this.renderer.mountElement(s.keyMap.get(c));for(const c of f.keyMap.values())this.renderer.unmountElement(c)}else console.warn(`widget component render: unknow scope type: ${s.scope}`)}this.subTree=o}else{const o=this.rawSetupState,r=s=>{!s.ref||typeof o[s.ref]!="undefined"&&(o[s.ref].value=s.component?s.component:s.config||null)},i=this.subTree=this.renderTree();for(const s of i)if(C(s))this.renderer.patch(null,s),r(s);else for(const f of s.vnodes)this.renderer.patch(null,f),r(f);this.isMounted=!0,J(()=>this.emit($.MOUNTED))}},()=>D(n),this.scope),n=()=>e.run();n(),this.effect=e,this.update=n}updateProps(e){const n=this.props;for(const o in e)n[o]=e[o]}getState(e=!0){return e?this.rawSetupState:this.setupState}}const ue=function(t){return t},S=Symbol.for("vis.widget.event"),fe=function(t){const e=function(n){e.value(n)};return e.value=t,e},K=/Once$/;function Y(t){let e={};if(K.test(t)){e={};let o;for(;o=t.match(K);)t=t.slice(0,t.length-o[0].length),e[o[0].toLowerCase()]=!0}return[t.slice(2).toLowerCase(),e]}const le=function(t,e,n){if(e[S]){console.error("config has already create events",e);return}const o=V(t);for(const r in o){o[r]=fe(o[r]);const[i,s]=Y(r);n.addEventListener(i,o[r])}e[S]=o},pe=function(t){const e=t.props,n=t.config;if(!n[S])return;const o=n[S];for(const r in o){const i=o[r];i&&i.value!==e[r]&&(i.value=e[r])}},he=function(t,e){const n=t.config;if(!n[S])return;const o=n[S];for(const r in o){const i=o[r];if(i){const[s,f]=Y(r);e.removeEventListener(s,i)}}n[S]=void 0};class ae{constructor(e){this.context=e,this.engine=e.engine}log(e,n,o){n?console[e](`Widget renderer: ${n}`,o):console.info(`Widget renderer: ${e}`)}patch(e,n){if(!e&&!n){console.error("widget renderer: patch prarams all of null");return}e!==n&&(n&&typeof n.type=="string"||e&&typeof e.type=="string"?this.processElement(e,n):this.processComponent(e,n))}render(e){this.patch(null,e)}processElement(e,n){if(!e&&!n){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountElement(n):n===null?this.unmountElement(e):this.patchElement(e,n)}unmountElement(e){if(g.isObjectType(e.type)){if(e.config.parent){const o=this.engine.getConfigfromModules(g.OBJECTMODULE,e.config.parent);if(!o){console.error("widget renderer: can not found parent config with: ",e);return}o.children.splice(o.children.indexOf(e.config.vid),1)}else if(!e.el){const o=this.engine.getObjectBySymbol(e.config.vid);o||console.error("widget renderer: can not found Three object with: ",e),o.removeFromParent()}const n=this.engine.getObjectBySymbol(e.config.vid);he(e,n)}this.engine.removeConfigBySymbol(e.config.vid)}mountElement(e){const{element:n,onProps:o}=this.createElement(e);if(this.engine.applyConfig(n),g.isObjectType(n.type)){if(!e.el)this.engine.scene.add(this.engine.getObjectfromModules(g.OBJECTMODULE,n.vid));else{const i=this.engine.getConfigfromModules(g.OBJECTMODULE,e.el);if(!i){console.error(`widget renderer: can not found parent config with: ${e.el}`);return}i.children.push(n.vid)}const r=this.engine.getObjectBySymbol(n.vid);le(e,n,r)}}patchElement(e,n){if(e.type!==n.type)this.unmountElement(e),this.mountElement(n);else{n.config=e.config;const o=e.config;o||console.error("widget renderer: can not found  config with: ",e);let r={};const i=n.props;let s=!1;for(const c in e.props){if(q(c)){s=!0;continue}r[c]=e.props[c]}const f=(c,y,O)=>{for(const p in c)C(c[p])?C(y[p])&&y[p].config.vid!==c[p].config.vid?O[p]=y[p].config.vid:C(y[p])||(O[p]=y[p]):z.isObject(c[p])?f(c[p],y[p],O[p]):y[p]!==c[p]&&(O[p]=y[p])};f(r,i,o),s&&pe(n)}}createElement(e){const n=e.props,o={},r={};for(const s in n)["ref","index"].includes(s)||(q(s)?r[s]=n[s]:C(n[s])?o[s]=n[s].config.vid:o[s]=n[s]);const i=g.generateConfig(e.type,o,{strict:!1,warn:!1});return e.config=i,{element:i,onProps:r}}processComponent(e,n){if(!e&&!n){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountComponent(n):n===null?this.unmountComponent(e):this.patchComponent(e,n)}mountComponent(e){e.component=new m(e,this)}unmountComponent(e){}patchComponent(e,n){const o=e.component;n.component=o,o.vnode=n;const r=e.props||{},i=n.props||{},s={};let f=!1;for(const c in i)i[c]!==r[c]&&(s[c]=i[c],f=!0);f&&(o.updateProps(s),o.update())}}class de{constructor(e,n){this.wid=g.createSymbol(),this.version=X,this.components={},this.instance=null,this.engine=e,this.root=n,this.renderer=new ae(this)}component(e,n){if(typeof e=="object"){if(n=e,!n.name){console.error("widget register component must be provide a name",n);return}e=n.name}if(!n){console.error("widget register component must be provide a component not a null",e);return}if(this.components[e]){console.warn(`A component with this name already exists: ${e}`);return}this.components[e]=n}mount(){const e=U(this.root);return this.renderer.render(e),this.instance=e.component,this}getState(){var e;return(e=this.instance)==null?void 0:e.getState(!0)}unmount(){}use(){}}class G extends g.EngineSupport{constructor(e={}){super(e)}createWidget(e){return new de(this,e)}}const ge=function(t,e={}){const n=new G;return t.modules&&t.modules.forEach(o=>{n.registModule(o)}),t.plugins&&t.plugins.forEach(o=>{n.install(o)}),t.strategy&&t.strategy.forEach(o=>{n.exec(o)}),t.wdigets&&t.wdigets.forEach(o=>{n.createWidget(o)}),n};function I(t,e,n){let o;try{o=n?t(...n):t()}catch(r){console.error(r)}return o}function N(t,e,n){if(d.isFunction(t)){const r=I(t,e,n);return r&&d.isPromise(r)&&r.catch(i=>{console.error(i)}),r}const o=[];for(let r=0;r<t.length;r++)o.push(N(t[r],e,n));return o}function me(t,e){return Z(t,null,e)}const W={};function ye(t,e,n){return Z(t,e,n)}function Z(t,e,{immediate:n,deep:o,flush:r,onTrack:i,onTrigger:s}=d.EMPTY_OBJ){var x;const f=h.getCurrentScope()===((x=m.currentComponent)==null?void 0:x.scope)?m.currentComponent:null;let c,y=!1,O=!1;if(h.isRef(t)?(c=()=>t.value,y=h.isShallow(t)):h.isReactive(t)?(c=()=>t,o=!0):d.isArray(t)?(O=!0,y=t.some(a=>h.isReactive(a)||h.isShallow(a)),c=()=>t.map(a=>{if(h.isRef(a))return a.value;if(h.isReactive(a))return T(a);if(d.isFunction(a))return I(a)})):d.isFunction(t)?e?c=()=>I(t):c=()=>{if(!(f&&!f.isMounted))return p&&p(),N(t,f)}:c=d.NOOP,e&&o){const a=c;c=()=>T(a())}let p,ve=a=>{p=E.onStop=()=>{I(a),p=E.onStop=void 0}},P=O?new Array(t.length).fill(W):W;const M=()=>{if(!!E.active)if(e){const a=E.run();(o||y||(O?a.some((Ee,we)=>d.hasChanged(Ee,P[we])):d.hasChanged(a,P)))&&(p&&p(),N(e,f,[a,P===W?void 0:O&&P[0]===W?[]:P,ve]),P=a)}else E.run()};M.allowRecurse=!!e;let A;r==="sync"?A=M:r==="post"?A=()=>J(M):(M.pre=!0,f&&(M.id=f.cid),A=()=>D(M));const E=new h.ReactiveEffect(c,A);return e?n?M():P=E.run():r==="post"?J(E.run.bind(E)):E.run(),()=>{E.stop(),f&&f.scope&&d.remove(f.scope.effects,E)}}function T(t,e){if(!d.isObject(t)||t.__v_skip||(e=e||new Set,e.has(t)))return t;if(e.add(t),h.isRef(t))T(t.value,e);else if(d.isArray(t))for(let n=0;n<t.length;n++)T(t[n],e);else if(d.isSet(t)||d.isMap(t))t.forEach(n=>{T(n,e)});else if(d.isPlainObject(t))for(const n in t)T(t[n],e);return t}Object.defineProperty(u,"computed",{enumerable:!0,get:function(){return h.computed}}),Object.defineProperty(u,"reactive",{enumerable:!0,get:function(){return h.reactive}}),Object.defineProperty(u,"ref",{enumerable:!0,get:function(){return h.ref}}),Object.defineProperty(u,"shallowReactive",{enumerable:!0,get:function(){return h.shallowReactive}}),Object.defineProperty(u,"shallowReadonly",{enumerable:!0,get:function(){return h.shallowReadonly}}),Object.defineProperty(u,"shallowRef",{enumerable:!0,get:function(){return h.shallowRef}}),Object.defineProperty(u,"toRef",{enumerable:!0,get:function(){return h.toRef}}),Object.defineProperty(u,"toRefs",{enumerable:!0,get:function(){return h.toRefs}}),u.EngineWidget=G,u.defineComponent=ue,u.defineEngineWidget=ge,u.h=ee,u.onMounted=oe,u.vfor=ne,u.vif=te,u.watch=ye,u.watchEffect=me,Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
