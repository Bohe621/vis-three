(function(f,g){typeof exports=="object"&&typeof module!="undefined"?g(exports,require("@vis-three/middleware"),require("@vis-three/utils"),require("@vue/reactivity"),require("@vis-three/core"),require("@vue/shared")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","@vis-three/utils","@vue/reactivity","@vis-three/core","@vue/shared"],g):(f=typeof globalThis!="undefined"?globalThis:f||self,g((f["vis-three"]=f["vis-three"]||{},f["vis-three"].widget={}),f.middleware,f.utils,f.reactivity,f.core,f.shared))})(this,function(f,g,z,h,Q,d){"use strict";const X="0.6.0",$=function(t,e=null,n={}){return{_isVNode:!0,type:t,props:e,config:null,component:null,el:null,key:n.key||null,ref:n.ref||null,children:null}},b=function(t){return typeof t=="object"?Boolean(t._isVNode):!1},F=function(t){return/^on[A-Z]/.test(t)},V=function(t){const e=t.props,n={};for(const o in e)F(o)&&(n[o]=e[o]);return n};var q=(t=>(t.STATIC="static",t.VIF="vif",t.VFOR="vfor",t))(q||{});const l=function(t,e=null){const n=$(t,e,{key:e&&e.key||null,ref:e&&e.ref||null});return l.add(n),n};l.reset=function(){l.el=null,l.scope="static",l.vnodes=[]},l.add=function(t){if(t.el=l.el,l.scope!=="static"){const e=l.vnodes[l.vnodes.length-1];l.scope==="vfor"&&(t.key||(t.key=e.vnodes.length),e.keyMap.set(t.key,t)),e.vnodes.push(t)}else l.vnodes.push(t);return l.vnodes};const ee=function(t,e=null){return l(t,e)},te=function(t){l.scope="vif",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),t(),l.scope="static"},ne=function(t){l.scope="vfor",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),t(),l.scope="static"};var D=(t=>(t.MOUNTED="mounted",t.BEFORE_DISTORY="beforeDistory",t.UPDATE="update",t))(D||{});const oe=function(t=()=>{}){m.currentComponent&&m.currentComponent.on("mounted",e=>t())};let I=!1,J=!1;const v=[];let C=0;const T=[];let w=null,S=0;const se=Promise.resolve();function re(t){let e=C+1,n=v.length;for(;e<n;){const o=e+n>>>1,r=v[o],c=j(r);c<t||c===t&&r.pre?e=o+1:n=o}return e}function _(t){(!v.length||!v.includes(t,I&&t.allowRecurse?C+1:C))&&(t.id==null?v.push(t):v.splice(re(t.id),0,t),Y())}function Y(){!I&&!J&&(J=!0,se.then(K))}function L(t){Array.isArray(t)?T.push(...t):(!w||!w.includes(t,t.allowRecurse?S+1:S))&&T.push(t),Y()}function ie(){if(T.length){const t=[...new Set(T)];if(T.length=0,w){w.push(...t);return}for(w=t,w.sort((e,n)=>j(e)-j(n)),S=0;S<w.length;S++)w[S]();w=null,S=0}}const j=t=>t.id==null?1/0:t.id,ce=(t,e)=>{const n=j(t)-j(e);if(n===0){if(t.pre&&!e.pre)return-1;if(e.pre&&!t.pre)return 1}return n};function K(){J=!1,I=!0,v.sort(ce);try{for(C=0;C<v.length;C++){const t=v[C];if(t&&t.active!==!1)try{t()}catch(e){console.error(e)}}}finally{C=0,v.length=0,ie(),I=!1,(v.length||T.length)&&K()}}const k=Symbol.for("vis.widget.event"),ue=function(t){const e=function(n){e.value(n)};return e.value=t,e},G=/Once$/;function N(t){let e={};if(G.test(t)){e={};let o;for(;o=t.match(G);)t=t.slice(0,t.length-o[0].length),e[o[0].toLowerCase()]=!0}return[t.slice(2).toLowerCase(),e]}const fe=function(t,e,n){if(e[k]){console.error("config has already create events",e);return}const o=V(t);for(const r in o){o[r]=ue(o[r]);const[c,s]=N(r);n.addEventListener(c,o[r])}e[k]=o},le=function(t){const e=t.props,n=t.config;if(!n[k])return;const o=n[k];for(const r in o){const c=o[r];c&&c.value!==e[r]&&(c.value=e[r])}},pe=function(t,e){const n=t.config;if(!n[k])return;const o=n[k];for(const r in o){const c=o[r];if(c){const[s,u]=N(r);e.removeEventListener(s,c)}}n[k]=void 0};class m extends Q.EventDispatcher{constructor(e,n){super(),this.cid=g.createSymbol(),this.name="",this.el="",this.isMounted=!1,this.props=h.shallowReactive(Object.create(Object.prototype)),this.scope=new h.EffectScope(!0),this.subTree=null,this.cacheResources=Object.create(Object.prototype),this.resourcesKeyEnum=Object.create(Object.prototype),this.vnode=e;const o=e.type;o.name&&(this.name=o.name),this.el=o.el,this.options=o,this.renderer=n,this.engine=n.engine,this.ctx=n.context,this.createProps(),this.createSetup(),this.createResources(),this.createRender(),this.createEffect()}static setCurrentComponent(e){m.currentComponent=e,e.scope.on()}static unsetCurrentComponent(){m.currentComponent&&m.currentComponent.scope.off(),m.currentComponent=null}renderTree(){return l.reset(),l.el=this.el,this.render.call({...this.setupState,...this.props},{components:this.options.components||{},resources:this.resourcesKeyEnum}),l.vnodes}createResources(){if(!this.options.resources)return;const e=this.options.resources.call(this.setupState);this.engine.registerResources(e),this.cacheResources=e;for(const n in e)this.resourcesKeyEnum[n]=n}createProps(){const e=this.options.props||{},n=this.vnode.props||{},o=this.props,r=this.options.emits||{},c={};for(const s in n)if(F(s)){const[u,i]=N(s);r[u]?this[i.once?"once":"on"](u,n[s]):console.warn(`widget Component: you not declare attribute  ${s}  in emits options`,this.options)}else c[s]=n[s];for(const s in e){const u=e[s];if(u.required&&typeof c[s]=="undefined"){console.error("widget component: component prop is required.",{component:this,props:c,key:s});return}let i;if(typeof c[s]!="undefined"?i=c[s]:u.default&&(i=typeof u.default=="function"?u.default():u.default),i.constructor!==u.type){console.error("widget component: component prop is not instance of type.",{component:this,props:c,key:s,value:i,type:u.type});return}o[s]=i}}createSetup(){if(!this.options.setup)return;m.setCurrentComponent(this);const e=this.options.setup({engine:this.engine,props:this.props,emit:this.emit.bind(this)});this.setupState=h.proxyRefs(e),this.rawSetupState=e,m.unsetCurrentComponent()}createRender(){this.render=this.options.render}createEffect(){const e=new h.ReactiveEffect(()=>{if(this.isMounted){const o=this.renderTree(),r=this.subTree;if(r.length!==o.length){console.error("widget component render: tree render error",{nextTree:o,prevTree:r});return}for(let c=0;c<o.length;c+=1)if(b(r[c])&&b(o[c]))this.renderer.patch(r[c],o[c]);else{const s=o[c],u=r[c];if(s.scope!==u.scope){console.error("widget component render: tree render error",{nextTree:o,prevTree:r});return}if(s.scope===q.VIF){for(const i of u.vnodes)this.renderer.unmountElement(i);for(const i of s.vnodes)this.renderer.mountElement(i)}else if(s.scope===q.VFOR){for(const i of s.keyMap.keys())u.keyMap.has(i)?(this.renderer.patch(u.keyMap.get(i),s.keyMap.get(i)),u.keyMap.delete(i)):this.renderer.mountElement(s.keyMap.get(i));for(const i of u.keyMap.values())this.renderer.unmountElement(i)}else console.warn(`widget component render: unknow scope type: ${s.scope}`)}this.subTree=o}else{const o=this.rawSetupState,r=s=>{!s.ref||typeof o[s.ref]!="undefined"&&(o[s.ref].value=s.component?s.component:s.config||null)},c=this.subTree=this.renderTree();for(const s of c)if(b(s))this.renderer.patch(null,s),r(s);else for(const u of s.vnodes)this.renderer.patch(null,u),r(u);this.isMounted=!0,L(()=>this.emit(D.MOUNTED))}},()=>_(n),this.scope),n=()=>e.run();n(),this.effect=e,this.update=n}distory(){this.emit(D.BEFORE_DISTORY),this.scope.stop(),this.effect.active=!1,this.effect.stop();const e=this.subTree||[];for(let n=0;n<e.length;n+=1)if(b(e[n]))this.renderer.patch(e[n],null),e[n].config=null;else for(const o of e[n].vnodes)this.renderer.patch(o,null),o.config=null}updateProps(e){const n=this.props;for(const o in e)n[o]=e[o]}getState(e=!0){return e?this.rawSetupState:this.setupState}}const he=function(t){return t};class ae{constructor(e){this.context=e,this.engine=e.engine}log(e,n,o){n?console[e](`Widget renderer: ${n}`,o):console.info(`Widget renderer: ${e}`)}patch(e,n){if(!e&&!n){console.error("widget renderer: patch prarams all of null");return}e!==n&&(n&&typeof n.type=="string"||e&&typeof e.type=="string"?this.processElement(e,n):this.processComponent(e,n))}render(e){this.patch(null,e)}processElement(e,n){if(!e&&!n){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountElement(n):n===null?this.unmountElement(e):this.patchElement(e,n)}unmountElement(e){if(g.isObjectType(e.type)){if(e.config.parent){const o=this.engine.getConfigfromModules(g.OBJECTMODULE,e.config.parent);if(!o){console.error("widget renderer: can not found parent config with: ",e);return}o.children.splice(o.children.indexOf(e.config.vid),1)}else if(!e.el){const o=this.engine.getObjectBySymbol(e.config.vid);o||console.error("widget renderer: can not found Three object with: ",e),o.removeFromParent()}const n=this.engine.getObjectBySymbol(e.config.vid);pe(e,n)}this.engine.removeConfigBySymbol(e.config.vid)}mountElement(e){const{element:n,onProps:o}=this.createElement(e);if(this.engine.applyConfig(n),g.isObjectType(n.type)){if(!e.el)this.engine.scene.add(this.engine.getObjectfromModules(g.OBJECTMODULE,n.vid));else{const c=this.engine.getConfigfromModules(g.OBJECTMODULE,e.el);if(!c){console.error(`widget renderer: can not found parent config with: ${e.el}`);return}c.children.push(n.vid)}const r=this.engine.getObjectBySymbol(n.vid);fe(e,n,r)}}patchElement(e,n){if(e.type!==n.type)this.unmountElement(e),this.mountElement(n);else{n.config=e.config;const o=e.config;o||console.error("widget renderer: can not found  config with: ",e);let r={};const c=n.props;let s=!1;for(const i in e.props){if(F(i)){s=!0;continue}r[i]=e.props[i]}const u=(i,y,O)=>{for(const p in i)b(i[p])?b(y[p])&&y[p].config.vid!==i[p].config.vid?O[p]=y[p].config.vid:b(y[p])||(O[p]=y[p]):z.isObject(i[p])?u(i[p],y[p],O[p]):y[p]!==i[p]&&(O[p]=y[p])};u(r,c,o),s&&le(n)}}createElement(e){const n=e.props,o={},r={};for(const s in n)["ref","index"].includes(s)||(F(s)?r[s]=n[s]:b(n[s])?o[s]=n[s].config.vid:o[s]=n[s]);const c=g.generateConfig(e.type,o,{strict:!1,warn:!1});return e.config=c,{element:c,onProps:r}}processComponent(e,n){if(!e&&!n){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountComponent(n):n===null?this.unmountComponent(e):this.patchComponent(e,n)}mountComponent(e){e.component=new m(e,this)}unmountComponent(e){var n;(n=e.component)==null||n.distory(),e.component=null}patchComponent(e,n){const o=e.component;n.component=o,o.vnode=n;const r=e.props||{},c=n.props||{},s={};let u=!1;for(const i in c)c[i]!==r[i]&&(s[i]=c[i],u=!0);u&&(o.updateProps(s),o.update())}}class de{constructor(e,n){this.wid=g.createSymbol(),this.version=X,this.components={},this.instance=null,this.engine=e,this.root=n,this.renderer=new ae(this)}component(e,n){if(typeof e=="object"){if(n=e,!n.name){console.error("widget register component must be provide a name",n);return}e=n.name}if(!n){console.error("widget register component must be provide a component not a null",e);return}if(this.components[e]){console.warn(`A component with this name already exists: ${e}`);return}this.components[e]=n}mount(){const e=$(this.root);return this.renderer.render(e),this.instance=e.component,this}getState(){var e;return(e=this.instance)==null?void 0:e.getState(!0)}unmount(){var e;(e=this.instance)==null||e.distory()}use(){}}class H extends g.EngineSupport{constructor(e={}){super(e)}createWidget(e){return new de(this,e)}}const ge=function(t,e={}){const n=new H;return t.modules&&t.modules.forEach(o=>{n.registModule(o)}),t.plugins&&t.plugins.forEach(o=>{n.install(o)}),t.strategy&&t.strategy.forEach(o=>{n.exec(o)}),t.wdigets&&t.wdigets.forEach(o=>{n.createWidget(o)}),n};function A(t,e,n){let o;try{o=n?t(...n):t()}catch(r){console.error(r)}return o}function U(t,e,n){if(d.isFunction(t)){const r=A(t,e,n);return r&&d.isPromise(r)&&r.catch(c=>{console.error(c)}),r}const o=[];for(let r=0;r<t.length;r++)o.push(U(t[r],e,n));return o}function me(t,e){return Z(t,null,e)}const W={};function ye(t,e,n){return Z(t,e,n)}function Z(t,e,{immediate:n,deep:o,flush:r,onTrack:c,onTrigger:s}=d.EMPTY_OBJ){var x;const u=h.getCurrentScope()===((x=m.currentComponent)==null?void 0:x.scope)?m.currentComponent:null;let i,y=!1,O=!1;if(h.isRef(t)?(i=()=>t.value,y=h.isShallow(t)):h.isReactive(t)?(i=()=>t,o=!0):d.isArray(t)?(O=!0,y=t.some(a=>h.isReactive(a)||h.isShallow(a)),i=()=>t.map(a=>{if(h.isRef(a))return a.value;if(h.isReactive(a))return M(a);if(d.isFunction(a))return A(a)})):d.isFunction(t)?e?i=()=>A(t):i=()=>{if(!(u&&!u.isMounted))return p&&p(),U(t,u)}:i=d.NOOP,e&&o){const a=i;i=()=>M(a())}let p,ve=a=>{p=E.onStop=()=>{A(a),p=E.onStop=void 0}},R=O?new Array(t.length).fill(W):W;const P=()=>{if(!!E.active)if(e){const a=E.run();(o||y||(O?a.some((Ee,we)=>d.hasChanged(Ee,R[we])):d.hasChanged(a,R)))&&(p&&p(),U(e,u,[a,R===W?void 0:O&&R[0]===W?[]:R,ve]),R=a)}else E.run()};P.allowRecurse=!!e;let B;r==="sync"?B=P:r==="post"?B=()=>L(P):(P.pre=!0,u&&(P.id=u.cid),B=()=>_(P));const E=new h.ReactiveEffect(i,B);return e?n?P():R=E.run():r==="post"?L(E.run.bind(E)):E.run(),()=>{E.stop(),u&&u.scope&&d.remove(u.scope.effects,E)}}function M(t,e){if(!d.isObject(t)||t.__v_skip||(e=e||new Set,e.has(t)))return t;if(e.add(t),h.isRef(t))M(t.value,e);else if(d.isArray(t))for(let n=0;n<t.length;n++)M(t[n],e);else if(d.isSet(t)||d.isMap(t))t.forEach(n=>{M(n,e)});else if(d.isPlainObject(t))for(const n in t)M(t[n],e);return t}Object.defineProperty(f,"computed",{enumerable:!0,get:function(){return h.computed}}),Object.defineProperty(f,"reactive",{enumerable:!0,get:function(){return h.reactive}}),Object.defineProperty(f,"ref",{enumerable:!0,get:function(){return h.ref}}),Object.defineProperty(f,"shallowReactive",{enumerable:!0,get:function(){return h.shallowReactive}}),Object.defineProperty(f,"shallowReadonly",{enumerable:!0,get:function(){return h.shallowReadonly}}),Object.defineProperty(f,"shallowRef",{enumerable:!0,get:function(){return h.shallowRef}}),Object.defineProperty(f,"toRef",{enumerable:!0,get:function(){return h.toRef}}),Object.defineProperty(f,"toRefs",{enumerable:!0,get:function(){return h.toRefs}}),f.EngineWidget=H,f.defineComponent=he,f.defineEngineWidget=ge,f.h=ee,f.onMounted=oe,f.vfor=ne,f.vif=te,f.watch=ye,f.watchEffect=me,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
