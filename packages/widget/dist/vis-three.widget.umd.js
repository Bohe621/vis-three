(function(i,a){typeof exports=="object"&&typeof module!="undefined"?a(exports,require("@vis-three/middleware"),require("@vis-three/utils"),require("@vue/reactivity"),require("@vis-three/core")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","@vis-three/utils","@vue/reactivity","@vis-three/core"],a):(i=typeof globalThis!="undefined"?globalThis:i||self,a((i["vis-three"]=i["vis-three"]||{},i["vis-three"].widget={}),i.middleware,i.utils,i.reactivity,i.core))})(this,function(i,a,O,h,V){"use strict";var Te=Object.defineProperty;var Pe=(i,a,O)=>a in i?Te(i,a,{enumerable:!0,configurable:!0,writable:!0,value:O}):i[a]=O;var f=(i,a,O)=>(Pe(i,typeof a!="symbol"?a+"":a,O),O);const ee="0.6.0",D=function(e,t=null){return{_isVNode:!0,type:e,props:t,config:null,component:null,el:null,key:null,ref:null,children:null}},S=function(e){return typeof e=="object"?Boolean(e._isVNode):!1};var B=(e=>(e.STATIC="static",e.VIF="vif",e.VFOR="vfor",e))(B||{});const l=function(e,t=null){const n=D(e,t);return l.add(n),n};l.reset=function(){l.el=null,l.scope="static",l.vnodes=[]},l.add=function(e){if(e.el=l.el,l.scope!=="static"){const t=l.vnodes[l.vnodes.length-1];l.scope==="vfor"&&(e.key||(e.key=t.vnodes.length),t.keyMap.set(e.key,e)),t.vnodes.push(e)}else l.vnodes.push(e);return l.vnodes};const te=function(e,t=null){return l(e,t)},ne=function(e){l.scope="vif",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),e(),l.scope="static"},re=function(e){l.scope="vfor",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),e(),l.scope="static"};var H=(e=>(e.MOUNTED="mounted",e))(H||{});const oe=function(e=()=>{}){b.currentComponent&&b.currentComponent.on("mounted",t=>e())};let W=!1,U=!1;const y=[];let C=0;const j=[];let w=null,M=0;const se=Promise.resolve();function ie(e){let t=C+1,n=y.length;for(;t<n;){const r=t+n>>>1,o=y[r],s=F(o);s<e||s===e&&o.pre?t=r+1:n=r}return t}function _(e){(!y.length||!y.includes(e,W&&e.allowRecurse?C+1:C))&&(e.id==null?y.push(e):y.splice(ie(e.id),0,e),x())}function x(){!W&&!U&&(U=!0,se.then(G))}function N(e){Array.isArray(e)?j.push(...e):(!w||!w.includes(e,e.allowRecurse?M+1:M))&&j.push(e),x()}function ce(){if(j.length){const e=[...new Set(j)];if(j.length=0,w){w.push(...e);return}for(w=e,w.sort((t,n)=>F(t)-F(n)),M=0;M<w.length;M++)w[M]();w=null,M=0}}const F=e=>e.id==null?1/0:e.id,ue=(e,t)=>{const n=F(e)-F(t);if(n===0){if(e.pre&&!t.pre)return-1;if(t.pre&&!e.pre)return 1}return n};function G(){U=!1,W=!0,y.sort(ue);try{for(C=0;C<y.length;C++){const e=y[C];if(e&&e.active!==!1)try{e()}catch(t){console.error(t)}}}finally{C=0,y.length=0,ce(),W=!1,(y.length||j.length)&&G()}}const v=class extends V.EventDispatcher{constructor(n,r){super();f(this,"cid",a.createSymbol());f(this,"name","");f(this,"vnode");f(this,"options");f(this,"el","");f(this,"render");f(this,"engine");f(this,"renderer");f(this,"isMounted",!1);f(this,"props",h.shallowReactive(Object.create(Object.prototype)));f(this,"setupState");f(this,"rawSetupState");f(this,"effect");f(this,"scope",new h.EffectScope(!0));f(this,"update");f(this,"subTree",null);f(this,"ctx");this.vnode=n;const o=n.type;o.name&&(this.name=o.name),this.el=o.el,this.options=o,this.renderer=r,this.engine=r.engine,this.ctx=r.context,this.createProps(),this.createSetup(),this.createRender(),this.createEffect()}static setCurrentComponent(n){v.currentComponent=n,n.scope.on()}static unsetCurrentComponent(){v.currentComponent&&v.currentComponent.scope.off(),v.currentComponent=null}renderTree(){return l.reset(),l.el=this.el,this.render.call({...this.setupState,...this.props}),l.vnodes}createProps(){const n=this.options.props||{},r=this.props,o=this.vnode.props||{};for(const s in n){const p=n[s];if(p.required&&typeof o[s]=="undefined"){console.error("widget component: component prop is required.",{component:this,props:o,key:s});return}let c;if(typeof o[s]!="undefined"?c=o[s]:p.default&&(c=typeof p.default=="function"?p.default():p.default),c.constructor!==p.type){console.error("widget component: component prop is not instance of type.",{component:this,props:o,key:s,value:c,type:p.type});return}r[s]=c}}createSetup(){v.setCurrentComponent(this);const n=this.options.setup(this.props);this.setupState=h.proxyRefs(n),this.rawSetupState=n,v.unsetCurrentComponent()}createRender(){this.render=this.options.render}createEffect(){const n=new h.ReactiveEffect(()=>{if(this.isMounted){const o=this.renderTree(),s=this.subTree;if(s.length!==o.length){console.error("widget component render: tree render error",{nextTree:o,prevTree:s});return}for(let p=0;p<o.length;p+=1)if(S(s[p])&&S(o[p]))this.renderer.patch(s[p],o[p]);else{const c=o[p],u=s[p];if(c.scope!==u.scope){console.error("widget component render: tree render error",{nextTree:o,prevTree:s});return}if(c.scope===B.VIF){for(const g of u.vnodes)this.renderer.unmountElement(g);for(const g of c.vnodes)this.renderer.mountElement(g)}else if(c.scope===B.VFOR){for(const g of c.keyMap.keys())u.keyMap.has(g)?(this.renderer.patch(u.keyMap.get(g),c.keyMap.get(g)),u.keyMap.delete(g)):this.renderer.mountElement(c.keyMap.get(g));for(const g of u.keyMap.values())this.renderer.unmountElement(g)}else console.warn(`widget component render: unknow scope type: ${c.scope}`)}this.subTree=o}else{const o=this.subTree=this.renderTree();for(const s of o)if(S(s))this.renderer.patch(null,s);else for(const p of s.vnodes)this.renderer.patch(null,p);this.isMounted=!0,N(()=>this.emit(H.MOUNTED))}},()=>_(r),this.scope),r=()=>n.run();r(),this.effect=n,this.update=r}updateProps(n){const r=this.props;for(const o in n)r[o]=n[o]}getState(n=!1){return n?this.rawSetupState:this.setupState}};let b=v;f(b,"currentComponent");const fe=function(e){return e};class le{constructor(t){f(this,"engine");f(this,"context");this.context=t,this.engine=t.engine}log(t,n,r){n?console[t](`Widget renderer: ${n}`,r):console.info(`Widget renderer: ${t}`)}patch(t,n){if(!t&&!n){console.error("widget renderer: patch prarams all of null");return}t!==n&&(n&&typeof n.type=="string"||t&&typeof t.type=="string"?this.processElement(t,n):this.processComponent(t,n))}render(t){this.patch(null,t)}processElement(t,n){if(!t&&!n){console.error("widget renderer: processElement prarams all of null");return}t===null?this.mountElement(n):n===null?this.unmountElement(t):this.patchElement(t,n)}unmountElement(t){if(a.isObjectType(t.type)){if(t.config.parent){const n=this.engine.getConfigfromModules(a.OBJECTMODULE,t.config.parent);if(!n){console.error("widget renderer: can not found parent config with: ",t);return}n.children.splice(n.children.indexOf(t.config.vid),1)}else if(!t.el){const n=this.engine.getObjectBySymbol(t.config.vid);n||console.error("widget renderer: can not found Three object with: ",t),n.removeFromParent()}}this.engine.removeConfigBySymbol(t.config.vid)}mountElement(t){const n=this.createElement(t);if(this.engine.applyConfig(n),a.isObjectType(n.type))if(!t.el)this.engine.scene.add(this.engine.getObjectfromModules(a.OBJECTMODULE,n.vid));else{const r=this.engine.getConfigfromModules(a.OBJECTMODULE,t.el);if(!r){console.error(`widget renderer: can not found parent config with: ${t.el}`);return}r.children.push(n.vid)}}patchElement(t,n){if(t.type!==n.type)this.unmountElement(t),this.mountElement(n);else{n.config=t.config;const r=t.props,o=n.props,s=t.config;s||console.error("widget renderer: can not found  config with: ",t);const p=(c,u,g)=>{for(const d in c)S(c[d])?S(u[d])&&u[d].config.vid!==c[d].config.vid?g[d]=u[d].config.vid:S(u[d])||(g[d]=u[d]):O.isObject(c[d])?p(c[d],u[d],g[d]):u[d]!==c[d]&&(g[d]=u[d])};p(r,o,s)}}createElement(t){const n=t.props,r={};for(const s in n)S(n[s])?r[s]=n[s].config.vid:r[s]=n[s];const o=a.generateConfig(t.type,r,{strict:!1,warn:!1});return t.config=o,o}processComponent(t,n){if(!t&&!n){console.error("widget renderer: processElement prarams all of null");return}t===null?this.mountComponent(n):n===null?this.unmountComponent(t):this.patchComponent(t,n)}mountComponent(t){t.component=new b(t,this)}unmountComponent(t){}patchComponent(t,n){const r=t.component;n.component=r,r.vnode=n;const o=t.props||{},s=n.props||{},p={};let c=!1;for(const u in s)s[u]!==o[u]&&(p[u]=s[u],c=!0);c&&(r.updateProps(p),r.update())}}class pe{constructor(t,n){f(this,"wid",a.createSymbol());f(this,"version",ee);f(this,"components",{});f(this,"renderer");f(this,"root");f(this,"instance",null);f(this,"engine");this.engine=t,this.root=n,this.renderer=new le(this)}component(t,n){if(typeof t=="object"){if(n=t,!n.name){console.error("widget register component must be provide a name",n);return}t=n.name}if(!n){console.error("widget register component must be provide a component not a null",t);return}if(this.components[t]){console.warn(`A component with this name already exists: ${t}`);return}this.components[t]=n}mount(){const t=D(this.root);return this.renderer.render(t),this.instance=t.component,this}getState(){var t;return(t=this.instance)==null?void 0:t.getState(!0)}unmount(){}use(){}}class Y extends a.EngineSupport{constructor(t={}){super(t)}createWidget(t){return new pe(this,t)}}const he=function(e,t={}){const n=new Y;return e.modules&&e.modules.forEach(r=>{n.registModule(r)}),e.plugins&&e.plugins.forEach(r=>{n.install(r)}),e.strategy&&e.strategy.forEach(r=>{n.exec(r)}),e.wdigets&&e.wdigets.forEach(r=>{n.createWidget(r)}),n},de={},ae=()=>{},ge=(e,t)=>{const n=e.indexOf(t);n>-1&&e.splice(n,1)},z=Array.isArray,me=e=>L(e)==="[object Map]",ye=e=>L(e)==="[object Set]",I=e=>typeof e=="function",K=e=>e!==null&&typeof e=="object",Ee=e=>K(e)&&I(e.then)&&I(e.catch),we=Object.prototype.toString,L=e=>we.call(e),Ce=e=>L(e)==="[object Object]",Q=(e,t)=>!Object.is(e,t);function A(e,t,n){let r;try{r=n?e(...n):e()}catch(o){console.error(o)}return r}function $(e,t,n){if(I(e)){const o=A(e,t,n);return o&&Ee(o)&&o.catch(s=>{console.error(s)}),o}const r=[];for(let o=0;o<e.length;o++)r.push($(e[o],t,n));return r}function be(e,t){return X(e,null,t)}const q={};function ve(e,t,n){return X(e,t,n)}function X(e,t,{immediate:n,deep:r,flush:o,onTrack:s,onTrigger:p}=de){var Z;const c=h.getCurrentScope()===((Z=b.currentComponent)==null?void 0:Z.scope)?b.currentComponent:null;let u,g=!1,d=!1;if(h.isRef(e)?(u=()=>e.value,g=h.isShallow(e)):h.isReactive(e)?(u=()=>e,r=!0):z(e)?(d=!0,g=e.some(m=>h.isReactive(m)||h.isShallow(m)),u=()=>e.map(m=>{if(h.isRef(m))return m.value;if(h.isReactive(m))return R(m);if(I(m))return A(m)})):I(e)?t?u=()=>A(e):u=()=>{if(!(c&&!c.isMounted))return k&&k(),$(e,c)}:u=ae,t&&r){const m=u;u=()=>R(m())}let k,Oe=m=>{k=E.onStop=()=>{A(m),k=E.onStop=void 0}},T=d?new Array(e.length).fill(q):q;const P=()=>{if(!!E.active)if(t){const m=E.run();(r||g||(d?m.some((Se,Me)=>Q(Se,T[Me])):Q(m,T)))&&(k&&k(),$(t,c,[m,T===q?void 0:d&&T[0]===q?[]:T,Oe]),T=m)}else E.run()};P.allowRecurse=!!t;let J;o==="sync"?J=P:o==="post"?J=()=>N(P):(P.pre=!0,c&&(P.id=c.cid),J=()=>_(P));const E=new h.ReactiveEffect(u,J);return t?n?P():T=E.run():o==="post"?N(E.run.bind(E)):E.run(),()=>{E.stop(),c&&c.scope&&ge(c.scope.effects,E)}}function R(e,t){if(!K(e)||e.__v_skip||(t=t||new Set,t.has(e)))return e;if(t.add(e),h.isRef(e))R(e.value,t);else if(z(e))for(let n=0;n<e.length;n++)R(e[n],t);else if(ye(e)||me(e))e.forEach(n=>{R(n,t)});else if(Ce(e))for(const n in e)R(e[n],t);return e}Object.defineProperty(i,"computed",{enumerable:!0,get:function(){return h.computed}}),Object.defineProperty(i,"reactive",{enumerable:!0,get:function(){return h.reactive}}),Object.defineProperty(i,"ref",{enumerable:!0,get:function(){return h.ref}}),Object.defineProperty(i,"shallowReactive",{enumerable:!0,get:function(){return h.shallowReactive}}),Object.defineProperty(i,"shallowReadonly",{enumerable:!0,get:function(){return h.shallowReadonly}}),Object.defineProperty(i,"shallowRef",{enumerable:!0,get:function(){return h.shallowRef}}),Object.defineProperty(i,"toRef",{enumerable:!0,get:function(){return h.toRef}}),Object.defineProperty(i,"toRefs",{enumerable:!0,get:function(){return h.toRefs}}),i.EngineWidget=Y,i.defineComponent=fe,i.defineEngineWidget=he,i.h=te,i.onMounted=oe,i.vfor=re,i.vif=ne,i.watch=ve,i.watchEffect=be,Object.defineProperties(i,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
