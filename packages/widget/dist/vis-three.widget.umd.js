(function(f,d){typeof exports=="object"&&typeof module!="undefined"?d(exports,require("@vis-three/middleware"),require("@vis-three/utils"),require("@vue/reactivity"),require("@vis-three/core")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","@vis-three/utils","@vue/reactivity","@vis-three/core"],d):(f=typeof globalThis!="undefined"?globalThis:f||self,d((f["vis-three"]=f["vis-three"]||{},f["vis-three"].widget={}),f.middleware,f.utils,f.reactivity,f.core))})(this,function(f,d,Q,p,X){"use strict";const Z="0.6.0",N=function(t,e=null,n={}){return{_isVNode:!0,type:t,props:e,config:null,component:null,el:null,key:n.key||null,ref:n.ref||null,children:null}},O=function(t){return typeof t=="object"?Boolean(t._isVNode):!1};var A=(t=>(t.STATIC="static",t.VIF="vif",t.VFOR="vfor",t))(A||{});const l=function(t,e=null){const n=N(t,e,{key:e&&e.key||null,ref:e&&e.ref||null});return l.add(n),n};l.reset=function(){l.el=null,l.scope="static",l.vnodes=[]},l.add=function(t){if(t.el=l.el,l.scope!=="static"){const e=l.vnodes[l.vnodes.length-1];l.scope==="vfor"&&(t.key||(t.key=e.vnodes.length),e.keyMap.set(t.key,t)),e.vnodes.push(t)}else l.vnodes.push(t);return l.vnodes};const V=function(t,e=null){return l(t,e)},ee=function(t){l.scope="vif",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),t(),l.scope="static"},te=function(t){l.scope="vfor",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),t(),l.scope="static"};var L=(t=>(t.MOUNTED="mounted",t))(L||{});const ne=function(t=()=>{}){g.currentComponent&&g.currentComponent.on("mounted",e=>t())};let P=!1,q=!1;const m=[];let b=0;const M=[];let E=null,C=0;const re=Promise.resolve();function se(t){let e=b+1,n=m.length;for(;e<n;){const r=e+n>>>1,s=m[r],o=j(s);o<t||o===t&&s.pre?e=r+1:n=r}return e}function $(t){(!m.length||!m.includes(t,P&&t.allowRecurse?b+1:b))&&(t.id==null?m.push(t):m.splice(se(t.id),0,t),D())}function D(){!P&&!q&&(q=!0,re.then(H))}function J(t){Array.isArray(t)?M.push(...t):(!E||!E.includes(t,t.allowRecurse?C+1:C))&&M.push(t),D()}function oe(){if(M.length){const t=[...new Set(M)];if(M.length=0,E){E.push(...t);return}for(E=t,E.sort((e,n)=>j(e)-j(n)),C=0;C<E.length;C++)E[C]();E=null,C=0}}const j=t=>t.id==null?1/0:t.id,ie=(t,e)=>{const n=j(t)-j(e);if(n===0){if(t.pre&&!e.pre)return-1;if(e.pre&&!t.pre)return 1}return n};function H(){q=!1,P=!0,m.sort(ie);try{for(b=0;b<m.length;b++){const t=m[b];if(t&&t.active!==!1)try{t()}catch(e){console.error(e)}}}finally{b=0,m.length=0,oe(),P=!1,(m.length||M.length)&&H()}}class g extends X.EventDispatcher{constructor(e,n){super(),this.cid=d.createSymbol(),this.name="",this.el="",this.isMounted=!1,this.props=p.shallowReactive(Object.create(Object.prototype)),this.scope=new p.EffectScope(!0),this.subTree=null,this.cacheResources=Object.create(Object.prototype),this.resourcesKeyEnum=Object.create(Object.prototype),this.vnode=e;const r=e.type;r.name&&(this.name=r.name),this.el=r.el,this.options=r,this.renderer=n,this.engine=n.engine,this.ctx=n.context,this.createProps(),this.createSetup(),this.createResources(),this.createRender(),this.createEffect()}static setCurrentComponent(e){g.currentComponent=e,e.scope.on()}static unsetCurrentComponent(){g.currentComponent&&g.currentComponent.scope.off(),g.currentComponent=null}renderTree(){return l.reset(),l.el=this.el,this.render.call({...this.setupState,...this.props},{components:this.options.components||{},resources:this.resourcesKeyEnum}),l.vnodes}createResources(){if(!this.options.resources)return;const e=this.options.resources.call(this.setupState);this.engine.registerResources(e),this.cacheResources=e;for(const n in e)this.resourcesKeyEnum[n]=n}createProps(){const e=this.options.props||{},n=this.props,r=this.vnode.props||{};for(const s in e){const o=e[s];if(o.required&&typeof r[s]=="undefined"){console.error("widget component: component prop is required.",{component:this,props:r,key:s});return}let c;if(typeof r[s]!="undefined"?c=r[s]:o.default&&(c=typeof o.default=="function"?o.default():o.default),c.constructor!==o.type){console.error("widget component: component prop is not instance of type.",{component:this,props:r,key:s,value:c,type:o.type});return}n[s]=c}}createSetup(){g.setCurrentComponent(this);const e=this.options.setup({engine:this.engine,props:this.props});this.setupState=p.proxyRefs(e),this.rawSetupState=e,g.unsetCurrentComponent()}createRender(){this.render=this.options.render}createEffect(){const e=new p.ReactiveEffect(()=>{if(this.isMounted){const r=this.renderTree(),s=this.subTree;if(s.length!==r.length){console.error("widget component render: tree render error",{nextTree:r,prevTree:s});return}for(let o=0;o<r.length;o+=1)if(O(s[o])&&O(r[o]))this.renderer.patch(s[o],r[o]);else{const c=r[o],u=s[o];if(c.scope!==u.scope){console.error("widget component render: tree render error",{nextTree:r,prevTree:s});return}if(c.scope===A.VIF){for(const i of u.vnodes)this.renderer.unmountElement(i);for(const i of c.vnodes)this.renderer.mountElement(i)}else if(c.scope===A.VFOR){for(const i of c.keyMap.keys())u.keyMap.has(i)?(this.renderer.patch(u.keyMap.get(i),c.keyMap.get(i)),u.keyMap.delete(i)):this.renderer.mountElement(c.keyMap.get(i));for(const i of u.keyMap.values())this.renderer.unmountElement(i)}else console.warn(`widget component render: unknow scope type: ${c.scope}`)}this.subTree=r}else{const r=this.rawSetupState,s=c=>{!c.ref||typeof r[c.ref]!="undefined"&&(r[c.ref].value=c.component?c.component:c.config||null)},o=this.subTree=this.renderTree();for(const c of o)if(O(c))this.renderer.patch(null,c),s(c);else for(const u of c.vnodes)this.renderer.patch(null,u),s(u);this.isMounted=!0,J(()=>this.emit(L.MOUNTED))}},()=>$(n),this.scope),n=()=>e.run();n(),this.effect=e,this.update=n}updateProps(e){const n=this.props;for(const r in e)n[r]=e[r]}getState(e=!0){return e?this.rawSetupState:this.setupState}}const ce=function(t){return t};class ue{constructor(e){this.context=e,this.engine=e.engine}log(e,n,r){n?console[e](`Widget renderer: ${n}`,r):console.info(`Widget renderer: ${e}`)}patch(e,n){if(!e&&!n){console.error("widget renderer: patch prarams all of null");return}e!==n&&(n&&typeof n.type=="string"||e&&typeof e.type=="string"?this.processElement(e,n):this.processComponent(e,n))}render(e){this.patch(null,e)}processElement(e,n){if(!e&&!n){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountElement(n):n===null?this.unmountElement(e):this.patchElement(e,n)}unmountElement(e){if(d.isObjectType(e.type)){if(e.config.parent){const n=this.engine.getConfigfromModules(d.OBJECTMODULE,e.config.parent);if(!n){console.error("widget renderer: can not found parent config with: ",e);return}n.children.splice(n.children.indexOf(e.config.vid),1)}else if(!e.el){const n=this.engine.getObjectBySymbol(e.config.vid);n||console.error("widget renderer: can not found Three object with: ",e),n.removeFromParent()}}this.engine.removeConfigBySymbol(e.config.vid)}mountElement(e){const n=this.createElement(e);if(this.engine.applyConfig(n),d.isObjectType(n.type))if(!e.el)this.engine.scene.add(this.engine.getObjectfromModules(d.OBJECTMODULE,n.vid));else{const r=this.engine.getConfigfromModules(d.OBJECTMODULE,e.el);if(!r){console.error(`widget renderer: can not found parent config with: ${e.el}`);return}r.children.push(n.vid)}}patchElement(e,n){if(e.type!==n.type)this.unmountElement(e),this.mountElement(n);else{n.config=e.config;const r=e.props,s=n.props,o=e.config;o||console.error("widget renderer: can not found  config with: ",e);const c=(u,i,w)=>{for(const h in u)O(u[h])?O(i[h])&&i[h].config.vid!==u[h].config.vid?w[h]=i[h].config.vid:O(i[h])||(w[h]=i[h]):Q.isObject(u[h])?c(u[h],i[h],w[h]):i[h]!==u[h]&&(w[h]=i[h])};c(r,s,o)}}createElement(e){const n=e.props,r={};for(const o in n)O(n[o])?r[o]=n[o].config.vid:r[o]=n[o];const s=d.generateConfig(e.type,r,{strict:!1,warn:!1});return e.config=s,s}processComponent(e,n){if(!e&&!n){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountComponent(n):n===null?this.unmountComponent(e):this.patchComponent(e,n)}mountComponent(e){e.component=new g(e,this)}unmountComponent(e){}patchComponent(e,n){const r=e.component;n.component=r,r.vnode=n;const s=e.props||{},o=n.props||{},c={};let u=!1;for(const i in o)o[i]!==s[i]&&(c[i]=o[i],u=!0);u&&(r.updateProps(c),r.update())}}class fe{constructor(e,n){this.wid=d.createSymbol(),this.version=Z,this.components={},this.instance=null,this.engine=e,this.root=n,this.renderer=new ue(this)}component(e,n){if(typeof e=="object"){if(n=e,!n.name){console.error("widget register component must be provide a name",n);return}e=n.name}if(!n){console.error("widget register component must be provide a component not a null",e);return}if(this.components[e]){console.warn(`A component with this name already exists: ${e}`);return}this.components[e]=n}mount(){const e=N(this.root);return this.renderer.render(e),this.instance=e.component,this}getState(){var e;return(e=this.instance)==null?void 0:e.getState(!0)}unmount(){}use(){}}class K extends d.EngineSupport{constructor(e={}){super(e)}createWidget(e){return new fe(this,e)}}const le=function(t,e={}){const n=new K;return t.modules&&t.modules.forEach(r=>{n.registModule(r)}),t.plugins&&t.plugins.forEach(r=>{n.install(r)}),t.strategy&&t.strategy.forEach(r=>{n.exec(r)}),t.wdigets&&t.wdigets.forEach(r=>{n.createWidget(r)}),n},pe={},he=()=>{},ae=(t,e)=>{const n=t.indexOf(e);n>-1&&t.splice(n,1)},_=Array.isArray,de=t=>B(t)==="[object Map]",ge=t=>B(t)==="[object Set]",k=t=>typeof t=="function",G=t=>t!==null&&typeof t=="object",me=t=>G(t)&&k(t.then)&&k(t.catch),ye=Object.prototype.toString,B=t=>ye.call(t),Ee=t=>B(t)==="[object Object]",Y=(t,e)=>!Object.is(t,e);function F(t,e,n){let r;try{r=n?t(...n):t()}catch(s){console.error(s)}return r}function U(t,e,n){if(k(t)){const s=F(t,e,n);return s&&me(s)&&s.catch(o=>{console.error(o)}),s}const r=[];for(let s=0;s<t.length;s++)r.push(U(t[s],e,n));return r}function be(t,e){return x(t,null,e)}const I={};function we(t,e,n){return x(t,e,n)}function x(t,e,{immediate:n,deep:r,flush:s,onTrack:o,onTrigger:c}=pe){var z;const u=p.getCurrentScope()===((z=g.currentComponent)==null?void 0:z.scope)?g.currentComponent:null;let i,w=!1,h=!1;if(p.isRef(t)?(i=()=>t.value,w=p.isShallow(t)):p.isReactive(t)?(i=()=>t,r=!0):_(t)?(h=!0,w=t.some(a=>p.isReactive(a)||p.isShallow(a)),i=()=>t.map(a=>{if(p.isRef(a))return a.value;if(p.isReactive(a))return R(a);if(k(a))return F(a)})):k(t)?e?i=()=>F(t):i=()=>{if(!(u&&!u.isMounted))return T&&T(),U(t,u)}:i=he,e&&r){const a=i;i=()=>R(a())}let T,Oe=a=>{T=y.onStop=()=>{F(a),T=y.onStop=void 0}},S=h?new Array(t.length).fill(I):I;const v=()=>{if(!!y.active)if(e){const a=y.run();(r||w||(h?a.some((Ce,Se)=>Y(Ce,S[Se])):Y(a,S)))&&(T&&T(),U(e,u,[a,S===I?void 0:h&&S[0]===I?[]:S,Oe]),S=a)}else y.run()};v.allowRecurse=!!e;let W;s==="sync"?W=v:s==="post"?W=()=>J(v):(v.pre=!0,u&&(v.id=u.cid),W=()=>$(v));const y=new p.ReactiveEffect(i,W);return e?n?v():S=y.run():s==="post"?J(y.run.bind(y)):y.run(),()=>{y.stop(),u&&u.scope&&ae(u.scope.effects,y)}}function R(t,e){if(!G(t)||t.__v_skip||(e=e||new Set,e.has(t)))return t;if(e.add(t),p.isRef(t))R(t.value,e);else if(_(t))for(let n=0;n<t.length;n++)R(t[n],e);else if(ge(t)||de(t))t.forEach(n=>{R(n,e)});else if(Ee(t))for(const n in t)R(t[n],e);return t}Object.defineProperty(f,"computed",{enumerable:!0,get:function(){return p.computed}}),Object.defineProperty(f,"reactive",{enumerable:!0,get:function(){return p.reactive}}),Object.defineProperty(f,"ref",{enumerable:!0,get:function(){return p.ref}}),Object.defineProperty(f,"shallowReactive",{enumerable:!0,get:function(){return p.shallowReactive}}),Object.defineProperty(f,"shallowReadonly",{enumerable:!0,get:function(){return p.shallowReadonly}}),Object.defineProperty(f,"shallowRef",{enumerable:!0,get:function(){return p.shallowRef}}),Object.defineProperty(f,"toRef",{enumerable:!0,get:function(){return p.toRef}}),Object.defineProperty(f,"toRefs",{enumerable:!0,get:function(){return p.toRefs}}),f.EngineWidget=K,f.defineComponent=ce,f.defineEngineWidget=le,f.h=V,f.onMounted=ne,f.vfor=te,f.vif=ee,f.watch=we,f.watchEffect=be,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
