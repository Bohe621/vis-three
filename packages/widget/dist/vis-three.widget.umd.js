(function(c,d){typeof exports=="object"&&typeof module!="undefined"?d(exports,require("@vis-three/middleware"),require("@vis-three/utils"),require("@vue/reactivity"),require("@vis-three/core")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","@vis-three/utils","@vue/reactivity","@vis-three/core"],d):(c=typeof globalThis!="undefined"?globalThis:c||self,d((c["vis-three"]=c["vis-three"]||{},c["vis-three"].widget={}),c.middleware,c.utils,c.reactivity,c.core))})(this,function(c,d,O,h,V){"use strict";var Te=Object.defineProperty;var ke=(c,d,O)=>d in c?Te(c,d,{enumerable:!0,configurable:!0,writable:!0,value:O}):c[d]=O;var f=(c,d,O)=>(ke(c,typeof d!="symbol"?d+"":d,O),O);const ee="0.6.0",D=function(e,t=null,n={}){return{_isVNode:!0,type:e,props:t,config:null,component:null,el:null,key:n.key||null,ref:n.ref||null,children:null}},v=function(e){return typeof e=="object"?Boolean(e._isVNode):!1};var B=(e=>(e.STATIC="static",e.VIF="vif",e.VFOR="vfor",e))(B||{});const l=function(e,t=null){const n=D(e,t,{key:t&&t.key||null,ref:t&&t.ref||null});return l.add(n),n};l.reset=function(){l.el=null,l.scope="static",l.vnodes=[]},l.add=function(e){if(e.el=l.el,l.scope!=="static"){const t=l.vnodes[l.vnodes.length-1];l.scope==="vfor"&&(e.key||(e.key=t.vnodes.length),t.keyMap.set(e.key,e)),t.vnodes.push(e)}else l.vnodes.push(e);return l.vnodes};const te=function(e,t=null){return l(e,t)},ne=function(e){l.scope="vif",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),e(),l.scope="static"},re=function(e){l.scope="vfor",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),e(),l.scope="static"};var H=(e=>(e.MOUNTED="mounted",e))(H||{});const oe=function(e=()=>{}){b.currentComponent&&b.currentComponent.on("mounted",t=>e())};let W=!1,U=!1;const y=[];let C=0;const P=[];let E=null,M=0;const se=Promise.resolve();function ie(e){let t=C+1,n=y.length;for(;t<n;){const o=t+n>>>1,r=y[o],i=F(r);i<e||i===e&&r.pre?t=o+1:n=o}return t}function _(e){(!y.length||!y.includes(e,W&&e.allowRecurse?C+1:C))&&(e.id==null?y.push(e):y.splice(ie(e.id),0,e),x())}function x(){!W&&!U&&(U=!0,se.then(G))}function N(e){Array.isArray(e)?P.push(...e):(!E||!E.includes(e,e.allowRecurse?M+1:M))&&P.push(e),x()}function ce(){if(P.length){const e=[...new Set(P)];if(P.length=0,E){E.push(...e);return}for(E=e,E.sort((t,n)=>F(t)-F(n)),M=0;M<E.length;M++)E[M]();E=null,M=0}}const F=e=>e.id==null?1/0:e.id,ue=(e,t)=>{const n=F(e)-F(t);if(n===0){if(e.pre&&!t.pre)return-1;if(t.pre&&!e.pre)return 1}return n};function G(){U=!1,W=!0,y.sort(ue);try{for(C=0;C<y.length;C++){const e=y[C];if(e&&e.active!==!1)try{e()}catch(t){console.error(t)}}}finally{C=0,y.length=0,ce(),W=!1,(y.length||P.length)&&G()}}const S=class extends V.EventDispatcher{constructor(n,o){super();f(this,"cid",d.createSymbol());f(this,"name","");f(this,"vnode");f(this,"options");f(this,"el","");f(this,"render");f(this,"engine");f(this,"renderer");f(this,"isMounted",!1);f(this,"props",h.shallowReactive(Object.create(Object.prototype)));f(this,"setupState");f(this,"rawSetupState");f(this,"effect");f(this,"scope",new h.EffectScope(!0));f(this,"update");f(this,"subTree",null);f(this,"ctx");this.vnode=n;const r=n.type;r.name&&(this.name=r.name),this.el=r.el,this.options=r,this.renderer=o,this.engine=o.engine,this.ctx=o.context,this.createProps(),this.createSetup(),this.createRender(),this.createEffect()}static setCurrentComponent(n){S.currentComponent=n,n.scope.on()}static unsetCurrentComponent(){S.currentComponent&&S.currentComponent.scope.off(),S.currentComponent=null}renderTree(){return l.reset(),l.el=this.el,this.render.call({...this.setupState,...this.props}),l.vnodes}createProps(){const n=this.options.props||{},o=this.props,r=this.vnode.props||{};for(const i in n){const p=n[i];if(p.required&&typeof r[i]=="undefined"){console.error("widget component: component prop is required.",{component:this,props:r,key:i});return}let s;if(typeof r[i]!="undefined"?s=r[i]:p.default&&(s=typeof p.default=="function"?p.default():p.default),s.constructor!==p.type){console.error("widget component: component prop is not instance of type.",{component:this,props:r,key:i,value:s,type:p.type});return}o[i]=s}}createSetup(){S.setCurrentComponent(this);const n=this.options.setup(this.props);this.setupState=h.proxyRefs(n),this.rawSetupState=n,S.unsetCurrentComponent()}createRender(){this.render=this.options.render}createEffect(){const n=new h.ReactiveEffect(()=>{if(this.isMounted){const r=this.renderTree(),i=this.subTree;if(i.length!==r.length){console.error("widget component render: tree render error",{nextTree:r,prevTree:i});return}for(let p=0;p<r.length;p+=1)if(v(i[p])&&v(r[p]))this.renderer.patch(i[p],r[p]);else{const s=r[p],u=i[p];if(s.scope!==u.scope){console.error("widget component render: tree render error",{nextTree:r,prevTree:i});return}if(s.scope===B.VIF){for(const g of u.vnodes)this.renderer.unmountElement(g);for(const g of s.vnodes)this.renderer.mountElement(g)}else if(s.scope===B.VFOR){for(const g of s.keyMap.keys())u.keyMap.has(g)?(this.renderer.patch(u.keyMap.get(g),s.keyMap.get(g)),u.keyMap.delete(g)):this.renderer.mountElement(s.keyMap.get(g));for(const g of u.keyMap.values())this.renderer.unmountElement(g)}else console.warn(`widget component render: unknow scope type: ${s.scope}`)}this.subTree=r}else{const r=this.rawSetupState,i=s=>{!s.ref||typeof r[s.ref]!="undefined"&&(r[s.ref].value=s.component?s.component:s.config||null)},p=this.subTree=this.renderTree();for(const s of p)if(v(s))this.renderer.patch(null,s),i(s);else for(const u of s.vnodes)this.renderer.patch(null,u),i(u);this.isMounted=!0,N(()=>this.emit(H.MOUNTED))}},()=>_(o),this.scope),o=()=>n.run();o(),this.effect=n,this.update=o}updateProps(n){const o=this.props;for(const r in n)o[r]=n[r]}getState(n=!0){return n?this.rawSetupState:this.setupState}};let b=S;f(b,"currentComponent");const fe=function(e){return e};class le{constructor(t){f(this,"engine");f(this,"context");this.context=t,this.engine=t.engine}log(t,n,o){n?console[t](`Widget renderer: ${n}`,o):console.info(`Widget renderer: ${t}`)}patch(t,n){if(!t&&!n){console.error("widget renderer: patch prarams all of null");return}t!==n&&(n&&typeof n.type=="string"||t&&typeof t.type=="string"?this.processElement(t,n):this.processComponent(t,n))}render(t){this.patch(null,t)}processElement(t,n){if(!t&&!n){console.error("widget renderer: processElement prarams all of null");return}t===null?this.mountElement(n):n===null?this.unmountElement(t):this.patchElement(t,n)}unmountElement(t){if(d.isObjectType(t.type)){if(t.config.parent){const n=this.engine.getConfigfromModules(d.OBJECTMODULE,t.config.parent);if(!n){console.error("widget renderer: can not found parent config with: ",t);return}n.children.splice(n.children.indexOf(t.config.vid),1)}else if(!t.el){const n=this.engine.getObjectBySymbol(t.config.vid);n||console.error("widget renderer: can not found Three object with: ",t),n.removeFromParent()}}this.engine.removeConfigBySymbol(t.config.vid)}mountElement(t){const n=this.createElement(t);if(this.engine.applyConfig(n),d.isObjectType(n.type))if(!t.el)this.engine.scene.add(this.engine.getObjectfromModules(d.OBJECTMODULE,n.vid));else{const o=this.engine.getConfigfromModules(d.OBJECTMODULE,t.el);if(!o){console.error(`widget renderer: can not found parent config with: ${t.el}`);return}o.children.push(n.vid)}}patchElement(t,n){if(t.type!==n.type)this.unmountElement(t),this.mountElement(n);else{n.config=t.config;const o=t.props,r=n.props,i=t.config;i||console.error("widget renderer: can not found  config with: ",t);const p=(s,u,g)=>{for(const a in s)v(s[a])?v(u[a])&&u[a].config.vid!==s[a].config.vid?g[a]=u[a].config.vid:v(u[a])||(g[a]=u[a]):O.isObject(s[a])?p(s[a],u[a],g[a]):u[a]!==s[a]&&(g[a]=u[a])};p(o,r,i)}}createElement(t){const n=t.props,o={};for(const i in n)v(n[i])?o[i]=n[i].config.vid:o[i]=n[i];const r=d.generateConfig(t.type,o,{strict:!1,warn:!1});return t.config=r,r}processComponent(t,n){if(!t&&!n){console.error("widget renderer: processElement prarams all of null");return}t===null?this.mountComponent(n):n===null?this.unmountComponent(t):this.patchComponent(t,n)}mountComponent(t){t.component=new b(t,this)}unmountComponent(t){}patchComponent(t,n){const o=t.component;n.component=o,o.vnode=n;const r=t.props||{},i=n.props||{},p={};let s=!1;for(const u in i)i[u]!==r[u]&&(p[u]=i[u],s=!0);s&&(o.updateProps(p),o.update())}}class pe{constructor(t,n){f(this,"wid",d.createSymbol());f(this,"version",ee);f(this,"components",{});f(this,"renderer");f(this,"root");f(this,"instance",null);f(this,"engine");this.engine=t,this.root=n,this.renderer=new le(this)}component(t,n){if(typeof t=="object"){if(n=t,!n.name){console.error("widget register component must be provide a name",n);return}t=n.name}if(!n){console.error("widget register component must be provide a component not a null",t);return}if(this.components[t]){console.warn(`A component with this name already exists: ${t}`);return}this.components[t]=n}mount(){const t=D(this.root);return this.renderer.render(t),this.instance=t.component,this}getState(){var t;return(t=this.instance)==null?void 0:t.getState(!0)}unmount(){}use(){}}class Y extends d.EngineSupport{constructor(t={}){super(t)}createWidget(t){return new pe(this,t)}}const he=function(e,t={}){const n=new Y;return e.modules&&e.modules.forEach(o=>{n.registModule(o)}),e.plugins&&e.plugins.forEach(o=>{n.install(o)}),e.strategy&&e.strategy.forEach(o=>{n.exec(o)}),e.wdigets&&e.wdigets.forEach(o=>{n.createWidget(o)}),n},ae={},de=()=>{},ge=(e,t)=>{const n=e.indexOf(t);n>-1&&e.splice(n,1)},z=Array.isArray,me=e=>L(e)==="[object Map]",ye=e=>L(e)==="[object Set]",I=e=>typeof e=="function",K=e=>e!==null&&typeof e=="object",we=e=>K(e)&&I(e.then)&&I(e.catch),Ee=Object.prototype.toString,L=e=>Ee.call(e),Ce=e=>L(e)==="[object Object]",Q=(e,t)=>!Object.is(e,t);function A(e,t,n){let o;try{o=n?e(...n):e()}catch(r){console.error(r)}return o}function $(e,t,n){if(I(e)){const r=A(e,t,n);return r&&we(r)&&r.catch(i=>{console.error(i)}),r}const o=[];for(let r=0;r<e.length;r++)o.push($(e[r],t,n));return o}function be(e,t){return X(e,null,t)}const q={};function Se(e,t,n){return X(e,t,n)}function X(e,t,{immediate:n,deep:o,flush:r,onTrack:i,onTrigger:p}=ae){var Z;const s=h.getCurrentScope()===((Z=b.currentComponent)==null?void 0:Z.scope)?b.currentComponent:null;let u,g=!1,a=!1;if(h.isRef(e)?(u=()=>e.value,g=h.isShallow(e)):h.isReactive(e)?(u=()=>e,o=!0):z(e)?(a=!0,g=e.some(m=>h.isReactive(m)||h.isShallow(m)),u=()=>e.map(m=>{if(h.isRef(m))return m.value;if(h.isReactive(m))return R(m);if(I(m))return A(m)})):I(e)?t?u=()=>A(e):u=()=>{if(!(s&&!s.isMounted))return j&&j(),$(e,s)}:u=de,t&&o){const m=u;u=()=>R(m())}let j,Oe=m=>{j=w.onStop=()=>{A(m),j=w.onStop=void 0}},T=a?new Array(e.length).fill(q):q;const k=()=>{if(!!w.active)if(t){const m=w.run();(o||g||(a?m.some((ve,Me)=>Q(ve,T[Me])):Q(m,T)))&&(j&&j(),$(t,s,[m,T===q?void 0:a&&T[0]===q?[]:T,Oe]),T=m)}else w.run()};k.allowRecurse=!!t;let J;r==="sync"?J=k:r==="post"?J=()=>N(k):(k.pre=!0,s&&(k.id=s.cid),J=()=>_(k));const w=new h.ReactiveEffect(u,J);return t?n?k():T=w.run():r==="post"?N(w.run.bind(w)):w.run(),()=>{w.stop(),s&&s.scope&&ge(s.scope.effects,w)}}function R(e,t){if(!K(e)||e.__v_skip||(t=t||new Set,t.has(e)))return e;if(t.add(e),h.isRef(e))R(e.value,t);else if(z(e))for(let n=0;n<e.length;n++)R(e[n],t);else if(ye(e)||me(e))e.forEach(n=>{R(n,t)});else if(Ce(e))for(const n in e)R(e[n],t);return e}Object.defineProperty(c,"computed",{enumerable:!0,get:function(){return h.computed}}),Object.defineProperty(c,"reactive",{enumerable:!0,get:function(){return h.reactive}}),Object.defineProperty(c,"ref",{enumerable:!0,get:function(){return h.ref}}),Object.defineProperty(c,"shallowReactive",{enumerable:!0,get:function(){return h.shallowReactive}}),Object.defineProperty(c,"shallowReadonly",{enumerable:!0,get:function(){return h.shallowReadonly}}),Object.defineProperty(c,"shallowRef",{enumerable:!0,get:function(){return h.shallowRef}}),Object.defineProperty(c,"toRef",{enumerable:!0,get:function(){return h.toRef}}),Object.defineProperty(c,"toRefs",{enumerable:!0,get:function(){return h.toRefs}}),c.EngineWidget=Y,c.defineComponent=fe,c.defineEngineWidget=he,c.h=te,c.onMounted=oe,c.vfor=re,c.vif=ne,c.watch=Se,c.watchEffect=be,Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
