(function(r,f){typeof exports=="object"&&typeof module!="undefined"?f(exports,require("@vis-three/middleware"),require("@vis-three/utils"),require("@vue/reactivity"),require("@vis-three/core")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","@vis-three/utils","@vue/reactivity","@vis-three/core"],f):(r=typeof globalThis!="undefined"?globalThis:r||self,f((r["vis-three"]=r["vis-three"]||{},r["vis-three"].widget={}),r.middleware,r.utils,r.reactivity,r.core))})(this,function(r,f,m,g,w){"use strict";var W=Object.defineProperty;var q=(r,f,m)=>f in r?W(r,f,{enumerable:!0,configurable:!0,writable:!0,value:m}):r[f]=m;var i=(r,f,m)=>(q(r,typeof f!="symbol"?f+"":f,m),m);const M="0.6.0",b=function(n,e=null){return{_isVNode:!0,type:n,props:e,config:null,component:null,el:null,key:null,ref:null,children:null}},y=function(n){return typeof n=="object"?Boolean(n._isVNode):!1};var v=(n=>(n.STATIC="static",n.VIF="vif",n.VFOR="vfor",n))(v||{});const u=function(n,e=null){const t=b(n,e);return u.add(t),t};u.reset=function(){u.el=null,u.scope="static",u.vnodes=[]},u.add=function(n){if(n.el=u.el,u.scope!=="static"){const e=u.vnodes[u.vnodes.length-1];u.scope==="vfor"&&(n.key||(n.key=e.vnodes.length),e.keyMap.set(n.key,n)),e.vnodes.push(n)}else u.vnodes.push(n);return u.vnodes};const O=function(n,e=null){return u(n,e)},S=function(n){u.scope="vif",u.vnodes.push({scope:u.scope,vnodes:[],keyMap:new Map}),n(),u.scope="static"},T=function(n){u.scope="vfor",u.vnodes.push({scope:u.scope,vnodes:[],keyMap:new Map}),n(),u.scope="static"};class j extends w.EventDispatcher{constructor(t,o){super();i(this,"cid",f.createSymbol());i(this,"name","");i(this,"options");i(this,"vnode");i(this,"el","");i(this,"render");i(this,"engine");i(this,"renderer");i(this,"isMounted",!1);i(this,"props",Object.create(Object.prototype));i(this,"setupState");i(this,"rawSetupState");i(this,"effect");i(this,"effectScope",new g.EffectScope(!0));i(this,"update");i(this,"subTree",null);i(this,"ctx");this.vnode=t;const c=t.type;c.name&&(this.name=c.name),this.el=c.el,this.options=c,this.renderer=o,this.engine=o.engine,this.ctx=o.context,this.createProps(),this.createSetup(),this.createRender(),this.createEffect()}renderTree(){return u.reset(),u.el=this.el,this.render.call({...this.setupState,...this.props}),u.vnodes}createProps(){const t=this.options.props||{},o=this.props,c=this.vnode.props||{};for(const s in t){const l=t[s];if(l.required&&typeof c[s]=="undefined"){console.error("widget component: component prop is required.",{component:this,props:c,key:s});return}let p;if(typeof c[s]!="undefined"?p=c[s]:l.default&&(p=typeof l.default=="function"?l.default():l.default),p.constructor!==l.type){console.error("widget component: component prop is not instance of type.",{component:this,props:c,key:s,value:p,type:l.type});return}o[s]=p}}createSetup(){const t=this.options.setup(this.props);this.setupState=g.proxyRefs(t),this.rawSetupState=t}createRender(){this.render=this.options.render}createEffect(){const t=new g.ReactiveEffect(()=>{if(this.isMounted){const c=this.renderTree(),s=this.subTree;if(s.length!==c.length){console.error("widget component render: tree render error",{nextTree:c,prevTree:s});return}for(let l=0;l<c.length;l+=1)if(y(s[l])&&y(c[l]))this.renderer.patch(s[l],c[l]);else{const p=c[l],d=s[l];if(p.scope!==d.scope){console.error("widget component render: tree render error",{nextTree:c,prevTree:s});return}if(p.scope===v.VIF){for(const a of d.vnodes)this.renderer.unmountElement(a);for(const a of p.vnodes)this.renderer.mountElement(a)}else if(p.scope===v.VFOR){for(const a of p.keyMap.keys())d.keyMap.has(a)?(this.renderer.patch(d.keyMap.get(a),p.keyMap.get(a)),d.keyMap.delete(a)):this.renderer.mountElement(p.keyMap.get(a));for(const a of d.keyMap.values())this.renderer.unmountElement(a)}else console.warn(`widget component render: unknow scope type: ${p.scope}`)}this.subTree=c}else{const c=this.subTree=this.renderTree();for(const s of c)if(y(s))this.renderer.patch(null,s);else for(const l of s.vnodes)this.renderer.patch(null,l);this.isMounted=!0}},null,this.effectScope),o=()=>t.run();o(),this.effect=t,this.update=o}getState(t=!1){return t?this.rawSetupState:this.setupState}}const k=function(n){return n};class C{constructor(e){i(this,"engine");i(this,"context");this.context=e,this.engine=e.engine}log(e,t,o){t?console[e](`Widget renderer: ${t}`,o):console.info(`Widget renderer: ${e}`)}patch(e,t){if(!e&&!t){console.error("widget renderer: patch prarams all of null");return}e!==t&&(t&&typeof t.type=="string"||e&&typeof e.type=="string"?this.processElement(e,t):this.processComponent(e,t))}render(e){this.patch(null,e)}processElement(e,t){if(!e&&!t){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountElement(t):t===null?this.unmountElement(e):this.patchElement(e,t)}unmountElement(e){if(f.isObjectType(e.type)){if(e.config.parent){const t=this.engine.getConfigfromModules(f.OBJECTMODULE,e.config.parent);if(!t){console.error("widget renderer: can not found parent config with: ",e);return}t.children.splice(t.children.indexOf(e.config.vid),1)}else if(!e.el){const t=this.engine.getObjectBySymbol(e.config.vid);t||console.error("widget renderer: can not found Three object with: ",e),t.removeFromParent()}}this.engine.removeConfigBySymbol(e.config.vid)}mountElement(e){const t=this.createElement(e);if(this.engine.applyConfig(t),f.isObjectType(t.type))if(!e.el)this.engine.scene.add(this.engine.getObjectfromModules(f.OBJECTMODULE,t.vid));else{const o=this.engine.getConfigfromModules(f.OBJECTMODULE,e.el);if(!o){console.error(`widget renderer: can not found parent config with: ${e.el}`);return}o.children.push(t.vid)}}patchElement(e,t){if(e.type!==t.type)this.unmountElement(e),this.mountElement(t);else{t.config=e.config;const o=e.props,c=t.props,s=e.config;s||console.error("widget renderer: can not found  config with: ",e);const l=(p,d,a)=>{for(const h in p)y(p[h])?y(d[h])&&d[h].config.vid!==p[h].config.vid?a[h]=d[h].config.vid:y(d[h])||(a[h]=d[h]):m.isObject(p[h])?l(p[h],d[h],a[h]):d[h]!==p[h]&&(a[h]=d[h])};l(o,c,s)}}createElement(e){const t=e.props,o={};for(const s in t)y(t[s])?o[s]=t[s].config.vid:o[s]=t[s];const c=f.generateConfig(e.type,o,{strict:!1,warn:!1});return e.config=c,c}processComponent(e,t){if(!e&&!t){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountComponent(t):t===null?this.unmountComponent(e):this.patchComponent(e,t)}mountComponent(e){e.component=new j(e,this)}unmountComponent(e){}patchComponent(e,t){}}class R{constructor(e,t){i(this,"wid",f.createSymbol());i(this,"version",M);i(this,"components",{});i(this,"renderer");i(this,"root");i(this,"instance",null);i(this,"engine");this.engine=e,this.root=t,this.renderer=new C(this)}component(e,t){if(typeof e=="object"){if(t=e,!t.name){console.error("widget register component must be provide a name",t);return}e=t.name}if(!t){console.error("widget register component must be provide a component not a null",e);return}if(this.components[e]){console.warn(`A component with this name already exists: ${e}`);return}this.components[e]=t}mount(){const e=b(this.root);return this.renderer.render(e),this.instance=e.component,this}getState(){var e;return(e=this.instance)==null?void 0:e.getState(!0)}unmount(){}use(){}}class E extends f.EngineSupport{constructor(e={}){super(e)}createWidget(e){return new R(this,e)}}const P=function(n,e={}){const t=new E;return n.modules&&n.modules.forEach(o=>{t.registModule(o)}),n.plugins&&n.plugins.forEach(o=>{t.install(o)}),n.strategy&&n.strategy.forEach(o=>{t.exec(o)}),n.wdigets&&n.wdigets.forEach(o=>{t.createWidget(o)}),t};Object.defineProperty(r,"computed",{enumerable:!0,get:function(){return g.computed}}),Object.defineProperty(r,"reactive",{enumerable:!0,get:function(){return g.reactive}}),Object.defineProperty(r,"ref",{enumerable:!0,get:function(){return g.ref}}),Object.defineProperty(r,"shallowReactive",{enumerable:!0,get:function(){return g.shallowReactive}}),Object.defineProperty(r,"shallowReadonly",{enumerable:!0,get:function(){return g.shallowReadonly}}),Object.defineProperty(r,"shallowRef",{enumerable:!0,get:function(){return g.shallowRef}}),Object.defineProperty(r,"toRef",{enumerable:!0,get:function(){return g.toRef}}),Object.defineProperty(r,"toRefs",{enumerable:!0,get:function(){return g.toRefs}}),r.EngineWidget=E,r.defineComponent=k,r.defineEngineWidget=P,r.h=O,r.vfor=T,r.vif=S,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
