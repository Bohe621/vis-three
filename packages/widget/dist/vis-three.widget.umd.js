(function(s,o){typeof exports=="object"&&typeof module!="undefined"?o(exports,require("@vue/reactivity"),require("@vis-three/middleware"),require("@vis-three/utils"),require("@vis-three/core")):typeof define=="function"&&define.amd?define(["exports","@vue/reactivity","@vis-three/middleware","@vis-three/utils","@vis-three/core"],o):(s=typeof globalThis!="undefined"?globalThis:s||self,o((s["vis-three"]=s["vis-three"]||{},s["vis-three"].widget={}),s.reactivity,s.middleware,s.utils,s.core))})(this,function(s,o,u,a,y){"use strict";var M=Object.defineProperty;var j=(s,o,u)=>o in s?M(s,o,{enumerable:!0,configurable:!0,writable:!0,value:u}):s[o]=u;var i=(s,o,u)=>(j(s,typeof o!="symbol"?o+"":o,u),u);const E="0.6.0",g=function(r,e=null){return{_isVNode:!0,type:r,props:e,config:null,component:null,el:null,key:null,ref:null,children:null}},v=function(r){return typeof r=="object"?Boolean(r._isVNode):!1};class C extends y.EventDispatcher{constructor(t,n){super();i(this,"cid",u.createSymbol());i(this,"name","");i(this,"options");i(this,"el","");i(this,"render");i(this,"engine");i(this,"renderer");i(this,"isMounted",!1);i(this,"setupState");i(this,"effect");i(this,"scope",new o.EffectScope(!0));i(this,"update");i(this,"subTree",null);i(this,"ctx");t.name&&(this.name=t.name),this.el=t.el,this.options=t,this.renderer=n,this.engine=n.engine,this.ctx=n.context,this.createSetup(),this.createRender(),this.createEffect()}renderTree(){let t=this.render.call(this.setupState);Array.isArray(t)||(t=[t]);for(const n of t)n.el=this.el;return t}createSetup(){const t=this.options.setup();this.setupState=o.proxyRefs(t)}createRender(){this.render=this.options.render}createEffect(){const t=new o.ReactiveEffect(()=>{if(this.isMounted){const h=this.renderTree(),d=this.subTree;for(let f=0;f<h.length;f+=1)this.renderer.patch(d[f],h[f])}else{const h=this.subTree=this.renderTree();for(const d of h)this.renderer.patch(null,d);this.isMounted=!0}},null,this.scope),n=()=>t.run();n(),this.effect=t,this.update=n}getState(){return this.setupState}}const T=function(r){return r};class b{constructor(e){i(this,"engine");i(this,"context");this.context=e,this.engine=e.engine}log(e,t,n){t?console[e](`Widget renderer: ${t}`,n):console.info(`Widget renderer: ${e}`)}patch(e,t){e!==t&&(typeof t.type=="string"?this.processElement(e,t):this.processComponent(e,t))}render(e){this.patch(null,e)}processElement(e,t){e===null&&this.mountElement(t)}unmountElement(e){var t;if(u.isObjectType(e.type)&&((t=e.props)==null?void 0:t.parent)){const n=this.engine.getConfigfromModules(u.OBJECTMODULE,e.props.parent);if(!n){console.error("widget renderer: can not found parent config with: ",e);return}n.children.splice(n.children.indexOf(e.props.vid),1)}this.engine.removeConfigBySymbol(e.props.vid)}mountElement(e){const t=this.createElement(e);if(this.engine.applyConfig(t),u.isObjectType(t.type))if(!e.el)this.engine.scene.add(this.engine.getObjectfromModules(u.OBJECTMODULE,t.vid));else{const n=this.engine.getConfigfromModules(u.OBJECTMODULE,e.el);if(!n){console.error(`widget renderer: can not found parent config with: ${e.el}`);return}n.children.push(t.vid)}}patchElement(e,t){if(e.type!==t.type)this.unmountElement(e),this.mountElement(t);else{const n=e.props,h=t.props,d=this.engine.getConfigBySymbol(n.vid);d||console.error("widget renderer: can not found  config with: ",e);const f=(p,l)=>{for(const c in p){if(typeof l[c]=="undefined"){console.warn(`widget renderer: config has not found this key: ${c}`,{config:l,vnode:t});continue}a.isObject(p[c])?a.isObject(l[c])?a.isArray(p[c])?(l[c].splice(0,l[c].length),l[c].push(...p[c])):f(p[c],l[c]):l[c]=p[c]:l[c]!==p[c]&&(l[c]=p[c])}};f(h,d)}}createElement(e){var d;const t=e.props,n={};for(const f in t)v(t[f])?n[f]=(d=t[f].config)==null?void 0:d.vid:n[f]=t[f];const h=u.generateConfig(e.type,n,{strict:!1,warn:!1});return e.config=h,h}processComponent(e,t){e===null&&this.mountComponent(t)}mountComponent(e){e.component=new C(e.type,this)}}class O{constructor(e,t){i(this,"wid",u.createSymbol());i(this,"version",E);i(this,"components",{});i(this,"renderer");i(this,"root");i(this,"instance",null);i(this,"engine");this.engine=e,this.root=t,this.renderer=new b(this)}component(e,t){if(typeof e=="object"){if(t=e,!t.name){console.error("widget register component must be provide a name",t);return}e=t.name}if(!t){console.error("widget register component must be provide a component not a null",e);return}if(this.components[e]){console.warn(`A component with this name already exists: ${e}`);return}this.components[e]=t}mount(){const e=g(this.root);return this.renderer.render(e),this}unmount(){}use(){}}class m extends u.EngineSupport{constructor(e={}){super(e)}createWidget(e){return new O(this,e)}}const S=function(r,e={}){const t=new m;return r.modules&&r.modules.forEach(n=>{t.registModule(n)}),r.plugins&&r.plugins.forEach(n=>{t.install(n)}),r.strategy&&r.strategy.forEach(n=>{t.exec(n)}),r.wdigets&&r.wdigets.forEach(n=>{t.createWidget(n)}),t},w=function(r,e=null){return g(r,e)};s.EngineWidget=m,s.defineComponent=T,s.defineEngineWidget=S,s.h=w,Object.keys(o).forEach(function(r){r!=="default"&&!s.hasOwnProperty(r)&&Object.defineProperty(s,r,{enumerable:!0,get:function(){return o[r]}})}),Object.defineProperties(s,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
