(function(o,l){typeof exports=="object"&&typeof module!="undefined"?l(exports,require("@vis-three/middleware"),require("@vis-three/utils"),require("@vue/reactivity"),require("@vis-three/core")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","@vis-three/utils","@vue/reactivity","@vis-three/core"],l):(o=typeof globalThis!="undefined"?globalThis:o||self,l((o["vis-three"]=o["vis-three"]||{},o["vis-three"].widget={}),o.middleware,o.utils,o.reactivity,o.core))})(this,function(o,l,m,g,w){"use strict";var W=Object.defineProperty;var q=(o,l,m)=>l in o?W(o,l,{enumerable:!0,configurable:!0,writable:!0,value:m}):o[l]=m;var c=(o,l,m)=>(q(o,typeof l!="symbol"?l+"":l,m),m);const M="0.6.0",b=function(n,e=null){return{_isVNode:!0,type:n,props:e,config:null,component:null,el:null,key:null,ref:null,children:null}},y=function(n){return typeof n=="object"?Boolean(n._isVNode):!1};var v=(n=>(n.STATIC="static",n.VIF="vif",n.VFOR="vfor",n))(v||{});const u=function(n,e=null){const t=b(n,e);return u.add(t),t};u.reset=function(){u.el=null,u.scope="static",u.vnodes=[]},u.add=function(n){if(n.el=u.el,u.scope!=="static"){const e=u.vnodes[u.vnodes.length-1];u.scope==="vfor"&&(n.key||(n.key=e.vnodes.length),e.keyMap.set(n.key,n)),e.vnodes.push(n)}else u.vnodes.push(n);return u.vnodes};const O=function(n,e=null){return u(n,e)},S=function(n){u.scope="vif",u.vnodes.push({scope:u.scope,vnodes:[],keyMap:new Map}),n(),u.scope="static"},k=function(n){u.scope="vfor",u.vnodes.push({scope:u.scope,vnodes:[],keyMap:new Map}),n(),u.scope="static"};class T extends w.EventDispatcher{constructor(t,r){super();c(this,"cid",l.createSymbol());c(this,"name","");c(this,"options");c(this,"vnode");c(this,"el","");c(this,"render");c(this,"engine");c(this,"renderer");c(this,"isMounted",!1);c(this,"props",Object.create(Object.prototype));c(this,"setupState");c(this,"rawSetupState");c(this,"effect");c(this,"effectScope",new g.EffectScope(!0));c(this,"update");c(this,"subTree",null);c(this,"ctx");this.vnode=t;const s=t.type;s.name&&(this.name=s.name),this.el=s.el,this.options=s,this.renderer=r,this.engine=r.engine,this.ctx=r.context,this.createProps(),this.createSetup(),this.createRender(),this.createEffect()}renderTree(){return u.reset(),u.el=this.el,this.render.call({...this.setupState,...this.props}),u.vnodes}createProps(){const t=this.options.props||{},r=this.props,s=this.vnode.props||{};for(const i in t){const f=t[i];if(f.required&&typeof s[i]=="undefined"){console.error("widget component: component prop is required.",{component:this,props:s,key:i});return}let p;if(typeof s[i]!="undefined"?p=s[i]:f.default&&(p=typeof f.default=="function"?f.default():f.default),p.constructor!==f.type){console.error("widget component: component prop is not instance of type.",{component:this,props:s,key:i,value:p,type:f.type});return}r[i]=p}}createSetup(){const t=this.options.setup(this.props);this.setupState=g.proxyRefs(t),this.rawSetupState=t}createRender(){this.render=this.options.render}createEffect(){const t=new g.ReactiveEffect(()=>{if(this.isMounted){const s=this.renderTree(),i=this.subTree;if(i.length!==s.length){console.error("widget component render: tree render error",{nextTree:s,prevTree:i});return}for(let f=0;f<s.length;f+=1)if(y(i[f])&&y(s[f]))this.renderer.patch(i[f],s[f]);else{const p=s[f],h=i[f];if(p.scope!==h.scope){console.error("widget component render: tree render error",{nextTree:s,prevTree:i});return}if(p.scope===v.VIF){for(const d of h.vnodes)this.renderer.unmountElement(d);for(const d of p.vnodes)this.renderer.mountElement(d)}else if(p.scope===v.VFOR){for(const d of p.keyMap.keys())h.keyMap.has(d)?(this.renderer.patch(h.keyMap.get(d),p.keyMap.get(d)),h.keyMap.delete(d)):this.renderer.mountElement(p.keyMap.get(d));for(const d of h.keyMap.values())this.renderer.unmountElement(d)}else console.warn(`widget component render: unknow scope type: ${p.scope}`)}this.subTree=s}else{const s=this.subTree=this.renderTree();for(const i of s)if(y(i))this.renderer.patch(null,i);else for(const f of i.vnodes)this.renderer.patch(null,f);this.isMounted=!0}},null,this.effectScope),r=()=>t.run();r(),this.effect=t,this.update=r}updateProps(t){const r=this.props;for(const s in t)r[s]=t[s]}getState(t=!1){return t?this.rawSetupState:this.setupState}}const j=function(n){return n};class C{constructor(e){c(this,"engine");c(this,"context");this.context=e,this.engine=e.engine}log(e,t,r){t?console[e](`Widget renderer: ${t}`,r):console.info(`Widget renderer: ${e}`)}patch(e,t){if(!e&&!t){console.error("widget renderer: patch prarams all of null");return}e!==t&&(t&&typeof t.type=="string"||e&&typeof e.type=="string"?this.processElement(e,t):this.processComponent(e,t))}render(e){this.patch(null,e)}processElement(e,t){if(!e&&!t){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountElement(t):t===null?this.unmountElement(e):this.patchElement(e,t)}unmountElement(e){if(l.isObjectType(e.type)){if(e.config.parent){const t=this.engine.getConfigfromModules(l.OBJECTMODULE,e.config.parent);if(!t){console.error("widget renderer: can not found parent config with: ",e);return}t.children.splice(t.children.indexOf(e.config.vid),1)}else if(!e.el){const t=this.engine.getObjectBySymbol(e.config.vid);t||console.error("widget renderer: can not found Three object with: ",e),t.removeFromParent()}}this.engine.removeConfigBySymbol(e.config.vid)}mountElement(e){const t=this.createElement(e);if(this.engine.applyConfig(t),l.isObjectType(t.type))if(!e.el)this.engine.scene.add(this.engine.getObjectfromModules(l.OBJECTMODULE,t.vid));else{const r=this.engine.getConfigfromModules(l.OBJECTMODULE,e.el);if(!r){console.error(`widget renderer: can not found parent config with: ${e.el}`);return}r.children.push(t.vid)}}patchElement(e,t){if(e.type!==t.type)this.unmountElement(e),this.mountElement(t);else{t.config=e.config;const r=e.props,s=t.props,i=e.config;i||console.error("widget renderer: can not found  config with: ",e);const f=(p,h,d)=>{for(const a in p)y(p[a])?y(h[a])&&h[a].config.vid!==p[a].config.vid?d[a]=h[a].config.vid:y(h[a])||(d[a]=h[a]):m.isObject(p[a])?f(p[a],h[a],d[a]):h[a]!==p[a]&&(d[a]=h[a])};f(r,s,i)}}createElement(e){const t=e.props,r={};for(const i in t)y(t[i])?r[i]=t[i].config.vid:r[i]=t[i];const s=l.generateConfig(e.type,r,{strict:!1,warn:!1});return e.config=s,s}processComponent(e,t){if(!e&&!t){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountComponent(t):t===null?this.unmountComponent(e):this.patchComponent(e,t)}mountComponent(e){e.component=new T(e,this)}unmountComponent(e){}patchComponent(e,t){const r=e.component;t.component=r;const s=e.props||{},i=t.props||{},f={};let p=!1;for(const h in i)i[h]!==s[h]&&(f[h]=i[h],p=!0);p&&(r.updateProps(f),r.update())}}class P{constructor(e,t){c(this,"wid",l.createSymbol());c(this,"version",M);c(this,"components",{});c(this,"renderer");c(this,"root");c(this,"instance",null);c(this,"engine");this.engine=e,this.root=t,this.renderer=new C(this)}component(e,t){if(typeof e=="object"){if(t=e,!t.name){console.error("widget register component must be provide a name",t);return}e=t.name}if(!t){console.error("widget register component must be provide a component not a null",e);return}if(this.components[e]){console.warn(`A component with this name already exists: ${e}`);return}this.components[e]=t}mount(){const e=b(this.root);return this.renderer.render(e),this.instance=e.component,this}getState(){var e;return(e=this.instance)==null?void 0:e.getState(!0)}unmount(){}use(){}}class E extends l.EngineSupport{constructor(e={}){super(e)}createWidget(e){return new P(this,e)}}const R=function(n,e={}){const t=new E;return n.modules&&n.modules.forEach(r=>{t.registModule(r)}),n.plugins&&n.plugins.forEach(r=>{t.install(r)}),n.strategy&&n.strategy.forEach(r=>{t.exec(r)}),n.wdigets&&n.wdigets.forEach(r=>{t.createWidget(r)}),t};Object.defineProperty(o,"computed",{enumerable:!0,get:function(){return g.computed}}),Object.defineProperty(o,"reactive",{enumerable:!0,get:function(){return g.reactive}}),Object.defineProperty(o,"ref",{enumerable:!0,get:function(){return g.ref}}),Object.defineProperty(o,"shallowReactive",{enumerable:!0,get:function(){return g.shallowReactive}}),Object.defineProperty(o,"shallowReadonly",{enumerable:!0,get:function(){return g.shallowReadonly}}),Object.defineProperty(o,"shallowRef",{enumerable:!0,get:function(){return g.shallowRef}}),Object.defineProperty(o,"toRef",{enumerable:!0,get:function(){return g.toRef}}),Object.defineProperty(o,"toRefs",{enumerable:!0,get:function(){return g.toRefs}}),o.EngineWidget=E,o.defineComponent=j,o.defineEngineWidget=R,o.h=O,o.vfor=k,o.vif=S,Object.defineProperties(o,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
