(function(r,i){typeof exports=="object"&&typeof module!="undefined"?i(exports,require("@vue/reactivity"),require("@vis-three/middleware"),require("@vis-three/utils"),require("@vis-three/core")):typeof define=="function"&&define.amd?define(["exports","@vue/reactivity","@vis-three/middleware","@vis-three/utils","@vis-three/core"],i):(r=typeof globalThis!="undefined"?globalThis:r||self,i((r["vis-three"]=r["vis-three"]||{},r["vis-three"].widget={}),r.reactivity,r.middleware,r.utils,r.core))})(this,function(r,i,u,a,m){"use strict";var S=Object.defineProperty;var O=(r,i,u)=>i in r?S(r,i,{enumerable:!0,configurable:!0,writable:!0,value:u}):r[i]=u;var n=(r,i,u)=>(O(r,typeof i!="symbol"?i+"":i,u),u);const y="0.6.0",g=function(c,e=null){return{type:c,props:e,component:null,el:null,key:null,ref:null,children:null}};class E extends m.EventDispatcher{constructor(t,o){super();n(this,"cid",u.createSymbol());n(this,"name","");n(this,"options");n(this,"render");n(this,"engine");n(this,"renderer");n(this,"isMounted",!1);n(this,"setupState");n(this,"effect");n(this,"scope",new i.EffectScope(!0));n(this,"update");n(this,"subTree",null);n(this,"ctx");t.name&&(this.name=t.name),this.options=t,this.renderer=o,this.engine=o.engine,this.ctx=o.context}renderTree(){const t=this.render.call(this.setupState);return Array.isArray(t)?t:[t]}createSetup(){const t=this.options.setup();this.setupState=i.proxyRefs(t)}createRender(){this.render=this.options.render}createEffect(){const t=new i.ReactiveEffect(()=>{if(this.isMounted){const p=this.renderTree(),d=this.subTree;for(let l=0;l<p.length;l+=1)this.renderer.patch(d[l],p[l])}else{const p=this.subTree=this.renderTree();for(const d of p)this.renderer.patch(null,d);this.isMounted=!0}},null,this.scope),o=()=>t.run();o(),this.effect=t,this.update=o}getState(){return this.setupState}}const v=function(c){return c};class b{constructor(e){n(this,"engine");n(this,"context");this.context=e,this.engine=e.engine}log(e,t,o){t?console[e](`Widget renderer: ${t}`,o):console.info(`Widget renderer: ${e}`)}patch(e,t){e!==t&&(typeof t.type=="string"?this.processElement(e,t):this.processComponent(e,t))}render(e){this.patch(null,e)}processElement(e,t){e===null&&this.mountElement(t)}unmountElement(e){var t;if(u.isObjectType(e.type)&&((t=e.props)==null?void 0:t.parent)){const o=this.engine.getConfigfromModules(u.OBJECTMODULE,e.props.parent);if(!o){console.error("widget renderer: can not found parent config with: ",e);return}o.children.splice(o.children.indexOf(e.props.vid),1)}this.engine.removeConfigBySymbol(e.props.vid)}mountElement(e){const t=this.createElement(e);return this.engine.applyConfig(t),this}patchElement(e,t){if(e.type!==t.type)this.unmountElement(e),this.mountElement(t);else{const o=e.props,p=t.props,d=this.engine.getConfigBySymbol(o.vid);d||console.error("widget renderer: can not found  config with: ",e);const l=(f,h)=>{for(const s in f){if(typeof h[s]=="undefined"){console.warn(`widget renderer: config has not found this key: ${s}`,{config:h,vnode:t});continue}a.isObject(f[s])?a.isObject(h[s])?a.isArray(f[s])?(h[s].splice(0,h[s].length),h[s].push(...f[s])):l(f[s],h[s]):h[s]=f[s]:h[s]!==f[s]&&(h[s]=f[s])}};l(p,d)}}createElement(e){return u.generateConfig(e.type,e.props,{strict:!1,warn:!1})}processComponent(e,t){e===null&&this.mountComponent(t)}mountComponent(e){e.component=new E(e.type,this)}}class w{constructor(e,t){n(this,"wid",u.createSymbol());n(this,"version",y);n(this,"components",{});n(this,"renderer");n(this,"root");n(this,"instance",null);n(this,"engine");this.engine=e,this.root=t,this.renderer=new b(this)}component(e,t){if(typeof e=="object"){if(t=e,!t.name){console.error("widget register component must be provide a name",t);return}e=t.name}if(!t){console.error("widget register component must be provide a component not a null",e);return}if(this.components[e]){console.warn(`A component with this name already exists: ${e}`);return}this.components[e]=t}mount(e){if(e){if(!this.engine.getConfigfromModules(u.OBJECTMODULE,e))return console.warn(`widget mount can not found object config with el:${e}`),this}else if(!this.engine.getObjectConfig(this.engine.scene))return console.warn("widget mount can not found object config with object:",this.engine.scene),this;const t=g(this.root);return this.renderer.render(t),this}unmount(){}use(){}}class C extends u.EngineSupport{constructor(e={}){super(e)}createWidget(e){return new w(this,e)}}const T=function(c,e=null){return g(c,e)};r.EngineWidget=C,r.defineComponent=v,r.h=T,Object.keys(i).forEach(function(c){c!=="default"&&!r.hasOwnProperty(c)&&Object.defineProperty(r,c,{enumerable:!0,get:function(){return i[c]}})}),Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
