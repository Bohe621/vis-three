(function(r,f){typeof exports=="object"&&typeof module!="undefined"?f(exports,require("@vue/reactivity"),require("@vis-three/middleware"),require("@vis-three/utils"),require("@vis-three/core")):typeof define=="function"&&define.amd?define(["exports","@vue/reactivity","@vis-three/middleware","@vis-three/utils","@vis-three/core"],f):(r=typeof globalThis!="undefined"?globalThis:r||self,f((r["vis-three"]=r["vis-three"]||{},r["vis-three"].widget={}),r.reactivity,r.middleware,r.utils,r.core))})(this,function(r,f,h,M,S){"use strict";var B=Object.defineProperty;var F=(r,f,h)=>f in r?B(r,f,{enumerable:!0,configurable:!0,writable:!0,value:h}):r[f]=h;var o=(r,f,h)=>(F(r,typeof f!="symbol"?f+"":f,h),h);const T="0.6.0",v=function(n,e=null){return{_isVNode:!0,type:n,props:e,config:null,component:null,el:null,key:null,ref:null,children:null}},m=function(n){return typeof n=="object"?Boolean(n._isVNode):!1};var y=(n=>(n.STATIC="static",n.VIF="vif",n.VFOR="vfor",n))(y||{});const s=function(n,e=null){const t=v(n,e);return s.add(t),t};s.reset=function(){s.el=null,s.scope="static",s.vnodes=[]},s.add=function(n){if(n.el=s.el,s.scope!=="static"){const e=s.vnodes[s.vnodes.length-1];s.scope==="vfor"&&(n.key||(n.key=e.vnodes.length),e.keyMap.set(n.key,n)),e.vnodes.push(n)}else s.vnodes.push(n);return s.vnodes};const w=function(n,e=null){return s(n,e)},b=function(n){s.scope="vif",s.vnodes.push({scope:s.scope,vnodes:[],keyMap:new Map}),n(),s.scope="static"},C=function(n){s.scope="vfor",s.vnodes.push({scope:s.scope,vnodes:[],keyMap:new Map}),n(),s.scope="static"};class k extends S.EventDispatcher{constructor(t,i){super();o(this,"cid",h.createSymbol());o(this,"name","");o(this,"options");o(this,"el","");o(this,"render");o(this,"engine");o(this,"renderer");o(this,"isMounted",!1);o(this,"setupState");o(this,"rawSetupState");o(this,"effect");o(this,"effectScope",new f.EffectScope(!0));o(this,"update");o(this,"subTree",null);o(this,"ctx");t.name&&(this.name=t.name),this.el=t.el,this.options=t,this.renderer=i,this.engine=i.engine,this.ctx=i.context,this.createSetup(),this.createRender(),this.createEffect()}renderTree(){return s.reset(),s.el=this.el,this.render.call(this.setupState),s.vnodes}createSetup(){const t=this.options.setup();this.setupState=f.proxyRefs(t),this.rawSetupState=t}createRender(){this.render=this.options.render}createEffect(){const t=new f.ReactiveEffect(()=>{if(this.isMounted){const a=this.renderTree(),c=this.subTree;if(c.length!==a.length){console.error("widget component render: tree render error",{nextTree:a,prevTree:c});return}for(let g=0;g<a.length;g+=1)if(m(c[g])&&m(a[g]))this.renderer.patch(c[g],a[g]);else{const p=a[g],d=c[g];if(p.scope!==d.scope){console.error("widget component render: tree render error",{nextTree:a,prevTree:c});return}if(p.scope===y.VIF){for(const l of d.vnodes)this.renderer.unmountElement(l);for(const l of p.vnodes)this.renderer.mountElement(l)}else if(p.scope===y.VFOR){for(const l in p.keyMap.keys())d.keyMap.has(l)?(this.renderer.patch(d.keyMap.get(l),p.keyMap.get(l)),d.keyMap.delete(l)):this.renderer.mountElement(p.keyMap.get(l));for(const l of d.keyMap.values())this.renderer.unmountElement(l)}else console.warn(`widget component render: unknow scope type: ${p.scope}`)}this.subTree=a}else{const a=this.subTree=this.renderTree();for(const c of a)if(m(c))this.renderer.patch(null,c);else for(const g of c.vnodes)this.renderer.patch(null,g);this.isMounted=!0}},null,this.effectScope),i=()=>t.run();i(),this.effect=t,this.update=i}getState(t=!1){return t?this.rawSetupState:this.setupState}}const O=function(n){return n};class j{constructor(e){o(this,"engine");o(this,"context");this.context=e,this.engine=e.engine}log(e,t,i){t?console[e](`Widget renderer: ${t}`,i):console.info(`Widget renderer: ${e}`)}patch(e,t){if(!e&&!t){console.error("widget renderer: patch prarams all of null");return}e!==t&&(t&&typeof t.type=="string"||e&&typeof e.type=="string"?this.processElement(e,t):this.processComponent(e,t))}render(e){this.patch(null,e)}processElement(e,t){if(!e&&!t){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountElement(t):t===null?this.unmountElement(e):this.patchElement(e,t)}unmountElement(e){if(h.isObjectType(e.type)){if(e.config.parent){const t=this.engine.getConfigfromModules(h.OBJECTMODULE,e.config.parent);if(!t){console.error("widget renderer: can not found parent config with: ",e);return}t.children.splice(t.children.indexOf(e.config.vid),1)}else if(!e.el){const t=this.engine.getObjectBySymbol(e.config.vid);t||console.error("widget renderer: can not found Three object with: ",e),t.removeFromParent()}}this.engine.removeConfigBySymbol(e.config.vid)}mountElement(e){const t=this.createElement(e);if(this.engine.applyConfig(t),h.isObjectType(t.type))if(!e.el)this.engine.scene.add(this.engine.getObjectfromModules(h.OBJECTMODULE,t.vid));else{const i=this.engine.getConfigfromModules(h.OBJECTMODULE,e.el);if(!i){console.error(`widget renderer: can not found parent config with: ${e.el}`);return}i.children.push(t.vid)}}patchElement(e,t){if(e.type!==t.type)this.unmountElement(e),this.mountElement(t);else{t.config=e.config;const i=e.props,a=t.props,c=e.config;c||console.error("widget renderer: can not found  config with: ",e);const g=(p,d,l)=>{for(const u in p)m(p[u])?m(d[u])&&d[u].config.vid!==p[u].config.vid?l[u]=d[u].config.vid:m(d[u])||(l[u]=d[u]):M.isObject(p[u])?g(p[u],d[u],l[u]):d[u]!==p[u]&&(l[u]=d[u])};g(i,a,c)}}createElement(e){const t=e.props,i={};for(const c in t)m(t[c])?i[c]=t[c].config.vid:i[c]=t[c];const a=h.generateConfig(e.type,i,{strict:!1,warn:!1});return e.config=a,a}processComponent(e,t){if(!e&&!t){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountComponent(t):t===null?this.unmountComponent(e):this.patchComponent(e,t)}mountComponent(e){e.component=new k(e.type,this)}unmountComponent(e){}patchComponent(e,t){}}class W{constructor(e,t){o(this,"wid",h.createSymbol());o(this,"version",T);o(this,"components",{});o(this,"renderer");o(this,"root");o(this,"instance",null);o(this,"engine");this.engine=e,this.root=t,this.renderer=new j(this)}component(e,t){if(typeof e=="object"){if(t=e,!t.name){console.error("widget register component must be provide a name",t);return}e=t.name}if(!t){console.error("widget register component must be provide a component not a null",e);return}if(this.components[e]){console.warn(`A component with this name already exists: ${e}`);return}this.components[e]=t}mount(){const e=v(this.root);return this.renderer.render(e),this.instance=e.component,this}getState(){var e;return(e=this.instance)==null?void 0:e.getState(!0)}unmount(){}use(){}}class E extends h.EngineSupport{constructor(e={}){super(e)}createWidget(e){return new W(this,e)}}const x=function(n,e={}){const t=new E;return n.modules&&n.modules.forEach(i=>{t.registModule(i)}),n.plugins&&n.plugins.forEach(i=>{t.install(i)}),n.strategy&&n.strategy.forEach(i=>{t.exec(i)}),n.wdigets&&n.wdigets.forEach(i=>{t.createWidget(i)}),t};r.EngineWidget=E,r.defineComponent=O,r.defineEngineWidget=x,r.h=w,r.vfor=C,r.vif=b,Object.keys(f).forEach(function(n){n!=="default"&&!r.hasOwnProperty(n)&&Object.defineProperty(r,n,{enumerable:!0,get:function(){return f[n]}})}),Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
