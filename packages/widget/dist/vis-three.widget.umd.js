(function(f,E){typeof exports=="object"&&typeof module!="undefined"?E(exports,require("@vis-three/middleware"),require("@vis-three/utils"),require("@vue/reactivity"),require("@vis-three/core"),require("@vue/shared")):typeof define=="function"&&define.amd?define(["exports","@vis-three/middleware","@vis-three/utils","@vue/reactivity","@vis-three/core","@vue/shared"],E):(f=typeof globalThis!="undefined"?globalThis:f||self,E((f["vis-three"]=f["vis-three"]||{},f["vis-three"].widget={}),f.middleware,f.utils,f.reactivity,f.core,f.shared))})(this,function(f,E,x,h,N,m){"use strict";const V="0.6.0",L=function(t,e=null,n={}){return{_isVNode:!0,type:t,props:e,config:null,component:null,el:null,key:n.key||null,ref:n.ref||null,raw:n.raw||null,children:null}},C=function(t){return typeof t=="object"?Boolean(t._isVNode):!1},F=function(t){return/^on[A-Z]/.test(t)},ee=function(t){const e=t.props,n={};for(const r in e)F(r)&&(n[r]=e[r]);return n};var _=(t=>(t.STATIC="static",t.VIF="vif",t.VFOR="vfor",t))(_||{});const l=function(t,e=null){const n=L(t,e,{key:e&&e.key||null,ref:e&&e.ref||null,raw:e&&e.raw||null});return l.add(n),n};l.reset=function(){l.el=null,l.scope="static",l.vnodes=[]},l.add=function(t){if(t.el=l.el,l.scope!=="static"){const e=l.vnodes[l.vnodes.length-1];l.scope==="vfor"&&(t.key||(t.key=e.vnodes.length),e.keyMap.set(t.key,t)),e.vnodes.push(t)}else l.vnodes.push(t);return l.vnodes};const te=function(t,e=null){return l(t,e)},ne=function(t){l.scope="vif",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),t(),l.scope="static"},re=function(t){l.scope="vfor",l.vnodes.push({scope:l.scope,vnodes:[],keyMap:new Map}),t(),l.scope="static"};var I=(t=>(t.MOUNTED="mounted",t.BEFORE_DISTORY="beforeDistory",t.UPDATE="update",t.FRAME="frame",t.CAMERA_CHANGE="cameraChange",t.SCENE_CHANGE="sceneCHange",t))(I||{});const oe=function(t=()=>{}){g.currentComponent&&g.currentComponent.on("mounted",e=>t())},se=function(t=()=>{}){g.currentComponent&&g.currentComponent.on("beforeDistory",e=>t())},ie=function(t=()=>{}){g.currentComponent&&g.currentComponent.on("frame",e=>t(e.delta,e.total))};let A=!1,q=!1;const y=[];let O=0;const P=[];let w=null,b=0;const ce=Promise.resolve();function ue(t){let e=O+1,n=y.length;for(;e<n;){const r=e+n>>>1,s=y[r],i=j(s);i<t||i===t&&s.pre?e=r+1:n=r}return e}function $(t){(!y.length||!y.includes(t,A&&t.allowRecurse?O+1:O))&&(t.id==null?y.push(t):y.splice(ue(t.id),0,t),Y())}function Y(){!A&&!q&&(q=!0,ce.then(K))}function J(t){Array.isArray(t)?P.push(...t):(!w||!w.includes(t,t.allowRecurse?b+1:b))&&P.push(t),Y()}function fe(){if(P.length){const t=[...new Set(P)];if(P.length=0,w){w.push(...t);return}for(w=t,w.sort((e,n)=>j(e)-j(n)),b=0;b<w.length;b++)w[b]();w=null,b=0}}const j=t=>t.id==null?1/0:t.id,le=(t,e)=>{const n=j(t)-j(e);if(n===0){if(t.pre&&!e.pre)return-1;if(e.pre&&!t.pre)return 1}return n};function K(){q=!1,A=!0,y.sort(le);try{for(O=0;O<y.length;O++){const t=y[O];if(t&&t.active!==!1)try{t()}catch(e){console.error(e)}}}finally{O=0,y.length=0,fe(),A=!1,(y.length||P.length)&&K()}}const S=Symbol.for("vis.widget.event"),pe=function(t){const e=function(n){e.value(n)};return e.value=t,e},H=/Once$/;function U(t){let e={};if(H.test(t)){e={};let r;for(;r=t.match(H);)t=t.slice(0,t.length-r[0].length),e[r[0].toLowerCase()]=!0}return[t.slice(2).toLowerCase(),e]}const he=function(t,e,n){if(e[S]){console.error("config has already create events",e);return}const r=ee(t);for(const s in r){r[s]=pe(r[s]);const[i,c]=U(s);n.addEventListener(i,r[s])}e[S]=r},ae=function(t){const e=t.props,n=t.config;if(!n[S])return;const r=n[S];for(const s in r){const i=r[s];i&&i.value!==e[s]&&(i.value=e[s])}},de=function(t,e){const n=t.config;if(!n[S])return;const r=n[S];for(const s in r){const i=r[s];if(i){const[c,u]=U(s);e.removeEventListener(c,i)}}n[S]=void 0};class g extends N.EventDispatcher{constructor(e,n){super(),this.cid=E.createSymbol(),this.name="",this.el="",this.isMounted=!1,this.props=h.shallowReactive(Object.create(Object.prototype)),this.scope=new h.EffectScope(!0),this.subTree=null,this.cacheResources=Object.create(Object.prototype),this.resourcesKeyEnum=Object.create(Object.prototype),this.cacheEvent={},this.vnode=e;const r=e.type;r.name&&(this.name=r.name),this.el=r.el,this.options=r,this.renderer=n,this.engine=n.engine,this.ctx=n.context,this.createProps(),this.createSetup(),this.createResources(),this.createRender(),this.createEffect()}static setCurrentComponent(e){g.currentComponent=e,e.scope.on()}static unsetCurrentComponent(){g.currentComponent&&g.currentComponent.scope.off(),g.currentComponent=null}renderTree(){return l.reset(),l.el=this.el,this.render.call({...this.setupState,...this.props},{components:this.options.components||{},resources:this.resourcesKeyEnum}),l.vnodes}createResources(){if(!this.options.resources)return;const e=this.options.resources.call(this.setupState);this.engine.registerResources(e),this.cacheResources=e;for(const n in e)this.resourcesKeyEnum[n]=n}createProps(){const e=this.options.props||{},n=this.vnode.props||{},r=this.props,s=this.options.emits||{},i={};for(const c in n)if(F(c)){const[u,o]=U(c);s[u]?this[o.once?"once":"on"](u,n[c]):console.warn(`widget Component: you not declare attribute  ${c}  in emits options`,this.options)}else i[c]=n[c];for(const c in e){const u=e[c];if(u.required&&typeof i[c]=="undefined"){console.error("widget component: component prop is required.",{component:this,props:i,key:c});return}let o;if(typeof i[c]!="undefined"?o=i[c]:u.default&&(o=typeof u.default=="function"?u.default():u.default),o.constructor!==u.type){console.error("widget component: component prop is not instance of type.",{component:this,props:i,key:c,value:o,type:u.type});return}r[c]=o}}createSetup(){if(!this.options.setup)return;g.setCurrentComponent(this);const e=this.options.setup({engine:this.engine,props:this.props,emit:this.emit.bind(this)})||{};this.setupState=h.proxyRefs(e),this.rawSetupState=e,g.unsetCurrentComponent()}createRender(){this.render=this.options.render}createEffect(){const e=new h.ReactiveEffect(()=>{if(this.isMounted){const r=this.renderTree(),s=this.subTree;if(s.length!==r.length){console.error("widget component render: tree render error",{nextTree:r,prevTree:s});return}for(let i=0;i<r.length;i+=1)if(C(s[i])&&C(r[i]))this.renderer.patch(s[i],r[i]);else{const c=r[i],u=s[i];if(c.scope!==u.scope){console.error("widget component render: tree render error",{nextTree:r,prevTree:s});return}if(c.scope===_.VIF){for(const o of u.vnodes)this.renderer.patch(o,null);for(const o of c.vnodes)this.renderer.patch(null,o)}else if(c.scope===_.VFOR){for(const o of c.keyMap.keys())u.keyMap.has(o)?(this.renderer.patch(u.keyMap.get(o),c.keyMap.get(o)),u.keyMap.delete(o)):this.renderer.patch(null,c.keyMap.get(o));for(const o of u.keyMap.values())this.renderer.unmountElement(o)}else console.warn(`widget component render: unknow scope type: ${c.scope}`)}this.subTree=r}else{const r=this.rawSetupState,s=o=>{!o.ref||typeof r[o.ref]!="undefined"&&(r[o.ref].value=o.component?o.component:o.config||null)},i=o=>{if(!!o.raw&&typeof r[o.raw]!="undefined")if(o.config){const a=this.engine.getObjectBySymbol(o.config.vid);a||console.warn("can not found raw object in engine",{component:this,vnode:o}),r[o.raw].value=a||null}else{console.warn("component raw object is not a native config",{component:this,vnode:o});return}},c=this.subTree=this.renderTree();for(const o of c)if(C(o))this.renderer.patch(null,o),s(o),i(o);else for(const a of o.vnodes)this.renderer.patch(null,a),s(a),i(a);this.isMounted=!0,J(()=>this.emit(I.MOUNTED));const u=o=>{this.emit(I.FRAME,o)};this.engine.renderManager.addEventListener(N.ENGINE_EVENT.RENDER,u),this.cacheEvent[N.ENGINE_EVENT.RENDER]=u}},()=>$(n),this.scope),n=()=>e.run();n(),this.effect=e,this.update=n}distory(){this.engine.removeEventListener(N.ENGINE_EVENT.RENDER,this.cacheEvent[N.ENGINE_EVENT.RENDER]),this.emit(I.BEFORE_DISTORY),this.scope.stop(),this.effect.active=!1,this.effect.stop();const e=this.subTree||[];for(let n=0;n<e.length;n+=1)if(C(e[n]))this.renderer.patch(e[n],null),e[n].config=null,e[n].raw=null;else for(const r of e[n].vnodes)this.renderer.patch(r,null),r.config=null,r.raw=null}updateProps(e){const n=this.props;for(const r in e)n[r]=e[r]}getState(e=!0){return e?this.rawSetupState:this.setupState}}const ge=function(t){return t},Z=t=>{if(typeof t=="object"){if(C(t))return t.config.vid;for(const e in t)t[e]=Z(t[e]);return t}else return t};class me{constructor(e){this.context=e,this.engine=e.engine}log(e,n,r){n?console[e](`Widget renderer: ${n}`,r):console.info(`Widget renderer: ${e}`)}patch(e,n){if(!e&&!n){console.error("widget renderer: patch prarams all of null");return}e!==n&&(n&&typeof n.type=="string"||e&&typeof e.type=="string"?this.processElement(e,n):this.processComponent(e,n))}render(e){this.patch(null,e)}processElement(e,n){if(!e&&!n){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountElement(n):n===null?this.unmountElement(e):this.patchElement(e,n)}unmountElement(e){if(E.isObjectType(e.type)){if(e.config.parent){const r=this.engine.getConfigfromModules(E.OBJECTMODULE,e.config.parent);if(!r){console.error("widget renderer: can not found parent config with: ",e);return}r.children.splice(r.children.indexOf(e.config.vid),1)}else if(!e.el){const r=this.engine.getObjectBySymbol(e.config.vid);r||console.error("widget renderer: can not found Three object with: ",e),r.removeFromParent()}const n=this.engine.getObjectBySymbol(e.config.vid);de(e,n)}this.engine.removeConfigBySymbol(e.config.vid)}mountElement(e){const{element:n,onProps:r}=this.createElement(e);if(this.engine.applyConfig(n),E.isObjectType(n.type)){if(!e.el)this.engine.scene.add(this.engine.getObjectfromModules(E.OBJECTMODULE,n.vid));else{const i=this.engine.getConfigfromModules(E.OBJECTMODULE,e.el);if(!i){console.error(`widget renderer: can not found parent config with: ${e.el}`);return}i.children.push(n.vid)}const s=this.engine.getObjectBySymbol(n.vid);he(e,n,s)}}patchElement(e,n){if(e.type!==n.type)this.unmountElement(e),this.mountElement(n);else{n.config=e.config;const r=e.config;r||console.error("widget renderer: can not found  config with: ",e);let s={};const i=n.props;let c=!1;for(const o in e.props){if(F(o)){c=!0;continue}s[o]=e.props[o]}const u=(o,a,R)=>{for(const p in o)C(o[p])?C(a[p])&&a[p].config.vid!==o[p].config.vid?R[p]=a[p].config.vid:C(a[p])||(R[p]=a[p]):x.isObject(o[p])?u(o[p],a[p],R[p]):a[p]!==o[p]&&(R[p]=a[p])};u(s,i,r),c&&ae(n)}}createElement(e){const n=e.props,r={},s={};for(const c in n)["ref","index"].includes(c)||(F(c)?s[c]=n[c]:r[c]=Z(n[c]));const i=E.generateConfig(e.type,r,{strict:!1,warn:!1});return e.config=i,{element:i,onProps:s}}processComponent(e,n){if(!e&&!n){console.error("widget renderer: processElement prarams all of null");return}e===null?this.mountComponent(n):n===null?this.unmountComponent(e):this.patchComponent(e,n)}mountComponent(e){e.component=new g(e,this)}unmountComponent(e){var n;(n=e.component)==null||n.distory(),e.component=null}patchComponent(e,n){const r=e.component;n.component=r,r.vnode=n;const s=e.props||{},i=n.props||{},c={};let u=!1;for(const o in i)i[o]!==s[o]&&(c[o]=i[o],u=!0);u&&(r.updateProps(c),r.update())}}class Ee{constructor(e,n){this.wid=E.createSymbol(),this.version=V,this.components={},this.instance=null,this.engine=e,this.root=n,this.renderer=new me(this)}component(e,n){if(typeof e=="object"){if(n=e,!n.name){console.error("widget register component must be provide a name",n);return}e=n.name}if(!n){console.error("widget register component must be provide a component not a null",e);return}if(this.components[e]){console.warn(`A component with this name already exists: ${e}`);return}this.components[e]=n}mount(){const e=L(this.root);return this.renderer.render(e),this.instance=e.component,this}getState(){var e;return(e=this.instance)==null?void 0:e.getState(!0)}unmount(){var e;(e=this.instance)==null||e.distory()}use(){}}class z extends E.EngineSupport{constructor(e={}){super(e)}createWidget(e){return new Ee(this,e)}}const ye=function(t,e={}){const n=new z;return t.modules&&t.modules.forEach(r=>{n.registModule(r)}),t.plugins&&t.plugins.forEach(r=>{n.install(r)}),t.strategy&&t.strategy.forEach(r=>{n.exec(r)}),t.wdigets&&t.wdigets.forEach(r=>{n.createWidget(r)}),n},ve=function(t){return{value:t}};function B(t,e,n){let r;try{r=n?t(...n):t()}catch(s){console.error(s)}return r}function G(t,e,n){if(m.isFunction(t)){const s=B(t,e,n);return s&&m.isPromise(s)&&s.catch(i=>{console.error(i)}),s}const r=[];for(let s=0;s<t.length;s++)r.push(G(t[s],e,n));return r}function we(t,e){return Q(t,null,e)}const D={};function Re(t,e,n){return Q(t,e,n)}function Q(t,e,{immediate:n,deep:r,flush:s,onTrack:i,onTrigger:c}=m.EMPTY_OBJ){var X;const u=h.getCurrentScope()===((X=g.currentComponent)==null?void 0:X.scope)?g.currentComponent:null;let o,a=!1,R=!1;if(h.isRef(t)?(o=()=>t.value,a=h.isShallow(t)):h.isReactive(t)?(o=()=>t,r=!0):m.isArray(t)?(R=!0,a=t.some(d=>h.isReactive(d)||h.isShallow(d)),o=()=>t.map(d=>{if(h.isRef(d))return d.value;if(h.isReactive(d))return k(d);if(m.isFunction(d))return B(d)})):m.isFunction(t)?e?o=()=>B(t):o=()=>{if(!(u&&!u.isMounted))return p&&p(),G(t,u)}:o=m.NOOP,e&&r){const d=o;o=()=>k(d())}let p,Ce=d=>{p=v.onStop=()=>{B(d),p=v.onStop=void 0}},T=R?new Array(t.length).fill(D):D;const M=()=>{if(!!v.active)if(e){const d=v.run();(r||a||(R?d.some((Oe,be)=>m.hasChanged(Oe,T[be])):m.hasChanged(d,T)))&&(p&&p(),G(e,u,[d,T===D?void 0:R&&T[0]===D?[]:T,Ce]),T=d)}else v.run()};M.allowRecurse=!!e;let W;s==="sync"?W=M:s==="post"?W=()=>J(M):(M.pre=!0,u&&(M.id=u.cid),W=()=>$(M));const v=new h.ReactiveEffect(o,W);return e?n?M():T=v.run():s==="post"?J(v.run.bind(v)):v.run(),()=>{v.stop(),u&&u.scope&&m.remove(u.scope.effects,v)}}function k(t,e){if(!m.isObject(t)||t.__v_skip||(e=e||new Set,e.has(t)))return t;if(e.add(t),h.isRef(t))k(t.value,e);else if(m.isArray(t))for(let n=0;n<t.length;n++)k(t[n],e);else if(m.isSet(t)||m.isMap(t))t.forEach(n=>{k(n,e)});else if(m.isPlainObject(t))for(const n in t)k(t[n],e);return t}Object.defineProperty(f,"computed",{enumerable:!0,get:function(){return h.computed}}),Object.defineProperty(f,"reactive",{enumerable:!0,get:function(){return h.reactive}}),Object.defineProperty(f,"ref",{enumerable:!0,get:function(){return h.ref}}),Object.defineProperty(f,"shallowReactive",{enumerable:!0,get:function(){return h.shallowReactive}}),Object.defineProperty(f,"shallowReadonly",{enumerable:!0,get:function(){return h.shallowReadonly}}),Object.defineProperty(f,"shallowRef",{enumerable:!0,get:function(){return h.shallowRef}}),Object.defineProperty(f,"toRef",{enumerable:!0,get:function(){return h.toRef}}),Object.defineProperty(f,"toRefs",{enumerable:!0,get:function(){return h.toRefs}}),f.EngineWidget=z,f.defineComponent=ge,f.defineEngineWidget=ye,f.h=te,f.onBeforeDistory=se,f.onFrame=ie,f.onMounted=oe,f.raw=ve,f.vfor=re,f.vif=ne,f.watch=Re,f.watchEffect=we,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
